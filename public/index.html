<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„É¨„Éá„Ç£„Ç¢„É≥„ÇØ„É™„Éã„ÉÉ„ÇØ | ÊñΩË°ì„É°„Éã„É•„Éº</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Kaku+Gothic+New:wght@400;500;700&family=Cormorant+Garamond:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-primary: #8B7355;
            --color-primary-light: #A69076;
            --color-primary-dark: #6B5344;
            --color-accent: #C9A86C;
            --color-accent-light: #E8D5B5;
            --color-bg: #FAF8F5;
            --color-bg-card: #FFFFFF;
            --color-text: #3D3D3D;
            --color-text-muted: #7A7A7A;
            --color-border: #E8E4DF;
            --color-success: #7BA05B;
            --color-campaign: #C75D5D;
            --color-info: #5B7BA0;
            --color-warning: #D4A84B;
            --shadow-sm: 0 1px 3px rgba(139, 115, 85, 0.08);
            --shadow-md: 0 4px 12px rgba(139, 115, 85, 0.1);
            --shadow-lg: 0 8px 24px rgba(139, 115, 85, 0.12);
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 16px;
            --font-sans: 'Zen Kaku Gothic New', sans-serif;
            --font-serif: 'Cormorant Garamond', serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-sans);
            background: var(--color-bg);
            color: var(--color-text);
            line-height: 1.7;
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
            color: white;
            padding: 3rem 2rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            opacity: 0.5;
        }

        .header-content {
            position: relative;
            z-index: 1;
        }

        .header h1 {
            font-family: var(--font-serif);
            font-size: 2.5rem;
            font-weight: 500;
            letter-spacing: 0.15em;
            margin-bottom: 0.5rem;
        }

        .header p {
            font-size: 0.95rem;
            opacity: 0.9;
            letter-spacing: 0.1em;
        }

        /* Search & Filter */
        .controls {
            max-width: 1400px;
            margin: -2rem auto 2rem;
            padding: 0 1.5rem;
            position: relative;
            z-index: 10;
        }

        .search-box {
            background: var(--color-bg-card);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            padding: 1.5rem;
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
        }

        .search-input {
            flex: 1;
            min-width: 200px;
            padding: 0.875rem 1.25rem;
            border: 2px solid var(--color-border);
            border-radius: var(--radius-md);
            font-size: 1rem;
            font-family: inherit;
            transition: all 0.2s;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(139, 115, 85, 0.1);
        }

        .filter-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .filter-tab {
            padding: 0.625rem 1.25rem;
            border: none;
            background: var(--color-bg);
            color: var(--color-text-muted);
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 0.875rem;
            font-family: inherit;
            font-weight: 500;
            transition: all 0.2s;
        }

        .filter-tab:hover {
            background: var(--color-accent-light);
            color: var(--color-primary-dark);
        }

        .filter-tab.active {
            background: var(--color-primary);
            color: white;
        }

        /* Toggle Switch */
        .toggle-group {
            display: flex;
            gap: 1rem;
            padding: 0.5rem 0;
            border-top: 1px solid var(--color-border);
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .toggle-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--color-border);
            transition: 0.3s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
            box-shadow: var(--shadow-sm);
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: var(--color-primary);
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }

        /* Stats */
        .stats {
            display: flex;
            justify-content: center;
            gap: 2rem;
            padding: 1rem;
            font-size: 0.875rem;
            color: var(--color-text-muted);
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .stat-number {
            font-weight: 700;
            color: var(--color-primary);
            font-size: 1.25rem;
        }

        /* Main Content */
        .main {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1.5rem 4rem;
        }

        /* Category */
        .category {
            margin-bottom: 3rem;
        }

        .category-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--color-accent);
        }

        .category-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--color-accent) 0%, var(--color-accent-light) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .category-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--color-primary-dark);
        }

        .category-count {
            margin-left: auto;
            font-size: 0.875rem;
            color: var(--color-text-muted);
            background: var(--color-bg);
            padding: 0.375rem 0.875rem;
            border-radius: 999px;
        }

        /* Subcategory */
        .subcategory {
            margin-bottom: 2rem;
        }

        .subcategory-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--color-primary);
            margin-bottom: 1rem;
            padding-left: 1rem;
            border-left: 3px solid var(--color-accent);
        }

        /* Treatment Grid */
        .treatments-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 1.25rem;
        }

        .treatments-grid.show-details {
            grid-template-columns: 1fr;
        }

        /* Treatment Card */
        .treatment-card {
            background: var(--color-bg-card);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            overflow: hidden;
            transition: all 0.3s;
            border: 1px solid var(--color-border);
        }

        .treatment-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .treatment-header {
            padding: 1.25rem;
            background: linear-gradient(135deg, rgba(139, 115, 85, 0.03) 0%, rgba(201, 168, 108, 0.05) 100%);
            border-bottom: 1px solid var(--color-border);
        }

        .treatment-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--color-text);
            margin-bottom: 0.25rem;
        }

        .treatment-meta {
            font-size: 0.8rem;
            color: var(--color-text-muted);
        }

        .treatment-plans {
            padding: 0.5rem;
        }

        /* Plan Table (for detail view) */
        .plan-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .plan-table th {
            background: var(--color-bg);
            padding: 0.75rem 0.5rem;
            text-align: left;
            font-weight: 600;
            color: var(--color-text-muted);
            font-size: 0.75rem;
            white-space: nowrap;
            border-bottom: 2px solid var(--color-border);
        }

        .plan-table td {
            padding: 0.75rem 0.5rem;
            border-bottom: 1px solid var(--color-border);
            vertical-align: middle;
        }

        .plan-table tr:last-child td {
            border-bottom: none;
        }

        .plan-table tr:hover td {
            background: rgba(139, 115, 85, 0.02);
        }

        .plan-table .text-right {
            text-align: right;
        }

        .plan-table .text-center {
            text-align: center;
        }

        /* Plan Row (for simple view) */
        .plan-row {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            border-radius: var(--radius-sm);
            transition: background 0.2s;
        }

        .plan-row:hover {
            background: var(--color-bg);
        }

        .plan-name {
            flex: 1;
            font-size: 0.9rem;
            color: var(--color-text);
        }

        .plan-badge {
            font-size: 0.7rem;
            padding: 0.2rem 0.5rem;
            border-radius: 999px;
            margin-left: 0.5rem;
            font-weight: 500;
        }

        .plan-badge.trial {
            background: #E8F5E9;
            color: #2E7D32;
        }

        .plan-badge.course {
            background: #E3F2FD;
            color: #1565C0;
        }

        .plan-badge.monitor {
            background: #FFF3E0;
            color: #EF6C00;
        }

        .plan-prices {
            text-align: right;
        }

        .plan-price {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--color-primary-dark);
        }

        .plan-price-taxed {
            font-size: 0.75rem;
            color: var(--color-text-muted);
        }

        .plan-campaign {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.25rem;
        }

        .plan-original {
            font-size: 0.8rem;
            color: var(--color-text-muted);
            text-decoration: line-through;
        }

        .plan-campaign-price {
            font-size: 1rem;
            font-weight: 700;
            color: var(--color-campaign);
        }

        .campaign-badge {
            font-size: 0.7rem;
            background: var(--color-campaign);
            color: white;
            padding: 0.25rem 0.6rem;
            border-radius: 999px;
            display: inline-block;
            margin-bottom: 0.25rem;
        }

        .campaign-badge-inline {
            font-size: 0.65rem;
            background: var(--color-campaign);
            color: white;
            padding: 0.15rem 0.5rem;
            border-radius: 999px;
        }

        /* Cost Info */
        .cost-badge {
            display: inline-block;
            font-size: 0.7rem;
            padding: 0.2rem 0.5rem;
            border-radius: var(--radius-sm);
            font-weight: 500;
        }

        .cost-badge.low {
            background: #E8F5E9;
            color: #2E7D32;
        }

        .cost-badge.mid {
            background: #FFF8E1;
            color: #F57F17;
        }

        .cost-badge.high {
            background: #FFEBEE;
            color: #C62828;
        }

        .staff-discount {
            display: inline-block;
            font-size: 0.7rem;
            padding: 0.2rem 0.5rem;
            border-radius: var(--radius-sm);
            background: #E3F2FD;
            color: #1565C0;
            font-weight: 500;
        }

        .cost-breakdown {
            font-size: 0.7rem;
            color: var(--color-text-muted);
        }

        .profit-positive {
            color: #2E7D32;
            font-weight: 600;
        }

        .profit-negative {
            color: #C62828;
            font-weight: 600;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--color-text-muted);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 4rem 2rem;
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--color-border);
            border-top-color: var(--color-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 2rem;
            color: var(--color-text-muted);
            font-size: 0.875rem;
            border-top: 1px solid var(--color-border);
            background: var(--color-bg-card);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.75rem;
            }

            .treatments-grid {
                grid-template-columns: 1fr;
            }

            .stats {
                flex-direction: column;
                gap: 0.5rem;
            }

            .filter-tabs {
                width: 100%;
                overflow-x: auto;
                flex-wrap: nowrap;
                padding-bottom: 0.5rem;
            }

            .filter-tab {
                white-space: nowrap;
            }

            .plan-table {
                font-size: 0.75rem;
            }

            .plan-table th,
            .plan-table td {
                padding: 0.5rem 0.25rem;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <h1>LEDIAN CLINIC</h1>
            <p>ÊñΩË°ì„É°„Éã„É•„Éº„ÉªÊñôÈáëË°®</p>
        </div>
    </header>

    <div class="controls">
        <div class="search-box">
            <input type="text" class="search-input" id="searchInput" placeholder="ÊñΩË°ìÂêç„ÅßÊ§úÁ¥¢...">
            <div class="filter-tabs" id="filterTabs">
                <button class="filter-tab active" data-category="all">„Åô„Åπ„Å¶</button>
            </div>
            <div class="toggle-group">
                <div class="toggle-item">
                    <label class="toggle-switch">
                        <input type="checkbox" id="toggleCost">
                        <span class="toggle-slider"></span>
                    </label>
                    <span>Âéü‰æ°Ë°®Á§∫</span>
                </div>
                <div class="toggle-item">
                    <label class="toggle-switch">
                        <input type="checkbox" id="toggleStaff">
                        <span class="toggle-slider"></span>
                    </label>
                    <span>Á§æË≤©OFFË°®Á§∫</span>
                </div>
                <div class="toggle-item">
                    <label class="toggle-switch">
                        <input type="checkbox" id="toggleDetail">
                        <span class="toggle-slider"></span>
                    </label>
                    <span>Ë©≥Á¥∞„ÉÜ„Éº„Éñ„É´</span>
                </div>
            </div>
        </div>
        <div class="stats" id="stats"></div>
    </div>

    <main class="main" id="main">
        <div class="loading">
            <div class="loading-spinner"></div>
            <p>„É°„Éã„É•„Éº„ÇíË™≠„ÅøËæº„Åø‰∏≠...</p>
        </div>
    </main>

    <footer class="footer">
        <p>&copy; 2024 LEDIAN CLINIC. All rights reserved.</p>
    </footer>

    <script>
        // State
        let appState = {
            showCost: false,
            showStaff: false,
            showDetail: false,
            categories: [],
            campaigns: {},
            filter: 'all',
            search: ''
        };

        // „Ç´„ÉÜ„Ç¥„É™„Ç¢„Ç§„Ç≥„É≥„Éû„ÉÉ„Éî„É≥„Ç∞
        const categoryIcons = {
            '„Çπ„Ç≠„É≥„Ç±„Ç¢': '‚ú®',
            'ÂåªÁôÇËÑ±ÊØõ': 'üí´',
            '„Ç¢„Éº„Éà„É°„Ç§„ÇØ': 'üé®',
            'ÁÇπÊª¥„ÉªÊ≥®Â∞Ñ': 'üíâ',
            'ËÑÇËÇ™Âê∏Âºï': 'ü©∫',
            'ËÑÇËÇ™Ê∫∂Ëß£Ê≥®Â∞Ñ': 'üíß',
            'ËÇåËÇ≤Ê≥®Â∞Ñ': 'üå∏',
            '„Éú„Éà„ÉÉ„ÇØ„Çπ': 'üíé',
            '„Éí„Ç¢„É´„É≠„É≥ÈÖ∏': 'üíß',
            'Á≥∏„É™„Éï„Éà': 'üßµ',
            'È∫ªÈÖî': 'üíä',
            '„Éâ„ÇØ„Çø„Éº„Ç∫„Ç≥„Çπ„É°': 'üß¥',
            'ËÇåË®∫Êñ≠': 'üî¨',
            '„É≠„Éº„Éû„Éî„É≥„ÇØ': 'üåπ',
            'LDM': 'üì°',
        };

        // ‰æ°Ê†º„Éï„Ç©„Éº„Éû„ÉÉ„Éà
        const formatPrice = (price) => {
            if (!price && price !== 0) return '-';
            return '¬•' + price.toLocaleString();
        };

        // ‰æ°Ê†º„Éï„Ç©„Éº„Éû„ÉÉ„ÉàÔºàÁ®éÊäú„Åç + Á®éËæºÔºâ
        const formatPriceWithTax = (price, priceTaxed) => {
            if (!price && price !== 0) return '-';
            const taxed = priceTaxed || Math.round(price * 1.1);
            return `¬•${price.toLocaleString()} (Á®éËæº¬•${taxed.toLocaleString()})`;
        };

        // Âéü‰æ°Áéá„Éê„ÉÉ„Ç∏
        const getCostBadge = (rate) => {
            if (!rate) return '';
            let className = 'mid';
            if (rate < 30) className = 'low';
            else if (rate > 50) className = 'high';
            return `<span class="cost-badge ${className}">${rate.toFixed(1)}%</span>`;
        };

        // Á§æË≤©‰æ°Ê†ºË®àÁÆó
        const getStaffPrice = (price, discountRate) => {
            if (!price || !discountRate) return null;
            return Math.round(price * (100 - discountRate) / 100);
        };

        // „Éó„É©„É≥„Çø„Ç§„Éó„Éê„ÉÉ„Ç∏
        const getPlanBadge = (planType) => {
            const badges = {
                'trial': '<span class="plan-badge trial">ÂàùÂõû</span>',
                'course': '<span class="plan-badge course">„Ç≥„Éº„Çπ</span>',
                'monitor': '<span class="plan-badge monitor">„É¢„Éã„Çø„Éº</span>',
                'campaign': '<span class="plan-badge campaign">„Ç≠„É£„É≥„Éö„Éº„É≥</span>',
            };
            return badges[planType] || '';
        };

        // Ë©≥Á¥∞„ÉÜ„Éº„Éñ„É´ÁîüÊàê
        const createDetailTable = (plans) => {
            const headers = ['„Éó„É©„É≥', '‰æ°Ê†º'];
            if (appState.showCost) {
                headers.push('Âéü‰æ°Áéá(Á®éÊäú)', 'ÂÇôÂìÅÂéü‰æ°', '‰∫∫‰ª∂Ë≤ª', 'Âéü‰æ°Ë®à', 'Á≤óÂà©');
            }
            if (appState.showStaff) {
                headers.push('Á§æË≤©OFF', 'Á§æË≤©‰æ°Ê†º');
            }
            headers.push('ÂÇôËÄÉ');

            const headerHtml = headers.map(h => `<th>${h}</th>`).join('');

            const rowsHtml = plans.map(plan => {
                const staffPrice = getStaffPrice(plan.price_taxed, plan.staff_discount_rate);
                const hasCampaign = plan.campaign_price && plan.campaign_price < plan.price;
                const campaignInfo = plan.campaign_id ? appState.campaigns[plan.campaign_id] : null;

                let cells = [
                    `<td>${plan.plan_name} ${getPlanBadge(plan.plan_type)}</td>`,
                    `<td class="text-right">${hasCampaign ? 
                        `<div class="plan-original">ÈÄöÂ∏∏: ${formatPriceWithTax(plan.price, plan.price_taxed)}</div>
                         <div class="plan-campaign-price"><span class="campaign-badge-inline">${campaignInfo ? campaignInfo.title : '„Ç≠„É£„É≥„Éö„Éº„É≥'} ${Math.round((1 - plan.campaign_price / plan.price) * 100)}%OFF</span><br>‚Üí ${formatPriceWithTax(plan.campaign_price, plan.campaign_price_taxed)}</div>` : 
                        `<strong>${formatPriceWithTax(plan.price, plan.price_taxed)}</strong>`
                    }</td>`
                ];

                if (appState.showCost) {
                    // Âéü‰æ°Ë®àÁÆóÔºàÁ®éÊäú„Åç‰æ°Ê†º √ó Âéü‰æ°ÁéáÔºâ
                    const estimatedCost = plan.cost_rate ? Math.round(plan.price * plan.cost_rate / 100) : null;
                    // Á≤óÂà©Ë®àÁÆó
                    const grossProfit = plan.total_cost ? plan.price - plan.total_cost : (estimatedCost ? plan.price - estimatedCost : null);
                    
                    cells.push(
                        `<td class="text-center">${getCostBadge(plan.cost_rate)}${plan.cost_rate ? `<br><span class="cost-breakdown">${formatPrice(estimatedCost)}</span>` : ''}</td>`,
                        `<td class="text-right">${formatPrice(plan.supply_cost)}</td>`,
                        `<td class="text-right">${formatPrice(plan.staff_cost)}</td>`,
                        `<td class="text-right">${plan.total_cost ? `<strong>${formatPrice(plan.total_cost)}</strong>` : '-'}</td>`,
                        `<td class="text-right">${grossProfit ? `<span class="${grossProfit > 0 ? 'profit-positive' : 'profit-negative'}">${formatPrice(grossProfit)}</span>` : '-'}</td>`
                    );
                }

                if (appState.showStaff) {
                    const staffPriceExTax = getStaffPrice(plan.price, plan.staff_discount_rate);
                    const staffPriceTaxed = getStaffPrice(plan.price_taxed, plan.staff_discount_rate);
                    cells.push(
                        `<td class="text-center">${plan.staff_discount_rate ? `<span class="staff-discount">${plan.staff_discount_rate}%OFF</span>` : '-'}</td>`,
                        `<td class="text-right">${staffPriceExTax ? `<strong>${formatPriceWithTax(staffPriceExTax, staffPriceTaxed)}</strong>` : '-'}</td>`
                    );
                }

                cells.push(`<td>${plan.notes || '-'}</td>`);

                return `<tr>${cells.join('')}</tr>`;
            }).join('');

            return `
                <table class="plan-table">
                    <thead><tr>${headerHtml}</tr></thead>
                    <tbody>${rowsHtml}</tbody>
                </table>
            `;
        };

        // „Ç∑„É≥„Éó„É´„Éó„É©„É≥Ë°åÁîüÊàê
        const createSimplePlanRow = (plan) => {
            const hasCampaign = plan.campaign_price && plan.campaign_price < plan.price;
            const campaignInfo = plan.campaign_id ? appState.campaigns[plan.campaign_id] : null;
            const staffPrice = getStaffPrice(plan.price_taxed, plan.staff_discount_rate);

            let extraInfo = [];
            if (appState.showCost) {
                if (plan.total_cost) {
                    const grossProfit = plan.price - plan.total_cost;
                    extraInfo.push(`Âéü‰æ°: ${formatPrice(plan.total_cost)} / Á≤óÂà©: ${formatPrice(grossProfit)}`);
                } else if (plan.cost_rate) {
                    const estimatedCost = Math.round(plan.price * plan.cost_rate / 100);
                    extraInfo.push(`Âéü‰æ°Áéá: ${plan.cost_rate.toFixed(1)}% (${formatPrice(estimatedCost)})`);
                }
            }
            if (appState.showStaff && plan.staff_discount_rate) {
                const staffPriceExTax = getStaffPrice(plan.price, plan.staff_discount_rate);
                const staffPriceTaxed = getStaffPrice(plan.price_taxed, plan.staff_discount_rate);
                extraInfo.push(`Á§æË≤©${plan.staff_discount_rate}%OFF: ${formatPriceWithTax(staffPriceExTax, staffPriceTaxed)}`);
            }

            return `
                <div class="plan-row">
                    <div class="plan-name">
                        ${plan.plan_name}
                        ${getPlanBadge(plan.plan_type)}
                        ${extraInfo.length ? `<div class="cost-breakdown">${extraInfo.join(' / ')}</div>` : ''}
                    </div>
                    <div class="plan-prices">
                        ${hasCampaign ? `
                            <div class="plan-campaign">
                                <span class="campaign-badge">${campaignInfo ? campaignInfo.title : '„Ç≠„É£„É≥„Éö„Éº„É≥'} ${Math.round((1 - plan.campaign_price / plan.price) * 100)}%OFF</span>
                                <div class="plan-original">ÈÄöÂ∏∏: ${formatPriceWithTax(plan.price, plan.price_taxed)}</div>
                                <div class="plan-campaign-price">‚Üí ${formatPriceWithTax(plan.campaign_price, plan.campaign_price_taxed)}</div>
                            </div>
                        ` : `
                            <div class="plan-price">${formatPriceWithTax(plan.price, plan.price_taxed)}</div>
                        `}
                    </div>
                </div>
            `;
        };

        // ÊñΩË°ì„Ç´„Éº„Éâ„ÇíÁîüÊàê
        const createTreatmentCard = (treatment) => {
            const plansHtml = appState.showDetail 
                ? createDetailTable(treatment.plans)
                : treatment.plans.map(createSimplePlanRow).join('');

            return `
                <div class="treatment-card" data-name="${treatment.name}">
                    <div class="treatment-header">
                        <div class="treatment-name">${treatment.name}</div>
                        <div class="treatment-meta">${treatment.plans.length}„Éó„É©„É≥</div>
                    </div>
                    <div class="treatment-plans">
                        ${plansHtml}
                    </div>
                </div>
            `;
        };

        // „Ç´„ÉÜ„Ç¥„É™„Çª„ÇØ„Ç∑„Éß„É≥„ÇíÁîüÊàê
        const createCategorySection = (category) => {
            const icon = categoryIcons[category.name] || 'üí†';
            const treatmentCount = category.subcategories.reduce(
                (acc, sub) => acc + sub.treatments.length, 0
            );

            if (treatmentCount === 0) return '';

            const subcategoriesHtml = category.subcategories
                .filter(sub => sub.treatments.length > 0)
                .map(sub => {
                    const treatmentsHtml = sub.treatments
                        .filter(t => t.plans.length > 0)
                        .map(createTreatmentCard)
                        .join('');

                    if (!treatmentsHtml) return '';

                    return `
                        <div class="subcategory">
                            <h3 class="subcategory-title">${sub.name}</h3>
                            <div class="treatments-grid ${appState.showDetail ? 'show-details' : ''}">
                                ${treatmentsHtml}
                            </div>
                        </div>
                    `;
                })
                .join('');

            return `
                <section class="category" data-category="${category.name}">
                    <div class="category-header">
                        <div class="category-icon">${icon}</div>
                        <h2 class="category-title">${category.name}</h2>
                        <span class="category-count">${treatmentCount}ÊñΩË°ì</span>
                    </div>
                    ${subcategoriesHtml}
                </section>
            `;
        };

        // „Éï„Ç£„É´„Çø„Éº„Çø„Éñ„ÇíÁîüÊàê
        const createFilterTabs = (categories) => {
            const tabs = categories
                .filter(cat => cat.subcategories.some(sub => sub.treatments.length > 0))
                .map(cat => `
                    <button class="filter-tab" data-category="${cat.name}">${cat.name}</button>
                `)
                .join('');

            document.getElementById('filterTabs').innerHTML = `
                <button class="filter-tab active" data-category="all">„Åô„Åπ„Å¶</button>
                ${tabs}
            `;
        };

        // Áµ±Ë®à„ÇíÊõ¥Êñ∞
        const updateStats = (categories) => {
            const totalTreatments = categories.reduce(
                (acc, cat) => acc + cat.subcategories.reduce(
                    (acc2, sub) => acc2 + sub.treatments.length, 0
                ), 0
            );
            const totalPlans = categories.reduce(
                (acc, cat) => acc + cat.subcategories.reduce(
                    (acc2, sub) => acc2 + sub.treatments.reduce(
                        (acc3, t) => acc3 + t.plans.length, 0
                    ), 0
                ), 0
            );

            document.getElementById('stats').innerHTML = `
                <div class="stat-item">
                    <span class="stat-number">${categories.length}</span>
                    <span>„Ç´„ÉÜ„Ç¥„É™</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">${totalTreatments}</span>
                    <span>ÊñΩË°ì</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">${totalPlans}</span>
                    <span>„Éó„É©„É≥</span>
                </div>
            `;
        };

        // „É°„Ç§„É≥„É¨„É≥„ÉÄ„É™„É≥„Ç∞
        const renderMenu = () => {
            const main = document.getElementById('main');
            
            let filteredCategories = appState.categories;
            
            // „Ç´„ÉÜ„Ç¥„É™„Éï„Ç£„É´„Çø„Éº
            if (appState.filter !== 'all') {
                filteredCategories = appState.categories.filter(cat => cat.name === appState.filter);
            }

            // Ê§úÁ¥¢„Éï„Ç£„É´„Çø„Éº
            if (appState.search) {
                const searchLower = appState.search.toLowerCase();
                filteredCategories = filteredCategories.map(cat => ({
                    ...cat,
                    subcategories: cat.subcategories.map(sub => ({
                        ...sub,
                        treatments: sub.treatments.filter(t => 
                            t.name.toLowerCase().includes(searchLower) ||
                            t.plans.some(p => p.plan_name.toLowerCase().includes(searchLower))
                        )
                    }))
                }));
            }

            const html = filteredCategories.map(createCategorySection).join('');

            if (!html.trim()) {
                main.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üîç</div>
                        <p>Ë©≤ÂΩì„Åô„ÇãÊñΩË°ì„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü</p>
                    </div>
                `;
                return;
            }

            main.innerHTML = html;
        };

        // „Ç¢„Éó„É™ÂàùÊúüÂåñ
        const init = async () => {
            try {
                // „É°„Éã„É•„Éº„Éá„Éº„ÇøË™≠„ÅøËæº„Åø
                const response = await fetch('../database/seed_data.json');
                const data = await response.json();
                appState.categories = data.categories;

                // „Ç≠„É£„É≥„Éö„Éº„É≥„Éá„Éº„ÇøË™≠„ÅøËæº„Åø
                try {
                    const campaignResponse = await fetch('../data/content/campaigns.json');
                    const campaignData = await campaignResponse.json();
                    // „Ç≠„É£„É≥„Éö„Éº„É≥„ÇíID„Åß„Éû„ÉÉ„ÉóÂåñ
                    campaignData.campaigns.forEach(campaign => {
                        appState.campaigns[campaign.id] = {
                            id: campaign.id,
                            title: campaign.title,
                            description: campaign.description
                        };
                    });
                } catch (e) {
                    console.warn('„Ç≠„É£„É≥„Éö„Éº„É≥„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó:', e);
                }

                createFilterTabs(appState.categories);
                updateStats(appState.categories);
                renderMenu();

                // Ê§úÁ¥¢„Ç§„Éô„É≥„Éà
                const searchInput = document.getElementById('searchInput');
                let debounceTimer;
                searchInput.addEventListener('input', (e) => {
                    clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(() => {
                        appState.search = e.target.value;
                        renderMenu();
                    }, 300);
                });

                // „Éï„Ç£„É´„Çø„Éº„Çø„Éñ„Ç§„Éô„É≥„Éà
                document.getElementById('filterTabs').addEventListener('click', (e) => {
                    if (e.target.classList.contains('filter-tab')) {
                        document.querySelectorAll('.filter-tab').forEach(tab => tab.classList.remove('active'));
                        e.target.classList.add('active');
                        appState.filter = e.target.dataset.category;
                        renderMenu();
                    }
                });

                // „Éà„Ç∞„É´„Ç§„Éô„É≥„Éà
                document.getElementById('toggleCost').addEventListener('change', (e) => {
                    appState.showCost = e.target.checked;
                    renderMenu();
                });

                document.getElementById('toggleStaff').addEventListener('change', (e) => {
                    appState.showStaff = e.target.checked;
                    renderMenu();
                });

                document.getElementById('toggleDetail').addEventListener('change', (e) => {
                    appState.showDetail = e.target.checked;
                    renderMenu();
                });

            } catch (error) {
                console.error('Error loading menu:', error);
                document.getElementById('main').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ö†Ô∏è</div>
                        <p>„É°„Éã„É•„Éº„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</p>
                        <p style="font-size: 0.8rem; margin-top: 0.5rem;">„É≠„Éº„Ç´„É´„Çµ„Éº„Éê„Éº„ÇíËµ∑Âãï„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
                    </div>
                `;
            }
        };

        init();
    </script>
</body>
</html>
