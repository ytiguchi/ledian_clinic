# データ正規化・拡張ロードマップ

## 最終的な出口（目標）

### 1. デザイナー向けAPI（公開サイト構築用）
- RESTful API (`/api/v1/*`)
- JSON形式のデータ提供
- 認証: API Key

### 2. 外部システム連携
- **POSシステム**: 料金・メニュー情報
- **カルテシステム**: 施術情報、症例情報
- **WEBサイト**: 公開用データ

### 3. データエクスポート
- CSV/PDF/JSON形式
- 各システム向けフォーマット

## 設計原則

1. **正規化**: データの重複を避け、整合性を保つ
2. **拡張性**: 将来的な要件追加に対応できる構造
3. **API設計**: 外部システムから使いやすい構造
4. **一貫性**: データ構造の一貫性を保つ

## 現在のデータ構造

### 実装済みテーブル

- `categories` - カテゴリ
- `subcategories` - サブカテゴリ
- `treatments` - 施術
- `treatment_plans` - 料金プラン
- `campaigns` - キャンペーン
- `campaign_plans` - キャンペーンプラン
- `treatment_before_afters` - 症例写真
- `treatment_details` - 施術詳細（一部）
- `treatment_faqs` - FAQ（一部）
- `treatment_cautions` - 注意事項（一部）

## 拡張・正規化すべき項目

### Phase 1: 施術詳細情報の充実

#### 1.1 施術詳細情報の拡張

**現状**: `treatment_details`は一部のみ実装
**必要**: 完全な実装と正規化

- `treatment_details` テーブルの完全実装
- スペック情報の構造化
- ターゲット（お悩み・効果・部位）の正規化
- 施術フロー（`treatment_flows`）の実装
- 注意事項（`treatment_cautions`）の実装
- FAQ（`treatment_faqs`）の実装

#### 1.2 タグシステムの拡張

**現状**: `tags`, `treatment_tags` は定義済み
**必要**: 実装とデータ投入

- タグカテゴリの追加（お悩み・効果・部位など）
- タグの階層構造
- タグの多言語対応（必要に応じて）

#### 1.3 メディア管理の拡張

**現状**: 画像URLは個別フィールド
**必要**: 正規化されたメディア管理

- `media` テーブルの作成
- 画像・動画の統一管理
- サムネイル生成
- 複数画像の管理

### Phase 2: 料金・原価管理の拡張

#### 2.1 原価管理の詳細化

**現状**: 基本的な原価情報のみ
**必要**: 詳細な原価管理

- 原価の内訳（備品・薬剤・人件費など）
- 原価の履歴管理
- 原価率の計算ロジック
- キャンペーン時の原価管理

#### 2.2 価格履歴管理

**現状**: 価格変更時の履歴なし
**必要**: 価格変更履歴の管理

- `price_history` テーブル
- 価格変更日時の記録
- 変更理由の記録

#### 2.3 社販（スタッフ割引）管理

**現状**: `staff_discount_rate` のみ
**必要**: 詳細な社販管理

- 社販価格の計算ロジック
- 社販適用条件
- 社販履歴

### Phase 3: キャンペーン・マーケティング機能の拡張

#### 3.1 キャンペーン管理の拡張

**現状**: 基本的なキャンペーン情報
**必要**: 詳細なキャンペーン管理

- キャンペーンの適用条件
- キャンペーンの優先順位管理
- キャンペーンの組み合わせルール
- キャンペーンの効果測定

#### 3.2 メールマガジン・通知管理

**新規**: キャンペーン告知などの管理

- `announcements` テーブル
- 通知先の管理
- 通知履歴

### Phase 4: 症例・レビュー管理の拡張

#### 4.1 症例写真の拡張

**現状**: 基本的なビフォーアフター情報
**必要**: 詳細な症例管理

- 症例の詳細情報（年齢・性別・施術回数など）
- 症例のカテゴリ分類
- 症例の承認フロー
- 症例の公開範囲管理

#### 4.2 レビュー・評価管理

**新規**: 顧客レビューの管理

- `reviews` テーブル
- レビューの承認フロー
- レビューの表示制御

### Phase 5: トレーニング・教育機能の拡張

#### 5.1 お知らせ・ニュース管理

**新規**: スタッフ向けお知らせ

- `announcements` テーブル（スタッフ向け）
- 既読管理
- カテゴリ分類

#### 5.2 マニュアル・資料管理

**新規**: トレーニング資料

- `training_manuals` テーブル
- ファイル管理
- バージョン管理

#### 5.3 FAQ管理の拡張

**現状**: `treatment_faqs` のみ（施術別）
**必要**: 一般FAQの追加

- `general_faqs` テーブル
- カテゴリ別FAQ
- 検索機能向けの最適化

### Phase 6: 外部システム連携準備

#### 6.1 データ同期管理

**新規**: 外部システムとの同期状態管理

- `sync_status` テーブル
- 同期履歴
- エラーログ

#### 6.2 APIアクセスログ

**新規**: API使用状況の記録

- `api_access_logs` テーブル
- 使用量の追跡
- エラー監視

## 優先順位

### 高優先度（Phase 1-2）

1. **施術詳細情報の完全実装**（デザイナーが公開サイトで必要）
2. **メディア管理の正規化**（画像・動画の統一管理）
3. **原価管理の詳細化**（経営判断に必要）

### 中優先度（Phase 3-4）

4. **キャンペーン管理の拡張**
5. **症例管理の拡張**

### 低優先度（Phase 5-6）

6. **トレーニング機能の拡張**
7. **外部システム連携準備**

## 実装スケジュール（目安）

### Q1: 基礎データ構造の拡張
- Phase 1: 施術詳細情報の充実
- Phase 2: 料金・原価管理の拡張

### Q2: 機能拡張
- Phase 3: キャンペーン・マーケティング機能
- Phase 4: 症例・レビュー管理

### Q3: トレーニング・連携準備
- Phase 5: トレーニング機能
- Phase 6: 外部システム連携準備

## データ構造設計のポイント

### 1. 正規化の基準

- **第3正規形以上を目指す**
- ただし、パフォーマンスを考慮した非正規化も検討
- APIレスポンスの効率化のため、ビューまたはJSONカラムも検討

### 2. 拡張性の確保

- カスタムフィールドの追加に対応できる構造
- バージョニング（スキーマ変更時の互換性）
- ソフトデリート（`is_active`, `deleted_at`）

### 3. API設計との整合

- APIレスポンスに必要な情報を効率的に取得できる構造
- JOINの最小化（パフォーマンス）
- キャッシュしやすい構造

## 注意事項

- **後方互換性**: 既存のAPIやデータ構造を壊さない
- **段階的移行**: 一度に全てを変更せず、段階的に拡張
- **データ移行**: 既存データの移行計画を事前に作成
- **テスト**: 各段階でテストを実施

## 関連ドキュメント

- [PostgreSQLスキーマ定義](./database/schema.sql)
- [デザイナー向けAPI仕様](./API_FOR_DESIGNER.md)
- [システム統合ガイド](./DESIGNER_INTEGRATION.md)



