# Internal Site 進捗状況

最終更新: 2024-12-26

## ✅ 完了したタスク

### Phase 1: 基盤構築

1. ✅ **Astroプロジェクト初期化**
   - プロジェクト作成完了
   - TypeScript設定
   - Tailwind CSS統合
   - React統合

2. ✅ **基本レイアウト・デザインシステム**
   - BaseLayout実装
   - Layoutコンポーネント（ヘッダー・ナビゲーション）
   - ダッシュボードページ
   - レスポンシブ対応

3. ✅ **Cloudflare D1統合（基盤）**
   - D1接続ユーティリティ（`src/lib/db.ts`）
   - API Routes構造
   - 環境変数・型定義

4. ✅ **ページ構造**
   - `/` - ダッシュボード
   - `/pricing` - 料金管理（一覧・新規作成・編集ページ）
   - `/campaigns` - キャンペーン管理
   - `/treatments` - 施術管理
   - `/menu` - メニュー管理（施術詳細）
   - `/before-afters` - 症例写真管理
   - `/launches` - 新商品導入管理

### Phase 2: 料金管理機能 ✅

1. ✅ **料金表一覧ページ**
   - ページ構造
   - API実装 (`/api/pricing`)
   - フロントエンドデータ取得
   - 検索・フィルター（カテゴリ/サブカテゴリ）
   - インライン編集モーダル

2. ✅ **料金プラン新規作成**
   - カテゴリ・サブカテゴリ・施術の連動選択
   - モダンなフォームデザイン
   - バリデーション
   - URLパラメータによる施術自動選択

3. ✅ **料金プラン編集・削除機能**
   - `/pricing/[id]/edit` ページ
   - PUT/DELETE API
   - 施術詳細ページからのインライン編集
   - 更新・削除処理

### Phase 3: 症例写真(BeforeAfter)管理 ✅

1. ✅ **症例写真一覧ページ**
   - テーブル表示
   - 画像プレビュー
   - フィルタリング

2. ✅ **症例写真編集機能**
   - 編集フォーム
   - 施術セレクター連携
   - TypeScript構文エラー修正

3. ✅ **画像・データ移行**
   - R2への画像移行スクリプト (`scripts/migrate_images_to_r2.py`)
   - captionの正規化スクリプト (`scripts/migrate_before_afters.py`)
   - 構造化データへの変換（部位、施術回数、リスク等）

### Phase 4: キャンペーン管理 ✅

1. ✅ **キャンペーン一覧ページ**
   - ステータス表示（進行中/終了）
   - 一覧API

2. ✅ **キャンペーン作成・編集**
   - 作成フォーム
   - 編集ページ

### Phase 5: 施術管理 ✅

1. ✅ **施術一覧ページ**
   - カテゴリ/サブカテゴリ階層表示
   - 施術詳細リンク

2. ✅ **施術詳細ページ (`/menu/[id]`)**
   - タブ切り替え（概要/料金/症例/FAQ等）
   - 料金プランのインライン編集
   - 料金プラン追加ボタン（施術自動選択付き）

3. ✅ **施術編集機能**
   - 基本情報編集
   - 詳細情報（施術の流れ、注意事項等）編集

### Phase 6: 新商品導入管理 ✅

1. ✅ **導入プロジェクト一覧**
   - ステータス管理
   - 進捗表示

2. ✅ **導入プロジェクト作成・編集**
   - タスク管理
   - 料金プラン連携

---

## 🚧 進行中

### 画像/アセット管理

1. 🔄 **R2統合**
   - 公開URL設計: ✅ (`pub-7fb3b78717844555a19c9c9ccae5f2f9.r2.dev`)
   - 画像アップロードAPI: ⏳
   - 画像最適化: ⏳

---

## 📋 次のタスク（優先順位順）

### 高優先度（公開サイト準備）

1. **公開サイトで必要なデータ項目の棚卸し**
   - ページ一覧確定
   - 必須データ項目列挙

2. **公開フラグ（`is_published`）の統一**
   - 対象テーブル洗い出し
   - 運用ルール定義

3. **スキーマ統合**
   - 主キー型の統一
   - 症例テーブル名統一

### 中優先度

4. **データエクスポート**
   - CSVエクスポート
   - PDFエクスポート

5. **画像管理UI**
   - アップロードUI
   - ギャラリー表示

### 低優先度（将来拡張）

6. **認証・認可**
   - Cloudflare Access統合
   - ロールベースアクセス制御

7. **履歴管理**
   - 変更履歴
   - ロールバック機能

---

## 📝 技術的な注意点

### D1データベース

- PostgreSQLからD1への移行完了
- UUIDはTEXT型で扱う
- ENUMはCHECK制約で実現
- マイグレーション: `database/d1/migrations/`

### R2ストレージ

- 公開URL: `https://pub-7fb3b78717844555a19c9c9ccae5f2f9.r2.dev`
- 画像移行スクリプト: `scripts/migrate_images_to_r2.py`

### 開発環境

- ローカル開発: `npm run dev`
- D1接続: `wrangler d1` コマンドでローカルDB作成
- ビルド: `npm run build`
- デプロイ: `npm exec wrangler -- pages deploy dist --project-name ledian-clinic-internal`

### API Routes

- `src/pages/api/` に配置
- `locals.runtime.env.DB` でD1にアクセス
- エラーハンドリング必須

---

## 🐛 既知の問題

- 特になし

---

## 📊 進捗率

- 基盤構築: **100%** ✅
- 料金管理: **100%** ✅
- キャンペーン管理: **90%** ✅
- 施術管理: **90%** ✅
- 症例写真管理: **90%** ✅
- 新商品導入管理: **80%** ✅
- 画像/R2管理: **40%** 🔄
- データエクスポート: **0%** ⏳
- 認証・認可: **0%** ⏳

**全体進捗: 約75%**
