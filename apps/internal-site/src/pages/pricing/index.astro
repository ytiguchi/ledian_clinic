---
import Layout from '../../components/Layout.astro';
---

<Layout>
  <div class="pricing-page">
    <!-- Page Header -->
    <div class="page-header">
      <div>
        <h1 class="page-title">æ–™é‡‘ç®¡ç†</h1>
        <p class="page-subtitle">æ–½è¡“ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®æ–™é‡‘ã‚’ç®¡ç†ã—ã¾ã™</p>
      </div>
      <a href="/pricing/new" class="btn btn-primary">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        æ–°è¦ãƒ—ãƒ©ãƒ³è¿½åŠ 
      </a>
    </div>

    <!-- Filter Bar -->
    <div class="filter-bar">
      <div class="filter-grid">
        <div class="filter-item filter-search">
          <label class="label">æ¤œç´¢</label>
          <input
            type="text"
            placeholder="æ–½è¡“åãƒ»ãƒ—ãƒ©ãƒ³åãƒ»ã‚«ãƒ†ã‚´ãƒªã§æ¤œç´¢..."
            class="input"
            id="searchInput"
          />
        </div>
        <div class="filter-item">
          <label class="label">ã‚«ãƒ†ã‚´ãƒª</label>
          <select class="select" id="categoryFilter">
            <option value="">ã™ã¹ã¦ã®ã‚«ãƒ†ã‚´ãƒª</option>
          </select>
        </div>
        <div class="filter-item">
          <label class="label">ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒª</label>
          <select class="select" id="subcategoryFilter">
            <option value="">ã™ã¹ã¦ã®ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒª</option>
          </select>
        </div>
        <div class="filter-item filter-actions">
          <button class="btn btn-secondary" id="clearBtn" title="æ¤œç´¢æ¡ä»¶ã‚’ã‚¯ãƒªã‚¢">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
            ã‚¯ãƒªã‚¢
          </button>
        </div>
      </div>
    </div>

    <!-- Price Table -->
    <div class="table-container">
      <table class="table">
        <thead>
          <tr>
            <th>ã‚«ãƒ†ã‚´ãƒª</th>
            <th>ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒª</th>
            <th>æ–½è¡“</th>
            <th>ãƒ—ãƒ©ãƒ³å</th>
            <th>ç¨®åˆ¥</th>
            <th class="text-center">å›æ•°</th>
            <th class="text-right">ç¨æŠœä¾¡æ ¼</th>
            <th class="text-right">ç¨è¾¼ä¾¡æ ¼</th>
            <th class="text-right">åŸä¾¡ç‡</th>
            <th class="text-right">åŸä¾¡åˆè¨ˆ</th>
            <th class="text-center">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="priceTableBody">
          <tr>
            <td colspan="11">
              <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</Layout>

<style>
  .pricing-page {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  /* Filter Grid */
  .filter-grid {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr auto;
    gap: 1rem;
    align-items: end;
  }

  .filter-search {
    grid-column: span 1;
  }

  .filter-item {
    display: flex;
    flex-direction: column;
    gap: 0.375rem;
  }

  .filter-actions {
    justify-content: flex-end;
  }

  /* Table Styles */
  .table-container {
    animation: fadeIn 0.3s ease-out;
  }

  .text-right {
    text-align: right;
  }

  .text-center {
    text-align: center;
  }

  /* Price Cell */
  .price-regular {
    font-weight: 600;
    color: var(--color-text);
  }

  .price-campaign {
    font-weight: 700;
    color: var(--color-accent);
  }

  .price-none {
    color: var(--color-text-muted);
  }

  /* Action Buttons */
  .action-buttons {
    display: flex;
    gap: 0.5rem;
    justify-content: center;
  }

  .action-btn {
    padding: 0.375rem 0.75rem;
    font-size: 0.8125rem;
    font-weight: 500;
    border-radius: var(--radius-md);
    text-decoration: none;
    transition: all var(--transition-fast);
    cursor: pointer;
    border: none;
  }

  .action-btn-edit {
    background: var(--color-accent-subtle);
    color: var(--color-accent-dark);
  }

  .action-btn-edit:hover {
    background: var(--color-accent);
    color: var(--color-primary);
  }

  .action-btn-delete {
    background: var(--color-error-light);
    color: #b91c1c;
  }

  .action-btn-delete:hover {
    background: var(--color-error);
    color: white;
  }

  /* Plan Info */
  .plan-name {
    font-weight: 500;
    color: var(--color-text);
  }

  /* Category Info */
  .category-cell {
    background: var(--color-bg-subtle);
    border-right: 2px solid var(--color-border);
    vertical-align: top;
  }

  .category-info {
    padding: 0.5rem 0;
  }

  .category-name {
    font-weight: 600;
    color: var(--color-text);
    font-size: 0.9375rem;
  }

  .treatment-info {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .subcategory-name {
    font-size: 0.75rem;
    color: var(--color-text-muted);
    font-weight: 500;
  }

  .treatment-name {
    font-weight: 500;
    color: var(--color-text);
  }

  /* Plan Type Badge */
  .plan-type-badge {
    display: inline-block;
    padding: 0.25rem 0.625rem;
    border-radius: var(--radius-sm);
    font-size: 0.75rem;
    font-weight: 600;
  }

  .plan-type-single {
    background: var(--color-primary-subtle);
    color: var(--color-primary-dark);
  }

  .plan-type-course {
    background: var(--color-accent-subtle);
    color: var(--color-accent-dark);
  }

  .plan-type-trial {
    background: #e0f2fe;
    color: #0369a1;
  }

  .plan-type-monitor {
    background: #fef3c7;
    color: #92400e;
  }

  .plan-type-campaign {
    background: #fce7f3;
    color: #9f1239;
  }

  .text-muted {
    color: var(--color-text-muted);
  }

  /* Responsive */
  @media (max-width: 1024px) {
    .filter-grid {
      grid-template-columns: 1fr 1fr;
    }
    .filter-search {
      grid-column: span 2;
    }
  }

  @media (max-width: 768px) {
    .filter-grid {
      grid-template-columns: 1fr;
    }
    .filter-search {
      grid-column: span 1;
    }
  }

  @media (max-width: 768px) {
    .table-container {
      overflow-x: auto;
    }

    .table {
      min-width: 800px;
    }
  }
</style>

<script type="module">
  import type {
    CategorySummary,
    SubcategorySummary,
    MedicationPlan,
    PricePlan,
    CategoriesResponse,
    SubcategoriesResponse,
    PricingResponse,
    MedicationPlansResponse
  } from '../../types/api';

  type FetchResult<T> =
    | { ok: true; data: T }
    | { ok: false; error: string };

  const planTypeLabels: Record<string, string> = {
    'single': 'å˜ç™º',
    'course': 'ã‚³ãƒ¼ã‚¹',
    'trial': 'ãŠè©¦ã—',
    'monitor': 'ãƒ¢ãƒ‹ã‚¿ãƒ¼',
    'campaign': 'ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³'
  };

  let plans: PricePlan[] = [];
  let medicationPlans: MedicationPlan[] = [];
  let categories: CategorySummary[] = [];
  let subcategories: SubcategorySummary[] = [];
  let searchQuery = '';
  let selectedCategoryId = '';
  let selectedSubcategoryId = '';
  let searchTimeout: number | null = null;
  let isLoading = false;

  async function fetchJson<T>(input: string, init?: RequestInit): Promise<FetchResult<T>> {
    try {
      const res = await fetch(input, init);
      const text = await res.text();
      const data = text ? JSON.parse(text) : null;
      if (!res.ok) {
        const message = data?.message || data?.error || `HTTP ${res.status}: ${res.statusText}`;
        return { ok: false, error: message };
      }
      if (data?.error) {
        return { ok: false, error: data.message || data.error };
      }
      return { ok: true, data };
    } catch (error) {
      return { ok: false, error: error instanceof Error ? error.message : 'Unknown error' };
    }
  }

  function setLoading(loading: boolean) {
    isLoading = loading;
    if (loading) {
      showLoading();
    }
  }

  function showLoading() {
    const tbody = document.getElementById('priceTableBody');
    if (!tbody) return;
    tbody.innerHTML = `
      <tr>
        <td colspan="11">
          <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
        </td>
      </tr>
    `;
  }

  function renderCategoryOptions() {
    const categoryFilter = document.getElementById('categoryFilter') as HTMLSelectElement;
    if (!categoryFilter) return;
    categoryFilter.innerHTML = '<option value="">ã™ã¹ã¦ã®ã‚«ãƒ†ã‚´ãƒª</option>' +
      categories.map(cat => `<option value="${cat.id}">${escapeHtml(cat.name)}</option>`).join('');
  }

  function renderSubcategoryOptions() {
    const subcategoryFilter = document.getElementById('subcategoryFilter') as HTMLSelectElement;
    if (!subcategoryFilter) return;
    subcategoryFilter.innerHTML = '<option value="">ã™ã¹ã¦ã®ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒª</option>' +
      subcategories.map(sub => `<option value="${sub.id}">${escapeHtml(sub.category_name)} - ${escapeHtml(sub.name)}</option>`).join('');
  }

  async function loadCategories() {
    const result = await fetchJson<CategoriesResponse>('/api/categories');
    if (!result.ok) {
      categories = [];
      renderCategoryOptions();
      showError(`ã‚«ãƒ†ã‚´ãƒªã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${result.error}`);
      return;
    }
    categories = result.data.categories || [];
    renderCategoryOptions();
  }

  async function loadSubcategories(categoryId?: string) {
    const targetCategoryId = categoryId || selectedCategoryId;
    const params = new URLSearchParams();
    if (targetCategoryId && targetCategoryId !== '') {
      params.append('category_id', targetCategoryId);
    }
    const result = await fetchJson<SubcategoriesResponse>(
      `/api/subcategories?${params.toString()}`
    );
    if (!result.ok) {
      subcategories = [];
      renderSubcategoryOptions();
      showError(`ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${result.error}`);
      return;
    }
    subcategories = result.data.subcategories || [];
    renderSubcategoryOptions();
  }

  async function fetchPricing(): Promise<FetchResult<PricePlan[]>> {
    const params = new URLSearchParams();
    if (selectedCategoryId && selectedCategoryId !== '') {
      params.append('category_id', selectedCategoryId);
    }
    if (selectedSubcategoryId && selectedSubcategoryId !== '') {
      params.append('subcategory_id', selectedSubcategoryId);
    }
    if (searchQuery && searchQuery.trim() !== '') {
      params.append('search', searchQuery.trim());
    }
    const result = await fetchJson<PricingResponse>(`/api/pricing?${params.toString()}`);
    if (!result.ok) {
      return { ok: false, error: result.error };
    }
    return { ok: true, data: result.data.plans || [] };
  }

  async function fetchMedicationPlans(): Promise<FetchResult<MedicationPlan[]>> {
    const params = new URLSearchParams();
    if (searchQuery && searchQuery.trim() !== '') {
      params.append('search', searchQuery.trim());
    }
    const result = await fetchJson<MedicationPlansResponse>(`/api/medication-plans?${params.toString()}`);
    if (!result.ok) {
      return { ok: false, error: result.error };
    }
    return { ok: true, data: result.data.plans || [] };
  }

  async function refreshData() {
    const [pricingResult, medicationResult] = await Promise.all([
      fetchPricing(),
      fetchMedicationPlans()
    ]);

    const errors: string[] = [];

    if (pricingResult.ok) {
      plans = pricingResult.data;
    } else {
      plans = [];
      errors.push(`æ–™é‡‘ãƒ‡ãƒ¼ã‚¿: ${pricingResult.error}`);
    }

    if (medicationResult.ok) {
      medicationPlans = medicationResult.data;
    } else {
      medicationPlans = [];
      errors.push(`è–¬å‰¤æ–™é‡‘: ${medicationResult.error}`);
    }

    renderTable();

    if (errors.length > 0 && plans.length === 0 && medicationPlans.length === 0) {
      showError(`ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${errors.join(' / ')}`);
    }
  }

  function clearFilters() {
    const searchInput = document.getElementById('searchInput') as HTMLInputElement;
    const categoryFilter = document.getElementById('categoryFilter') as HTMLSelectElement;
    const subcategoryFilter = document.getElementById('subcategoryFilter') as HTMLSelectElement;
    
    if (searchInput) searchInput.value = '';
    if (categoryFilter) categoryFilter.value = '';
    if (subcategoryFilter) subcategoryFilter.innerHTML = '<option value="">ã™ã¹ã¦ã®ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒª</option>';
    
    searchQuery = '';
    selectedCategoryId = '';
    selectedSubcategoryId = '';
    subcategories = [];
    
    setLoading(true);
    loadSubcategories()
      .then(refreshData)
      .finally(() => setLoading(false));
  }

  function renderTable() {
    const tbody = document.getElementById('priceTableBody');
    if (!tbody) return;

    if (plans.length === 0 && medicationPlans.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="11">
            <div class="empty-state">
              <div class="empty-state-icon">ğŸ“‹</div>
              <div class="empty-state-title">ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div>
              <div class="empty-state-desc">æ¤œç´¢æ¡ä»¶ã‚’å¤‰æ›´ã—ã¦ãã ã•ã„</div>
            </div>
          </td>
        </tr>
      `;
      return;
    }

    // ã‚«ãƒ†ã‚´ãƒªã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
    const groupedPlans = plans.reduce((acc, plan) => {
      const categoryId = plan.category_id;
      if (!acc[categoryId]) {
        acc[categoryId] = {
          categoryName: plan.category_name,
          plans: []
        };
      }
      acc[categoryId].plans.push(plan);
      return acc;
    }, {} as Record<string, { categoryName: string; plans: PricePlan[] }>);

    // ã‚«ãƒ†ã‚´ãƒªã”ã¨ã«ãƒ†ãƒ¼ãƒ–ãƒ«è¡Œã‚’ç”Ÿæˆ
    let html = '';
    
    // è–¬å‰¤æ–™é‡‘ã‚’å…ˆã«è¡¨ç¤º
    if (medicationPlans.length > 0) {
      medicationPlans.forEach((mp) => {
        html += `
          <tr class="medication-row">
            <td>
              <div class="category-info">
                <span class="category-name">è–¬å‰¤æ–™é‡‘</span>
              </div>
            </td>
            <td>
              <div class="treatment-info">
                <span class="subcategory-name">-</span>
              </div>
            </td>
            <td>
              <div class="treatment-info">
                <span class="treatment-name">${escapeHtml(mp.medication_name)}</span>
              </div>
            </td>
            <td>
              <span class="plan-name">${escapeHtml(mp.quantity)}${(() => {
                // quantityã«æ—¢ã«å˜ä½ï¼ˆccã€mgã€mlã€å˜ä½ï¼‰ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã¯å˜ä½ã‚’è¿½åŠ ã—ãªã„
                if (!mp.quantity) return '';
                const hasUnit = /(cc|mg|ml|å˜ä½)/.test(mp.quantity);
                return hasUnit ? '' : (mp.medication_unit || 'cc');
              })()}</span>
            </td>
            <td class="text-center">
              <span class="plan-type-badge plan-type-single">è–¬å‰¤</span>
            </td>
            <td class="text-center">
              ${mp.sessions ? `<span>${mp.sessions}å›</span>` : '<span class="text-muted">-</span>'}
            </td>
            <td class="text-right">
              <span class="price-regular">Â¥${mp.price.toLocaleString()}</span>
            </td>
            <td class="text-right">
              <span class="price-regular">Â¥${mp.price_taxed.toLocaleString()}</span>
            </td>
            <td class="text-right">
              <span class="text-muted">-</span>
            </td>
            <td class="text-right">
              <span class="text-muted">-</span>
            </td>
            <td>
              <div class="action-buttons">
                <span class="text-muted">-</span>
              </div>
            </td>
          </tr>
        `;
      });
    }
    
    // é€šå¸¸ã®æ–™é‡‘ãƒ—ãƒ©ãƒ³ã‚’è¡¨ç¤º
    Object.keys(groupedPlans).forEach((categoryId) => {
      const group = groupedPlans[categoryId];
      
      group.plans.forEach((plan, planIndex) => {
        const isFirstInCategory = planIndex === 0;
        const rowspan = group.plans.length;
        
        html += '<tr>';
        
        // ã‚«ãƒ†ã‚´ãƒªåï¼ˆæœ€åˆã®è¡Œã®ã¿ã€rowspanã§çµåˆï¼‰
        if (isFirstInCategory) {
          html += `<td rowspan="${rowspan}" class="category-cell">
            <div class="category-info">
              <span class="category-name">${escapeHtml(group.categoryName)}</span>
            </div>
          </td>`;
        }
        
        // ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªï¼ˆæ²»ç™‚æ³•ã‚°ãƒ«ãƒ¼ãƒ—ï¼‰
        html += `
          <td>
            <div class="treatment-info">
              <span class="subcategory-name">${escapeHtml(plan.subcategory_name)}</span>
            </div>
          </td>
          <td>
            <div class="treatment-info">
              <span class="treatment-name">${escapeHtml(plan.treatment_name || '')}</span>
            </div>
          </td>
          <td>
            <span class="plan-name">${escapeHtml(plan.plan_name)}</span>
          </td>
          <td class="text-center">
            <span class="plan-type-badge plan-type-${plan.plan_type}">${planTypeLabels[plan.plan_type] || plan.plan_type}</span>
          </td>
          <td class="text-center">
            ${plan.sessions ? `<span>${plan.sessions}å›</span>` : '<span class="text-muted">-</span>'}
          </td>
          <td class="text-right">
            <span class="price-regular">Â¥${plan.price.toLocaleString()}</span>
          </td>
          <td class="text-right">
            <span class="price-regular">Â¥${plan.price_taxed.toLocaleString()}</span>
          </td>
          <td class="text-right">
            ${plan.cost_rate !== null && plan.cost_rate !== undefined ? `<span>${typeof plan.cost_rate === 'number' ? plan.cost_rate.toFixed(1) : plan.cost_rate}%</span>` : '<span class="text-muted">-</span>'}
          </td>
          <td class="text-right">
            ${plan.total_cost !== null && plan.total_cost !== undefined ? `<span>Â¥${plan.total_cost.toLocaleString()}</span>` : '<span class="text-muted">-</span>'}
          </td>
          <td>
            <div class="action-buttons">
              <a href="/pricing/${plan.id}/edit" class="action-btn action-btn-edit">ç·¨é›†</a>
              <button onclick="deletePlan('${plan.id}')" class="action-btn action-btn-delete">å‰Šé™¤</button>
            </div>
          </td>
        </tr>`;
      });
    });

    tbody.innerHTML = html;
  }

  function escapeHtml(text: string): string {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function showError(message: string) {
    const tbody = document.getElementById('priceTableBody');
    if (tbody) {
      tbody.innerHTML = `
        <tr>
          <td colspan="11">
            <div class="empty-state" style="color: var(--color-error)">
              <div class="empty-state-icon">âš ï¸</div>
              <div class="empty-state-title">${escapeHtml(message)}</div>
            </div>
          </td>
        </tr>
      `;
    }
  }

  async function deletePlan(id: string) {
    if (!confirm('ã“ã®ãƒ—ãƒ©ãƒ³ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
    
    try {
      const res = await fetch(`/api/pricing-id/${id}`, { method: 'DELETE' });
      if (res.ok) {
        await loadPricing();
      } else {
        alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    } catch (error) {
      console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
      alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    setLoading(true);
    loadCategories()
      .then(() => loadSubcategories())
      .then(() => refreshData())
      .finally(() => setLoading(false));

    const searchInput = document.getElementById('searchInput') as HTMLInputElement;
    const categoryFilter = document.getElementById('categoryFilter') as HTMLSelectElement;
    const subcategoryFilter = document.getElementById('subcategoryFilter') as HTMLSelectElement;
    const clearButton = document.getElementById('clearBtn') as HTMLButtonElement;

    // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¤œç´¢ï¼ˆå…¥åŠ›ä¸­ã«æ¤œç´¢ï¼‰
    searchInput?.addEventListener('input', (e) => {
      const value = (e.target as HTMLInputElement).value;
      searchQuery = value;
      
      // ãƒ‡ãƒã‚¦ãƒ³ã‚¹å‡¦ç†ï¼ˆ500mså¾Œã«æ¤œç´¢å®Ÿè¡Œï¼‰
      if (searchTimeout !== null) {
        clearTimeout(searchTimeout);
      }
      searchTimeout = window.setTimeout(() => {
        setLoading(true);
        refreshData().finally(() => setLoading(false));
      }, 500);
    });

    searchInput?.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        if (searchTimeout !== null) {
          clearTimeout(searchTimeout);
        }
        searchQuery = searchInput.value;
        setLoading(true);
        refreshData().finally(() => setLoading(false));
      }
    });

    categoryFilter?.addEventListener('change', (e) => {
      const value = (e.target as HTMLSelectElement).value;
      selectedCategoryId = value;
      selectedSubcategoryId = ''; // ã‚«ãƒ†ã‚´ãƒªå¤‰æ›´æ™‚ã¯ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªã‚’ãƒªã‚»ãƒƒãƒˆ
      if (subcategoryFilter) {
        subcategoryFilter.value = '';
        subcategoryFilter.innerHTML = '<option value="">ã™ã¹ã¦ã®ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒª</option>';
      }
      setLoading(true);
      loadSubcategories(selectedCategoryId)
        .then(() => refreshData())
        .finally(() => setLoading(false));
    });

    subcategoryFilter?.addEventListener('change', () => {
      selectedSubcategoryId = subcategoryFilter.value;
      setLoading(true);
      refreshData().finally(() => setLoading(false));
    });

    clearButton?.addEventListener('click', () => {
      clearFilters();
    });
  });

  (window as any).deletePlan = deletePlan;
</script>
