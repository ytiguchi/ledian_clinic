---
import Layout from '../../components/Layout.astro';
import { getTaxRate } from '../../lib/pricing';

const taxRate = getTaxRate(Astro.locals.runtime);
---

<Layout>
  <div class="pricing-page">
    <!-- Page Header -->
    <div class="page-header">
      <div>
        <h1 class="page-title">æ–™é‡‘ç®¡ç†</h1>
        <p class="page-subtitle">æ–½è¡“ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®æ–™é‡‘ã‚’ç®¡ç†ã—ã¾ã™</p>
      </div>
      <a href="/pricing/new" class="btn btn-primary">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        æ–°è¦ãƒ—ãƒ©ãƒ³è¿½åŠ 
      </a>
    </div>

    <!-- Filter Bar -->
    <div class="filter-bar">
      <div class="filter-grid">
        <div class="filter-item filter-search">
          <label class="label">æ¤œç´¢</label>
          <input
            type="text"
            placeholder="æ–½è¡“åãƒ»ãƒ—ãƒ©ãƒ³åãƒ»ã‚«ãƒ†ã‚´ãƒªã§æ¤œç´¢..."
            class="input"
            id="searchInput"
          />
        </div>
        <div class="filter-item">
          <label class="label">ã‚«ãƒ†ã‚´ãƒª</label>
          <select class="select" id="categoryFilter">
            <option value="">ã™ã¹ã¦ã®ã‚«ãƒ†ã‚´ãƒª</option>
          </select>
        </div>
        <div class="filter-item">
          <label class="label">ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒª</label>
          <select class="select" id="subcategoryFilter">
            <option value="">ã™ã¹ã¦ã®ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒª</option>
          </select>
        </div>
        <div class="filter-item filter-actions">
          <button class="btn btn-secondary" id="clearBtn" title="æ¤œç´¢æ¡ä»¶ã‚’ã‚¯ãƒªã‚¢">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
            ã‚¯ãƒªã‚¢
          </button>
        </div>
      </div>
    </div>

    <!-- Price Table -->
    <div class="table-container">
      <table class="table">
        <thead>
          <tr>
            <th>ã‚«ãƒ†ã‚´ãƒª</th>
            <th>ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒª</th>
            <th>æ–½è¡“</th>
            <th>ãƒ—ãƒ©ãƒ³å</th>
            <th>ç¨®åˆ¥</th>
            <th class="text-center">å›æ•°</th>
            <th class="text-right">ç¨æŠœä¾¡æ ¼</th>
            <th class="text-right">ç¨è¾¼ä¾¡æ ¼</th>
            <th class="text-right">åŸä¾¡ç‡</th>
            <th class="text-right">åŸä¾¡åˆè¨ˆ</th>
            <th>å‚™è€ƒ</th>
            <th class="text-center">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="priceTableBody">
          <tr>
            <td colspan="12">
              <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div id="pagination" class="pagination hidden">
      <div class="pagination-info">
        <span id="paginationText"></span>
        <select id="itemsPerPageSelect" class="select select-sm">
          <option value="25">25ä»¶/ãƒšãƒ¼ã‚¸</option>
          <option value="50" selected>50ä»¶/ãƒšãƒ¼ã‚¸</option>
          <option value="100">100ä»¶/ãƒšãƒ¼ã‚¸</option>
          <option value="200">200ä»¶/ãƒšãƒ¼ã‚¸</option>
        </select>
      </div>
      <div class="pagination-controls">
        <button id="paginationPrev" class="btn btn-sm btn-secondary" disabled>å‰ã¸</button>
        <div id="paginationNumbers" class="pagination-numbers"></div>
        <button id="paginationNext" class="btn btn-sm btn-secondary" disabled>æ¬¡ã¸</button>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div id="editModal" class="modal hidden">
    <div class="modal-backdrop" onclick="closeEditModal()"></div>
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">æ–™é‡‘ãƒ—ãƒ©ãƒ³ç·¨é›†</h2>
        <button onclick="closeEditModal()" class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <form id="editPlanForm">
          <input type="hidden" id="editPlanId" />
          <div id="editFormError" class="hidden form-error"></div>
          
          <!-- åŸºæœ¬æƒ…å ± -->
          <div class="form-section">
            <h3 class="form-section-title">åŸºæœ¬æƒ…å ±</h3>
            <div class="form-grid">
              <div class="form-group">
                <label class="form-label">æ–½è¡“ *</label>
                <select id="editTreatmentId" class="select" required>
                  <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">ãƒ—ãƒ©ãƒ³å *</label>
                <input type="text" id="editPlanName" class="input" required />
              </div>
              <div class="form-group">
                <label class="form-label">ãƒ—ãƒ©ãƒ³ç¨®åˆ¥ *</label>
                <select id="editPlanType" class="select" required>
                  <option value="single">å˜ç™º</option>
                  <option value="course">ã‚³ãƒ¼ã‚¹</option>
                  <option value="trial">ãŠè©¦ã—</option>
                  <option value="monitor">ãƒ¢ãƒ‹ã‚¿ãƒ¼</option>
                  <option value="campaign">ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">å›æ•°</label>
                <input type="number" id="editSessions" class="input" />
              </div>
            </div>
          </div>

          <!-- ä¾¡æ ¼æƒ…å ± -->
          <div class="form-section">
            <h3 class="form-section-title">ä¾¡æ ¼æƒ…å ±</h3>
            <div class="form-grid">
              <div class="form-group">
                <label class="form-label">ç¨æŠœä¾¡æ ¼ï¼ˆå††ï¼‰ *</label>
                <input type="number" id="editPrice" class="input" required />
              </div>
              <div class="form-group">
                <label class="form-label">ç¨è¾¼ä¾¡æ ¼ï¼ˆå††ï¼‰ *</label>
                <input type="number" id="editPriceTaxed" class="input" required />
              </div>
            </div>
          </div>

          <!-- åŸä¾¡æƒ…å ± -->
          <div class="form-section">
            <h3 class="form-section-title">åŸä¾¡æƒ…å ±</h3>
            <div class="form-grid">
              <div class="form-group">
                <label class="form-label">åŸä¾¡ç‡ï¼ˆ%ï¼‰</label>
                <input type="number" id="editCostRate" class="input" step="0.1" />
              </div>
              <div class="form-group">
                <label class="form-label">å‚™å“åŸä¾¡ï¼ˆå††ï¼‰</label>
                <input type="number" id="editSupplyCost" class="input" />
              </div>
              <div class="form-group">
                <label class="form-label">äººä»¶è²»ï¼ˆå††ï¼‰</label>
                <input type="number" id="editStaffCost" class="input" />
              </div>
              <div class="form-group">
                <label class="form-label">åŸä¾¡åˆè¨ˆï¼ˆå††ï¼‰</label>
                <input type="number" id="editTotalCost" class="input" />
              </div>
            </div>
          </div>

          <!-- å‚™è€ƒ -->
          <div class="form-section">
            <h3 class="form-section-title">å‚™è€ƒ</h3>
            <div class="form-group">
              <textarea id="editNotes" class="textarea" rows="3"></textarea>
            </div>
          </div>

          <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
          <div class="form-actions">
            <button type="button" onclick="closeEditModal()" class="btn btn-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button type="submit" class="btn btn-primary">æ›´æ–°</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</Layout>

<style>
  .pricing-page {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  /* Filter Grid */
  .filter-grid {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr auto;
    gap: 1rem;
    align-items: end;
  }

  .filter-search {
    grid-column: span 1;
  }

  .filter-item {
    display: flex;
    flex-direction: column;
    gap: 0.375rem;
  }

  .filter-actions {
    justify-content: flex-end;
  }

  /* Table Styles */
  .table-container {
    animation: fadeIn 0.3s ease-out;
  }

  .text-right {
    text-align: right;
  }

  .text-center {
    text-align: center;
  }

  /* Price Cell */
  .price-regular {
    font-weight: 600;
    color: var(--color-text);
  }

  .price-campaign {
    font-weight: 700;
    color: var(--color-accent);
  }

  .price-none {
    color: var(--color-text-muted);
  }

  /* Action Buttons */
  .action-buttons {
    display: flex;
    gap: 0.5rem;
    justify-content: center;
  }

  .action-btn {
    padding: 0.375rem 0.75rem;
    font-size: 0.8125rem;
    font-weight: 500;
    border-radius: var(--radius-md);
    text-decoration: none;
    transition: all var(--transition-fast);
    cursor: pointer;
    border: none;
  }

  .action-btn-edit {
    background: var(--color-accent-subtle);
    color: var(--color-accent-dark);
  }

  .action-btn-edit:hover {
    background: var(--color-accent);
    color: var(--color-primary);
  }

  .action-btn-delete {
    background: var(--color-error-light);
    color: #b91c1c;
  }

  .action-btn-delete:hover {
    background: var(--color-error);
    color: white;
  }

  /* Notes Cell */
  .notes-cell {
    max-width: 150px;
    overflow: hidden;
  }

  .notes-text {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
    font-size: 0.75rem;
    color: var(--color-text-muted);
    cursor: help;
  }

  /* Plan Info */
  .plan-name {
    font-weight: 500;
    color: var(--color-text);
  }

  /* Category Info */
  .category-cell {
    background: var(--color-bg-subtle);
    border-right: 2px solid var(--color-border);
    vertical-align: top;
  }

  .category-info {
    padding: 0.5rem 0;
  }

  .category-name {
    font-weight: 600;
    color: var(--color-text);
    font-size: 0.9375rem;
  }

  .treatment-info {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .subcategory-name {
    font-size: 0.75rem;
    color: var(--color-text-muted);
    font-weight: 500;
  }

  .treatment-name {
    font-weight: 500;
    color: var(--color-text);
  }

  /* Plan Type Badge */
  .plan-type-badge {
    display: inline-block;
    padding: 0.25rem 0.625rem;
    border-radius: var(--radius-sm);
    font-size: 0.75rem;
    font-weight: 600;
  }

  .plan-type-single {
    background: var(--color-primary-subtle);
    color: var(--color-primary-dark);
  }

  .plan-type-course {
    background: var(--color-accent-subtle);
    color: var(--color-accent-dark);
  }

  .plan-type-trial {
    background: #e0f2fe;
    color: #0369a1;
  }

  .plan-type-monitor {
    background: #fef3c7;
    color: #92400e;
  }

  .plan-type-campaign {
    background: #fce7f3;
    color: #9f1239;
  }

  .text-muted {
    color: var(--color-text-muted);
  }

  .form-error {
    padding: 0.75rem 1rem;
    border: 1px solid #fecaca;
    border-radius: var(--radius-md);
    background: #fef2f2;
    color: #b91c1c;
    font-size: 0.95rem;
  }

  .form-error ul {
    margin: 0.5rem 0 0;
    padding-left: 1.25rem;
  }

  /* Responsive */
  @media (max-width: 1024px) {
    .filter-grid {
      grid-template-columns: 1fr 1fr;
    }
    .filter-search {
      grid-column: span 2;
    }
  }

  @media (max-width: 768px) {
    .filter-grid {
      grid-template-columns: 1fr;
    }
    .filter-search {
      grid-column: span 1;
    }
  }

  @media (max-width: 768px) {
    .table-container {
      overflow-x: auto;
    }

    .table {
      min-width: 800px;
    }
  }

  /* Modal Styles */
  .modal {
    position: fixed;
    inset: 0;
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem;
  }

  .modal.hidden {
    display: none;
  }

  .modal-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
  }

  .modal-content {
    position: relative;
    width: 100%;
    max-width: 600px;
    max-height: 90vh;
    background: var(--color-bg-card);
    border-radius: var(--radius-lg);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--color-border-light);
    background: var(--color-bg-secondary);
  }

  .modal-title {
    font-size: 1.125rem;
    font-weight: 700;
    margin: 0;
  }

  .modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--color-text-muted);
    padding: 0.25rem;
    line-height: 1;
  }

  .modal-close:hover {
    color: var(--color-text);
  }

  .modal-body {
    padding: 1.5rem;
    overflow-y: auto;
    flex: 1;
  }

  .form-section {
    margin-bottom: 1.5rem;
  }

  .form-section-title {
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: 0.75rem;
    color: var(--color-text);
  }

  .form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .form-label {
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--color-text-muted);
  }

  .form-actions {
    display: flex;
    justify-content: flex-end;
    gap: 0.75rem;
    padding-top: 1rem;
    border-top: 1px solid var(--color-border-light);
    margin-top: 1rem;
  }

  .textarea {
    min-height: 80px;
    resize: vertical;
  }
</style>

<script define:vars={{ taxRate }}>
  const toTaxedPrice = (amount) => Math.round(amount * (1 + taxRate));

  const planTypeLabels = {
    'single': 'å˜ç™º',
    'course': 'ã‚³ãƒ¼ã‚¹',
    'trial': 'ãŠè©¦ã—',
    'monitor': 'ãƒ¢ãƒ‹ã‚¿ãƒ¼',
    'campaign': 'ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³'
  };

  let plans = [];
  let medicationPlans = [];
  let categories = [];
  let subcategories = [];
  let treatments = [];
  let searchQuery = '';
  let selectedCategoryId = '';
  let selectedSubcategoryId = '';
  let searchTimeout = null;
  let isLoading = false;
  
  // Pagination
  let currentPage = 1;
  let itemsPerPage = 50;
  let totalItems = 0;

  async function fetchJson(input, init) {
    try {
      const res = await fetch(input, init);
      const text = await res.text();
      const data = text ? JSON.parse(text) : null;
      if (!res.ok) {
        const message = (data && data.message) || (data && data.error) || `HTTP ${res.status}: ${res.statusText}`;
        return { ok: false, error: message };
      }
      if (data && data.error) {
        return { ok: false, error: data.message || data.error };
      }
      return { ok: true, data: data };
    } catch (error) {
      return { ok: false, error: error instanceof Error ? error.message : 'Unknown error' };
    }
  }

  function setLoading(loading) {
    isLoading = loading;
    if (loading) {
      showLoading();
    }
  }

  function showLoading() {
    const tbody = document.getElementById('priceTableBody');
    if (!tbody) return;
    tbody.innerHTML = `
      <tr>
        <td colspan="12">
          <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
        </td>
      </tr>
    `;
  }

  function renderCategoryOptions() {
    const categoryFilter = document.getElementById('categoryFilter');
    if (!categoryFilter) return;
    categoryFilter.innerHTML = '<option value="">ã™ã¹ã¦ã®ã‚«ãƒ†ã‚´ãƒª</option>' +
      categories.map(cat => `<option value="${cat.id}">${escapeHtml(cat.name)}</option>`).join('');
  }

  function renderSubcategoryOptions() {
    const subcategoryFilter = document.getElementById('subcategoryFilter');
    if (!subcategoryFilter) return;
    subcategoryFilter.innerHTML = '<option value="">ã™ã¹ã¦ã®ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒª</option>' +
      subcategories.map(sub => `<option value="${sub.id}">${escapeHtml(sub.category_name)} - ${escapeHtml(sub.name)}</option>`).join('');
  }

  function renderTreatmentOptions(selectedId = '') {
    const treatmentSelect = document.getElementById('editTreatmentId');
    if (!treatmentSelect) return;
    treatmentSelect.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>' +
      treatments.map(treatment => {
        const label = `${treatment.category_name} - ${treatment.subcategory_name} - ${treatment.name}`;
        const selected = treatment.id === selectedId ? 'selected' : '';
        return `<option value="${treatment.id}" ${selected}>${escapeHtml(label)}</option>`;
      }).join('');
  }

  async function loadCategories() {
    const result = await fetchJson<CategoriesResponse>('/api/categories');
    if (!result.ok) {
      categories = [];
      renderCategoryOptions();
      showError(`ã‚«ãƒ†ã‚´ãƒªã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${result.error}`);
      return;
    }
    categories = (result.data && result.data.categories) || [];
    renderCategoryOptions();
  }

  async function loadSubcategories(categoryId) {
    const targetCategoryId = categoryId || selectedCategoryId;
    const params = new URLSearchParams();
    if (targetCategoryId && targetCategoryId !== '') {
      params.append('category_id', targetCategoryId);
    }
    const result = await fetchJson<SubcategoriesResponse>(
      `/api/subcategories?${params.toString()}`
    );
    if (!result.ok) {
      subcategories = [];
      renderSubcategoryOptions();
      showError(`ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${result.error}`);
      return;
    }
    subcategories = (result.data && result.data.subcategories) || [];
    renderSubcategoryOptions();
  }

  async function loadTreatments() {
    const result = await fetchJson<{ treatments: any[] }>('/api/treatments');
    if (!result.ok) {
      treatments = [];
      renderTreatmentOptions();
      showError(`æ–½è¡“ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${result.error}`);
      return;
    }
    treatments = (result.data && result.data.treatments) || [];
    renderTreatmentOptions();
  }

  async function fetchPricing() {
    const params = new URLSearchParams();
    if (selectedCategoryId && selectedCategoryId !== '') {
      params.append('category_id', selectedCategoryId);
    }
    if (selectedSubcategoryId && selectedSubcategoryId !== '') {
      params.append('subcategory_id', selectedSubcategoryId);
    }
    if (searchQuery && searchQuery.trim() !== '') {
      params.append('search', searchQuery.trim());
    }
    const result = await fetchJson<PricingResponse>(`/api/pricing?${params.toString()}`);
    if (!result.ok) {
      return { ok: false, error: result.error };
    }
    return { ok: true, data: (result.data && result.data.plans) || [] };
  }

  async function fetchMedicationPlans() {
    const params = new URLSearchParams();
    if (searchQuery && searchQuery.trim() !== '') {
      params.append('search', searchQuery.trim());
    }
    const result = await fetchJson<MedicationPlansResponse>(`/api/medication-plans?${params.toString()}`);
    if (!result.ok) {
      return { ok: false, error: result.error };
    }
    return { ok: true, data: (result.data && result.data.plans) || [] };
  }

  async function refreshData() {
    console.log('Starting refreshData...');
    try {
      const [pricingResult, medicationResult] = await Promise.all([
        fetchPricing(),
        fetchMedicationPlans()
      ]);

      console.log('Results received:', { 
        pricing: pricingResult.ok ? `${pricingResult.data.length} plans` : pricingResult.error,
        medication: medicationResult.ok ? `${medicationResult.data.length} plans` : medicationResult.error
      });

      const errors = [];

      if (pricingResult.ok) {
        plans = pricingResult.data || [];
      } else {
        plans = [];
        errors.push(`æ–™é‡‘ãƒ‡ãƒ¼ã‚¿: ${pricingResult.error}`);
      }

      if (medicationResult.ok) {
        medicationPlans = medicationResult.data || [];
      } else {
        medicationPlans = [];
        errors.push(`è–¬å‰¤æ–™é‡‘: ${medicationResult.error}`);
      }

      totalItems = plans.length + medicationPlans.length;
      currentPage = Math.min(currentPage, Math.max(1, Math.ceil(totalItems / itemsPerPage)));

      renderTable();
      renderPagination();

      if (errors.length > 0 && plans.length === 0 && medicationPlans.length === 0) {
        showError(`ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${errors.join(' / ')}`);
      }
    } catch (error) {
      console.error('Error in refreshData:', error);
      showError(`ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error instanceof Error ? error.message : 'Unknown error'}`);
    }
  }

  function clearFilters() {
    const searchInput = document.getElementById('searchInput');
    const categoryFilter = document.getElementById('categoryFilter');
    const subcategoryFilter = document.getElementById('subcategoryFilter');
    
    if (searchInput) searchInput.value = '';
    if (categoryFilter) categoryFilter.value = '';
    if (subcategoryFilter) subcategoryFilter.innerHTML = '<option value="">ã™ã¹ã¦ã®ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒª</option>';
    
    searchQuery = '';
    selectedCategoryId = '';
    selectedSubcategoryId = '';
    subcategories = [];
    
    setLoading(true);
    loadSubcategories()
      .then(refreshData)
      .finally(() => setLoading(false));
  }

  function getPaginatedItems() {
    const allItems = [...medicationPlans, ...plans];
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    return {
      items: allItems.slice(startIndex, endIndex),
      startIndex
    };
  }

  function renderTable() {
    console.log('Starting renderTable...', { plansCount: plans.length, medicationPlansCount: medicationPlans.length });
    try {
      const tbody = document.getElementById('priceTableBody');
      if (!tbody) {
        console.error('priceTableBody element not found');
        return;
      }

      if (plans.length === 0 && medicationPlans.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="12">
              <div class="empty-state">
                <div class="empty-state-icon">ğŸ“‹</div>
                <div class="empty-state-title">ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div>
                <div class="empty-state-desc">æ¤œç´¢æ¡ä»¶ã‚’å¤‰æ›´ã—ã¦ãã ã•ã„</div>
              </div>
            </td>
          </tr>
        `;
        return;
      }

      const { items: paginatedItems, startIndex } = getPaginatedItems();
      console.log(`Rendering ${paginatedItems.length} items for page ${currentPage}`);

      // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³è¡¨ç¤ºç”¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†é›¢
      const paginatedMedicationPlans = [];
      const paginatedPlans = [];
      
      paginatedItems.forEach((item) => {
        if (item && item.medication_name) {
          paginatedMedicationPlans.push(item);
        } else if (item) {
          paginatedPlans.push(item);
        }
      });

      // ã‚«ãƒ†ã‚´ãƒªã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
      const groupedPlans = paginatedPlans.reduce((acc, plan) => {
        if (!plan) return acc;
        const categoryId = plan.category_id || 'unknown';
        if (!acc[categoryId]) {
          acc[categoryId] = {
            categoryName: plan.category_name || 'æœªåˆ†é¡',
            plans: []
          };
        }
        acc[categoryId].plans.push(plan);
        return acc;
      }, {});

      // ã‚«ãƒ†ã‚´ãƒªã”ã¨ã«ãƒ†ãƒ¼ãƒ–ãƒ«è¡Œã‚’ç”Ÿæˆ
      let html = '';
      
      // è–¬å‰¤æ–™é‡‘ã‚’å…ˆã«è¡¨ç¤º
      if (paginatedMedicationPlans.length > 0) {
        paginatedMedicationPlans.forEach((mp) => {
          html += `
            <tr class="medication-row">
              <td>
                <div class="category-info">
                  <span class="category-name">è–¬å‰¤æ–™é‡‘</span>
                </div>
              </td>
              <td>
                <div class="treatment-info">
                  <span class="subcategory-name">-</span>
                </div>
              </td>
              <td>
                <div class="treatment-info">
                  <span class="treatment-name">${escapeHtml(mp.medication_name || '')}</span>
                </div>
              </td>
              <td>
                <span class="plan-name">${escapeHtml(mp.quantity || '')}${(() => {
                  if (!mp.quantity) return '';
                  const hasUnit = /(cc|mg|ml|å˜ä½)/.test(mp.quantity);
                  return hasUnit ? '' : (mp.medication_unit || 'cc');
                })()}</span>
              </td>
              <td class="text-center">
                <span class="plan-type-badge plan-type-single">è–¬å‰¤</span>
              </td>
              <td class="text-center">
                ${mp.sessions ? `<span>${mp.sessions}å›</span>` : '<span class="text-muted">-</span>'}
              </td>
              <td class="text-right">
                <span class="price-regular">Â¥${(mp.price || 0).toLocaleString()}</span>
              </td>
              <td class="text-right">
                <span class="price-regular">Â¥${(mp.price_taxed || 0).toLocaleString()}</span>
              </td>
              <td class="text-right">
                <span class="text-muted">-</span>
              </td>
              <td class="text-right">
                <span class="text-muted">-</span>
              </td>
              <td class="notes-cell">
                <span class="text-muted">-</span>
              </td>
              <td>
                <div class="action-buttons">
                  <span class="text-muted">-</span>
                </div>
              </td>
            </tr>
          `;
        });
      }
      
      // é€šå¸¸ã®æ–™é‡‘ãƒ—ãƒ©ãƒ³ã‚’è¡¨ç¤º
      Object.keys(groupedPlans).forEach((categoryId) => {
        const group = groupedPlans[categoryId];
        
        group.plans.forEach((plan, planIndex) => {
          const isFirstInCategory = planIndex === 0;
          const rowspan = group.plans.length;
          
          html += '<tr>';
          
          if (isFirstInCategory) {
            html += `<td rowspan="${rowspan}" class="category-cell">
              <div class="category-info">
                <span class="category-name">${escapeHtml(group.categoryName)}</span>
              </div>
            </td>`;
          }
          
          html += `
            <td>
              <div class="treatment-info">
                <span class="subcategory-name">${escapeHtml(plan.subcategory_name || '')}</span>
              </div>
            </td>
            <td>
              <div class="treatment-info">
                <span class="treatment-name">${escapeHtml(plan.treatment_name || '')}</span>
              </div>
            </td>
            <td>
              <span class="plan-name">${escapeHtml(plan.plan_name || '')}</span>
            </td>
            <td class="text-center">
              <span class="plan-type-badge plan-type-${plan.plan_type || 'single'}">${planTypeLabels[plan.plan_type] || plan.plan_type || 'å˜ç™º'}</span>
            </td>
            <td class="text-center">
              ${plan.sessions ? `<span>${plan.sessions}å›</span>` : '<span class="text-muted">-</span>'}
            </td>
            <td class="text-right">
              <span class="price-regular">Â¥${(plan.price || 0).toLocaleString()}</span>
            </td>
            <td class="text-right">
              <span class="price-regular">Â¥${(plan.price_taxed || 0).toLocaleString()}</span>
            </td>
            <td class="text-right">
              ${plan.cost_rate !== null && plan.cost_rate !== undefined ? `<span>${typeof plan.cost_rate === 'number' ? plan.cost_rate.toFixed(1) : plan.cost_rate}%</span>` : '<span class="text-muted">-</span>'}
            </td>
            <td class="text-right">
              ${plan.total_cost !== null && plan.total_cost !== undefined ? `<span>Â¥${plan.total_cost.toLocaleString()}</span>` : '<span class="text-muted">-</span>'}
            </td>
            <td class="notes-cell">
              ${plan.notes ? `<span class="notes-text" title="${escapeHtml(plan.notes)}">${escapeHtml(plan.notes)}</span>` : '<span class="text-muted">-</span>'}
            </td>
            <td>
              <div class="action-buttons">
                <button onclick="openEditModal('${plan.id}')" class="action-btn action-btn-edit">ç·¨é›†</button>
                <button onclick="deletePlan('${plan.id}')" class="action-btn action-btn-delete">å‰Šé™¤</button>
              </div>
            </td>
          </tr>`;
        });
      });

      tbody.innerHTML = html;
      console.log('Table rendered successfully');
    } catch (error) {
      console.error('Error in renderTable:', error);
      showError(`ãƒ†ãƒ¼ãƒ–ãƒ«ã®æç”»ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error instanceof Error ? error.message : 'Unknown error'}`);
    }
  }

  function renderPagination() {
    const paginationEl = document.getElementById('pagination');
    const paginationText = document.getElementById('paginationText');
    const paginationNumbers = document.getElementById('paginationNumbers');
    const paginationPrev = document.getElementById('paginationPrev');
    const paginationNext = document.getElementById('paginationNext');

    if (!paginationEl || !paginationText || !paginationNumbers) return;

    const totalPages = Math.max(1, Math.ceil(totalItems / itemsPerPage));

    if (totalItems === 0 || totalPages <= 1) {
      paginationEl.classList.add('hidden');
      return;
    }

    paginationEl.classList.remove('hidden');

    // æƒ…å ±ãƒ†ã‚­ã‚¹ãƒˆ
    const startItem = totalItems === 0 ? 0 : (currentPage - 1) * itemsPerPage + 1;
    const endItem = Math.min(currentPage * itemsPerPage, totalItems);
    paginationText.textContent = `${startItem}ä»¶ã€œ${endItem}ä»¶ / å…¨${totalItems}ä»¶`;

    // ãƒšãƒ¼ã‚¸ç•ªå·ãƒœã‚¿ãƒ³
    let html = '';
    const maxVisiblePages = 7;
    let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
    let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

    if (endPage - startPage < maxVisiblePages - 1) {
      startPage = Math.max(1, endPage - maxVisiblePages + 1);
    }

    if (startPage > 1) {
      html += `<button class="pagination-number" onclick="goToPage(1)">1</button>`;
      if (startPage > 2) {
        html += `<span class="pagination-number disabled">...</span>`;
      }
    }

    for (let i = startPage; i <= endPage; i++) {
      html += `<button class="pagination-number ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
    }

    if (endPage < totalPages) {
      if (endPage < totalPages - 1) {
        html += `<span class="pagination-number disabled">...</span>`;
      }
      html += `<button class="pagination-number" onclick="goToPage(${totalPages})">${totalPages}</button>`;
    }

    paginationNumbers.innerHTML = html;

    // å‰ã¸/æ¬¡ã¸ãƒœã‚¿ãƒ³
    if (paginationPrev) {
      paginationPrev.disabled = currentPage === 1;
      paginationPrev.onclick = () => goToPage(currentPage - 1);
    }
    if (paginationNext) {
      paginationNext.disabled = currentPage === totalPages;
      paginationNext.onclick = () => goToPage(currentPage + 1);
    }
  }

  function goToPage(page) {
    const totalPages = Math.max(1, Math.ceil(totalItems / itemsPerPage));
    if (page < 1 || page > totalPages) return;
    currentPage = page;
    renderTable();
    renderPagination();
    // ãƒšãƒ¼ã‚¸ãƒˆãƒƒãƒ—ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function showError(message) {
    const tbody = document.getElementById('priceTableBody');
    if (tbody) {
      tbody.innerHTML = `
        <tr>
          <td colspan="12">
            <div class="empty-state" style="color: var(--color-error)">
              <div class="empty-state-icon">âš ï¸</div>
              <div class="empty-state-title">${escapeHtml(message)}</div>
            </div>
          </td>
        </tr>
      `;
    }
  }

  async function deletePlan(id) {
    if (!confirm('ã“ã®ãƒ—ãƒ©ãƒ³ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
    
    try {
      const res = await fetch(`/api/pricing-id/${id}`, { method: 'DELETE' });
      if (res.ok) {
        await refreshData();
      } else {
        alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    } catch (error) {
      console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
      alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  }

  async function openEditModal(planId) {
    const modal = document.getElementById('editModal');
    const form = document.getElementById('editPlanForm');
    if (!modal || !form) return;

    try {
      // ãƒ—ãƒ©ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
      const res = await fetch(`/api/pricing-id/${planId}`);
      if (!res.ok) {
        alert('ãƒ—ãƒ©ãƒ³ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        return;
      }
      const data = await res.json();
      const plan = data.plan;

      // ãƒ•ã‚©ãƒ¼ãƒ ã«å€¤ã‚’è¨­å®š
      document.getElementById('editPlanId').value = plan.id;
      if (treatments.length === 0) {
        await loadTreatments();
      }
      renderTreatmentOptions(plan.treatment_id || '');
      document.getElementById('editPlanName').value = plan.plan_name || '';
      document.getElementById('editPlanType').value = plan.plan_type || 'single';
      document.getElementById('editSessions').value = plan.sessions || '';
      document.getElementById('editPrice').value = plan.price || '';
      document.getElementById('editPriceTaxed').value = plan.price_taxed || '';
      document.getElementById('editCostRate').value = plan.cost_rate || '';
      document.getElementById('editSupplyCost').value = plan.supply_cost || '';
      document.getElementById('editStaffCost').value = plan.staff_cost || '';
      document.getElementById('editTotalCost').value = plan.total_cost || '';
      document.getElementById('editNotes').value = plan.notes || '';

      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
      modal.classList.remove('hidden');
    } catch (error) {
      console.error('ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚ªãƒ¼ãƒ—ãƒ³ã‚¨ãƒ©ãƒ¼:', error);
      alert('ãƒ—ãƒ©ãƒ³ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  }

  function closeEditModal() {
    const modal = document.getElementById('editModal');
    if (modal) {
      modal.classList.add('hidden');
      const form = document.getElementById('editPlanForm');
      if (form) form.reset();
      clearEditFormError();
    }
  }

  function clearEditFormError() {
    const errorBox = document.getElementById('editFormError');
    if (!errorBox) return;
    errorBox.textContent = '';
    errorBox.classList.add('hidden');
  }

  function showEditFormError(message, fields) {
    const errorBox = document.getElementById('editFormError');
    if (!errorBox) return;
    if (fields && fields.length > 0) {
      const items = fields.map(field => `<li>${escapeHtml(field.message)}</li>`).join('');
      errorBox.innerHTML = `<div>${escapeHtml(message)}</div><ul>${items}</ul>`;
    } else {
      errorBox.textContent = message;
    }
    errorBox.classList.remove('hidden');
  }

  async function savePlan() {
    const form = document.getElementById('editPlanForm');
    if (!form) return;

    const planId = document.getElementById('editPlanId').value;
    if (!planId) return;

    clearEditFormError();

    const data = {
      treatment_id: document.getElementById('editTreatmentId').value || null,
      plan_name: document.getElementById('editPlanName').value,
      plan_type: document.getElementById('editPlanType').value,
      sessions: document.getElementById('editSessions').value ? Number(document.getElementById('editSessions').value) : null,
      price: Number(document.getElementById('editPrice').value),
      price_taxed: Number(document.getElementById('editPriceTaxed').value),
      cost_rate: document.getElementById('editCostRate').value ? Number(document.getElementById('editCostRate').value) : null,
      supply_cost: document.getElementById('editSupplyCost').value ? Number(document.getElementById('editSupplyCost').value) : null,
      staff_cost: document.getElementById('editStaffCost').value ? Number(document.getElementById('editStaffCost').value) : null,
      total_cost: document.getElementById('editTotalCost').value ? Number(document.getElementById('editTotalCost').value) : null,
      notes: document.getElementById('editNotes').value || null,
    };

    try {
      const res = await fetch(`/api/pricing-id/${planId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });

      if (res.ok) {
        closeEditModal();
        await refreshData();
      } else {
        const error = await res.json();
        showEditFormError(`æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message || 'Unknown error'}`, error.fields);
      }
    } catch (error) {
      console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
      showEditFormError('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    setLoading(true);
    loadCategories()
      .then(() => loadSubcategories())
      .then(() => loadTreatments())
      .then(() => refreshData())
      .finally(() => setLoading(false));

    const searchInput = document.getElementById('searchInput');
    const categoryFilter = document.getElementById('categoryFilter');
    const subcategoryFilter = document.getElementById('subcategoryFilter');
    const clearButton = document.getElementById('clearBtn');
    const itemsPerPageSelect = document.getElementById('itemsPerPageSelect');
    const editPlanForm = document.getElementById('editPlanForm');

    // 1ãƒšãƒ¼ã‚¸ã‚ãŸã‚Šã®ä»¶æ•°å¤‰æ›´
    itemsPerPageSelect?.addEventListener('change', (e) => {
      itemsPerPage = Number((e.target as HTMLSelectElement).value);
      currentPage = 1;
      renderTable();
      renderPagination();
    });

    // ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
    editPlanForm?.addEventListener('submit', async (e) => {
      e.preventDefault();
      await savePlan();
    });

    // ç¨æŠœä¾¡æ ¼ã‹ã‚‰ç¨è¾¼ä¾¡æ ¼ã‚’è‡ªå‹•è¨ˆç®—
    const editPriceInput = document.getElementById('editPrice');
    const editPriceTaxedInput = document.getElementById('editPriceTaxed');
    editPriceInput?.addEventListener('input', () => {
      const price = Number((editPriceInput as HTMLInputElement).value);
      if (editPriceTaxedInput && price > 0) {
        (editPriceTaxedInput as HTMLInputElement).value = toTaxedPrice(price).toString();
      }
    });

    // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¤œç´¢ï¼ˆå…¥åŠ›ä¸­ã«æ¤œç´¢ï¼‰
    searchInput?.addEventListener('input', (e) => {
      const value = (e.target as HTMLInputElement).value;
      searchQuery = value;
      
      // ãƒ‡ãƒã‚¦ãƒ³ã‚¹å‡¦ç†ï¼ˆ500mså¾Œã«æ¤œç´¢å®Ÿè¡Œï¼‰
      if (searchTimeout !== null) {
        clearTimeout(searchTimeout);
      }
      searchTimeout = window.setTimeout(() => {
        currentPage = 1; // æ¤œç´¢æ™‚ã¯1ãƒšãƒ¼ã‚¸ç›®ã«æˆ»ã‚‹
        setLoading(true);
        refreshData().finally(() => setLoading(false));
      }, 500);
    });

    searchInput?.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        if (searchTimeout !== null) {
          clearTimeout(searchTimeout);
        }
        searchQuery = (searchInput as HTMLInputElement).value;
        currentPage = 1; // æ¤œç´¢æ™‚ã¯1ãƒšãƒ¼ã‚¸ç›®ã«æˆ»ã‚‹
        setLoading(true);
        refreshData().finally(() => setLoading(false));
      }
    });

    categoryFilter?.addEventListener('change', (e) => {
      const value = (e.target as HTMLSelectElement).value;
      selectedCategoryId = value;
      selectedSubcategoryId = ''; // ã‚«ãƒ†ã‚´ãƒªå¤‰æ›´æ™‚ã¯ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªã‚’ãƒªã‚»ãƒƒãƒˆ
      if (subcategoryFilter) {
        subcategoryFilter.value = '';
        subcategoryFilter.innerHTML = '<option value="">ã™ã¹ã¦ã®ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒª</option>';
      }
      currentPage = 1; // ãƒ•ã‚£ãƒ«ã‚¿å¤‰æ›´æ™‚ã¯1ãƒšãƒ¼ã‚¸ç›®ã«æˆ»ã‚‹
      setLoading(true);
      loadSubcategories(selectedCategoryId)
        .then(() => refreshData())
        .finally(() => setLoading(false));
    });

    subcategoryFilter?.addEventListener('change', () => {
      selectedSubcategoryId = (subcategoryFilter as HTMLSelectElement).value;
      currentPage = 1; // ãƒ•ã‚£ãƒ«ã‚¿å¤‰æ›´æ™‚ã¯1ãƒšãƒ¼ã‚¸ç›®ã«æˆ»ã‚‹
      setLoading(true);
      refreshData().finally(() => setLoading(false));
    });

    clearButton?.addEventListener('click', () => {
      clearFilters();
    });
  });
</script>
