---
import Layout from '../../../components/Layout.astro';
import { getTaxRate } from '../../../lib/pricing';

const id = Astro.params.id;
const taxRate = getTaxRate(Astro.locals.runtime);
export const prerender = false;
---

<Layout>
  <div class="max-w-4xl mx-auto space-y-6">
    <div>
      <a href="/pricing" class="text-accent hover:underline">← 料金管理に戻る</a>
      <h2 class="text-3xl font-bold mt-4">料金プラン編集</h2>
    </div>

    <div id="loadingMessage" class="bg-white rounded-lg shadow p-8 text-center">
      <p class="text-gray-500">データを読み込み中...</p>
    </div>

    <form class="bg-white rounded-lg shadow p-6 space-y-6 hidden" id="pricePlanForm">
      <input type="hidden" name="id" id="planId" />
      <div id="formError" class="hidden text-red-500 whitespace-pre-line"></div>

      <!-- 基本情報 -->
      <div>
        <h3 class="text-xl font-semibold mb-4">基本情報</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">カテゴリ</label>
            <select name="category" id="categorySelect" class="w-full px-4 py-2 border rounded-lg" required>
              <option value="">選択してください</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">サブカテゴリ</label>
            <select name="subcategory" id="subcategorySelect" class="w-full px-4 py-2 border rounded-lg" required>
              <option value="">選択してください</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">施術</label>
            <select name="treatment" id="treatmentSelect" class="w-full px-4 py-2 border rounded-lg" required>
              <option value="">選択してください</option>
            </select>
            <div class="field-error hidden text-red-500 text-sm mt-1" data-field="treatment_id"></div>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">プラン名</label>
            <input
              type="text"
              name="planName"
              id="planName"
              placeholder="例: 1回、3回、200S"
              class="w-full px-4 py-2 border rounded-lg"
              required
            />
            <div class="field-error hidden text-red-500 text-sm mt-1" data-field="plan_name"></div>
          </div>
        </div>
      </div>

      <!-- 価格情報 -->
      <div>
        <h3 class="text-xl font-semibold mb-4">価格情報</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">税抜価格（円）</label>
            <input
              type="number"
              name="price"
              id="price"
              placeholder="22600"
              class="w-full px-4 py-2 border rounded-lg"
              required
            />
            <div class="field-error hidden text-red-500 text-sm mt-1" data-field="price"></div>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">税込価格（円）</label>
            <input
              type="number"
              name="priceTaxed"
              id="priceTaxed"
              placeholder="24860"
              class="w-full px-4 py-2 border rounded-lg"
              required
            />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">回数</label>
            <input
              type="number"
              name="sessions"
              id="sessions"
              placeholder="例: 3"
              class="w-full px-4 py-2 border rounded-lg"
            />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">プラン種別</label>
            <select name="planType" id="planType" class="w-full px-4 py-2 border rounded-lg" required>
              <option value="single">単発</option>
              <option value="course">回数コース</option>
              <option value="trial">初回お試し</option>
              <option value="monitor">モニター価格</option>
              <option value="campaign">キャンペーン</option>
            </select>
          </div>
        </div>
      </div>

      <!-- 原価情報 -->
      <div>
        <h3 class="text-xl font-semibold mb-4">原価情報</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">原価率（%）</label>
            <input
              type="number"
              name="costRate"
              id="costRate"
              step="0.1"
              placeholder="9.3"
              class="w-full px-4 py-2 border rounded-lg"
            />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">備品原価（円）</label>
            <input
              type="number"
              name="supplyCost"
              id="supplyCost"
              placeholder="100"
              class="w-full px-4 py-2 border rounded-lg"
            />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">人件費（円）</label>
            <input
              type="number"
              name="staffCost"
              id="staffCost"
              placeholder="2000"
              class="w-full px-4 py-2 border rounded-lg"
            />
          </div>
        </div>
      </div>

      <!-- アクション -->
      <div class="flex justify-end gap-4 pt-4 border-t">
        <a href="/pricing" class="px-6 py-2 border rounded-lg hover:bg-gray-50 transition">
          キャンセル
        </a>
        <button
          type="submit"
          class="px-6 py-2 bg-accent text-white rounded-lg hover:bg-accent-light transition"
        >
          更新
        </button>
      </div>
    </form>
  </div>
</Layout>

<script define:vars={{ planId: id, taxRate }}>
  const toTaxedPrice = (amount) => Math.round(amount * (1 + taxRate));
  
  interface PlanData {
    id: string;
    plan_name: string;
    plan_type: string;
    sessions: number | null;
    price: number;
    price_taxed: number;
    cost_rate: number | null;
    supply_cost: number | null;
    staff_cost: number | null;
    category_id: string;
    subcategory_id: string;
    treatment_id: string;
  }

  let categories: Array<{ id: string; name: string }> = [];
  let subcategories: Array<{ id: string; name: string; category_id: string }> = [];
  let treatments: Array<{ id: string; name: string; subcategory_id: string }> = [];

  const fetchJson = async (url: string) => {
    const res = await fetch(url);
    if (!res.ok) {
      throw new Error(`${res.status}: ${res.statusText}`);
    }
    return res.json();
  };

  const setSelectOptions = (
    select: HTMLSelectElement | null,
    options: Array<{ id: string; name: string }>,
    placeholder = '選択してください'
  ) => {
    if (!select) return;
    select.innerHTML = `<option value="">${placeholder}</option>` +
      options.map(option => `<option value="${option.id}">${option.name}</option>`).join('');
  };

  async function loadData() {
    try {
      // カテゴリ一覧取得
      const catData = await fetchJson('/api/categories');
      categories = catData.categories || [];
      setSelectOptions(document.getElementById('categorySelect') as HTMLSelectElement, categories);

      // プランデータ取得
      const planData = await fetchJson(`/api/pricing-id/${planId}`);
      const plan = planData.plan as PlanData;
      if (!plan) {
        throw new Error('プランが見つかりません');
      }

      // サブカテゴリ取得（カテゴリ選択後に）
      await loadSubcategories(plan.category_id);
      // 施術取得（サブカテゴリ選択後に）
      await loadTreatments(plan.subcategory_id);

      // フォームに値を設定（選択肢を読み込んだ後）
      populateForm(plan);

      // フォームを表示
      document.getElementById('loadingMessage')?.classList.add('hidden');
      const form = document.getElementById('pricePlanForm');
      if (form) {
        form.classList.remove('hidden');
      }

      // カテゴリ変更時のイベントリスナー
      const categorySelect = document.getElementById('categorySelect') as HTMLSelectElement;
      const subcategorySelect = document.getElementById('subcategorySelect') as HTMLSelectElement;
      const treatmentSelect = document.getElementById('treatmentSelect') as HTMLSelectElement;

      categorySelect?.addEventListener('change', (e) => {
        const categoryId = (e.target as HTMLSelectElement).value;
        if (categoryId) {
          loadSubcategories(categoryId);
          setSelectOptions(subcategorySelect, []);
          setSelectOptions(treatmentSelect, []);
        }
      });

      subcategorySelect?.addEventListener('change', (e) => {
        const subcategoryId = (e.target as HTMLSelectElement).value;
        if (subcategoryId) {
          loadTreatments(subcategoryId);
          setSelectOptions(treatmentSelect, []);
        }
      });
    } catch (error) {
      console.error('データ読み込みエラー:', error);
      const loadingMsg = document.getElementById('loadingMessage');
      if (loadingMsg) {
        loadingMsg.innerHTML = `<p class="text-red-500">データの読み込みに失敗しました: ${error instanceof Error ? error.message : 'Unknown error'}</p>`;
      }
    }
  }

  const showFormError = (message: string, fields?: Array<{ message: string }>) => {
    const formError = document.getElementById('formError');
    if (formError) {
      if (fields && fields.length > 0) {
        const details = fields.map(field => `- ${field.message}`).join('\n');
        formError.textContent = `${message}\n${details}`;
      } else {
        formError.textContent = message;
      }
      formError.classList.remove('hidden');
    }
  };

  const clearFieldErrors = () => {
    document.querySelectorAll<HTMLDivElement>('.field-error').forEach(node => {
      node.textContent = '';
      node.classList.add('hidden');
    });
  };

  const showFieldErrors = (fields?: Array<{ field: string; message: string }>) => {
    if (!fields || fields.length === 0) return;
    fields.forEach(field => {
      const target = document.querySelector<HTMLDivElement>(`.field-error[data-field="${field.field}"]`);
      if (!target) return;
      target.textContent = field.message;
      target.classList.remove('hidden');
    });
  };

  const clearFormError = () => {
    const formError = document.getElementById('formError');
    if (formError) {
      formError.textContent = '';
      formError.classList.add('hidden');
    }
  };

  async function loadSubcategories(categoryId: string) {
    try {
      const data = await fetchJson(`/api/subcategories?category_id=${categoryId}`);
      subcategories = data.subcategories || [];
      setSelectOptions(document.getElementById('subcategorySelect') as HTMLSelectElement, subcategories);
    } catch (error) {
      console.error('サブカテゴリ読み込みエラー:', error);
    }
  }

  async function loadTreatments(subcategoryId: string) {
    try {
      const data = await fetchJson(`/api/treatments?subcategory_id=${subcategoryId}`);
      treatments = data.treatments || [];
      setSelectOptions(document.getElementById('treatmentSelect') as HTMLSelectElement, treatments);
    } catch (error) {
      console.error('施術読み込みエラー:', error);
    }
  }

  function populateForm(plan: PlanData) {
    (document.getElementById('planId') as HTMLInputElement).value = plan.id;
    
    const categorySelect = document.getElementById('categorySelect') as HTMLSelectElement;
    const subcategorySelect = document.getElementById('subcategorySelect') as HTMLSelectElement;
    const treatmentSelect = document.getElementById('treatmentSelect') as HTMLSelectElement;
    
    if (categorySelect) categorySelect.value = plan.category_id;
    if (subcategorySelect) subcategorySelect.value = plan.subcategory_id;
    if (treatmentSelect) treatmentSelect.value = plan.treatment_id;
    
    (document.getElementById('planName') as HTMLInputElement).value = plan.plan_name;
    (document.getElementById('planType') as HTMLSelectElement).value = plan.plan_type;
    (document.getElementById('price') as HTMLInputElement).value = plan.price.toString();
    (document.getElementById('priceTaxed') as HTMLInputElement).value = plan.price_taxed.toString();
    if (plan.sessions) {
      (document.getElementById('sessions') as HTMLInputElement).value = plan.sessions.toString();
    }
    if (plan.cost_rate) {
      (document.getElementById('costRate') as HTMLInputElement).value = plan.cost_rate.toString();
    }
    if (plan.supply_cost) {
      (document.getElementById('supplyCost') as HTMLInputElement).value = plan.supply_cost.toString();
    }
    if (plan.staff_cost) {
      (document.getElementById('staffCost') as HTMLInputElement).value = plan.staff_cost.toString();
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    loadData();

    const form = document.getElementById('pricePlanForm');
    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      clearFormError();
      clearFieldErrors();
      const formData = new FormData(form as HTMLFormElement);
      
      const data = {
        treatment_id: formData.get('treatment'),
        plan_name: formData.get('planName'),
        plan_type: formData.get('planType'),
        sessions: formData.get('sessions') ? Number(formData.get('sessions')) : null,
        price: Number(formData.get('price')),
        price_taxed: Number(formData.get('priceTaxed')),
        cost_rate: formData.get('costRate') ? Number(formData.get('costRate')) : null,
        supply_cost: formData.get('supplyCost') ? Number(formData.get('supplyCost')) : null,
        staff_cost: formData.get('staffCost') ? Number(formData.get('staffCost')) : null,
      };

      try {
        const res = await fetch(`/api/pricing-id/${planId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });

        if (res.ok) {
          alert('更新しました');
          window.location.href = '/pricing';
        } else {
          const error = await res.json();
          showFormError(`更新に失敗しました: ${error.message || 'Unknown error'}`, error.fields);
          showFieldErrors(error.fields);
        }
      } catch (error) {
        console.error('更新エラー:', error);
        showFormError('更新に失敗しました');
      }
    });

    // 税抜価格から税込価格を自動計算
    const priceInput = document.getElementById('price') as HTMLInputElement;
    const priceTaxedInput = document.getElementById('priceTaxed') as HTMLInputElement;
    
    priceInput?.addEventListener('input', () => {
      const price = Number(priceInput.value);
      if (priceTaxedInput && price > 0) {
        priceTaxedInput.value = toTaxedPrice(price).toString();
      }
    });
  });
</script>
