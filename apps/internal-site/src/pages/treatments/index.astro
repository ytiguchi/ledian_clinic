---
import Layout from '../../components/Layout.astro';
---

<Layout>
  <div class="training-page">
    <!-- Page Header -->
    <div class="page-header">
      <div>
        <h1 class="page-title">æ–½è¡“ã‚«ã‚¦ãƒ³ã‚»ãƒªãƒ³ã‚°è³‡æ–™</h1>
        <p class="page-subtitle">ã‚«ãƒ†ã‚´ãƒª â†’ æ–½è¡“ â†’ è©³ç´°æƒ…å ±ã‚’ãƒ‰ãƒªãƒ«ãƒ€ã‚¦ãƒ³ã§ç¢ºèª</p>
      </div>
    </div>

    <!-- Navigation Breadcrumb -->
    <nav class="nav-breadcrumb" id="navBreadcrumb">
      <button class="breadcrumb-item active" data-level="category">
        <span class="breadcrumb-icon">ğŸ </span>
        ã‚«ãƒ†ã‚´ãƒªä¸€è¦§
      </button>
    </nav>

    <!-- Level 1: Category Grid -->
    <div class="content-level" id="categoryLevel">
      <div class="category-grid" id="categoryGrid">
        <div class="loading-state">èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>
    </div>

    <!-- Level 2: Subcategory & Treatment List -->
    <div class="content-level hidden" id="subcategoryLevel">
      <div class="two-column-layout">
        <aside class="sidebar-nav" id="subcategorySidebar">
          <!-- Subcategory list will be rendered here -->
        </aside>
        <main class="treatment-list" id="treatmentList">
          <!-- Treatment cards will be rendered here -->
        </main>
      </div>
    </div>

    <!-- Level 3: Treatment Detail -->
    <div class="content-level hidden" id="detailLevel">
      <div class="detail-container" id="treatmentDetail">
        <!-- Treatment detail will be rendered here -->
      </div>
    </div>
  </div>
</Layout>

<style>
  .training-page {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  /* Breadcrumb Navigation */
  .nav-breadcrumb {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    background: var(--color-bg-card);
    border-radius: var(--radius-lg);
    border: 1px solid var(--color-border-light);
    overflow-x: auto;
  }

  .breadcrumb-item {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.5rem 0.875rem;
    background: transparent;
    border: 1px solid transparent;
    border-radius: var(--radius-full);
    font-size: 0.8125rem;
    font-weight: 500;
    color: var(--color-text-muted);
    cursor: pointer;
    transition: all var(--transition-fast);
    white-space: nowrap;
  }

  .breadcrumb-item:hover {
    background: var(--color-bg-hover);
    color: var(--color-text);
  }

  .breadcrumb-item.active {
    background: var(--color-accent);
    color: var(--color-primary);
    pointer-events: none;
  }

  .breadcrumb-item::after {
    content: 'â€º';
    margin-left: 0.5rem;
    color: var(--color-text-muted);
  }

  .breadcrumb-item:last-child::after {
    display: none;
  }

  .breadcrumb-icon {
    font-size: 0.875rem;
  }

  /* Content Levels */
  .content-level {
    animation: fadeIn 0.3s ease;
  }

  .content-level.hidden {
    display: none;
  }

  /* Category Grid */
  .category-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 1rem;
  }

  .category-card {
    background: var(--color-bg-card);
    border-radius: var(--radius-lg);
    border: 2px solid var(--color-border-light);
    padding: 1.5rem;
    cursor: pointer;
    transition: all var(--transition-base);
    text-align: center;
  }

  .category-card:hover {
    border-color: var(--color-accent);
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
  }

  .category-icon {
    font-size: 2rem;
    margin-bottom: 0.5rem;
  }

  .category-name {
    font-size: 0.9375rem;
    font-weight: 600;
    color: var(--color-text);
    margin: 0 0 0.25rem 0;
  }

  .category-count {
    font-size: 0.75rem;
    color: var(--color-text-muted);
  }

  /* Two Column Layout */
  .two-column-layout {
    display: grid;
    grid-template-columns: 220px 1fr;
    gap: 1.5rem;
  }

  .sidebar-nav {
    background: var(--color-bg-card);
    border-radius: var(--radius-lg);
    border: 1px solid var(--color-border-light);
    padding: 1rem;
    height: fit-content;
    position: sticky;
    top: 1rem;
  }

  .sidebar-title {
    font-size: 0.6875rem;
    font-weight: 700;
    color: var(--color-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin: 0 0 0.75rem 0;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--color-border-light);
  }

  .sidebar-item {
    display: block;
    width: 100%;
    padding: 0.625rem 0.75rem;
    background: transparent;
    border: none;
    border-radius: var(--radius-md);
    font-size: 0.8125rem;
    font-weight: 500;
    color: var(--color-text-secondary);
    text-align: left;
    cursor: pointer;
    transition: all var(--transition-fast);
    margin-bottom: 0.25rem;
  }

  .sidebar-item:hover {
    background: var(--color-bg-hover);
    color: var(--color-text);
  }

  .sidebar-item.active {
    background: var(--color-accent);
    color: var(--color-primary);
  }

  .sidebar-item .count {
    float: right;
    font-size: 0.6875rem;
    padding: 0.125rem 0.5rem;
    background: rgba(0,0,0,0.1);
    border-radius: var(--radius-full);
  }

  /* Treatment List */
  .treatment-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1rem;
    align-content: start;
  }

  .treatment-card {
    background: var(--color-bg-card);
    border-radius: var(--radius-lg);
    border: 1px solid var(--color-border-light);
    padding: 1.25rem;
    cursor: pointer;
    transition: all var(--transition-base);
  }

  .treatment-card:hover {
    border-color: var(--color-accent);
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
  }

  .treatment-name {
    font-size: 1rem;
    font-weight: 600;
    color: var(--color-text);
    margin: 0 0 0.5rem 0;
  }

  .treatment-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.375rem;
    margin-bottom: 0.75rem;
  }

  .treatment-tag {
    font-size: 0.625rem;
    padding: 0.25rem 0.5rem;
    background: var(--color-bg-hover);
    border-radius: var(--radius-full);
    color: var(--color-text-muted);
  }

  .treatment-tag.has-content {
    background: var(--color-success-light);
    color: var(--color-success);
  }

  .treatment-desc {
    font-size: 0.8125rem;
    color: var(--color-text-secondary);
    line-height: 1.5;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* Detail Container */
  .detail-container {
    display: grid;
    gap: 1.5rem;
  }

  .detail-header {
    background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-light) 100%);
    border-radius: var(--radius-lg);
    padding: 2rem;
    color: white;
  }

  .detail-title {
    font-size: 1.5rem;
    font-weight: 700;
    margin: 0 0 0.5rem 0;
  }

  .detail-subtitle {
    font-size: 0.875rem;
    color: var(--color-accent-light);
    margin: 0;
  }

  .detail-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1.5rem;
  }

  .detail-section {
    background: var(--color-bg-card);
    border-radius: var(--radius-lg);
    border: 1px solid var(--color-border-light);
    overflow: hidden;
  }

  .section-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 1rem 1.25rem;
    background: var(--color-bg-hover);
    border-bottom: 1px solid var(--color-border-light);
  }

  .section-icon {
    font-size: 1.25rem;
  }

  .section-title {
    font-size: 0.9375rem;
    font-weight: 600;
    color: var(--color-text);
    margin: 0;
  }

  .section-content {
    padding: 1.25rem;
  }

  /* Overview Table */
  .overview-table {
    width: 100%;
    border-collapse: collapse;
  }

  .overview-table tr {
    border-bottom: 1px solid var(--color-border-light);
  }

  .overview-table tr:last-child {
    border-bottom: none;
  }

  .overview-table th {
    text-align: left;
    padding: 0.75rem 0;
    font-size: 0.8125rem;
    font-weight: 600;
    color: var(--color-text-muted);
    width: 30%;
    vertical-align: top;
  }

  .overview-table td {
    padding: 0.75rem 0;
    font-size: 0.875rem;
    color: var(--color-text);
    line-height: 1.5;
  }

  /* Contraindications Highlight */
  .contraindication-row {
    background: rgba(239, 68, 68, 0.05);
  }

  .contraindication-row th {
    color: var(--color-error);
  }

  .contraindication-row td {
    color: var(--color-error);
    font-weight: 500;
  }

  /* Features List */
  .features-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .feature-item {
    padding: 1rem;
    background: var(--color-bg-hover);
    border-radius: var(--radius-md);
    border-left: 3px solid var(--color-accent);
  }

  .feature-title {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--color-text);
    margin: 0 0 0.5rem 0;
  }

  .feature-desc {
    font-size: 0.8125rem;
    color: var(--color-text-secondary);
    line-height: 1.6;
    margin: 0;
  }

  /* FAQ List */
  .faq-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .faq-item {
    border: 1px solid var(--color-border-light);
    border-radius: var(--radius-md);
    overflow: hidden;
  }

  .faq-question {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem;
    background: var(--color-bg-hover);
    cursor: pointer;
    transition: background var(--transition-fast);
  }

  .faq-question:hover {
    background: var(--color-bg-active);
  }

  .faq-q-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 24px;
    height: 24px;
    background: var(--color-accent);
    color: var(--color-primary);
    border-radius: var(--radius-full);
    font-size: 0.75rem;
    font-weight: 700;
    flex-shrink: 0;
  }

  .faq-q-text {
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--color-text);
    flex: 1;
  }

  .faq-toggle {
    font-size: 1rem;
    color: var(--color-text-muted);
    transition: transform var(--transition-fast);
  }

  .faq-item.open .faq-toggle {
    transform: rotate(180deg);
  }

  .faq-answer {
    display: none;
    padding: 1rem;
    padding-top: 0;
    background: white;
  }

  .faq-item.open .faq-answer {
    display: block;
  }

  .faq-a-text {
    font-size: 0.8125rem;
    color: var(--color-text-secondary);
    line-height: 1.7;
    margin: 0;
    padding-left: 2.5rem;
  }

  /* About Section */
  .about-text {
    font-size: 0.9375rem;
    color: var(--color-text);
    line-height: 1.8;
  }

  /* Full Width Section */
  .full-width {
    grid-column: 1 / -1;
  }

  /* Loading & Empty States */
  .loading-state, .empty-state {
    grid-column: 1 / -1;
    text-align: center;
    padding: 3rem;
    color: var(--color-text-muted);
  }

  .empty-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
  }

  /* Responsive */
  @media (max-width: 1024px) {
    .detail-grid {
      grid-template-columns: 1fr;
    }
  }

  @media (max-width: 768px) {
    .two-column-layout {
      grid-template-columns: 1fr;
    }

    .sidebar-nav {
      position: static;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      padding: 0.75rem;
    }

    .sidebar-title {
      width: 100%;
    }

    .sidebar-item {
      flex: 0 0 auto;
      margin-bottom: 0;
    }

    .nav-breadcrumb {
      padding: 0.5rem;
    }

    .breadcrumb-item {
      padding: 0.375rem 0.625rem;
      font-size: 0.75rem;
    }
  }
</style>

<script>
  interface Category {
    id: string;
    name: string;
    slug: string;
    sort_order: number;
    is_active: boolean;
  }

  interface Subcategory {
    id: string;
    category_id: string;
    name: string;
    slug: string;
    sort_order: number;
    is_active: boolean;
  }

  interface Treatment {
    id: string;
    name: string;
    slug: string;
    subcategory_id: string;
    subcategory_name: string;
    category_id: string;
    category_name: string;
  }

  interface EducationContent {
    slug: string;
    name_ja: string;
    name_en?: string;
    description?: string;
    about?: string;
    features?: Array<{ title: string; description: string }>;
    overview?: Record<string, string>;
    faqs?: Array<{ question: string; answer: string }>;
  }

  let categories: Category[] = [];
  let subcategories: Subcategory[] = [];
  let treatments: Treatment[] = [];
  let educationContents: Record<string, EducationContent> = {};
  
  let currentCategory: Category | null = null;
  let currentSubcategory: Subcategory | null = null;
  let currentTreatment: Treatment | null = null;

  const categoryIcons: Record<string, string> = {
    'ã‚¹ã‚­ãƒ³ã‚±ã‚¢': 'âœ¨',
    'åŒ»ç™‚è„±æ¯›': 'ğŸ’«',
    'ã‚¢ãƒ¼ãƒˆãƒ¡ã‚¤ã‚¯': 'ğŸ¨',
    'ç‚¹æ»´ãƒ»æ³¨å°„': 'ğŸ’‰',
    'è„‚è‚ªå¸å¼•': 'ğŸ‹ï¸',
    'è„‚è‚ªæº¶è§£æ³¨å°„': 'ğŸ’§',
    'è‚Œè‚²æ³¨å°„': 'ğŸŒ¸',
    'ãƒœãƒˆãƒƒã‚¯ã‚¹': 'ğŸ’',
    'ãƒ’ã‚¢ãƒ«ãƒ­ãƒ³é…¸': 'ğŸ’§',
    'ç³¸ãƒªãƒ•ãƒˆ': 'ğŸ§µ',
    'éº»é…”': 'ğŸ’¤',
    'ãƒ‰ã‚¯ã‚¿ãƒ¼ã‚ºã‚³ã‚¹ãƒ¡': 'ğŸ§´',
    'è‚Œè¨ºæ–­': 'ğŸ”¬',
    'LDM': 'âš¡',
    'ãƒ‹ã‚­ãƒ“ãƒ»ãƒ‹ã‚­ãƒ“ç—•ãƒ»æ¯›ç©´æ²»ç™‚': 'ğŸ©¹',
    'ãƒªãƒ•ãƒˆã‚¢ãƒƒãƒ—ãƒ»å¼•ãç· ã‚': 'â¬†ï¸',
    'ãƒ”ãƒ¼ãƒªãƒ³ã‚°': 'ğŸ‹',
    'ã‚·ãƒŸãƒ»ç¾ç™½æ²»ç™‚': 'â˜€ï¸',
    'ç—©èº«æ²»ç™‚': 'ğŸƒ',
    'å°å…¥ãƒ»ã‚¨ãƒ¬ã‚¯ãƒˆãƒ­ãƒãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³': 'âš¡',
    'ãƒ­ãƒ¼ãƒãƒ”ãƒ³ã‚¯': 'ğŸŒ¸',
  };

  function escapeHtml(text: string): string {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function getCategoryIcon(name: string): string {
    for (const [key, icon] of Object.entries(categoryIcons)) {
      if (name.includes(key) || key.includes(name)) return icon;
    }
    return 'âœ¨';
  }

  async function init() {
    try {
      // Load all data in parallel (education API is optional)
      const [catRes, subRes, treatRes, eduRes] = await Promise.allSettled([
        fetch('/api/categories'),
        fetch('/api/subcategories'),
        fetch('/api/treatments'),
        fetch('/api/education').catch(() => ({ ok: false, json: () => Promise.resolve({ treatments: [] }) }))
      ]);

      const catResult = catRes.status === 'fulfilled' ? catRes.value : null;
      const subResult = subRes.status === 'fulfilled' ? subRes.value : null;
      const treatResult = treatRes.status === 'fulfilled' ? treatRes.value : null;
      const eduResult = eduRes.status === 'fulfilled' ? eduRes.value : null;

      if (!catResult?.ok || !subResult?.ok || !treatResult?.ok) {
        console.error('API error:', { 
          catRes: catResult?.status, 
          subRes: subResult?.status, 
          treatRes: treatResult?.status 
        });
        const grid = document.getElementById('categoryGrid');
        if (grid) {
          grid.innerHTML = '<div class="empty-state"><div class="empty-icon">âŒ</div><p>ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p></div>';
        }
        return;
      }

      const catData = await catResult.json();
      const subData = await subResult.json();
      const treatData = await treatResult.json();
      const eduData = eduResult?.ok ? await eduResult.json() : { treatments: [] };

      console.log('Loaded data:', { 
        categories: catData.categories?.length || 0,
        subcategories: subData.subcategories?.length || 0,
        treatments: treatData.treatments?.length || 0
      });

      categories = (catData.categories || []).filter((c: any) => c.is_active !== false);
      subcategories = (subData.subcategories || []).filter((s: any) => s.is_active !== false);
      treatments = treatData.treatments || [];

      console.log('Filtered data:', { 
        categories: categories.length,
        subcategories: subcategories.length,
        treatments: treatments.length
      });
      
      // Index education content by slug
      const eduList = eduData.treatments || [];
      for (const item of eduList) {
        try {
          const res = await fetch(`/api/education/${item.slug}`);
          if (res.ok) {
            educationContents[item.slug] = await res.json();
          }
        } catch (e) {
          // Skip if not found
        }
      }

      renderCategories();
    } catch (error) {
      console.error('Error loading data:', error);
      const grid = document.getElementById('categoryGrid');
      if (grid) {
        grid.innerHTML = `<div class="empty-state"><div class="empty-icon">âŒ</div><p>ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error instanceof Error ? error.message : 'Unknown error'}</p></div>`;
      }
    }
  }

  function renderCategories() {
    const grid = document.getElementById('categoryGrid');
    if (!grid) return;

    // ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªã®æ•°ã‚’ã‚«ãƒ†ã‚´ãƒªã”ã¨ã«é›†è¨ˆï¼ˆã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªã®ã¿ï¼‰
    const subcatCounts: Record<string, number> = {};
    subcategories.forEach(sub => {
      subcatCounts[sub.category_id] = (subcatCounts[sub.category_id] || 0) + 1;
    });

    // ã‚«ãƒ†ã‚´ãƒªã ã‘ã‚’è¡¨ç¤ºï¼ˆis_activeãŒtrueã®ã‚‚ã®ã®ã¿ï¼‰
    const activeCategories = categories.filter(cat => cat.is_active !== false);
    
    console.log('Rendering categories:', activeCategories.length);
    
    if (activeCategories.length === 0) {
      grid.innerHTML = `
        <div class="empty-state">
          <div class="empty-icon">ğŸ“­</div>
          <p>ã‚«ãƒ†ã‚´ãƒªãŒã‚ã‚Šã¾ã›ã‚“</p>
        </div>
      `;
      return;
    }

    grid.innerHTML = activeCategories.map(cat => `
      <div class="category-card" data-id="${cat.id}">
        <div class="category-icon">${getCategoryIcon(cat.name)}</div>
        <h3 class="category-name">${escapeHtml(cat.name)}</h3>
        <p class="category-count">${subcatCounts[cat.id] || 0} ãƒ¡ãƒ‹ãƒ¥ãƒ¼</p>
      </div>
    `).join('');

    grid.querySelectorAll('.category-card').forEach(card => {
      card.addEventListener('click', () => {
        const id = card.getAttribute('data-id');
        const category = activeCategories.find(c => c.id === id);
        if (category) selectCategory(category);
      });
    });
  }

  function selectCategory(category: Category) {
    currentCategory = category;
    currentSubcategory = null;

    // Update breadcrumb
    updateBreadcrumb([
      { label: 'ã‚«ãƒ†ã‚´ãƒªä¸€è¦§', icon: 'ğŸ ', level: 'category' },
      { label: category.name, icon: getCategoryIcon(category.name), level: 'subcategory', active: true }
    ]);

    // Show subcategory level
    showLevel('subcategoryLevel');

    // Render sidebar with subcategoriesï¼ˆã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªã®ã¿ï¼‰
    const sidebar = document.getElementById('subcategorySidebar');
    const categorySubcats = subcategories.filter(s => s.category_id === category.id);
    
    if (sidebar) {
      sidebar.innerHTML = `
        <h4 class="sidebar-title">ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒª</h4>
        <button class="sidebar-item active" data-id="">
          ã™ã¹ã¦è¡¨ç¤º
          <span class="count">${getTreatmentCount(category.id, null)}</span>
        </button>
        ${categorySubcats.map(sub => `
          <button class="sidebar-item" data-id="${sub.id}">
            ${escapeHtml(sub.name)}
            <span class="count">${getTreatmentCount(category.id, sub.id)}</span>
          </button>
        `).join('')}
      `;

      sidebar.querySelectorAll('.sidebar-item').forEach(item => {
        item.addEventListener('click', () => {
          sidebar.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
          item.classList.add('active');
          
          const subId = item.getAttribute('data-id');
          currentSubcategory = subId ? subcategories.find(s => s.id === subId) || null : null;
          renderTreatmentList();
        });
      });
    }

    renderTreatmentList();
  }

  function getTreatmentCount(categoryId: string, subcategoryId: string | null): number {
    return treatments.filter(t => 
      t.category_id === categoryId && 
      (!subcategoryId || t.subcategory_id === subcategoryId)
    ).length;
  }

  function renderTreatmentList() {
    const list = document.getElementById('treatmentList');
    if (!list || !currentCategory) return;

    let filtered = treatments.filter(t => t.category_id === currentCategory!.id);
    if (currentSubcategory) {
      filtered = filtered.filter(t => t.subcategory_id === currentSubcategory!.id);
    }

    if (filtered.length === 0) {
      list.innerHTML = `
        <div class="empty-state">
          <div class="empty-icon">ğŸ“­</div>
          <p>è©²å½“ã™ã‚‹æ–½è¡“ãŒã‚ã‚Šã¾ã›ã‚“</p>
        </div>
      `;
      return;
    }

    list.innerHTML = filtered.map(treatment => {
      const eduSlug = getEducationSlug(treatment.name);
      const hasContent = educationContents[eduSlug];
      
      return `
        <div class="treatment-card" data-id="${treatment.id}" data-slug="${eduSlug}">
          <h3 class="treatment-name">${escapeHtml(treatment.name)}</h3>
          <div class="treatment-tags">
            <span class="treatment-tag">${escapeHtml(treatment.subcategory_name)}</span>
            ${hasContent ? '<span class="treatment-tag has-content">ã‚«ã‚¦ãƒ³ã‚»ãƒªãƒ³ã‚°è³‡æ–™ã‚ã‚Š</span>' : ''}
          </div>
          <p class="treatment-desc">
            ${hasContent && hasContent.description ? escapeHtml(hasContent.description.substring(0, 80)) + '...' : 'ã‚¯ãƒªãƒƒã‚¯ã—ã¦è©³ç´°ã‚’è¡¨ç¤º'}
          </p>
        </div>
      `;
    }).join('');

    list.querySelectorAll('.treatment-card').forEach(card => {
      card.addEventListener('click', () => {
        const id = card.getAttribute('data-id');
        const slug = card.getAttribute('data-slug');
        const treatment = treatments.find(t => t.id === id);
        if (treatment) selectTreatment(treatment, slug || '');
      });
    });
  }

  function selectTreatment(treatment: Treatment, slug: string) {
    currentTreatment = treatment;

    // Update breadcrumb
    updateBreadcrumb([
      { label: 'ã‚«ãƒ†ã‚´ãƒªä¸€è¦§', icon: 'ğŸ ', level: 'category' },
      { label: currentCategory?.name || '', icon: getCategoryIcon(currentCategory?.name || ''), level: 'subcategory' },
      { label: treatment.name, icon: 'ğŸ“‹', level: 'detail', active: true }
    ]);

    showLevel('detailLevel');
    renderTreatmentDetail(treatment, slug);
  }

  function renderTreatmentDetail(treatment: Treatment, slug: string) {
    const container = document.getElementById('treatmentDetail');
    if (!container) return;

    const content = educationContents[slug];

    if (!content) {
      container.innerHTML = `
        <div class="detail-header">
          <h1 class="detail-title">${escapeHtml(treatment.name)}</h1>
          <p class="detail-subtitle">${escapeHtml(treatment.subcategory_name)}</p>
        </div>
        <div class="detail-section full-width">
          <div class="section-content">
            <div class="empty-state">
              <div class="empty-icon">ğŸ“š</div>
              <p>ã‚«ã‚¦ãƒ³ã‚»ãƒªãƒ³ã‚°è³‡æ–™ã¯æº–å‚™ä¸­ã§ã™</p>
            </div>
          </div>
        </div>
      `;
      return;
    }

    // Extract overview data
    const overview = content.overview || {};
    const contraindication = overview['ç¦å¿Œ'] || null;
    
    container.innerHTML = `
      <div class="detail-header">
        <h1 class="detail-title">${escapeHtml(content.name_ja || treatment.name)}</h1>
        <p class="detail-subtitle">${content.name_en ? escapeHtml(content.name_en) : escapeHtml(treatment.subcategory_name)}</p>
      </div>

      <div class="detail-grid">
        <!-- æ–½è¡“æ¦‚è¦ -->
        <div class="detail-section">
          <div class="section-header">
            <span class="section-icon">ğŸ“–</span>
            <h2 class="section-title">æ–½è¡“æ¦‚è¦</h2>
          </div>
          <div class="section-content">
            <p class="about-text">${escapeHtml(content.about || content.description || 'æ¦‚è¦æƒ…å ±ãªã—')}</p>
          </div>
        </div>

        <!-- ãƒ—ãƒ­ãƒˆã‚³ãƒ¼ãƒ«ï¼ˆæ–½è¡“æƒ…å ±ï¼‰ -->
        <div class="detail-section">
          <div class="section-header">
            <span class="section-icon">ğŸ“‹</span>
            <h2 class="section-title">ãƒ—ãƒ­ãƒˆã‚³ãƒ¼ãƒ«</h2>
          </div>
          <div class="section-content">
            <table class="overview-table">
              ${Object.entries(overview)
                .filter(([key]) => key !== 'é …ç›®' && key !== 'ç¦å¿Œ')
                .map(([key, value]) => `
                  <tr>
                    <th>${escapeHtml(key)}</th>
                    <td>${escapeHtml(value)}</td>
                  </tr>
                `).join('')}
              ${contraindication ? `
                <tr class="contraindication-row">
                  <th>âš ï¸ ç¦å¿Œ</th>
                  <td>${escapeHtml(contraindication)}</td>
                </tr>
              ` : ''}
            </table>
          </div>
        </div>

        <!-- ã“ã ã‚ã‚Šãƒ»ç‰¹å¾´ -->
        ${content.features && content.features.length > 0 ? `
          <div class="detail-section full-width">
            <div class="section-header">
              <span class="section-icon">âœ¨</span>
              <h2 class="section-title">æ–½è¡“ã®ç‰¹å¾´ãƒ»ãƒ¡ã‚«ãƒ‹ã‚ºãƒ </h2>
            </div>
            <div class="section-content">
              <div class="features-list">
                ${content.features.map(f => `
                  <div class="feature-item">
                    <h4 class="feature-title">${escapeHtml(f.title)}</h4>
                    <p class="feature-desc">${escapeHtml(f.description)}</p>
                  </div>
                `).join('')}
              </div>
            </div>
          </div>
        ` : ''}

        <!-- FAQ -->
        ${content.faqs && content.faqs.length > 0 ? `
          <div class="detail-section full-width">
            <div class="section-header">
              <span class="section-icon">â“</span>
              <h2 class="section-title">ã‚ˆãã‚ã‚‹è³ªå•ï¼ˆã‚«ã‚¦ãƒ³ã‚»ãƒªãƒ³ã‚°å¯¾å¿œç”¨ï¼‰</h2>
            </div>
            <div class="section-content">
              <div class="faq-list">
                ${content.faqs.map((faq, i) => `
                  <div class="faq-item" data-faq="${i}">
                    <div class="faq-question">
                      <span class="faq-q-icon">Q</span>
                      <span class="faq-q-text">${escapeHtml(faq.question)}</span>
                      <span class="faq-toggle">â–¼</span>
                    </div>
                    <div class="faq-answer">
                      <p class="faq-a-text">${escapeHtml(faq.answer)}</p>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          </div>
        ` : ''}
      </div>
    `;

    // Add FAQ toggle handlers
    container.querySelectorAll('.faq-item').forEach(item => {
      item.querySelector('.faq-question')?.addEventListener('click', () => {
        item.classList.toggle('open');
      });
    });
  }

  function getEducationSlug(treatmentName: string): string {
    const slugMap: Record<string, string> = {
      'ã‚ªãƒ³ãƒ€ãƒªãƒ•ãƒˆ': 'onda-pro',
      'ã‚ªãƒ³ãƒ€ãƒ—ãƒ­': 'onda-pro',
      'HIFU': 'high-intensity-focused-ultrasound',
      'ã‚¦ãƒ«ãƒˆãƒ©ã‚»ãƒ«Zi': 'high-intensity-focused-ultrasound',
      'ãƒœãƒˆãƒƒã‚¯ã‚¹': 'botox',
      'ãƒ’ã‚¢ãƒ«ãƒ­ãƒ³é…¸': 'hyaluronic-acid-2',
      'ãƒãƒ†ãƒ³ãƒ„ã‚¡': 'potenza',
      'ãƒ”ã‚³ãƒ¬ãƒ¼ã‚¶ãƒ¼': 'pico-laser',
      'ç³¸ãƒªãƒ•ãƒˆ': 'thread-lift',
      'ãƒ•ã‚©ãƒˆãƒ•ã‚§ã‚¤ã‚·ãƒ£ãƒ«': 'stella-m22',
      'ã‚¹ãƒ†ãƒ©M22': 'stella-m22',
      'åŒ»ç™‚è„±æ¯›': 'soprano-ice-platinum',
      'ã‚½ãƒ—ãƒ©ãƒã‚¢ã‚¤ã‚¹': 'soprano-ice-platinum',
      'ã‚¢ãƒ¼ãƒˆãƒ¡ã‚¤ã‚¯': 'permanent-makeup',
      'ã‚±ã‚¢ã‚·ã‚¹': 'carecys',
      'ã‚¨ãƒªã‚·ã‚¹ã‚»ãƒ³ã‚¹': 'ellisys-sense',
      'ãƒˆãƒ©ã‚¤ãƒ•ã‚£ãƒ«ãƒ—ãƒ­': 'trifill-pro',
      'è„‚è‚ªæº¶è§£æ³¨å°„': 'lipodissolve-injection',
      'è‚Œè‚²æ³¨å°„': 'skin-boosting-injection',
      'ãƒãƒƒã‚µãƒ¼ã‚¸ãƒ”ãƒ¼ãƒ«': 'massage-peel',
      'ãƒã‚¤ãƒ‰ãƒ©ã‚¸ã‚§ãƒ³ãƒˆãƒ«': 'hydra-gentle',
      'Vã‚«ãƒ¼ãƒœãƒ³ãƒ”ãƒ¼ãƒ«': 'v-carbon-peel',
      'ã‚µãƒ–ã‚·ã‚¸ãƒ§ãƒ³': 'subcision',
      'ãƒ­ãƒ¼ãƒãƒ”ãƒ³ã‚¯': 'roma-pink',
      'LDM': 'lhala-10-ldm',
      'Eve V Muse': 'eve-v-muse',
      'ãƒŸãƒ©ãƒãƒªãƒ”ãƒ¼ãƒ«': 'milano-repeel',
      'ãƒãƒŒã‚«ãƒ”ãƒ¼ãƒ«': 'manuka-peel',
      'ãƒ©ãƒ©ãƒ‰ã‚¯ã‚¿ãƒ¼': 'lhala-doctor',
      'ã‚¸ãƒ£ãƒ«ãƒ—ãƒ­': 'jalupro-glowpeel',
      'ãƒ–ãƒ©ãƒƒã‚¯ãƒ”ãƒ¼ãƒ«': 'v-carbon-peel',
    };

    if (slugMap[treatmentName]) return slugMap[treatmentName];
    
    for (const [key, slug] of Object.entries(slugMap)) {
      if (treatmentName.includes(key) || key.includes(treatmentName)) {
        return slug;
      }
    }

    return treatmentName.toLowerCase().replace(/\s+/g, '-');
  }

  interface BreadcrumbItem {
    label: string;
    icon: string;
    level: string;
    active?: boolean;
  }

  function updateBreadcrumb(items: BreadcrumbItem[]) {
    const nav = document.getElementById('navBreadcrumb');
    if (!nav) return;

    nav.innerHTML = items.map(item => `
      <button class="breadcrumb-item ${item.active ? 'active' : ''}" data-level="${item.level}">
        <span class="breadcrumb-icon">${item.icon}</span>
        ${escapeHtml(item.label)}
      </button>
    `).join('');

    nav.querySelectorAll('.breadcrumb-item:not(.active)').forEach(btn => {
      btn.addEventListener('click', () => {
        const level = btn.getAttribute('data-level');
        navigateToLevel(level || 'category');
      });
    });
  }

  function navigateToLevel(level: string) {
    switch (level) {
      case 'category':
        currentCategory = null;
        currentSubcategory = null;
        currentTreatment = null;
        updateBreadcrumb([
          { label: 'ã‚«ãƒ†ã‚´ãƒªä¸€è¦§', icon: 'ğŸ ', level: 'category', active: true }
        ]);
        showLevel('categoryLevel');
        break;
      case 'subcategory':
        if (currentCategory) {
          currentTreatment = null;
          selectCategory(currentCategory);
        }
        break;
    }
  }

  function showLevel(levelId: string) {
    ['categoryLevel', 'subcategoryLevel', 'detailLevel'].forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        el.classList.toggle('hidden', id !== levelId);
      }
    });
  }

  document.addEventListener('DOMContentLoaded', init);
</script>
