---
import Layout from '../../components/Layout.astro';
---

<Layout>
  <div class="new-launch-page">
    <!-- Page Header -->
    <div class="page-header">
      <div class="header-left">
        <a href="/launches" class="back-link">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="15 18 9 12 15 6"></polyline>
          </svg>
          ä¸€è¦§ã«æˆ»ã‚‹
        </a>
        <h1 class="page-title">
          <span class="title-icon">ğŸš€</span>
          æ–°è¦å•†å“ã‚’ç™»éŒ²
        </h1>
        <p class="page-subtitle">åŸºæœ¬æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ç™»éŒ²å¾Œã€æ–™é‡‘ãƒ—ãƒ©ãƒ³ã‚„ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ ã§ãã¾ã™</p>
      </div>
    </div>

    <!-- Steps Guide -->
    <div class="steps-guide">
      <div class="step active">
        <div class="step-number">1</div>
        <div class="step-content">
          <span class="step-title">åŸºæœ¬æƒ…å ±ã‚’ç™»éŒ²</span>
          <span class="step-desc">å•†å“åãƒ»ã‚«ãƒ†ã‚´ãƒªãƒ»æ‹…å½“è€…</span>
        </div>
      </div>
      <div class="step-arrow">â†’</div>
      <div class="step">
        <div class="step-number">2</div>
        <div class="step-content">
          <span class="step-title">æ–™é‡‘ãƒ—ãƒ©ãƒ³ã‚’è¿½åŠ </span>
          <span class="step-desc">1å›ãƒ»ã‚³ãƒ¼ã‚¹ç­‰</span>
        </div>
      </div>
      <div class="step-arrow">â†’</div>
      <div class="step">
        <div class="step-number">3</div>
        <div class="step-content">
          <span class="step-title">ç™ºå£²å‡¦ç†</span>
          <span class="step-desc">æ–½è¡“ä¸€è¦§ã«ãƒãƒ¼ã‚¸</span>
        </div>
      </div>
    </div>

    <!-- Form -->
    <form id="launchForm" class="form-container">
      <div class="form-section">
        <h2 class="section-title">ğŸ“¦ å•†å“æƒ…å ±</h2>
        
        <div class="form-grid">
          <div class="form-group full-width">
            <label class="label required">å•†å“å</label>
            <input type="text" name="name" class="input" placeholder="ä¾‹: ã‚¯ãƒå–ã‚Šï¼ˆçµŒçµè†œè„±è„‚ï¼‰" required>
            <span class="input-hint">ç™ºå£²å¾Œã€ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªåã¨ã—ã¦ä½¿ç”¨ã•ã‚Œã¾ã™</span>
          </div>

          <div class="form-group full-width">
            <label class="label">èª¬æ˜</label>
            <textarea name="description" class="textarea" rows="2" 
              placeholder="å•†å“ã®æ¦‚è¦ï¼ˆä»»æ„ï¼‰"></textarea>
          </div>

          <div class="form-group">
            <label class="label">äºˆå®šã‚«ãƒ†ã‚´ãƒª</label>
            <select name="target_category_id" class="select" id="categorySelect">
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            </select>
            <span class="input-hint">ç™ºå£²æ™‚ã«é¸æŠã—ç›´ã›ã¾ã™</span>
          </div>

          <div class="form-group">
            <label class="label">ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªå</label>
            <input type="text" name="target_subcategory_name" class="input" 
              placeholder="å•†å“åã¨åŒã˜ãªã‚‰ç©ºæ¬„ã§OK">
          </div>
        </div>
      </div>

      <div class="form-section">
        <h2 class="section-title">ğŸ‘¤ æ‹…å½“ãƒ»ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</h2>
        
        <div class="form-grid">
          <div class="form-group">
            <label class="label">ä¸»æ‹…å½“</label>
            <input type="text" name="owner_name" class="input" placeholder="ä¾‹: é™¢é•·">
          </div>

          <div class="form-group">
            <label class="label">ç™ºå£²äºˆå®šæ—¥</label>
            <input type="date" name="target_launch_date" class="input">
          </div>

          <div class="form-group">
            <label class="label">å„ªå…ˆåº¦</label>
            <select name="priority" class="select">
              <option value="0">é€šå¸¸</option>
              <option value="5">ã‚„ã‚„é«˜ã„</option>
              <option value="10">é«˜ã„</option>
              <option value="15">æœ€å„ªå…ˆ</option>
            </select>
          </div>

          <div class="form-group">
            <label class="label">å‚™è€ƒ</label>
            <input type="text" name="notes" class="input" placeholder="ãƒ¡ãƒ¢ãŒã‚ã‚Œã°">
          </div>
        </div>
      </div>

      <div class="form-actions">
        <a href="/launches" class="btn btn-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</a>
        <button type="submit" class="btn btn-primary" id="submitBtn">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="9 11 12 14 22 4"></polyline>
            <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
          </svg>
          ç™»éŒ²ã—ã¦æ–™é‡‘ãƒ—ãƒ©ãƒ³ã‚’è¿½åŠ  â†’
        </button>
      </div>
    </form>
  </div>
</Layout>

<style>
  .new-launch-page {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    max-width: 800px;
  }

  /* Page Header */
  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
  }

  .header-left {
    flex: 1;
  }

  .back-link {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    font-size: 0.875rem;
    color: var(--color-text-muted);
    text-decoration: none;
    margin-bottom: 0.75rem;
    transition: color 0.15s ease;
  }

  .back-link:hover {
    color: var(--color-accent);
  }

  .back-link svg {
    width: 16px;
    height: 16px;
  }

  .page-title {
    display: flex;
    align-items: center;
    gap: 0.625rem;
    font-size: 1.5rem;
    font-weight: 700;
    margin: 0;
  }

  .title-icon {
    font-size: 1.75rem;
  }

  .page-subtitle {
    font-size: 0.9375rem;
    color: var(--color-text-muted);
    margin: 0.5rem 0 0;
  }

  /* Steps Guide */
  .steps-guide {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1.25rem 1.5rem;
    background: linear-gradient(135deg, var(--color-bg-card) 0%, var(--color-bg) 100%);
    border: 1px solid var(--color-border-light);
    border-radius: 16px;
    overflow-x: auto;
  }

  .step {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    background: var(--color-bg-secondary);
    border-radius: 12px;
    opacity: 0.5;
    transition: all 0.2s ease;
  }

  .step.active {
    opacity: 1;
    background: linear-gradient(135deg, var(--color-accent) 0%, #c99a45 100%);
  }

  .step-number {
    width: 28px;
    height: 28px;
    background: rgba(255, 255, 255, 0.9);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8125rem;
    font-weight: 700;
    color: var(--color-primary);
  }

  .step.active .step-number {
    background: var(--color-primary);
    color: var(--color-accent);
  }

  .step-content {
    display: flex;
    flex-direction: column;
    gap: 0.125rem;
  }

  .step-title {
    font-size: 0.8125rem;
    font-weight: 600;
    color: var(--color-text);
  }

  .step.active .step-title {
    color: var(--color-primary);
  }

  .step-desc {
    font-size: 0.6875rem;
    color: var(--color-text-muted);
  }

  .step.active .step-desc {
    color: var(--color-primary);
    opacity: 0.8;
  }

  .step-arrow {
    color: var(--color-text-muted);
    font-size: 1rem;
    flex-shrink: 0;
  }

  /* Form */
  .form-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .form-section {
    background: var(--color-bg-card);
    border: 1px solid var(--color-border-light);
    border-radius: 16px;
    padding: 1.5rem;
  }

  .section-title {
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: 1.25rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid var(--color-border-light);
  }

  .form-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.375rem;
  }

  .form-group.full-width {
    grid-column: span 2;
  }

  .label {
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--color-text-secondary);
  }

  .label.required::after {
    content: ' *';
    color: #dc2626;
  }

  .input, .select, .textarea {
    padding: 0.625rem 0.875rem;
    border: 1px solid var(--color-border);
    border-radius: 8px;
    font-size: 0.9375rem;
    background: var(--color-bg);
    transition: border-color 0.15s ease;
  }

  .input:focus, .select:focus, .textarea:focus {
    outline: none;
    border-color: var(--color-accent);
  }

  .textarea {
    resize: vertical;
    min-height: 60px;
  }

  .input-hint {
    font-size: 0.75rem;
    color: var(--color-text-muted);
  }

  .form-actions {
    display: flex;
    justify-content: flex-end;
    gap: 0.75rem;
    padding-top: 0.5rem;
  }

  /* Buttons */
  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    border-radius: 10px;
    font-size: 0.9375rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s ease;
    text-decoration: none;
    border: none;
  }

  .btn svg {
    width: 16px;
    height: 16px;
  }

  .btn-primary {
    background: linear-gradient(135deg, var(--color-accent) 0%, #c99a45 100%);
    color: var(--color-primary);
    box-shadow: 0 4px 12px rgba(212, 168, 83, 0.3);
  }

  .btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 6px 16px rgba(212, 168, 83, 0.4);
  }

  .btn-secondary {
    background: var(--color-bg-secondary);
    color: var(--color-text);
    border: 1px solid var(--color-border);
  }

  .btn-secondary:hover {
    background: var(--color-bg-hover);
  }

  @media (max-width: 640px) {
    .form-grid {
      grid-template-columns: 1fr;
    }

    .form-group.full-width {
      grid-column: span 1;
    }

    .steps-guide {
      padding: 1rem;
    }

    .step-desc {
      display: none;
    }

    .step-content {
      display: none;
    }
  }
</style>

<script>
  async function loadCategories() {
    try {
      const res = await fetch('/api/categories');
      const data = await res.json();
      
      const select = document.getElementById('categorySelect') as HTMLSelectElement;
      if (select && data.categories) {
        data.categories.forEach((cat: { id: number; name: string }) => {
          const option = document.createElement('option');
          option.value = String(cat.id);
          option.textContent = cat.name;
          select.appendChild(option);
        });
      }
    } catch (error) {
      console.error('Error loading categories:', error);
    }
  }

  async function handleSubmit(e: Event) {
    e.preventDefault();
    
    const submitBtn = document.getElementById('submitBtn') as HTMLButtonElement;
    submitBtn.disabled = true;
    submitBtn.textContent = 'ç™»éŒ²ä¸­...';

    const form = e.target as HTMLFormElement;
    const formData = new FormData(form);
    
    const data: Record<string, any> = {
      status: 'planning' // åˆæœŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
    };
    
    formData.forEach((value, key) => {
      if (value) {
        if (key === 'priority' || key === 'target_category_id') {
          data[key] = parseInt(value as string) || null;
        } else {
          data[key] = value;
        }
      }
    });

    // ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªåãŒç©ºãªã‚‰å•†å“åã‚’ä½¿ç”¨
    if (!data.target_subcategory_name && data.name) {
      data.target_subcategory_name = data.name;
    }

    try {
      const res = await fetch('/api/product-launches', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      const result = await res.json();
      
      if (res.ok && result.success) {
        // ç·¨é›†ãƒšãƒ¼ã‚¸ã®æ–™é‡‘ãƒ—ãƒ©ãƒ³ã‚¿ãƒ–ã¸é·ç§»
        window.location.href = `/launches/${result.id}/edit?tab=plans`;
      } else {
        alert(result.error || 'ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ');
        submitBtn.disabled = false;
        submitBtn.innerHTML = `
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="9 11 12 14 22 4"></polyline>
            <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
          </svg>
          ç™»éŒ²ã—ã¦æ–™é‡‘ãƒ—ãƒ©ãƒ³ã‚’è¿½åŠ  â†’
        `;
      }
    } catch (error) {
      console.error('Error creating launch:', error);
      alert('ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ');
      submitBtn.disabled = false;
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    loadCategories();
    
    const form = document.getElementById('launchForm');
    form?.addEventListener('submit', handleSubmit);
  });
</script>
