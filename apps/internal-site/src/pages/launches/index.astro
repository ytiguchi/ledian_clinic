---
import Layout from '../../components/Layout.astro';
---

<Layout>
  <div class="launches-page">
    <!-- Page Header -->
    <div class="page-header">
      <div>
        <h1 class="page-title">ç™ºå£²äºˆå®šå•†å“</h1>
        <p class="page-subtitle">æ–°å•†å“ã®ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’ç®¡ç†ã—ã¾ã™</p>
      </div>
      <a href="/launches/new" class="btn btn-primary">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        æ–°è¦å•†å“
      </a>
    </div>

    <!-- Status Filter -->
    <div class="filter-bar">
      <div class="status-tabs">
        <button class="status-tab active" data-status="">ã™ã¹ã¦</button>
        <button class="status-tab" data-status="planning">ä¼ç”»ä¸­</button>
        <button class="status-tab" data-status="pricing">æ–™é‡‘æ±ºå®šä¸­</button>
        <button class="status-tab" data-status="protocol">ãƒ—ãƒ­ãƒˆã‚³ãƒ«</button>
        <button class="status-tab" data-status="training">ç ”ä¿®ä¸­</button>
        <button class="status-tab" data-status="ready">ç™ºå£²æº–å‚™</button>
        <button class="status-tab" data-status="launched">ç™ºå£²æ¸ˆã¿</button>
      </div>
    </div>

    <!-- Pipeline Board -->
    <div class="pipeline-board" id="pipelineBoard">
      <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>
  </div>
</Layout>

<style>
  .launches-page {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .status-tabs {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .status-tab {
    padding: 0.5rem 1rem;
    border: 1px solid var(--color-border);
    background: var(--color-bg);
    border-radius: var(--radius-md);
    font-size: 0.875rem;
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .status-tab:hover {
    background: var(--color-bg-hover);
  }

  .status-tab.active {
    background: var(--color-accent);
    border-color: var(--color-accent);
    color: var(--color-primary);
    font-weight: 600;
  }

  .pipeline-board {
    display: grid;
    gap: 1rem;
  }

  /* Card */
  .launch-card {
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: 1.25rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    transition: all var(--transition-fast);
  }

  .launch-card:hover {
    border-color: var(--color-accent);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
  }

  .launch-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 1rem;
  }

  .launch-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--color-text);
    margin: 0;
  }

  .launch-owner {
    font-size: 0.8125rem;
    color: var(--color-text-muted);
    margin-top: 0.25rem;
  }

  .launch-status {
    padding: 0.25rem 0.75rem;
    border-radius: var(--radius-full);
    font-size: 0.75rem;
    font-weight: 600;
    white-space: nowrap;
  }

  .status-planning { background: #f3f4f6; color: #374151; }
  .status-pricing { background: #fef3c7; color: #92400e; }
  .status-protocol { background: #dbeafe; color: #1e40af; }
  .status-training { background: #e0e7ff; color: #3730a3; }
  .status-ready { background: #d1fae5; color: #065f46; }
  .status-launched { background: #10b981; color: white; }
  .status-cancelled { background: #fee2e2; color: #991b1b; }

  .launch-meta {
    display: flex;
    gap: 1.5rem;
    flex-wrap: wrap;
    font-size: 0.875rem;
    color: var(--color-text-secondary);
  }

  .meta-item {
    display: flex;
    align-items: center;
    gap: 0.375rem;
  }

  .meta-icon {
    opacity: 0.6;
  }

  /* Progress Bar */
  .progress-container {
    display: flex;
    flex-direction: column;
    gap: 0.375rem;
  }

  .progress-label {
    display: flex;
    justify-content: space-between;
    font-size: 0.75rem;
    color: var(--color-text-muted);
  }

  .progress-bar {
    height: 6px;
    background: var(--color-bg-hover);
    border-radius: var(--radius-full);
    overflow: hidden;
  }

  .progress-fill {
    height: 100%;
    background: var(--color-accent);
    border-radius: var(--radius-full);
    transition: width 0.3s ease;
  }

  /* System Registration */
  .system-badges {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .system-badge {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.25rem 0.5rem;
    border-radius: var(--radius-sm);
    font-size: 0.6875rem;
    font-weight: 500;
  }

  .system-badge.registered {
    background: #d1fae5;
    color: #065f46;
  }

  .system-badge.pending {
    background: #f3f4f6;
    color: #6b7280;
  }

  .system-icon {
    width: 10px;
    height: 10px;
  }

  /* Actions */
  .launch-actions {
    display: flex;
    gap: 0.5rem;
    margin-top: auto;
    padding-top: 1rem;
    border-top: 1px solid var(--color-border);
  }

  .action-btn {
    flex: 1;
    padding: 0.5rem;
    font-size: 0.8125rem;
    font-weight: 500;
    border: 1px solid var(--color-border);
    background: var(--color-bg);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all var(--transition-fast);
    text-decoration: none;
    text-align: center;
    color: var(--color-text);
  }

  .action-btn:hover {
    background: var(--color-bg-hover);
  }

  .action-btn-primary {
    background: var(--color-accent);
    border-color: var(--color-accent);
    color: var(--color-primary);
  }

  .action-btn-primary:hover {
    background: var(--color-accent-dark);
  }

  .action-btn-success {
    background: #10b981;
    border-color: #10b981;
    color: white;
  }

  .action-btn-success:hover {
    background: #059669;
  }

  /* Empty State */
  .empty-state {
    text-align: center;
    padding: 3rem;
    color: var(--color-text-muted);
  }

  .empty-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
  }

  @media (min-width: 768px) {
    .pipeline-board {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (min-width: 1200px) {
    .pipeline-board {
      grid-template-columns: repeat(3, 1fr);
    }
  }
</style>

<script>
  interface Launch {
    id: number;
    name: string;
    description: string | null;
    status: string;
    target_launch_date: string | null;
    owner_name: string | null;
    category_name: string | null;
    planned_price_taxed: number | null;
    total_tasks: number;
    completed_tasks: number;
    web_registered_at: string | null;
    smaregi_registered_at: string | null;
    medical_force_registered_at: string | null;
  }

  let launches: Launch[] = [];
  let selectedStatus = '';

  const statusLabels: Record<string, string> = {
    planning: 'ä¼ç”»ä¸­',
    pricing: 'æ–™é‡‘æ±ºå®šä¸­',
    protocol: 'ãƒ—ãƒ­ãƒˆã‚³ãƒ«',
    training: 'ç ”ä¿®ä¸­',
    ready: 'ç™ºå£²æº–å‚™',
    launched: 'ç™ºå£²æ¸ˆã¿',
    cancelled: 'ä¸­æ­¢'
  };

  async function loadLaunches() {
    try {
      const params = new URLSearchParams();
      if (selectedStatus) params.append('status', selectedStatus);
      
      const res = await fetch(`/api/product-launches?${params.toString()}`);
      const data = await res.json();
      
      if (data.error) {
        showError(data.message || data.error);
        return;
      }
      
      launches = data.launches || [];
      renderBoard();
    } catch (error) {
      console.error('Error loading launches:', error);
      showError('èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  }

  function renderBoard() {
    const board = document.getElementById('pipelineBoard');
    if (!board) return;

    if (launches.length === 0) {
      board.innerHTML = `
        <div class="empty-state">
          <div class="empty-icon">ğŸ“¦</div>
          <div>ç™ºå£²äºˆå®šå•†å“ãŒã‚ã‚Šã¾ã›ã‚“</div>
          <a href="/launches/new" class="btn btn-primary" style="margin-top: 1rem;">æ–°è¦å•†å“ã‚’è¿½åŠ </a>
        </div>
      `;
      return;
    }

    board.innerHTML = launches.map(launch => {
      const progress = launch.total_tasks > 0 
        ? Math.round((launch.completed_tasks / launch.total_tasks) * 100) 
        : 0;
      
      return `
        <div class="launch-card">
          <div class="launch-header">
            <div>
              <h3 class="launch-title">${escapeHtml(launch.name)}</h3>
              ${launch.owner_name ? `<div class="launch-owner">æ‹…å½“: ${escapeHtml(launch.owner_name)}</div>` : ''}
            </div>
            <span class="launch-status status-${launch.status}">
              ${statusLabels[launch.status] || launch.status}
            </span>
          </div>
          
          <div class="launch-meta">
            ${launch.target_launch_date ? `
              <span class="meta-item">
                <span class="meta-icon">ğŸ“…</span>
                ${formatDate(launch.target_launch_date)}
              </span>
            ` : ''}
            ${launch.planned_price_taxed ? `
              <span class="meta-item">
                <span class="meta-icon">ğŸ’°</span>
                Â¥${launch.planned_price_taxed.toLocaleString()}
              </span>
            ` : ''}
            ${launch.category_name ? `
              <span class="meta-item">
                <span class="meta-icon">ğŸ“</span>
                ${escapeHtml(launch.category_name)}
              </span>
            ` : ''}
          </div>

          <div class="progress-container">
            <div class="progress-label">
              <span>ã‚¿ã‚¹ã‚¯é€²æ—</span>
              <span>${launch.completed_tasks}/${launch.total_tasks}</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" style="width: ${progress}%"></div>
            </div>
          </div>

          <div class="system-badges">
            <span class="system-badge ${launch.web_registered_at ? 'registered' : 'pending'}">
              ${launch.web_registered_at ? 'âœ“' : 'â—‹'} WEB
            </span>
            <span class="system-badge ${launch.smaregi_registered_at ? 'registered' : 'pending'}">
              ${launch.smaregi_registered_at ? 'âœ“' : 'â—‹'} ã‚¹ãƒãƒ¬ã‚¸
            </span>
            <span class="system-badge ${launch.medical_force_registered_at ? 'registered' : 'pending'}">
              ${launch.medical_force_registered_at ? 'âœ“' : 'â—‹'} MF
            </span>
          </div>

          <div class="launch-actions">
            <a href="/launches/${launch.id}/edit" class="action-btn">è©³ç´°ãƒ»ç·¨é›†</a>
            ${launch.status === 'ready' ? `
              <button onclick="openLaunchModal(${launch.id})" class="action-btn action-btn-success">ç™ºå£²ã™ã‚‹</button>
            ` : ''}
          </div>
        </div>
      `;
    }).join('');
  }

  function formatDate(dateStr: string): string {
    const date = new Date(dateStr);
    return `${date.getFullYear()}/${date.getMonth() + 1}/${date.getDate()}`;
  }

  function escapeHtml(text: string): string {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function showError(message: string) {
    const board = document.getElementById('pipelineBoard');
    if (board) {
      board.innerHTML = `
        <div class="empty-state" style="color: var(--color-error)">
          <div class="empty-icon">âš ï¸</div>
          <div>${escapeHtml(message)}</div>
        </div>
      `;
    }
  }

  function openLaunchModal(id: number) {
    // ç™ºå£²ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãï¼ˆç·¨é›†ãƒšãƒ¼ã‚¸ã«é·ç§»ã—ã¦ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºï¼‰
    window.location.href = `/launches/${id}/edit?action=launch`;
  }

  document.addEventListener('DOMContentLoaded', () => {
    loadLaunches();

    // Status tab click
    document.querySelectorAll('.status-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.status-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        selectedStatus = (tab as HTMLElement).dataset.status || '';
        loadLaunches();
      });
    });
  });

  (window as any).openLaunchModal = openLaunchModal;
</script>

