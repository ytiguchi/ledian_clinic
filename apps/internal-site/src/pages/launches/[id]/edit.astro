---
import Layout from '../../../components/Layout.astro';

const { id } = Astro.params;
---

<Layout>
  <div class="edit-launch-page" data-launch-id={id}>
    <!-- Page Header -->
    <div class="page-header">
      <div>
        <a href="/launches" class="back-link">â† ç™ºå£²äºˆå®šå•†å“ä¸€è¦§</a>
        <h1 class="page-title" id="pageTitle">èª­ã¿è¾¼ã¿ä¸­...</h1>
      </div>
      <div class="header-actions">
        <span class="launch-status" id="statusBadge"></span>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" data-tab="details">åŸºæœ¬æƒ…å ±</button>
      <button class="tab" data-tab="tasks">ã‚¿ã‚¹ã‚¯</button>
      <button class="tab" data-tab="systems">ã‚·ã‚¹ãƒ†ãƒ ç™»éŒ²</button>
    </div>

    <!-- Tab Content: Details -->
    <div class="tab-content active" id="tab-details">
      <form id="launchForm" class="form-container">
        <div class="form-section">
          <h2 class="section-title">åŸºæœ¬æƒ…å ±</h2>
          
          <div class="form-grid">
            <div class="form-group full-width">
              <label class="label required">å•†å“å</label>
              <input type="text" name="name" class="input" required>
            </div>

            <div class="form-group full-width">
              <label class="label">èª¬æ˜</label>
              <textarea name="description" class="textarea" rows="3"></textarea>
            </div>

            <div class="form-group">
              <label class="label">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
              <select name="status" class="select" id="statusSelect">
                <option value="planning">ä¼ç”»ä¸­</option>
                <option value="pricing">æ–™é‡‘æ±ºå®šä¸­</option>
                <option value="protocol">ãƒ—ãƒ­ãƒˆã‚³ãƒ«ç­–å®šä¸­</option>
                <option value="training">ç ”ä¿®ä¸­</option>
                <option value="ready">ç™ºå£²æº–å‚™å®Œäº†</option>
                <option value="launched">ç™ºå£²æ¸ˆã¿</option>
                <option value="cancelled">ä¸­æ­¢</option>
              </select>
            </div>

            <div class="form-group">
              <label class="label">äºˆå®šã‚«ãƒ†ã‚´ãƒª</label>
              <select name="target_category_id" class="select" id="categorySelect">
                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              </select>
            </div>

            <div class="form-group">
              <label class="label">ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªå</label>
              <input type="text" name="target_subcategory_name" class="input">
            </div>

            <div class="form-group">
              <label class="label">ä¸»æ‹…å½“</label>
              <input type="text" name="owner_name" class="input">
            </div>
          </div>
        </div>

        <div class="form-section">
          <h2 class="section-title">æ–™é‡‘æƒ…å ±</h2>
          
          <div class="form-grid">
            <div class="form-group">
              <label class="label">äºˆå®šä¾¡æ ¼ï¼ˆç¨æŠœï¼‰</label>
              <div class="input-group">
                <span class="input-prefix">Â¥</span>
                <input type="number" name="planned_price" class="input">
              </div>
            </div>

            <div class="form-group">
              <label class="label">äºˆå®šä¾¡æ ¼ï¼ˆç¨è¾¼ï¼‰</label>
              <div class="input-group">
                <span class="input-prefix">Â¥</span>
                <input type="number" name="planned_price_taxed" class="input">
              </div>
            </div>

            <div class="form-group full-width">
              <label class="label">æ–™é‡‘å‚™è€ƒ</label>
              <textarea name="price_notes" class="textarea" rows="2"></textarea>
            </div>
          </div>
        </div>

        <div class="form-section">
          <h2 class="section-title">ãƒ—ãƒ­ãƒˆã‚³ãƒ«ãƒ»ç ”ä¿®</h2>
          
          <div class="form-grid">
            <div class="form-group full-width">
              <label class="label">ãƒ—ãƒ­ãƒˆã‚³ãƒ«å‚™è€ƒ</label>
              <textarea name="protocol_notes" class="textarea" rows="2"></textarea>
            </div>

            <div class="form-group full-width">
              <label class="label">ç ”ä¿®å‚™è€ƒ</label>
              <textarea name="training_notes" class="textarea" rows="2"></textarea>
            </div>
          </div>
        </div>

        <div class="form-section">
          <h2 class="section-title">ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</h2>
          
          <div class="form-grid">
            <div class="form-group">
              <label class="label">ç™ºå£²äºˆå®šæ—¥</label>
              <input type="date" name="target_launch_date" class="input">
            </div>

            <div class="form-group">
              <label class="label">å„ªå…ˆåº¦</label>
              <select name="priority" class="select">
                <option value="0">é€šå¸¸</option>
                <option value="5">ã‚„ã‚„é«˜ã„</option>
                <option value="10">é«˜ã„</option>
                <option value="15">æœ€å„ªå…ˆ</option>
              </select>
            </div>
          </div>
        </div>

        <div class="form-section">
          <div class="form-group full-width">
            <label class="label">å‚™è€ƒ</label>
            <textarea name="notes" class="textarea" rows="3"></textarea>
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-danger" id="deleteBtn">å‰Šé™¤</button>
          <div style="flex: 1;"></div>
          <a href="/launches" class="btn btn-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</a>
          <button type="submit" class="btn btn-primary">ä¿å­˜</button>
        </div>
      </form>
    </div>

    <!-- Tab Content: Tasks -->
    <div class="tab-content" id="tab-tasks">
      <div class="tasks-container">
        <div class="tasks-header">
          <h2 class="section-title" style="margin: 0;">ã‚¿ã‚¹ã‚¯ä¸€è¦§</h2>
          <button class="btn btn-sm btn-primary" id="addTaskBtn">+ ã‚¿ã‚¹ã‚¯è¿½åŠ </button>
        </div>
        <div id="tasksList" class="tasks-list">
          <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>
      </div>
    </div>

    <!-- Tab Content: Systems -->
    <div class="tab-content" id="tab-systems">
      <div class="systems-container">
        <div class="system-card">
          <div class="system-header">
            <h3>WEB ã‚µã‚¤ãƒˆ</h3>
            <span class="system-status" id="webStatus">æœªç™»éŒ²</span>
          </div>
          <p class="system-desc">å…¬é–‹ã‚µã‚¤ãƒˆã¸ã®å•†å“ç™»éŒ²</p>
          <div id="webRegisteredAt" class="system-date"></div>
        </div>

        <div class="system-card">
          <div class="system-header">
            <h3>ã‚¹ãƒãƒ¬ã‚¸</h3>
            <span class="system-status" id="smaregiStatus">æœªç™»éŒ²</span>
          </div>
          <p class="system-desc">POSãƒ¬ã‚¸ã¸ã®å•†å“ç™»éŒ²</p>
          <div class="form-group" style="margin-top: 0.5rem;">
            <input type="text" id="smaregiCode" class="input" placeholder="å•†å“ã‚³ãƒ¼ãƒ‰">
          </div>
          <div id="smaregiRegisteredAt" class="system-date"></div>
        </div>

        <div class="system-card">
          <div class="system-header">
            <h3>ãƒ¡ãƒ‡ã‚£ã‚«ãƒ«ãƒ•ã‚©ãƒ¼ã‚¹</h3>
            <span class="system-status" id="mfStatus">æœªç™»éŒ²</span>
          </div>
          <p class="system-desc">é›»å­ã‚«ãƒ«ãƒ†ã¸ã®å•†å“ç™»éŒ²</p>
          <div class="form-group" style="margin-top: 0.5rem;">
            <input type="text" id="mfId" class="input" placeholder="å•†å“ID">
          </div>
          <div id="mfRegisteredAt" class="system-date"></div>
        </div>
      </div>

      <div class="launch-section" id="launchSection" style="display: none;">
        <div class="launch-card">
          <h2>ğŸš€ ç™ºå£²å‡¦ç†</h2>
          <p>ã™ã¹ã¦ã®æº–å‚™ãŒå®Œäº†ã—ãŸã‚‰ã€ã“ã®å•†å“ã‚’ç™ºå£²ã—ã¦æ—¢å­˜ã®å•†å“ä¸€è¦§ã«ãƒãƒ¼ã‚¸ã—ã¾ã™ã€‚</p>
          
          <div class="form-grid" style="margin-top: 1rem;">
            <div class="form-group">
              <label class="label required">ã‚«ãƒ†ã‚´ãƒª</label>
              <select id="launchCategoryId" class="select" required>
                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              </select>
            </div>
            <div class="form-group">
              <label class="label required">ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªå</label>
              <input type="text" id="launchSubcategoryName" class="input" required>
            </div>
            <div class="form-group">
              <label class="label required">ã‚¹ãƒ©ãƒƒã‚°ï¼ˆURLç”¨ï¼‰</label>
              <input type="text" id="launchSubcategorySlug" class="input" placeholder="ä¾‹: kuma-tori" required>
            </div>
            <div class="form-group">
              <label class="label">ãƒ—ãƒ©ãƒ³å</label>
              <input type="text" id="launchPlanName" class="input" value="1å›">
            </div>
          </div>

          <div class="launch-checklist">
            <label class="checkbox-item">
              <input type="checkbox" id="launchWebRegister"> WEBã‚µã‚¤ãƒˆã«ã‚‚ç™»éŒ²ã™ã‚‹
            </label>
          </div>

          <button class="btn btn-success btn-lg" id="launchBtn">
            ğŸ‰ ç™ºå£²ã™ã‚‹ï¼ˆå•†å“ä¸€è¦§ã«ãƒãƒ¼ã‚¸ï¼‰
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Task Modal -->
  <div class="modal" id="addTaskModal">
    <div class="modal-content">
      <h3>ã‚¿ã‚¹ã‚¯è¿½åŠ </h3>
      <form id="addTaskForm">
        <div class="form-group">
          <label class="label">ã‚¿ã‚¹ã‚¯ç¨®åˆ¥</label>
          <select name="task_type" class="select" required>
            <option value="pricing">æ–™é‡‘æ±ºå®š</option>
            <option value="protocol">ãƒ—ãƒ­ãƒˆã‚³ãƒ«ç­–å®š</option>
            <option value="training_material">ç ”ä¿®è³‡æ–™ä½œæˆ</option>
            <option value="training_session">ç ”ä¿®å®Ÿæ–½</option>
            <option value="web_register">WEBç™»éŒ²</option>
            <option value="smaregi_register">ã‚¹ãƒãƒ¬ã‚¸ç™»éŒ²</option>
            <option value="medical_force_register">ãƒ¡ãƒ‡ã‚£ã‚«ãƒ«ãƒ•ã‚©ãƒ¼ã‚¹ç™»éŒ²</option>
            <option value="photo_prepare">å†™çœŸæº–å‚™</option>
            <option value="marketing">ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°æº–å‚™</option>
            <option value="other">ãã®ä»–</option>
          </select>
        </div>
        <div class="form-group">
          <label class="label required">ã‚¿ã‚¤ãƒˆãƒ«</label>
          <input type="text" name="title" class="input" required>
        </div>
        <div class="form-group">
          <label class="label">æœŸé™</label>
          <input type="date" name="due_date" class="input">
        </div>
        <div class="form-group">
          <label class="label">æ‹…å½“è€…</label>
          <input type="text" name="assignee" class="input">
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button type="submit" class="btn btn-primary">è¿½åŠ </button>
        </div>
      </form>
    </div>
  </div>
</Layout>

<style>
  .edit-launch-page {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    max-width: 900px;
  }

  .back-link {
    font-size: 0.875rem;
    color: var(--color-text-muted);
    text-decoration: none;
    margin-bottom: 0.5rem;
    display: inline-block;
  }

  .header-actions {
    display: flex;
    gap: 0.75rem;
    align-items: center;
  }

  .launch-status {
    padding: 0.375rem 1rem;
    border-radius: var(--radius-full);
    font-size: 0.875rem;
    font-weight: 600;
  }

  /* Tabs */
  .tabs {
    display: flex;
    gap: 0.25rem;
    background: var(--color-bg);
    padding: 0.25rem;
    border-radius: var(--radius-lg);
    border: 1px solid var(--color-border);
  }

  .tab {
    flex: 1;
    padding: 0.75rem 1rem;
    border: none;
    background: transparent;
    border-radius: var(--radius-md);
    font-size: 0.9375rem;
    font-weight: 500;
    cursor: pointer;
    transition: all var(--transition-fast);
    color: var(--color-text-secondary);
  }

  .tab:hover {
    background: var(--color-bg-hover);
  }

  .tab.active {
    background: var(--color-accent);
    color: var(--color-primary);
  }

  .tab-content {
    display: none;
  }

  .tab-content.active {
    display: block;
  }

  /* Form */
  .form-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .form-section {
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
  }

  .section-title {
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: 1.25rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid var(--color-border);
  }

  .form-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.375rem;
  }

  .form-group.full-width {
    grid-column: span 2;
  }

  .label {
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--color-text-secondary);
  }

  .label.required::after {
    content: ' *';
    color: var(--color-error);
  }

  .input, .select, .textarea {
    padding: 0.625rem 0.875rem;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    font-size: 0.9375rem;
    background: var(--color-bg);
  }

  .input:focus, .select:focus, .textarea:focus {
    outline: none;
    border-color: var(--color-accent);
  }

  .input-group {
    display: flex;
    align-items: center;
  }

  .input-prefix {
    padding: 0.625rem 0.75rem;
    background: var(--color-bg-hover);
    border: 1px solid var(--color-border);
    border-right: none;
    border-radius: var(--radius-md) 0 0 var(--radius-md);
    color: var(--color-text-muted);
  }

  .input-group .input {
    border-radius: 0 var(--radius-md) var(--radius-md) 0;
    flex: 1;
  }

  .form-actions {
    display: flex;
    gap: 0.75rem;
    padding-top: 1rem;
  }

  .btn-danger {
    background: var(--color-error-light);
    color: #b91c1c;
    border: 1px solid transparent;
  }

  .btn-danger:hover {
    background: var(--color-error);
    color: white;
  }

  /* Tasks */
  .tasks-container {
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
  }

  .tasks-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
  }

  .tasks-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .task-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    background: var(--color-bg-secondary);
    border-radius: var(--radius-md);
    border: 1px solid var(--color-border);
  }

  .task-item.completed {
    opacity: 0.6;
  }

  .task-checkbox {
    width: 20px;
    height: 20px;
    cursor: pointer;
  }

  .task-info {
    flex: 1;
  }

  .task-title {
    font-weight: 500;
  }

  .task-meta {
    font-size: 0.75rem;
    color: var(--color-text-muted);
    margin-top: 0.25rem;
  }

  .task-type-badge {
    font-size: 0.6875rem;
    padding: 0.125rem 0.5rem;
    background: var(--color-bg-hover);
    border-radius: var(--radius-sm);
    color: var(--color-text-secondary);
  }

  /* Systems */
  .systems-container {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
  }

  .system-card {
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: 1.25rem;
  }

  .system-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
  }

  .system-header h3 {
    font-size: 1rem;
    margin: 0;
  }

  .system-status {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
    border-radius: var(--radius-sm);
    background: #f3f4f6;
    color: #6b7280;
  }

  .system-status.registered {
    background: #d1fae5;
    color: #065f46;
  }

  .system-desc {
    font-size: 0.8125rem;
    color: var(--color-text-muted);
    margin: 0;
  }

  .system-date {
    font-size: 0.75rem;
    color: var(--color-text-muted);
    margin-top: 0.5rem;
  }

  /* Launch Section */
  .launch-section {
    margin-top: 2rem;
  }

  .launch-card {
    background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
    border: 2px solid #86efac;
    border-radius: var(--radius-lg);
    padding: 2rem;
  }

  .launch-card h2 {
    margin: 0 0 0.5rem 0;
    font-size: 1.25rem;
  }

  .launch-card p {
    color: var(--color-text-secondary);
    margin: 0;
  }

  .launch-checklist {
    margin: 1rem 0;
  }

  .checkbox-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
  }

  .btn-success {
    background: #10b981;
    color: white;
    border: none;
  }

  .btn-success:hover {
    background: #059669;
  }

  .btn-lg {
    padding: 0.875rem 2rem;
    font-size: 1rem;
  }

  /* Modal */
  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
  }

  .modal.open {
    display: flex;
  }

  .modal-content {
    background: var(--color-bg);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    width: 100%;
    max-width: 400px;
  }

  .modal-content h3 {
    margin: 0 0 1rem 0;
  }

  .modal-actions {
    display: flex;
    justify-content: flex-end;
    gap: 0.5rem;
    margin-top: 1rem;
  }

  @media (max-width: 768px) {
    .form-grid {
      grid-template-columns: 1fr;
    }

    .form-group.full-width {
      grid-column: span 1;
    }

    .systems-container {
      grid-template-columns: 1fr;
    }

    .tabs {
      flex-wrap: wrap;
    }
  }
</style>

<script>
  const launchId = document.querySelector('.edit-launch-page')?.getAttribute('data-launch-id');
  let launchData: any = null;
  let tasksData: any[] = [];

  const statusLabels: Record<string, string> = {
    planning: 'ä¼ç”»ä¸­',
    pricing: 'æ–™é‡‘æ±ºå®šä¸­',
    protocol: 'ãƒ—ãƒ­ãƒˆã‚³ãƒ«ç­–å®šä¸­',
    training: 'ç ”ä¿®ä¸­',
    ready: 'ç™ºå£²æº–å‚™å®Œäº†',
    launched: 'ç™ºå£²æ¸ˆã¿',
    cancelled: 'ä¸­æ­¢'
  };

  const taskTypeLabels: Record<string, string> = {
    pricing: 'æ–™é‡‘',
    protocol: 'ãƒ—ãƒ­ãƒˆã‚³ãƒ«',
    training_material: 'ç ”ä¿®è³‡æ–™',
    training_session: 'ç ”ä¿®',
    web_register: 'WEB',
    smaregi_register: 'ã‚¹ãƒãƒ¬ã‚¸',
    medical_force_register: 'MF',
    photo_prepare: 'å†™çœŸ',
    marketing: 'ãƒãƒ¼ã‚±',
    other: 'ãã®ä»–'
  };

  async function loadData() {
    try {
      const res = await fetch(`/api/product-launches/${launchId}`);
      const data = await res.json();
      
      if (data.error) {
        alert(data.message || data.error);
        return;
      }

      launchData = data.launch;
      tasksData = data.tasks || [];
      
      populateForm();
      renderTasks();
      updateSystemsTab();
      updateStatusBadge();
    } catch (error) {
      console.error('Error loading data:', error);
    }
  }

  async function loadCategories() {
    try {
      const res = await fetch('/api/categories');
      const data = await res.json();
      
      const selects = ['categorySelect', 'launchCategoryId'];
      selects.forEach(selectId => {
        const select = document.getElementById(selectId) as HTMLSelectElement;
        if (select && data.categories) {
          data.categories.forEach((cat: { id: number; name: string }) => {
            const option = document.createElement('option');
            option.value = String(cat.id);
            option.textContent = cat.name;
            select.appendChild(option);
          });
        }
      });
    } catch (error) {
      console.error('Error loading categories:', error);
    }
  }

  function populateForm() {
    if (!launchData) return;

    document.getElementById('pageTitle')!.textContent = launchData.name;

    const form = document.getElementById('launchForm') as HTMLFormElement;
    
    (form.querySelector('[name="name"]') as HTMLInputElement).value = launchData.name || '';
    (form.querySelector('[name="description"]') as HTMLTextAreaElement).value = launchData.description || '';
    (form.querySelector('[name="status"]') as HTMLSelectElement).value = launchData.status || 'planning';
    (form.querySelector('[name="target_category_id"]') as HTMLSelectElement).value = launchData.target_category_id || '';
    (form.querySelector('[name="target_subcategory_name"]') as HTMLInputElement).value = launchData.target_subcategory_name || '';
    (form.querySelector('[name="owner_name"]') as HTMLInputElement).value = launchData.owner_name || '';
    (form.querySelector('[name="planned_price"]') as HTMLInputElement).value = launchData.planned_price || '';
    (form.querySelector('[name="planned_price_taxed"]') as HTMLInputElement).value = launchData.planned_price_taxed || '';
    (form.querySelector('[name="price_notes"]') as HTMLTextAreaElement).value = launchData.price_notes || '';
    (form.querySelector('[name="protocol_notes"]') as HTMLTextAreaElement).value = launchData.protocol_notes || '';
    (form.querySelector('[name="training_notes"]') as HTMLTextAreaElement).value = launchData.training_notes || '';
    (form.querySelector('[name="target_launch_date"]') as HTMLInputElement).value = launchData.target_launch_date?.split('T')[0] || '';
    (form.querySelector('[name="priority"]') as HTMLSelectElement).value = String(launchData.priority || 0);
    (form.querySelector('[name="notes"]') as HTMLTextAreaElement).value = launchData.notes || '';

    // Launch form defaults
    (document.getElementById('launchSubcategoryName') as HTMLInputElement).value = launchData.target_subcategory_name || launchData.name || '';
    (document.getElementById('launchCategoryId') as HTMLSelectElement).value = launchData.target_category_id || '';
  }

  function updateStatusBadge() {
    if (!launchData) return;
    const badge = document.getElementById('statusBadge')!;
    badge.textContent = statusLabels[launchData.status] || launchData.status;
    badge.className = `launch-status status-${launchData.status}`;
    badge.style.cssText = getStatusStyle(launchData.status);

    // Show launch section if ready
    const launchSection = document.getElementById('launchSection');
    if (launchSection) {
      launchSection.style.display = launchData.status === 'ready' ? 'block' : 'none';
    }
  }

  function getStatusStyle(status: string): string {
    const styles: Record<string, string> = {
      planning: 'background: #f3f4f6; color: #374151;',
      pricing: 'background: #fef3c7; color: #92400e;',
      protocol: 'background: #dbeafe; color: #1e40af;',
      training: 'background: #e0e7ff; color: #3730a3;',
      ready: 'background: #d1fae5; color: #065f46;',
      launched: 'background: #10b981; color: white;',
      cancelled: 'background: #fee2e2; color: #991b1b;'
    };
    return styles[status] || '';
  }

  function renderTasks() {
    const list = document.getElementById('tasksList')!;
    
    if (tasksData.length === 0) {
      list.innerHTML = '<div class="empty-state">ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“</div>';
      return;
    }

    list.innerHTML = tasksData.map(task => `
      <div class="task-item ${task.is_completed ? 'completed' : ''}">
        <input type="checkbox" class="task-checkbox" 
          ${task.is_completed ? 'checked' : ''} 
          onchange="toggleTask(${task.id}, this.checked)">
        <div class="task-info">
          <div class="task-title">${escapeHtml(task.title)}</div>
          <div class="task-meta">
            ${task.assignee ? `æ‹…å½“: ${escapeHtml(task.assignee)}` : ''}
            ${task.due_date ? ` | æœŸé™: ${formatDate(task.due_date)}` : ''}
            ${task.completed_at ? ` | å®Œäº†: ${formatDate(task.completed_at)}` : ''}
          </div>
        </div>
        <span class="task-type-badge">${taskTypeLabels[task.task_type] || task.task_type}</span>
      </div>
    `).join('');
  }

  function updateSystemsTab() {
    if (!launchData) return;

    // WEB
    const webStatus = document.getElementById('webStatus')!;
    const webDate = document.getElementById('webRegisteredAt')!;
    if (launchData.web_registered_at) {
      webStatus.textContent = 'ç™»éŒ²æ¸ˆã¿';
      webStatus.classList.add('registered');
      webDate.textContent = `ç™»éŒ²æ—¥: ${formatDate(launchData.web_registered_at)}`;
    }

    // ã‚¹ãƒãƒ¬ã‚¸
    const smaregiStatus = document.getElementById('smaregiStatus')!;
    const smaregiDate = document.getElementById('smaregiRegisteredAt')!;
    const smaregiCode = document.getElementById('smaregiCode') as HTMLInputElement;
    if (launchData.smaregi_registered_at) {
      smaregiStatus.textContent = 'ç™»éŒ²æ¸ˆã¿';
      smaregiStatus.classList.add('registered');
      smaregiDate.textContent = `ç™»éŒ²æ—¥: ${formatDate(launchData.smaregi_registered_at)}`;
    }
    smaregiCode.value = launchData.smaregi_product_code || '';

    // ãƒ¡ãƒ‡ã‚£ã‚«ãƒ«ãƒ•ã‚©ãƒ¼ã‚¹
    const mfStatus = document.getElementById('mfStatus')!;
    const mfDate = document.getElementById('mfRegisteredAt')!;
    const mfId = document.getElementById('mfId') as HTMLInputElement;
    if (launchData.medical_force_registered_at) {
      mfStatus.textContent = 'ç™»éŒ²æ¸ˆã¿';
      mfStatus.classList.add('registered');
      mfDate.textContent = `ç™»éŒ²æ—¥: ${formatDate(launchData.medical_force_registered_at)}`;
    }
    mfId.value = launchData.medical_force_product_id || '';
  }

  async function handleSubmit(e: Event) {
    e.preventDefault();
    
    const form = e.target as HTMLFormElement;
    const formData = new FormData(form);
    
    const data: Record<string, any> = {};
    formData.forEach((value, key) => {
      if (key === 'planned_price' || key === 'planned_price_taxed' || key === 'priority' || key === 'target_category_id') {
        data[key] = value ? parseInt(value as string) : null;
      } else {
        data[key] = value || null;
      }
    });

    try {
      const res = await fetch(`/api/product-launches/${launchId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      const result = await res.json();
      
      if (res.ok && result.success) {
        alert('ä¿å­˜ã—ã¾ã—ãŸ');
        loadData();
      } else {
        alert(result.error || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    } catch (error) {
      console.error('Error saving:', error);
      alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  }

  async function handleDelete() {
    if (!confirm('ã“ã®ç™ºå£²äºˆå®šå•†å“ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

    try {
      const res = await fetch(`/api/product-launches/${launchId}`, { method: 'DELETE' });
      if (res.ok) {
        window.location.href = '/launches';
      } else {
        alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    } catch (error) {
      console.error('Error deleting:', error);
      alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  }

  async function toggleTask(taskId: number, isCompleted: boolean) {
    try {
      await fetch(`/api/product-launches/${launchId}/tasks`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ task_id: taskId, is_completed: isCompleted })
      });
      loadData();
    } catch (error) {
      console.error('Error toggling task:', error);
    }
  }

  async function handleAddTask(e: Event) {
    e.preventDefault();
    const form = e.target as HTMLFormElement;
    const formData = new FormData(form);
    
    const data: Record<string, any> = {};
    formData.forEach((value, key) => {
      data[key] = value || null;
    });

    try {
      const res = await fetch(`/api/product-launches/${launchId}/tasks`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      if (res.ok) {
        closeModal();
        form.reset();
        loadData();
      } else {
        alert('è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    } catch (error) {
      console.error('Error adding task:', error);
      alert('è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  }

  async function handleLaunch() {
    const categoryId = (document.getElementById('launchCategoryId') as HTMLSelectElement).value;
    const subcategoryName = (document.getElementById('launchSubcategoryName') as HTMLInputElement).value;
    const subcategorySlug = (document.getElementById('launchSubcategorySlug') as HTMLInputElement).value;
    const planName = (document.getElementById('launchPlanName') as HTMLInputElement).value || '1å›';
    const webRegister = (document.getElementById('launchWebRegister') as HTMLInputElement).checked;
    const smaregiCode = (document.getElementById('smaregiCode') as HTMLInputElement).value;
    const mfId = (document.getElementById('mfId') as HTMLInputElement).value;

    if (!categoryId || !subcategoryName || !subcategorySlug) {
      alert('ã‚«ãƒ†ã‚´ãƒªã€ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªåã€ã‚¹ãƒ©ãƒƒã‚°ã¯å¿…é ˆã§ã™');
      return;
    }

    if (!confirm(`ã€Œ${launchData.name}ã€ã‚’ç™ºå£²ã—ã€å•†å“ä¸€è¦§ã«ãƒãƒ¼ã‚¸ã—ã¾ã™ã‹ï¼Ÿ`)) return;

    try {
      const res = await fetch(`/api/product-launches/${launchId}/launch`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          category_id: parseInt(categoryId),
          subcategory_name: subcategoryName,
          subcategory_slug: subcategorySlug,
          plan_name: planName,
          web_register: webRegister,
          smaregi_product_code: smaregiCode || null,
          medical_force_product_id: mfId || null
        })
      });

      const result = await res.json();
      
      if (res.ok && result.success) {
        alert(result.message || 'ç™ºå£²ã—ã¾ã—ãŸï¼');
        window.location.href = '/launches';
      } else {
        alert(result.error || 'ç™ºå£²å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    } catch (error) {
      console.error('Error launching:', error);
      alert('ç™ºå£²å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  }

  function openModal() {
    document.getElementById('addTaskModal')!.classList.add('open');
  }

  function closeModal() {
    document.getElementById('addTaskModal')!.classList.remove('open');
  }

  function formatDate(dateStr: string): string {
    const date = new Date(dateStr);
    return `${date.getFullYear()}/${date.getMonth() + 1}/${date.getDate()}`;
  }

  function escapeHtml(text: string): string {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Tab switching
  function setupTabs() {
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        tab.classList.add('active');
        const tabId = (tab as HTMLElement).dataset.tab;
        document.getElementById(`tab-${tabId}`)?.classList.add('active');
      });
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    loadCategories();
    loadData();
    setupTabs();

    document.getElementById('launchForm')?.addEventListener('submit', handleSubmit);
    document.getElementById('deleteBtn')?.addEventListener('click', handleDelete);
    document.getElementById('addTaskBtn')?.addEventListener('click', openModal);
    document.getElementById('addTaskForm')?.addEventListener('submit', handleAddTask);
    document.getElementById('launchBtn')?.addEventListener('click', handleLaunch);

    // Check URL for action=launch
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('action') === 'launch') {
      document.querySelector('[data-tab="systems"]')?.dispatchEvent(new Event('click'));
    }
  });

  (window as any).toggleTask = toggleTask;
  (window as any).closeModal = closeModal;
</script>

