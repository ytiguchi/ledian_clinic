---
import Layout from '../../../components/Layout.astro';

const { id } = Astro.params;
---

<Layout>
  <div class="edit-launch-page" data-launch-id={id}>
    <!-- Page Header -->
    <div class="page-header">
      <div class="header-left">
        <a href="/launches" class="back-link">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="15 18 9 12 15 6"></polyline>
          </svg>
          ä¸€è¦§ã«æˆ»ã‚‹
        </a>
        <h1 class="page-title" id="pageTitle">èª­ã¿è¾¼ã¿ä¸­...</h1>
      </div>
      <div class="header-actions">
        <button class="btn btn-danger-outline" id="deleteBtn">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="3 6 5 6 21 6"></polyline>
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
          </svg>
          å‰Šé™¤
        </button>
      </div>
    </div>

    <!-- Status Pipeline -->
    <div class="status-pipeline">
      <div class="pipeline-step" data-status="planning">
        <div class="step-icon">ğŸ’¡</div>
        <div class="step-content">
          <span class="step-label">ä¼ç”»ä¸­</span>
        </div>
      </div>
      <div class="pipeline-arrow">â†’</div>
      <div class="pipeline-step" data-status="pricing">
        <div class="step-icon">ğŸ’°</div>
        <div class="step-content">
          <span class="step-label">æ–™é‡‘æ±ºå®š</span>
        </div>
      </div>
      <div class="pipeline-arrow">â†’</div>
      <div class="pipeline-step" data-status="protocol">
        <div class="step-icon">ğŸ“‹</div>
        <div class="step-content">
          <span class="step-label">ãƒ—ãƒ­ãƒˆã‚³ãƒ«</span>
        </div>
      </div>
      <div class="pipeline-arrow">â†’</div>
      <div class="pipeline-step" data-status="training">
        <div class="step-icon">ğŸ“š</div>
        <div class="step-content">
          <span class="step-label">ç ”ä¿®</span>
        </div>
      </div>
      <div class="pipeline-arrow">â†’</div>
      <div class="pipeline-step" data-status="ready">
        <div class="step-icon">âœ…</div>
        <div class="step-content">
          <span class="step-label">æº–å‚™å®Œäº†</span>
        </div>
      </div>
      <div class="pipeline-arrow">â†’</div>
      <div class="pipeline-step launch-step" data-status="launched" title="ã€Œç™ºå£²å‡¦ç†ã€ã‚¿ãƒ–ã‹ã‚‰ç™ºå£²ã—ã¦ãã ã•ã„">
        <div class="step-icon">ğŸ‰</div>
        <div class="step-content">
          <span class="step-label">ç™ºå£²æ¸ˆã¿</span>
          <span class="step-hint">ç™ºå£²å‡¦ç†ã‚¿ãƒ– â†’</span>
        </div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" data-tab="details">åŸºæœ¬æƒ…å ±</button>
      <button class="tab" data-tab="plans">æ–™é‡‘ãƒ—ãƒ©ãƒ³</button>
      <button class="tab" data-tab="tasks">ã‚¿ã‚¹ã‚¯</button>
      <button class="tab tab-launch" data-tab="launch" id="tabLaunch">
        ğŸš€ ç™ºå£²å‡¦ç†
        <span class="tab-badge" id="launchBadge" style="display: none;">æº–å‚™å®Œäº†!</span>
      </button>
    </div>

    <!-- Tab Content: Details -->
    <div class="tab-content active" id="tab-details">
      <form id="launchForm" class="form-container">
        <div class="form-section">
          <h2 class="section-title">ğŸ“¦ åŸºæœ¬æƒ…å ±</h2>
          
          <div class="form-grid">
            <div class="form-group full-width">
              <label class="label required">å•†å“å</label>
              <input type="text" name="name" class="input" required>
            </div>

            <div class="form-group full-width">
              <label class="label">èª¬æ˜</label>
              <textarea name="description" class="textarea" rows="3"></textarea>
            </div>

            <div class="form-group">
              <label class="label">äºˆå®šã‚«ãƒ†ã‚´ãƒª</label>
              <select name="target_category_id" class="select" id="categorySelect">
                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              </select>
            </div>

            <div class="form-group">
              <label class="label">ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªå</label>
              <input type="text" name="target_subcategory_name" class="input" placeholder="ä¾‹: ã‚¯ãƒå–ã‚Š">
            </div>

            <div class="form-group">
              <label class="label">ä¸»æ‹…å½“</label>
              <input type="text" name="owner_name" class="input" placeholder="ä¾‹: é™¢é•·">
            </div>

            <div class="form-group">
              <label class="label">ç™ºå£²äºˆå®šæ—¥</label>
              <input type="date" name="target_launch_date" class="input">
            </div>
          </div>
        </div>

        <div class="form-section">
          <h2 class="section-title">ğŸ“ å‚™è€ƒãƒ»ãƒ¡ãƒ¢</h2>
          
          <div class="form-grid">
            <div class="form-group full-width">
              <label class="label">æ–™é‡‘å‚™è€ƒ</label>
              <textarea name="price_notes" class="textarea" rows="2" placeholder="æ–™é‡‘ã«é–¢ã™ã‚‹è£œè¶³ï¼ˆè–¬å‰¤é¸å®šä¸­ãªã©ï¼‰"></textarea>
            </div>

            <div class="form-group full-width">
              <label class="label">ãƒ—ãƒ­ãƒˆã‚³ãƒ«å‚™è€ƒ</label>
              <textarea name="protocol_notes" class="textarea" rows="2" placeholder="ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã«é–¢ã™ã‚‹ãƒ¡ãƒ¢"></textarea>
            </div>

            <div class="form-group full-width">
              <label class="label">ç ”ä¿®å‚™è€ƒ</label>
              <textarea name="training_notes" class="textarea" rows="2" placeholder="ç ”ä¿®ã«é–¢ã™ã‚‹ãƒ¡ãƒ¢"></textarea>
            </div>

            <div class="form-group full-width">
              <label class="label">ãã®ä»–å‚™è€ƒ</label>
              <textarea name="notes" class="textarea" rows="2" placeholder="ãã®ä»–ã®ãƒ¡ãƒ¢"></textarea>
            </div>
          </div>
        </div>

        <div class="form-actions">
          <div style="flex: 1;"></div>
          <a href="/launches" class="btn btn-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</a>
          <button type="submit" class="btn btn-primary">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
              <polyline points="17 21 17 13 7 13 7 21"></polyline>
              <polyline points="7 3 7 8 15 8"></polyline>
            </svg>
            ä¿å­˜
          </button>
        </div>
      </form>
    </div>

    <!-- Tab Content: Plans -->
    <div class="tab-content" id="tab-plans">
      <div class="plans-section">
        <div class="section-header">
          <h2 class="section-title" style="margin: 0;">ğŸ’° æ–™é‡‘ãƒ—ãƒ©ãƒ³</h2>
          <button class="btn btn-primary btn-sm" id="addPlanBtn">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            ãƒ—ãƒ©ãƒ³è¿½åŠ 
          </button>
        </div>
        <p class="section-desc">ç™ºå£²æ™‚ã«ã“ã‚Œã‚‰ã®ãƒ—ãƒ©ãƒ³ãŒæ–½è¡“ä¸€è¦§ã«è‡ªå‹•çš„ã«ã‚³ãƒ”ãƒ¼ã•ã‚Œã¾ã™</p>
        
        <div id="plansList" class="plans-list">
          <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>

        <div class="plans-empty" id="plansEmpty" style="display: none;">
          <div class="empty-icon">ğŸ’°</div>
          <h3>æ–™é‡‘ãƒ—ãƒ©ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“</h3>
          <p>ã€Œãƒ—ãƒ©ãƒ³è¿½åŠ ã€ãƒœã‚¿ãƒ³ã‹ã‚‰æ–™é‡‘ãƒ—ãƒ©ãƒ³ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</p>
        </div>
      </div>
    </div>

    <!-- Tab Content: Tasks -->
    <div class="tab-content" id="tab-tasks">
      <div class="tasks-section">
        <div class="section-header">
          <h2 class="section-title" style="margin: 0;">ğŸ“‹ ã‚¿ã‚¹ã‚¯ä¸€è¦§</h2>
          <button class="btn btn-primary btn-sm" id="addTaskBtn">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            ã‚¿ã‚¹ã‚¯è¿½åŠ 
          </button>
        </div>
        
        <div id="tasksList" class="tasks-list">
          <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>
      </div>
    </div>

    <!-- Tab Content: Launch -->
    <div class="tab-content" id="tab-launch">
      <div class="launch-section">
        <!-- Pre-launch Checklist -->
        <div class="checklist-card">
          <h2 class="section-title">ğŸ” ç™ºå£²å‰ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ</h2>
          <div class="checklist" id="launchChecklist">
            <div class="checklist-item" id="checkPlans">
              <span class="check-icon">â—‹</span>
              <span class="check-label">æ–™é‡‘ãƒ—ãƒ©ãƒ³ãŒ1ã¤ä»¥ä¸Šç™»éŒ²ã•ã‚Œã¦ã„ã‚‹</span>
            </div>
            <div class="checklist-item" id="checkCategory">
              <span class="check-icon">â—‹</span>
              <span class="check-label">ã‚«ãƒ†ã‚´ãƒªãŒé¸æŠã•ã‚Œã¦ã„ã‚‹</span>
            </div>
            <div class="checklist-item" id="checkSubcat">
              <span class="check-icon">â—‹</span>
              <span class="check-label">ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªåãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚‹</span>
            </div>
          </div>
        </div>

        <!-- System Registration -->
        <div class="systems-card">
          <h2 class="section-title">ğŸ“¡ å¤–éƒ¨ã‚·ã‚¹ãƒ†ãƒ ç™»éŒ²</h2>
          <div class="systems-grid">
            <div class="system-item">
              <div class="system-header">
                <span class="system-name">WEB ã‚µã‚¤ãƒˆ</span>
                <span class="system-status" id="webStatus">æœªç™»éŒ²</span>
              </div>
              <label class="checkbox-label">
                <input type="checkbox" id="launchWebRegister">
                ç™ºå£²æ™‚ã«WEBç™»éŒ²æ¸ˆã¿ã«ã™ã‚‹
              </label>
            </div>
            
            <div class="system-item">
              <div class="system-header">
                <span class="system-name">ã‚¹ãƒãƒ¬ã‚¸</span>
                <span class="system-status" id="smaregiStatus">æœªç™»éŒ²</span>
              </div>
              <input type="text" id="smaregiCode" class="input input-sm" placeholder="å•†å“ã‚³ãƒ¼ãƒ‰">
            </div>
            
            <div class="system-item">
              <div class="system-header">
                <span class="system-name">ãƒ¡ãƒ‡ã‚£ã‚«ãƒ«ãƒ•ã‚©ãƒ¼ã‚¹</span>
                <span class="system-status" id="mfStatus">æœªç™»éŒ²</span>
              </div>
              <input type="text" id="mfId" class="input input-sm" placeholder="å•†å“ID">
            </div>
          </div>
        </div>

        <!-- Launch Action -->
        <div class="launch-action-card" id="launchActionCard">
          <div class="launch-preview">
            <h2>ğŸš€ ç™ºå£²å‡¦ç†</h2>
            <p>ã“ã®å•†å“ã‚’ç™ºå£²ã™ã‚‹ã¨ã€ä»¥ä¸‹ã®å‡¦ç†ãŒè‡ªå‹•çš„ã«è¡Œã‚ã‚Œã¾ã™ï¼š</p>
            <ul class="launch-steps">
              <li>ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªã€Œ<span id="previewSubcat">-</span>ã€ã‚’ä½œæˆ</li>
              <li>æ–½è¡“ã€Œ<span id="previewTreatment">-</span>ã€ã‚’ä½œæˆ</li>
              <li>æ–™é‡‘ãƒ—ãƒ©ãƒ³ï¼ˆ<span id="previewPlanCount">0</span>ä»¶ï¼‰ã‚’ã‚³ãƒ”ãƒ¼</li>
            </ul>
          </div>

          <div class="launch-form">
            <div class="form-grid">
              <div class="form-group">
                <label class="label required">ã‚«ãƒ†ã‚´ãƒª</label>
                <select id="launchCategoryId" class="select" required>
                  <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                </select>
              </div>
              <div class="form-group">
                <label class="label required">ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªå</label>
                <input type="text" id="launchSubcategoryName" class="input" required>
              </div>
              <div class="form-group">
                <label class="label required">ã‚¹ãƒ©ãƒƒã‚°ï¼ˆURLç”¨ï¼‰</label>
                <input type="text" id="launchSubcategorySlug" class="input" placeholder="ä¾‹: kuma-tori" required>
              </div>
              <div class="form-group">
                <label class="label">æ–½è¡“åï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªã¨åŒã˜ï¼‰</label>
                <input type="text" id="launchTreatmentName" class="input" placeholder="ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªåã¨åŒã˜å ´åˆã¯ç©ºæ¬„">
              </div>
            </div>

            <button class="btn btn-launch" id="launchBtn" disabled>
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 2L11 13"></path>
                <path d="M22 2L15 22L11 13L2 9L22 2Z"></path>
              </svg>
              ç™ºå£²ã™ã‚‹ï¼ˆæ–½è¡“ä¸€è¦§ã«ãƒãƒ¼ã‚¸ï¼‰
            </button>
          </div>
        </div>

        <!-- Already Launched -->
        <div class="launched-card" id="launchedCard" style="display: none;">
          <div class="launched-icon">ğŸ‰</div>
          <h2>ç™ºå£²æ¸ˆã¿</h2>
          <p>ã“ã®å•†å“ã¯ã™ã§ã«ç™ºå£²ã•ã‚Œã€æ–½è¡“ä¸€è¦§ã«ãƒãƒ¼ã‚¸ã•ã‚Œã¦ã„ã¾ã™ã€‚</p>
          <a href="/menu" class="btn btn-primary">æ–½è¡“ä¸€è¦§ã‚’è¦‹ã‚‹</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Plan Modal -->
  <div class="modal" id="addPlanModal">
    <div class="modal-content modal-lg">
      <h3>æ–™é‡‘ãƒ—ãƒ©ãƒ³è¿½åŠ </h3>
      <form id="addPlanForm">
        <div class="form-grid">
          <div class="form-group">
            <label class="label required">ãƒ—ãƒ©ãƒ³å</label>
            <input type="text" name="plan_name" class="input" placeholder="ä¾‹: 1å›ã€3å›ã‚³ãƒ¼ã‚¹" required>
          </div>
          <div class="form-group">
            <label class="label">ãƒ—ãƒ©ãƒ³ã‚¿ã‚¤ãƒ—</label>
            <select name="plan_type" class="select">
              <option value="single">å˜ç™º</option>
              <option value="course">ã‚³ãƒ¼ã‚¹</option>
              <option value="trial">ãƒˆãƒ©ã‚¤ã‚¢ãƒ«</option>
              <option value="monitor">ãƒ¢ãƒ‹ã‚¿ãƒ¼</option>
            </select>
          </div>
          <div class="form-group">
            <label class="label">å›æ•°</label>
            <input type="number" name="sessions" class="input" value="1" min="1">
          </div>
          <div class="form-group">
            <label class="label">æ•°é‡è¡¨è¨˜</label>
            <input type="text" name="quantity" class="input" placeholder="ä¾‹: 1ccã€10å˜ä½">
          </div>
          <div class="form-group">
            <label class="label required">ç¨æŠœä¾¡æ ¼</label>
            <div class="input-group">
              <span class="input-prefix">Â¥</span>
              <input type="number" name="price" class="input" required>
            </div>
          </div>
          <div class="form-group">
            <label class="label required">ç¨è¾¼ä¾¡æ ¼</label>
            <div class="input-group">
              <span class="input-prefix">Â¥</span>
              <input type="number" name="price_taxed" class="input" required>
            </div>
          </div>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closePlanModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button type="submit" class="btn btn-primary">è¿½åŠ </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add Task Modal -->
  <div class="modal" id="addTaskModal">
    <div class="modal-content">
      <h3>ã‚¿ã‚¹ã‚¯è¿½åŠ </h3>
      <form id="addTaskForm">
        <div class="form-group">
          <label class="label">ã‚¿ã‚¹ã‚¯ç¨®åˆ¥</label>
          <select name="task_type" class="select" required>
            <option value="pricing">æ–™é‡‘æ±ºå®š</option>
            <option value="protocol">ãƒ—ãƒ­ãƒˆã‚³ãƒ«ç­–å®š</option>
            <option value="training_material">ç ”ä¿®è³‡æ–™ä½œæˆ</option>
            <option value="training_session">ç ”ä¿®å®Ÿæ–½</option>
            <option value="web_register">WEBç™»éŒ²</option>
            <option value="smaregi_register">ã‚¹ãƒãƒ¬ã‚¸ç™»éŒ²</option>
            <option value="medical_force_register">ãƒ¡ãƒ‡ã‚£ã‚«ãƒ«ãƒ•ã‚©ãƒ¼ã‚¹ç™»éŒ²</option>
            <option value="photo_prepare">å†™çœŸæº–å‚™</option>
            <option value="marketing">ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°æº–å‚™</option>
            <option value="other">ãã®ä»–</option>
          </select>
        </div>
        <div class="form-group">
          <label class="label required">ã‚¿ã‚¤ãƒˆãƒ«</label>
          <input type="text" name="title" class="input" required>
        </div>
        <div class="form-group">
          <label class="label">æœŸé™</label>
          <input type="date" name="due_date" class="input">
        </div>
        <div class="form-group">
          <label class="label">æ‹…å½“è€…</label>
          <input type="text" name="assignee" class="input">
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closeTaskModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button type="submit" class="btn btn-primary">è¿½åŠ </button>
        </div>
      </form>
    </div>
  </div>
</Layout>

<style>
  .edit-launch-page {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    max-width: 1000px;
  }

  /* Page Header */
  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 1rem;
  }

  .header-left {
    flex: 1;
  }

  .back-link {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    font-size: 0.875rem;
    color: var(--color-text-muted);
    text-decoration: none;
    margin-bottom: 0.5rem;
    transition: color 0.15s ease;
  }

  .back-link:hover {
    color: var(--color-accent);
  }

  .back-link svg {
    width: 16px;
    height: 16px;
  }

  .page-title {
    font-size: 1.5rem;
    font-weight: 700;
    margin: 0;
  }

  .btn-danger-outline {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.5rem 1rem;
    background: transparent;
    border: 1px solid #fecaca;
    color: #dc2626;
    border-radius: 8px;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s ease;
  }

  .btn-danger-outline:hover {
    background: #fef2f2;
    border-color: #fca5a5;
  }

  .btn-danger-outline svg {
    width: 16px;
    height: 16px;
  }

  /* Status Pipeline */
  .status-pipeline {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 1.25rem;
    background: var(--color-bg-card);
    border: 1px solid var(--color-border-light);
    border-radius: 16px;
    overflow-x: auto;
  }

  .pipeline-step {
    display: flex;
    align-items: center;
    gap: 0.625rem;
    padding: 0.625rem 1rem;
    background: var(--color-bg-secondary);
    border: 2px solid transparent;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
  }

  .pipeline-step:hover {
    background: var(--color-bg-hover);
    border-color: var(--color-border);
  }

  .pipeline-step.active {
    background: linear-gradient(135deg, var(--color-accent) 0%, #c99a45 100%);
    border-color: var(--color-accent);
    color: var(--color-primary);
  }

  .pipeline-step.completed {
    background: #d1fae5;
    border-color: #10b981;
    color: #065f46;
  }

  .pipeline-step.launched {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    border-color: #10b981;
    color: white;
  }

  .step-icon {
    font-size: 1.125rem;
  }

  .step-label {
    font-size: 0.8125rem;
    font-weight: 600;
  }

  .step-hint {
    display: none;
    font-size: 0.625rem;
    color: var(--color-text-muted);
    font-weight: 500;
  }

  .pipeline-step.launch-step {
    cursor: help;
    opacity: 0.7;
  }

  .pipeline-step.launch-step:hover {
    background: var(--color-bg-secondary);
    border-color: transparent;
  }

  .pipeline-step.launch-step:hover .step-hint {
    display: block;
  }

  .pipeline-step.launch-step.launched {
    opacity: 1;
    cursor: default;
  }

  .pipeline-step.launch-step.launched .step-hint {
    display: none;
  }

  .pipeline-arrow {
    color: var(--color-text-muted);
    font-size: 0.875rem;
    flex-shrink: 0;
  }

  /* Tabs */
  .tabs {
    display: flex;
    gap: 0.25rem;
    padding: 0.25rem;
    background: var(--color-bg-card);
    border: 1px solid var(--color-border-light);
    border-radius: 12px;
  }

  .tab {
    flex: 1;
    padding: 0.75rem 1rem;
    border: none;
    background: transparent;
    border-radius: 8px;
    font-size: 0.9375rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s ease;
    color: var(--color-text-secondary);
  }

  .tab:hover {
    background: var(--color-bg-hover);
    color: var(--color-text);
  }

  .tab.active {
    background: var(--color-accent);
    color: var(--color-primary);
  }

  .tab-launch {
    position: relative;
  }

  .tab-launch.ready {
    background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
    color: #065f46;
    animation: pulse-ready 2s ease-in-out infinite;
  }

  .tab-launch.ready.active {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    animation: none;
  }

  @keyframes pulse-ready {
    0%, 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); }
    50% { box-shadow: 0 0 0 6px rgba(16, 185, 129, 0); }
  }

  .tab-badge {
    position: absolute;
    top: -8px;
    right: -8px;
    padding: 2px 6px;
    background: #ef4444;
    color: white;
    font-size: 0.625rem;
    font-weight: 600;
    border-radius: 10px;
    white-space: nowrap;
  }

  .tab-content {
    display: none;
  }

  .tab-content.active {
    display: block;
  }

  /* Form Styles */
  .form-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .form-section {
    background: var(--color-bg-card);
    border: 1px solid var(--color-border-light);
    border-radius: 16px;
    padding: 1.5rem;
  }

  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
  }

  .section-title {
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .section-desc {
    font-size: 0.875rem;
    color: var(--color-text-muted);
    margin: 0 0 1rem;
  }

  .form-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.375rem;
  }

  .form-group.full-width {
    grid-column: span 2;
  }

  .label {
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--color-text-secondary);
  }

  .label.required::after {
    content: ' *';
    color: #dc2626;
  }

  .input, .select, .textarea {
    padding: 0.625rem 0.875rem;
    border: 1px solid var(--color-border);
    border-radius: 8px;
    font-size: 0.9375rem;
    background: var(--color-bg);
    transition: border-color 0.15s ease;
  }

  .input:focus, .select:focus, .textarea:focus {
    outline: none;
    border-color: var(--color-accent);
  }

  .input-sm {
    padding: 0.5rem 0.75rem;
    font-size: 0.875rem;
  }

  .input-group {
    display: flex;
    align-items: center;
  }

  .input-prefix {
    padding: 0.625rem 0.75rem;
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-right: none;
    border-radius: 8px 0 0 8px;
    color: var(--color-text-muted);
    font-size: 0.875rem;
  }

  .input-group .input {
    border-radius: 0 8px 8px 0;
    flex: 1;
  }

  .form-actions {
    display: flex;
    gap: 0.75rem;
    padding-top: 0.5rem;
  }

  /* Plans Section */
  .plans-section, .tasks-section, .launch-section {
    background: var(--color-bg-card);
    border: 1px solid var(--color-border-light);
    border-radius: 16px;
    padding: 1.5rem;
  }

  .plans-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .plan-card {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: 12px;
    transition: all 0.15s ease;
  }

  .plan-card:hover {
    border-color: var(--color-accent);
  }

  .plan-type-badge {
    padding: 0.25rem 0.625rem;
    background: var(--color-bg-secondary);
    border-radius: 6px;
    font-size: 0.6875rem;
    font-weight: 600;
    text-transform: uppercase;
    color: var(--color-text-muted);
  }

  .plan-info {
    flex: 1;
  }

  .plan-name {
    font-weight: 600;
    font-size: 0.9375rem;
    color: var(--color-text);
  }

  .plan-meta {
    font-size: 0.8125rem;
    color: var(--color-text-muted);
    margin-top: 0.25rem;
  }

  .plan-price {
    text-align: right;
  }

  .plan-price-value {
    font-size: 1.125rem;
    font-weight: 700;
    color: var(--color-text);
  }

  .plan-price-label {
    font-size: 0.75rem;
    color: var(--color-text-muted);
  }

  .plan-actions {
    display: flex;
    gap: 0.375rem;
  }

  .btn-icon {
    width: 32px;
    height: 32px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.15s ease;
    color: var(--color-text-muted);
  }

  .btn-icon:hover {
    background: var(--color-bg-hover);
    color: var(--color-text);
  }

  .btn-icon.danger:hover {
    background: #fef2f2;
    border-color: #fecaca;
    color: #dc2626;
  }

  .btn-icon svg {
    width: 14px;
    height: 14px;
  }

  .plans-empty {
    text-align: center;
    padding: 2rem;
    color: var(--color-text-muted);
  }

  .empty-icon {
    font-size: 2.5rem;
    margin-bottom: 0.75rem;
  }

  .plans-empty h3 {
    font-size: 1rem;
    margin: 0 0 0.5rem;
    color: var(--color-text);
  }

  .plans-empty p {
    font-size: 0.875rem;
    margin: 0;
  }

  /* Tasks */
  .tasks-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .task-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.875rem 1rem;
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: 10px;
    transition: all 0.15s ease;
  }

  .task-item:hover {
    border-color: var(--color-accent);
  }

  .task-item.completed {
    opacity: 0.6;
  }

  .task-checkbox {
    width: 18px;
    height: 18px;
    cursor: pointer;
    accent-color: var(--color-accent);
  }

  .task-info {
    flex: 1;
  }

  .task-title {
    font-weight: 500;
    font-size: 0.9375rem;
  }

  .task-meta {
    font-size: 0.75rem;
    color: var(--color-text-muted);
    margin-top: 0.25rem;
  }

  .task-type-badge {
    font-size: 0.6875rem;
    padding: 0.25rem 0.5rem;
    background: var(--color-bg-secondary);
    border-radius: 4px;
    color: var(--color-text-muted);
    font-weight: 500;
  }

  /* Launch Section */
  .launch-section {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    background: transparent;
    border: none;
    padding: 0;
  }

  .checklist-card, .systems-card, .launch-action-card, .launched-card {
    background: var(--color-bg-card);
    border: 1px solid var(--color-border-light);
    border-radius: 16px;
    padding: 1.5rem;
  }

  .checklist {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .checklist-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem;
    background: var(--color-bg);
    border-radius: 8px;
  }

  .checklist-item.passed {
    background: #f0fdf4;
  }

  .checklist-item.passed .check-icon {
    color: #10b981;
  }

  .check-icon {
    font-size: 1rem;
    width: 24px;
    text-align: center;
  }

  .check-label {
    font-size: 0.9375rem;
  }

  .systems-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
  }

  .system-item {
    padding: 1rem;
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: 10px;
  }

  .system-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
  }

  .system-name {
    font-weight: 600;
    font-size: 0.875rem;
  }

  .system-status {
    font-size: 0.6875rem;
    padding: 0.25rem 0.5rem;
    background: var(--color-bg-secondary);
    border-radius: 4px;
    color: var(--color-text-muted);
    font-weight: 500;
  }

  .system-status.registered {
    background: #d1fae5;
    color: #065f46;
  }

  .checkbox-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.8125rem;
    cursor: pointer;
  }

  .launch-action-card {
    border: 2px solid #86efac;
    background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
  }

  .launch-preview h2 {
    margin: 0 0 0.5rem;
    font-size: 1.25rem;
  }

  .launch-preview p {
    color: var(--color-text-secondary);
    margin: 0 0 1rem;
    font-size: 0.9375rem;
  }

  .launch-steps {
    margin: 0;
    padding-left: 1.25rem;
    font-size: 0.9375rem;
    color: var(--color-text-secondary);
  }

  .launch-steps li {
    margin-bottom: 0.375rem;
  }

  .launch-steps span {
    font-weight: 600;
    color: var(--color-text);
  }

  .launch-form {
    margin-top: 1.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid #86efac;
  }

  .btn-launch {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.625rem;
    width: 100%;
    margin-top: 1rem;
    padding: 1rem 2rem;
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 1.0625rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
  }

  .btn-launch:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
  }

  .btn-launch:disabled {
    background: #9ca3af;
    cursor: not-allowed;
    box-shadow: none;
  }

  .btn-launch svg {
    width: 20px;
    height: 20px;
  }

  .launched-card {
    text-align: center;
    background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
    border: 2px solid #86efac;
  }

  .launched-icon {
    font-size: 3rem;
    margin-bottom: 0.75rem;
  }

  .launched-card h2 {
    margin: 0 0 0.5rem;
    color: #065f46;
  }

  .launched-card p {
    color: var(--color-text-secondary);
    margin: 0 0 1.5rem;
  }

  /* Modal */
  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    padding: 1rem;
  }

  .modal.open {
    display: flex;
  }

  .modal-content {
    background: var(--color-bg-card);
    border-radius: 16px;
    padding: 1.5rem;
    width: 100%;
    max-width: 400px;
    max-height: 90vh;
    overflow-y: auto;
  }

  .modal-lg {
    max-width: 500px;
  }

  .modal-content h3 {
    margin: 0 0 1.25rem;
    font-size: 1.125rem;
  }

  .modal-actions {
    display: flex;
    justify-content: flex-end;
    gap: 0.5rem;
    margin-top: 1.5rem;
    padding-top: 1rem;
    border-top: 1px solid var(--color-border);
  }

  /* Buttons */
  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.625rem 1.25rem;
    border-radius: 8px;
    font-size: 0.9375rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s ease;
    text-decoration: none;
    border: none;
  }

  .btn svg {
    width: 16px;
    height: 16px;
  }

  .btn-sm {
    padding: 0.5rem 0.875rem;
    font-size: 0.8125rem;
  }

  .btn-sm svg {
    width: 14px;
    height: 14px;
  }

  .btn-primary {
    background: var(--color-accent);
    color: var(--color-primary);
  }

  .btn-primary:hover {
    background: #c99a45;
  }

  .btn-secondary {
    background: var(--color-bg-secondary);
    color: var(--color-text);
    border: 1px solid var(--color-border);
  }

  .btn-secondary:hover {
    background: var(--color-bg-hover);
  }

  .loading {
    text-align: center;
    padding: 2rem;
    color: var(--color-text-muted);
  }

  @media (max-width: 768px) {
    .form-grid {
      grid-template-columns: 1fr;
    }

    .form-group.full-width {
      grid-column: span 1;
    }

    .systems-grid {
      grid-template-columns: 1fr;
    }

    .status-pipeline {
      padding: 1rem;
    }

    .pipeline-step {
      padding: 0.5rem 0.75rem;
    }

    .step-label {
      display: none;
    }

    .tabs {
      flex-wrap: wrap;
    }

    .tab {
      flex: 1 1 45%;
    }
  }
</style>

<script>
  const launchId = document.querySelector('.edit-launch-page')?.getAttribute('data-launch-id');
  let launchData: any = null;
  let plansData: any[] = [];
  let tasksData: any[] = [];

  const statusOrder = ['planning', 'pricing', 'protocol', 'training', 'ready', 'launched'];
  
  const statusLabels: Record<string, string> = {
    planning: 'ä¼ç”»ä¸­',
    pricing: 'æ–™é‡‘æ±ºå®šä¸­',
    protocol: 'ãƒ—ãƒ­ãƒˆã‚³ãƒ«ç­–å®šä¸­',
    training: 'ç ”ä¿®ä¸­',
    ready: 'ç™ºå£²æº–å‚™å®Œäº†',
    launched: 'ç™ºå£²æ¸ˆã¿',
    cancelled: 'ä¸­æ­¢'
  };

  const planTypeLabels: Record<string, string> = {
    single: 'å˜ç™º',
    course: 'ã‚³ãƒ¼ã‚¹',
    trial: 'ãƒˆãƒ©ã‚¤ã‚¢ãƒ«',
    monitor: 'ãƒ¢ãƒ‹ã‚¿ãƒ¼',
    campaign: 'ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³'
  };

  const taskTypeLabels: Record<string, string> = {
    pricing: 'æ–™é‡‘',
    protocol: 'ãƒ—ãƒ­ãƒˆã‚³ãƒ«',
    training_material: 'ç ”ä¿®è³‡æ–™',
    training_session: 'ç ”ä¿®',
    web_register: 'WEB',
    smaregi_register: 'ã‚¹ãƒãƒ¬ã‚¸',
    medical_force_register: 'MF',
    photo_prepare: 'å†™çœŸ',
    marketing: 'ãƒãƒ¼ã‚±',
    other: 'ãã®ä»–'
  };

  async function loadData() {
    try {
      const res = await fetch(`/api/product-launches/${launchId}`);
      const data = await res.json();
      
      if (data.error) {
        alert(data.message || data.error);
        return;
      }

      launchData = data.launch;
      plansData = data.plans || [];
      tasksData = data.tasks || [];
      
      populateForm();
      updateStatusPipeline();
      renderPlans();
      renderTasks();
      updateLaunchTab();
    } catch (error) {
      console.error('Error loading data:', error);
    }
  }

  async function loadCategories() {
    try {
      const res = await fetch('/api/categories');
      const data = await res.json();
      
      const selects = ['categorySelect', 'launchCategoryId'];
      selects.forEach(selectId => {
        const select = document.getElementById(selectId) as HTMLSelectElement;
        if (select && data.categories) {
          data.categories.forEach((cat: { id: number; name: string }) => {
            const option = document.createElement('option');
            option.value = String(cat.id);
            option.textContent = cat.name;
            select.appendChild(option);
          });
        }
      });
    } catch (error) {
      console.error('Error loading categories:', error);
    }
  }

  function populateForm() {
    if (!launchData) return;

    document.getElementById('pageTitle')!.textContent = launchData.name;

    const form = document.getElementById('launchForm') as HTMLFormElement;
    
    (form.querySelector('[name="name"]') as HTMLInputElement).value = launchData.name || '';
    (form.querySelector('[name="description"]') as HTMLTextAreaElement).value = launchData.description || '';
    (form.querySelector('[name="target_category_id"]') as HTMLSelectElement).value = launchData.target_category_id || '';
    (form.querySelector('[name="target_subcategory_name"]') as HTMLInputElement).value = launchData.target_subcategory_name || '';
    (form.querySelector('[name="owner_name"]') as HTMLInputElement).value = launchData.owner_name || '';
    (form.querySelector('[name="target_launch_date"]') as HTMLInputElement).value = launchData.target_launch_date?.split('T')[0] || '';
    (form.querySelector('[name="price_notes"]') as HTMLTextAreaElement).value = launchData.price_notes || '';
    (form.querySelector('[name="protocol_notes"]') as HTMLTextAreaElement).value = launchData.protocol_notes || '';
    (form.querySelector('[name="training_notes"]') as HTMLTextAreaElement).value = launchData.training_notes || '';
    (form.querySelector('[name="notes"]') as HTMLTextAreaElement).value = launchData.notes || '';

    // Launch form defaults
    (document.getElementById('launchSubcategoryName') as HTMLInputElement).value = launchData.target_subcategory_name || launchData.name || '';
    (document.getElementById('launchCategoryId') as HTMLSelectElement).value = launchData.target_category_id || '';
  }

  function updateStatusPipeline() {
    if (!launchData) return;

    const currentIndex = statusOrder.indexOf(launchData.status);
    
    document.querySelectorAll('.pipeline-step').forEach((step, idx) => {
      const status = (step as HTMLElement).dataset.status;
      const stepIndex = statusOrder.indexOf(status || '');
      
      step.classList.remove('active', 'completed', 'launched');
      
      if (launchData.status === 'launched') {
        step.classList.add('launched');
      } else if (stepIndex < currentIndex) {
        step.classList.add('completed');
      } else if (stepIndex === currentIndex) {
        step.classList.add('active');
      }
    });
  }

  function renderPlans() {
    const list = document.getElementById('plansList')!;
    const empty = document.getElementById('plansEmpty')!;
    
    if (plansData.length === 0) {
      list.style.display = 'none';
      empty.style.display = 'block';
      return;
    }

    list.style.display = 'flex';
    empty.style.display = 'none';

    list.innerHTML = plansData.map(plan => `
      <div class="plan-card">
        <span class="plan-type-badge">${planTypeLabels[plan.plan_type] || plan.plan_type}</span>
        <div class="plan-info">
          <div class="plan-name">${escapeHtml(plan.plan_name)}</div>
          <div class="plan-meta">
            ${plan.sessions > 1 ? `${plan.sessions}å›` : ''}
            ${plan.quantity ? ` / ${escapeHtml(plan.quantity)}` : ''}
          </div>
        </div>
        <div class="plan-price">
          <div class="plan-price-value">Â¥${plan.price_taxed?.toLocaleString() || '-'}</div>
          <div class="plan-price-label">ç¨è¾¼</div>
        </div>
        <div class="plan-actions">
          <button class="btn-icon danger" onclick="deletePlan(${plan.id})" title="å‰Šé™¤">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="3 6 5 6 21 6"></polyline>
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            </svg>
          </button>
        </div>
      </div>
    `).join('');
  }

  function renderTasks() {
    const list = document.getElementById('tasksList')!;
    
    if (tasksData.length === 0) {
      list.innerHTML = '<div class="loading">ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“</div>';
      return;
    }

    list.innerHTML = tasksData.map(task => `
      <div class="task-item ${task.is_completed ? 'completed' : ''}">
        <input type="checkbox" class="task-checkbox" 
          ${task.is_completed ? 'checked' : ''} 
          onchange="toggleTask(${task.id}, this.checked)">
        <div class="task-info">
          <div class="task-title">${escapeHtml(task.title)}</div>
          <div class="task-meta">
            ${task.assignee ? `æ‹…å½“: ${escapeHtml(task.assignee)}` : ''}
            ${task.due_date ? ` | æœŸé™: ${formatDate(task.due_date)}` : ''}
          </div>
        </div>
        <span class="task-type-badge">${taskTypeLabels[task.task_type] || task.task_type}</span>
      </div>
    `).join('');
  }

  function updateLaunchTab() {
    if (!launchData) return;

    // Update checklist
    const hasPlans = plansData.length > 0;
    const hasCategory = !!launchData.target_category_id;
    const hasSubcat = !!launchData.target_subcategory_name;

    updateChecklistItem('checkPlans', hasPlans);
    updateChecklistItem('checkCategory', hasCategory);
    updateChecklistItem('checkSubcat', hasSubcat);

    // Update preview
    document.getElementById('previewSubcat')!.textContent = launchData.target_subcategory_name || launchData.name || '-';
    document.getElementById('previewTreatment')!.textContent = launchData.target_subcategory_name || launchData.name || '-';
    document.getElementById('previewPlanCount')!.textContent = String(plansData.length);

    // Show/hide launch cards
    const launchCard = document.getElementById('launchActionCard')!;
    const launchedCard = document.getElementById('launchedCard')!;
    
    if (launchData.status === 'launched') {
      launchCard.style.display = 'none';
      launchedCard.style.display = 'block';
    } else {
      launchCard.style.display = 'block';
      launchedCard.style.display = 'none';
    }

    // Enable/disable launch button
    const launchBtn = document.getElementById('launchBtn') as HTMLButtonElement;
    launchBtn.disabled = !hasPlans || !hasCategory || !hasSubcat;

    // Update system statuses
    updateSystemStatus('webStatus', launchData.web_registered_at);
    updateSystemStatus('smaregiStatus', launchData.smaregi_registered_at);
    updateSystemStatus('mfStatus', launchData.medical_force_registered_at);

    (document.getElementById('smaregiCode') as HTMLInputElement).value = launchData.smaregi_product_code || '';
    (document.getElementById('mfId') as HTMLInputElement).value = launchData.medical_force_product_id || '';

    // Highlight launch tab when ready
    const tabLaunch = document.getElementById('tabLaunch')!;
    const launchBadge = document.getElementById('launchBadge')!;
    
    if (launchData.status === 'ready' && hasPlans) {
      tabLaunch.classList.add('ready');
      launchBadge.style.display = 'block';
    } else {
      tabLaunch.classList.remove('ready');
      launchBadge.style.display = 'none';
    }
  }

  function updateChecklistItem(id: string, passed: boolean) {
    const item = document.getElementById(id)!;
    item.classList.toggle('passed', passed);
    item.querySelector('.check-icon')!.textContent = passed ? 'âœ“' : 'â—‹';
  }

  function updateSystemStatus(id: string, registeredAt: string | null) {
    const el = document.getElementById(id)!;
    if (registeredAt) {
      el.textContent = 'ç™»éŒ²æ¸ˆã¿';
      el.classList.add('registered');
    } else {
      el.textContent = 'æœªç™»éŒ²';
      el.classList.remove('registered');
    }
  }

  async function changeStatus(newStatus: string) {
    if (!launchData || launchData.status === newStatus) return;
    if (newStatus === 'launched') return; // Can't directly set to launched

    try {
      const res = await fetch(`/api/product-launches/${launchId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: newStatus })
      });

      if (res.ok) {
        loadData();
      } else {
        const data = await res.json();
        alert(data.error || 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    } catch (error) {
      console.error('Error changing status:', error);
      alert('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  }

  async function handleSubmit(e: Event) {
    e.preventDefault();
    
    const form = e.target as HTMLFormElement;
    const formData = new FormData(form);
    
    const data: Record<string, any> = {};
    formData.forEach((value, key) => {
      if (key === 'target_category_id') {
        data[key] = value ? parseInt(value as string) : null;
      } else {
        data[key] = value || null;
      }
    });

    try {
      const res = await fetch(`/api/product-launches/${launchId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      const result = await res.json();
      
      if (res.ok && result.success) {
        alert('ä¿å­˜ã—ã¾ã—ãŸ');
        loadData();
      } else {
        alert(result.error || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    } catch (error) {
      console.error('Error saving:', error);
      alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  }

  async function handleDelete() {
    if (!confirm('ã“ã®ç™ºå£²äºˆå®šå•†å“ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

    try {
      const res = await fetch(`/api/product-launches/${launchId}`, { method: 'DELETE' });
      if (res.ok) {
        window.location.href = '/launches';
      } else {
        alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    } catch (error) {
      console.error('Error deleting:', error);
      alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  }

  async function handleAddPlan(e: Event) {
    e.preventDefault();
    const form = e.target as HTMLFormElement;
    const formData = new FormData(form);
    
    const data: Record<string, any> = { launch_id: launchId };
    formData.forEach((value, key) => {
      if (key === 'price' || key === 'price_taxed' || key === 'sessions') {
        data[key] = value ? parseInt(value as string) : null;
      } else {
        data[key] = value || null;
      }
    });

    try {
      const res = await fetch(`/api/product-launches/${launchId}/plans`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      if (res.ok) {
        closePlanModal();
        form.reset();
        loadData();
      } else {
        const result = await res.json();
        alert(result.error || 'è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    } catch (error) {
      console.error('Error adding plan:', error);
      alert('è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  }

  async function deletePlan(planId: number) {
    if (!confirm('ã“ã®ãƒ—ãƒ©ãƒ³ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

    try {
      const res = await fetch(`/api/product-launches/${launchId}/plans?plan_id=${planId}`, {
        method: 'DELETE'
      });

      if (res.ok) {
        loadData();
      } else {
        alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    } catch (error) {
      console.error('Error deleting plan:', error);
      alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  }

  async function toggleTask(taskId: number, isCompleted: boolean) {
    try {
      await fetch(`/api/product-launches/${launchId}/tasks`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ task_id: taskId, is_completed: isCompleted })
      });
      loadData();
    } catch (error) {
      console.error('Error toggling task:', error);
    }
  }

  async function handleAddTask(e: Event) {
    e.preventDefault();
    const form = e.target as HTMLFormElement;
    const formData = new FormData(form);
    
    const data: Record<string, any> = {};
    formData.forEach((value, key) => {
      data[key] = value || null;
    });

    try {
      const res = await fetch(`/api/product-launches/${launchId}/tasks`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      if (res.ok) {
        closeTaskModal();
        form.reset();
        loadData();
      } else {
        alert('è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    } catch (error) {
      console.error('Error adding task:', error);
      alert('è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  }

  async function handleLaunch() {
    const categoryId = (document.getElementById('launchCategoryId') as HTMLSelectElement).value;
    const subcategoryName = (document.getElementById('launchSubcategoryName') as HTMLInputElement).value;
    const subcategorySlug = (document.getElementById('launchSubcategorySlug') as HTMLInputElement).value;
    const treatmentName = (document.getElementById('launchTreatmentName') as HTMLInputElement).value || subcategoryName;
    const webRegister = (document.getElementById('launchWebRegister') as HTMLInputElement).checked;
    const smaregiCode = (document.getElementById('smaregiCode') as HTMLInputElement).value;
    const mfId = (document.getElementById('mfId') as HTMLInputElement).value;

    if (!categoryId || !subcategoryName || !subcategorySlug) {
      alert('ã‚«ãƒ†ã‚´ãƒªã€ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªåã€ã‚¹ãƒ©ãƒƒã‚°ã¯å¿…é ˆã§ã™');
      return;
    }

    if (plansData.length === 0) {
      alert('æ–™é‡‘ãƒ—ãƒ©ãƒ³ã‚’1ã¤ä»¥ä¸Šè¿½åŠ ã—ã¦ãã ã•ã„');
      return;
    }

    if (!confirm(`ã€Œ${launchData.name}ã€ã‚’ç™ºå£²ã—ã€æ–½è¡“ä¸€è¦§ã«ãƒãƒ¼ã‚¸ã—ã¾ã™ã‹ï¼Ÿ\n\n${plansData.length}ä»¶ã®æ–™é‡‘ãƒ—ãƒ©ãƒ³ãŒã‚³ãƒ”ãƒ¼ã•ã‚Œã¾ã™ã€‚`)) return;

    try {
      const res = await fetch(`/api/product-launches/${launchId}/launch`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          category_id: parseInt(categoryId),
          subcategory_name: subcategoryName,
          subcategory_slug: subcategorySlug,
          treatment_name: treatmentName,
          plans: plansData,
          web_register: webRegister,
          smaregi_product_code: smaregiCode || null,
          medical_force_product_id: mfId || null
        })
      });

      const result = await res.json();
      
      if (res.ok && result.success) {
        alert(result.message || 'ç™ºå£²ã—ã¾ã—ãŸï¼æ–½è¡“ä¸€è¦§ã«è¿½åŠ ã•ã‚Œã¾ã—ãŸã€‚');
        loadData();
      } else {
        alert(result.error || 'ç™ºå£²å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    } catch (error) {
      console.error('Error launching:', error);
      alert('ç™ºå£²å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  }

  function openPlanModal() {
    document.getElementById('addPlanModal')!.classList.add('open');
  }

  function closePlanModal() {
    document.getElementById('addPlanModal')!.classList.remove('open');
  }

  function openTaskModal() {
    document.getElementById('addTaskModal')!.classList.add('open');
  }

  function closeTaskModal() {
    document.getElementById('addTaskModal')!.classList.remove('open');
  }

  function formatDate(dateStr: string): string {
    const date = new Date(dateStr);
    return `${date.getFullYear()}/${date.getMonth() + 1}/${date.getDate()}`;
  }

  function escapeHtml(text: string): string {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Tab switching
  function setupTabs() {
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        tab.classList.add('active');
        const tabId = (tab as HTMLElement).dataset.tab;
        document.getElementById(`tab-${tabId}`)?.classList.add('active');
      });
    });
  }

  // Status pipeline click
  function setupPipeline() {
    document.querySelectorAll('.pipeline-step').forEach(step => {
      step.addEventListener('click', () => {
        const status = (step as HTMLElement).dataset.status;
        if (status && status !== 'launched') {
          changeStatus(status);
        }
      });
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    loadCategories();
    loadData();
    setupTabs();
    setupPipeline();

    document.getElementById('launchForm')?.addEventListener('submit', handleSubmit);
    document.getElementById('deleteBtn')?.addEventListener('click', handleDelete);
    document.getElementById('addPlanBtn')?.addEventListener('click', openPlanModal);
    document.getElementById('addPlanForm')?.addEventListener('submit', handleAddPlan);
    document.getElementById('addTaskBtn')?.addEventListener('click', openTaskModal);
    document.getElementById('addTaskForm')?.addEventListener('submit', handleAddTask);
    document.getElementById('launchBtn')?.addEventListener('click', handleLaunch);

    // Check URL for action=launch
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('action') === 'launch') {
      document.querySelector('[data-tab="launch"]')?.dispatchEvent(new Event('click'));
    }
  });

  (window as any).toggleTask = toggleTask;
  (window as any).deletePlan = deletePlan;
  (window as any).closePlanModal = closePlanModal;
  (window as any).closeTaskModal = closeTaskModal;
</script>
