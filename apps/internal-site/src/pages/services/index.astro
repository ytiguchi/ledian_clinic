---
import Layout from '../../components/Layout.astro';
export const prerender = false;
---

<Layout>
  <div class="services-page">
    <!-- Page Header -->
    <div class="page-header">
      <div>
        <h1 class="page-title">施術コンテンツ管理</h1>
        <p class="page-subtitle">公開サイトに表示される施術詳細ページのコンテンツを管理</p>
      </div>
    </div>

    <!-- Search & Filter -->
    <div class="search-filter-bar">
      <input type="text" id="searchInput" placeholder="サービス名で検索..." class="search-input" />
      <select id="categoryFilter" class="filter-select">
        <option value="">全カテゴリ</option>
      </select>
      <select id="publishedFilter" class="filter-select">
        <option value="">全て</option>
        <option value="1">公開中</option>
        <option value="0">非公開</option>
      </select>
    </div>

    <!-- Services List -->
    <div class="services-container" id="servicesContainer">
      <div class="loading-state">読み込み中...</div>
    </div>
  </div>
</Layout>

<style is:global>
  .services-page {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .search-filter-bar {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    padding: 1rem;
    background: var(--color-bg-card);
    border-radius: var(--radius-lg);
    border: 1px solid var(--color-border-light);
  }

  .search-input {
    flex: 1;
    min-width: 200px;
    padding: 0.75rem 1rem;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    font-size: 0.875rem;
  }

  .filter-select {
    padding: 0.75rem 1rem;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    font-size: 0.875rem;
    background: #fff;
    min-width: 150px;
  }

  .services-container {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .loading-state {
    text-align: center;
    padding: 3rem;
    color: var(--color-text-secondary);
  }

  .service-card {
    display: flex;
    align-items: center;
    gap: 1.5rem;
    padding: 1.25rem;
    background: var(--color-bg-card);
    border: 1px solid var(--color-border-light);
    border-radius: var(--radius-lg);
    transition: all var(--transition-base);
  }

  .service-card:hover {
    border-color: var(--color-accent);
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  }

  .service-image {
    width: 80px;
    height: 80px;
    border-radius: var(--radius-md);
    object-fit: cover;
    background: #f0f0f0;
    flex-shrink: 0;
  }

  .service-info {
    flex: 1;
    min-width: 0;
  }

  .service-name {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--color-text);
    margin-bottom: 0.25rem;
  }

  .service-name-en {
    font-size: 0.75rem;
    color: var(--color-text-secondary);
    margin-bottom: 0.5rem;
  }

  .service-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    font-size: 0.75rem;
  }

  .service-badge {
    padding: 0.25rem 0.5rem;
    border-radius: var(--radius-sm);
    background: #e5e7eb;
    color: #374151;
  }

  .service-badge.published {
    background: #d1fae5;
    color: #065f46;
  }

  .service-badge.draft {
    background: #fef3c7;
    color: #92400e;
  }

  .service-badge.category {
    background: #e0e7ff;
    color: #3730a3;
  }

  .service-stats {
    display: flex;
    gap: 1rem;
    flex-shrink: 0;
  }

  .stat-item {
    text-align: center;
    padding: 0.5rem;
    background: #f9fafb;
    border-radius: var(--radius-sm);
    min-width: 60px;
  }

  .stat-value {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--color-accent);
  }

  .stat-label {
    font-size: 0.625rem;
    color: var(--color-text-secondary);
  }

  .service-actions {
    display: flex;
    gap: 0.5rem;
    flex-shrink: 0;
  }

  .btn {
    padding: 0.5rem 1rem;
    border-radius: var(--radius-md);
    font-size: 0.875rem;
    font-weight: 500;
    text-decoration: none;
    transition: all var(--transition-fast);
    cursor: pointer;
    border: none;
  }

  .btn-primary {
    background: var(--color-accent);
    color: #fff;
  }

  .btn-primary:hover {
    opacity: 0.9;
  }

  .btn-secondary {
    background: #f3f4f6;
    color: #374151;
  }

  .btn-secondary:hover {
    background: #e5e7eb;
  }

  .empty-state {
    text-align: center;
    padding: 3rem;
    color: var(--color-text-secondary);
  }
</style>

<script>
  interface ServiceContent {
    id: string;
    name_ja: string;
    name_en: string | null;
    slug: string;
    hero_image_url: string | null;
    is_published: number;
    category_name: string | null;
    subcategory_name: string | null;
    features_count: number;
    recommendations_count: number;
    faqs_count: number;
  }

  interface Category {
    id: string;
    name: string;
  }

  let allServices: ServiceContent[] = [];
  let categories: Category[] = [];

  async function loadServices() {
    const container = document.getElementById('servicesContainer');
    if (!container) return;

    try {
      const response = await fetch('/api/services');
      if (!response.ok) throw new Error('Failed to fetch services');
      
      const data = await response.json();
      allServices = data.services || [];
      categories = data.categories || [];
      
      populateCategoryFilter();
      renderServices(allServices);
    } catch (error) {
      console.error('Error loading services:', error);
      container.innerHTML = `<div class="empty-state">サービスの読み込みに失敗しました</div>`;
    }
  }

  function populateCategoryFilter() {
    const select = document.getElementById('categoryFilter') as HTMLSelectElement;
    if (!select) return;
    
    select.innerHTML = '<option value="">全カテゴリ</option>' +
      categories.map(cat => `<option value="${cat.name}">${cat.name}</option>`).join('');
  }

  function renderServices(services: ServiceContent[]) {
    const container = document.getElementById('servicesContainer');
    if (!container) return;

    if (services.length === 0) {
      container.innerHTML = `<div class="empty-state">サービスが見つかりません</div>`;
      return;
    }

    container.innerHTML = services.map(service => `
      <div class="service-card">
        <img 
          src="${service.hero_image_url || '/images/placeholder.png'}" 
          alt="${service.name_ja}" 
          class="service-image"
          onerror="this.src='/images/placeholder.png'"
        />
        <div class="service-info">
          <div class="service-name">${escapeHtml(service.name_ja)}</div>
          ${service.name_en ? `<div class="service-name-en">${escapeHtml(service.name_en)}</div>` : ''}
          <div class="service-meta">
            <span class="service-badge ${service.is_published ? 'published' : 'draft'}">
              ${service.is_published ? '公開中' : '非公開'}
            </span>
            ${service.category_name ? `<span class="service-badge category">${escapeHtml(service.category_name)}</span>` : ''}
            ${service.subcategory_name ? `<span class="service-badge">${escapeHtml(service.subcategory_name)}</span>` : ''}
          </div>
        </div>
        <div class="service-stats">
          <div class="stat-item">
            <div class="stat-value">${service.features_count}</div>
            <div class="stat-label">特徴</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">${service.recommendations_count}</div>
            <div class="stat-label">おすすめ</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">${service.faqs_count}</div>
            <div class="stat-label">FAQ</div>
          </div>
        </div>
        <div class="service-actions">
          <a href="/services/${service.slug}/edit" class="btn btn-primary">編集</a>
          <a href="https://develop.ledian-clinic-public.pages.dev/service/${service.slug}/" target="_blank" class="btn btn-secondary">プレビュー</a>
        </div>
      </div>
    `).join('');
  }

  function escapeHtml(text: string): string {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function filterServices() {
    const searchValue = (document.getElementById('searchInput') as HTMLInputElement).value.toLowerCase();
    const categoryValue = (document.getElementById('categoryFilter') as HTMLSelectElement).value;
    const publishedValue = (document.getElementById('publishedFilter') as HTMLSelectElement).value;

    const filtered = allServices.filter(service => {
      const matchesSearch = !searchValue || 
        service.name_ja.toLowerCase().includes(searchValue) ||
        (service.name_en?.toLowerCase().includes(searchValue) ?? false);
      
      const matchesCategory = !categoryValue || service.category_name === categoryValue;
      
      const matchesPublished = publishedValue === '' || 
        String(service.is_published) === publishedValue;

      return matchesSearch && matchesCategory && matchesPublished;
    });

    renderServices(filtered);
  }

  document.addEventListener('DOMContentLoaded', () => {
    loadServices();

    document.getElementById('searchInput')?.addEventListener('input', filterServices);
    document.getElementById('categoryFilter')?.addEventListener('change', filterServices);
    document.getElementById('publishedFilter')?.addEventListener('change', filterServices);
  });
</script>

