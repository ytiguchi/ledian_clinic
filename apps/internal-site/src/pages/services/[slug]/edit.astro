---
import Layout from '../../../components/Layout.astro';

const { slug } = Astro.params;
export const prerender = false;
---

<Layout>
  <div class="service-edit-page">
    <!-- Header -->
    <div class="page-header">
      <a href="/services" class="back-link">← サービス一覧に戻る</a>
      <h1 class="page-title" id="pageTitle">サービス編集</h1>
      <p class="page-subtitle" id="pageSubtitle">読み込み中...</p>
    </div>

    <!-- Loading State -->
    <div id="loadingState" class="loading-state">
      <p>データを読み込み中...</p>
    </div>

    <!-- Edit Form -->
    <form id="editForm" class="edit-form hidden">
      <input type="hidden" id="serviceId" />
      
      <!-- 基本情報 -->
      <section class="form-section">
        <h2 class="section-title">基本情報</h2>
        <div class="form-grid">
          <div class="form-group">
            <label for="nameJa">サービス名（日本語）<span class="required">*</span></label>
            <input type="text" id="nameJa" required />
          </div>
          <div class="form-group">
            <label for="nameEn">サービス名（英語）</label>
            <input type="text" id="nameEn" />
          </div>
          <div class="form-group">
            <label for="slug">スラッグ（URL）</label>
            <input type="text" id="slug" readonly class="readonly" />
            <p class="help-text">URLパスに使用されます（変更不可）</p>
          </div>
          <div class="form-group">
            <label for="heroImageUrl">ヒーロー画像URL</label>
            <input type="url" id="heroImageUrl" placeholder="/images/service/xxx-hero.jpg" />
          </div>
          <div class="form-group full-width">
            <label class="checkbox-label">
              <input type="checkbox" id="isPublished" />
              公開する
            </label>
          </div>
        </div>
      </section>

      <!-- ABOUT セクション -->
      <section class="form-section">
        <h2 class="section-title">ABOUTセクション</h2>
        <div class="form-grid">
          <div class="form-group full-width">
            <label for="aboutSubtitle">サブタイトル</label>
            <input type="text" id="aboutSubtitle" placeholder="〜最先端マイクロニードルRF治療〜" />
          </div>
          <div class="form-group full-width">
            <label for="aboutDescription">説明文</label>
            <textarea id="aboutDescription" rows="4" placeholder="施術の概要説明を入力してください"></textarea>
          </div>
        </div>
      </section>

      <!-- 特徴・こだわり -->
      <section class="form-section">
        <div class="section-header">
          <h2 class="section-title">特徴・こだわり</h2>
          <button type="button" class="btn btn-add" onclick="addFeature()">+ 追加</button>
        </div>
        <div id="featuresContainer" class="items-container">
          <p class="empty-message">特徴を追加してください</p>
        </div>
      </section>

      <!-- おすすめの方 -->
      <section class="form-section">
        <div class="section-header">
          <h2 class="section-title">おすすめの方・適応症状</h2>
          <button type="button" class="btn btn-add" onclick="addRecommendation()">+ 追加</button>
        </div>
        <div id="recommendationsContainer" class="items-container">
          <p class="empty-message">おすすめを追加してください</p>
        </div>
      </section>

      <!-- 施術概要 -->
      <section class="form-section">
        <h2 class="section-title">施術概要</h2>
        <div class="form-grid">
          <div class="form-group">
            <label for="duration">施術時間</label>
            <input type="text" id="duration" placeholder="60分程度" />
          </div>
          <div class="form-group">
            <label for="downtime">ダウンタイム</label>
            <input type="text" id="downtime" placeholder="赤み・腫れが数時間〜1日程度" />
          </div>
          <div class="form-group">
            <label for="frequency">施術頻度</label>
            <input type="text" id="frequency" placeholder="4週間〜6週間に1回" />
          </div>
          <div class="form-group">
            <label for="makeup">メイク</label>
            <input type="text" id="makeup" placeholder="12時間後から可能" />
          </div>
          <div class="form-group">
            <label for="bathing">入浴</label>
            <input type="text" id="bathing" placeholder="長時間の入浴は2〜3日控える" />
          </div>
          <div class="form-group full-width">
            <label for="contraindications">禁忌</label>
            <textarea id="contraindications" rows="3" placeholder="妊娠中・授乳中の方、ペースメーカーを装着されている方..."></textarea>
          </div>
        </div>
      </section>

      <!-- よくある質問 -->
      <section class="form-section">
        <div class="section-header">
          <h2 class="section-title">よくある質問（FAQ）</h2>
          <button type="button" class="btn btn-add" onclick="addFaq()">+ 追加</button>
        </div>
        <div id="faqsContainer" class="items-container">
          <p class="empty-message">FAQを追加してください</p>
        </div>
      </section>

      <!-- 保存ボタン -->
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" onclick="window.location.href='/services'">キャンセル</button>
        <button type="submit" class="btn btn-primary">保存</button>
      </div>
    </form>
  </div>
</Layout>

<style is:global>
  .service-edit-page {
    max-width: 900px;
    margin: 0 auto;
  }

  .back-link {
    color: var(--color-accent);
    text-decoration: none;
    font-size: 0.875rem;
  }

  .back-link:hover {
    text-decoration: underline;
  }

  .loading-state {
    text-align: center;
    padding: 3rem;
    background: var(--color-bg-card);
    border-radius: var(--radius-lg);
    color: var(--color-text-secondary);
  }

  .edit-form {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .edit-form.hidden {
    display: none;
  }

  .form-section {
    background: var(--color-bg-card);
    border: 1px solid var(--color-border-light);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
  }

  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
  }

  .section-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--color-text);
    margin: 0 0 1rem 0;
  }

  .section-header .section-title {
    margin: 0;
  }

  .form-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .form-group.full-width {
    grid-column: 1 / -1;
  }

  .form-group label {
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--color-text);
  }

  .required {
    color: #ef4444;
  }

  .form-group input,
  .form-group textarea,
  .form-group select {
    padding: 0.75rem;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    font-size: 0.875rem;
    transition: border-color var(--transition-fast);
  }

  .form-group input:focus,
  .form-group textarea:focus,
  .form-group select:focus {
    outline: none;
    border-color: var(--color-accent);
  }

  .form-group input.readonly {
    background: #f3f4f6;
    cursor: not-allowed;
  }

  .help-text {
    font-size: 0.75rem;
    color: var(--color-text-secondary);
    margin: 0;
  }

  .checkbox-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
  }

  .checkbox-label input {
    width: 1rem;
    height: 1rem;
  }

  .items-container {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .empty-message {
    color: var(--color-text-secondary);
    font-size: 0.875rem;
    text-align: center;
    padding: 1rem;
    background: #f9fafb;
    border-radius: var(--radius-md);
    margin: 0;
  }

  .item-card {
    background: #f9fafb;
    border: 1px solid var(--color-border-light);
    border-radius: var(--radius-md);
    padding: 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .item-row {
    display: flex;
    gap: 0.75rem;
  }

  .item-input {
    flex: 1;
  }

  .item-input input,
  .item-input textarea {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    font-size: 0.875rem;
  }

  .item-actions {
    display: flex;
    justify-content: flex-end;
  }

  .btn {
    padding: 0.5rem 1rem;
    border-radius: var(--radius-md);
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    border: none;
    transition: all var(--transition-fast);
  }

  .btn-primary {
    background: var(--color-accent);
    color: #fff;
  }

  .btn-primary:hover {
    opacity: 0.9;
  }

  .btn-secondary {
    background: #f3f4f6;
    color: #374151;
  }

  .btn-secondary:hover {
    background: #e5e7eb;
  }

  .btn-add {
    background: #10b981;
    color: #fff;
    font-size: 0.75rem;
    padding: 0.375rem 0.75rem;
  }

  .btn-add:hover {
    background: #059669;
  }

  .btn-remove {
    background: transparent;
    color: #ef4444;
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
  }

  .btn-remove:hover {
    background: #fef2f2;
  }

  .form-actions {
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
    padding: 1rem 0;
    border-top: 1px solid var(--color-border-light);
  }

  @media (max-width: 640px) {
    .form-grid {
      grid-template-columns: 1fr;
    }
  }
</style>

<script define:vars={{ slug }}>
  const serviceSlug = slug;
  
  // Data stores
  let serviceData = null;
  let features = [];
  let recommendations = [];
  let overview = null;
  let faqs = [];

  // DOM helpers
  const $ = (id) => document.getElementById(id);
  const escapeHtml = (text) => {
    const div = document.createElement('div');
    div.textContent = text || '';
    return div.innerHTML;
  };

  // Load service data
  async function loadData() {
    try {
      const response = await fetch(`/api/services/${serviceSlug}`);
      if (!response.ok) throw new Error('Failed to load service');
      
      const data = await response.json();
      serviceData = data.content;
      features = data.features || [];
      recommendations = data.recommendations || [];
      overview = data.overview;
      faqs = data.faqs || [];

      populateForm();
      
      $('loadingState').style.display = 'none';
      $('editForm').classList.remove('hidden');
      $('pageTitle').textContent = `${serviceData.nameJa} の編集`;
      $('pageSubtitle').textContent = serviceData.slug;
    } catch (error) {
      console.error('Error loading service:', error);
      $('loadingState').innerHTML = `<p style="color: #ef4444;">読み込みに失敗しました: ${error.message}</p>`;
    }
  }

  function populateForm() {
    $('serviceId').value = serviceData.id;
    $('nameJa').value = serviceData.nameJa || '';
    $('nameEn').value = serviceData.nameEn || '';
    $('slug').value = serviceData.slug || '';
    $('heroImageUrl').value = serviceData.heroImageUrl || '';
    $('isPublished').checked = serviceData.isPublished;
    $('aboutSubtitle').value = serviceData.aboutSubtitle || '';
    $('aboutDescription').value = serviceData.aboutDescription || '';

    if (overview) {
      $('duration').value = overview.duration || '';
      $('downtime').value = overview.downtime || '';
      $('frequency').value = overview.frequency || '';
      $('makeup').value = overview.makeup || '';
      $('bathing').value = overview.bathing || '';
      $('contraindications').value = overview.contraindications || '';
    }

    renderFeatures();
    renderRecommendations();
    renderFaqs();
  }

  // Features
  function renderFeatures() {
    const container = $('featuresContainer');
    if (features.length === 0) {
      container.innerHTML = '<p class="empty-message">特徴を追加してください</p>';
      return;
    }
    container.innerHTML = features.map((f, i) => `
      <div class="item-card">
        <div class="item-row">
          <div class="item-input">
            <input type="text" value="${escapeHtml(f.title)}" placeholder="タイトル" onchange="updateFeature(${i}, 'title', this.value)" />
          </div>
        </div>
        <div class="item-row">
          <div class="item-input">
            <textarea rows="2" placeholder="説明" onchange="updateFeature(${i}, 'description', this.value)">${escapeHtml(f.description || '')}</textarea>
          </div>
        </div>
        <div class="item-actions">
          <button type="button" class="btn btn-remove" onclick="removeFeature(${i})">削除</button>
        </div>
      </div>
    `).join('');
  }

  window.addFeature = function() {
    features.push({ title: '', description: '', sort_order: features.length });
    renderFeatures();
  };

  window.updateFeature = function(index, field, value) {
    features[index][field] = value;
  };

  window.removeFeature = function(index) {
    features.splice(index, 1);
    renderFeatures();
  };

  // Recommendations
  function renderRecommendations() {
    const container = $('recommendationsContainer');
    if (recommendations.length === 0) {
      container.innerHTML = '<p class="empty-message">おすすめを追加してください</p>';
      return;
    }
    container.innerHTML = recommendations.map((r, i) => `
      <div class="item-card">
        <div class="item-row">
          <div class="item-input">
            <input type="text" value="${escapeHtml(r.text)}" placeholder="✓ 毛穴を引き締めたい" onchange="updateRecommendation(${i}, 'text', this.value)" />
          </div>
          <button type="button" class="btn btn-remove" onclick="removeRecommendation(${i})">削除</button>
        </div>
      </div>
    `).join('');
  }

  window.addRecommendation = function() {
    recommendations.push({ text: '', sort_order: recommendations.length });
    renderRecommendations();
  };

  window.updateRecommendation = function(index, field, value) {
    recommendations[index][field] = value;
  };

  window.removeRecommendation = function(index) {
    recommendations.splice(index, 1);
    renderRecommendations();
  };

  // FAQs
  function renderFaqs() {
    const container = $('faqsContainer');
    if (faqs.length === 0) {
      container.innerHTML = '<p class="empty-message">FAQを追加してください</p>';
      return;
    }
    container.innerHTML = faqs.map((f, i) => `
      <div class="item-card">
        <div class="item-row">
          <div class="item-input">
            <input type="text" value="${escapeHtml(f.question)}" placeholder="質問" onchange="updateFaq(${i}, 'question', this.value)" />
          </div>
        </div>
        <div class="item-row">
          <div class="item-input">
            <textarea rows="2" placeholder="回答" onchange="updateFaq(${i}, 'answer', this.value)">${escapeHtml(f.answer || '')}</textarea>
          </div>
        </div>
        <div class="item-actions">
          <button type="button" class="btn btn-remove" onclick="removeFaq(${i})">削除</button>
        </div>
      </div>
    `).join('');
  }

  window.addFaq = function() {
    faqs.push({ question: '', answer: '', sort_order: faqs.length });
    renderFaqs();
  };

  window.updateFaq = function(index, field, value) {
    faqs[index][field] = value;
  };

  window.removeFaq = function(index) {
    faqs.splice(index, 1);
    renderFaqs();
  };

  // Form submission
  $('editForm')?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const payload = {
      content: {
        name_ja: $('nameJa').value,
        name_en: $('nameEn').value || null,
        hero_image_url: $('heroImageUrl').value || null,
        is_published: $('isPublished').checked ? 1 : 0,
        about_subtitle: $('aboutSubtitle').value || null,
        about_description: $('aboutDescription').value || null,
      },
      features: features.map((f, i) => ({
        ...f,
        sort_order: i
      })),
      recommendations: recommendations.map((r, i) => ({
        ...r,
        sort_order: i
      })),
      overview: {
        duration: $('duration').value || null,
        downtime: $('downtime').value || null,
        frequency: $('frequency').value || null,
        makeup: $('makeup').value || null,
        bathing: $('bathing').value || null,
        contraindications: $('contraindications').value || null,
      },
      faqs: faqs.map((f, i) => ({
        ...f,
        sort_order: i
      })),
    };

    try {
      const response = await fetch(`/api/services/${serviceSlug}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.message || 'Failed to save');
      }

      alert('保存しました！');
      window.location.reload();
    } catch (error) {
      console.error('Error saving:', error);
      alert('保存に失敗しました: ' + error.message);
    }
  });

  document.addEventListener('DOMContentLoaded', loadData);
</script>

