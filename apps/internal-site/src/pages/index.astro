---
import Layout from '../components/Layout.astro';
---

<Layout>
  <div class="dashboard">
    <!-- Page Header -->
    <div class="page-header">
      <div>
        <h1 class="page-title">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
        <p class="page-subtitle">ãƒ¬ãƒ‡ã‚£ã‚¢ãƒ³ã‚¯ãƒªãƒ‹ãƒƒã‚¯ ç®¡ç†ã‚µã‚¤ãƒˆ</p>
      </div>
    </div>

    <!-- Stats Grid -->
    <div class="stats-grid">
      <div class="stat-card animate-fade-in stagger-1">
        <div class="stat-content">
          <div class="stat-icon">ğŸ“‚</div>
          <div class="stat-info">
            <p class="stat-label">ã‚«ãƒ†ã‚´ãƒªæ•°</p>
            <p class="stat-value" id="categoriesCount">-</p>
          </div>
        </div>
      </div>
      
      <div class="stat-card animate-fade-in stagger-2">
        <div class="stat-content">
          <div class="stat-icon">âœ¨</div>
          <div class="stat-info">
            <p class="stat-label">æ–½è¡“æ•°</p>
            <p class="stat-value" id="treatmentsCount">-</p>
          </div>
        </div>
      </div>
      
      <div class="stat-card animate-fade-in stagger-3">
        <div class="stat-content">
          <div class="stat-icon">ğŸ’°</div>
          <div class="stat-info">
            <p class="stat-label">æ–™é‡‘ãƒ—ãƒ©ãƒ³æ•°</p>
            <p class="stat-value" id="plansCount">-</p>
          </div>
        </div>
      </div>
      
      <div class="stat-card animate-fade-in stagger-4">
        <div class="stat-content">
          <div class="stat-icon">ğŸ</div>
          <div class="stat-info">
            <p class="stat-label">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³</p>
            <p class="stat-value" id="campaignsCount">-</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Quick Actions -->
    <section class="section animate-fade-in" style="animation-delay: 0.2s">
      <h2 class="section-title">ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h2>
      <div class="actions-grid">
        <a href="/pricing" class="action-card">
          <span class="action-icon">ğŸ’°</span>
          <span class="action-title">æ–™é‡‘ç®¡ç†</span>
          <span class="action-desc">ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ–™é‡‘ã®ç®¡ç†</span>
        </a>
        
        <a href="/campaigns" class="action-card">
          <span class="action-icon">ğŸ</span>
          <span class="action-title">ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³</span>
          <span class="action-desc">ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ç®¡ç†</span>
        </a>
        
        <a href="/menu" class="action-card">
          <span class="action-icon">ğŸ“‹</span>
          <span class="action-title">æ–½è¡“ä¸€è¦§</span>
          <span class="action-desc">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ»æ–™é‡‘ãƒ»ã‚«ã‚¦ãƒ³ã‚»ãƒªãƒ³ã‚°è³‡æ–™</span>
        </a>
        
        <a href="/before-afters" class="action-card">
          <span class="action-icon">ğŸ“¸</span>
          <span class="action-title">ç—‡ä¾‹å†™çœŸ</span>
          <span class="action-desc">ãƒ“ãƒ•ã‚©ãƒ¼ã‚¢ãƒ•ã‚¿ãƒ¼ç®¡ç†</span>
        </a>
      </div>
    </section>

    <!-- Active Campaigns -->
    <section class="section animate-fade-in" style="animation-delay: 0.3s">
      <div class="section-header">
        <h2 class="section-title">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³</h2>
        <a href="/campaigns" class="section-link">ã™ã¹ã¦è¦‹ã‚‹ â†’</a>
      </div>
      <div class="card">
        <div id="activeCampaigns" class="campaign-list">
          <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>
      </div>
    </section>

    <!-- Recent Plans -->
    <section class="section animate-fade-in" style="animation-delay: 0.4s">
      <div class="section-header">
        <h2 class="section-title">æœ€è¿‘è¿½åŠ ã•ã‚ŒãŸæ–™é‡‘ãƒ—ãƒ©ãƒ³</h2>
        <a href="/pricing" class="section-link">ã™ã¹ã¦è¦‹ã‚‹ â†’</a>
      </div>
      <div class="card">
        <div id="recentPlans" class="plan-list">
          <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>
      </div>
    </section>
  </div>
</Layout>

<style>
  .dashboard {
    display: flex;
    flex-direction: column;
    gap: 2rem;
  }

  /* Stats Grid */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1.25rem;
  }

  .stat-card {
    background: var(--color-bg-card);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    border: 1px solid var(--color-border-light);
    box-shadow: var(--shadow-sm);
    position: relative;
    overflow: hidden;
    transition: all var(--transition-base);
  }

  .stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--color-accent) 0%, var(--color-accent-light) 100%);
  }

  .stat-card:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow-md);
  }

  .stat-content {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .stat-icon {
    font-size: 2.5rem;
    opacity: 0.9;
  }

  .stat-info {
    flex: 1;
  }

  .stat-label {
    font-size: 0.8125rem;
    color: var(--color-text-muted);
    margin: 0 0 0.25rem 0;
  }

  .stat-value {
    font-size: 2rem;
    font-weight: 700;
    color: var(--color-text);
    margin: 0;
    line-height: 1.2;
  }

  /* Sections */
  .section {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .section-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--color-text);
    margin: 0;
  }

  .section-link {
    font-size: 0.875rem;
    color: var(--color-accent);
    text-decoration: none;
    font-weight: 500;
    transition: color var(--transition-fast);
  }

  .section-link:hover {
    color: var(--color-accent-dark);
  }

  /* Actions Grid */
  .actions-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1rem;
  }

  /* Card */
  .card {
    background: var(--color-bg-card);
    border-radius: var(--radius-lg);
    border: 1px solid var(--color-border-light);
    box-shadow: var(--shadow-sm);
    overflow: hidden;
  }

  /* Campaign List */
  .campaign-list {
    padding: 0;
  }

  .campaign-item {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid var(--color-border-light);
    transition: background var(--transition-fast);
  }

  .campaign-item:last-child {
    border-bottom: none;
  }

  .campaign-item:hover {
    background: var(--color-bg-hover);
  }

  .campaign-info {
    flex: 1;
  }

  .campaign-title {
    font-size: 1rem;
    font-weight: 600;
    color: var(--color-text);
    margin: 0 0 0.25rem 0;
  }

  .campaign-period {
    font-size: 0.8125rem;
    color: var(--color-text-muted);
    margin: 0 0 0.5rem 0;
  }

  .campaign-desc {
    font-size: 0.875rem;
    color: var(--color-text-secondary);
    margin: 0;
  }

  /* Plan List */
  .plan-list {
    padding: 0;
  }

  .plan-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid var(--color-border-light);
    transition: background var(--transition-fast);
  }

  .plan-item:last-child {
    border-bottom: none;
  }

  .plan-item:hover {
    background: var(--color-bg-hover);
  }

  .plan-info {
    flex: 1;
  }

  .plan-name {
    font-size: 1rem;
    font-weight: 600;
    color: var(--color-text);
    margin: 0 0 0.25rem 0;
  }

  .plan-category {
    font-size: 0.8125rem;
    color: var(--color-text-muted);
    margin: 0;
  }

  .plan-price {
    font-size: 1.125rem;
    font-weight: 700;
    color: var(--color-accent);
    margin-right: 1rem;
  }

  /* Empty State */
  .empty-state {
    padding: 3rem 2rem;
    text-align: center;
    color: var(--color-text-muted);
  }

  /* Responsive */
  @media (max-width: 1200px) {
    .stats-grid {
      grid-template-columns: repeat(2, 1fr);
    }

    .actions-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 640px) {
    .stats-grid {
      grid-template-columns: 1fr;
    }

    .actions-grid {
      grid-template-columns: 1fr;
    }
  }
</style>

<script>
  // çµ±è¨ˆæƒ…å ±ã‚’èª­ã¿è¾¼ã‚€
  async function loadStats() {
    try {
      // ã‚«ãƒ†ã‚´ãƒªæ•°
      const catRes = await fetch('/api/categories');
      if (catRes.ok) {
        const catData = await catRes.json();
        const categoriesCount = catData.categories?.length || 0;
        const catElement = document.getElementById('categoriesCount');
        if (catElement) catElement.textContent = categoriesCount.toString();
      }

      // æ–™é‡‘ãƒ—ãƒ©ãƒ³æ•°
      const pricingRes = await fetch('/api/pricing');
      if (pricingRes.ok) {
        const pricingData = await pricingRes.json();
        const plans = pricingData.plans || [];
        const plansCount = plans.length;
        const plansElement = document.getElementById('plansCount');
        if (plansElement) plansElement.textContent = plansCount.toString();

        // æ–½è¡“æ•°ï¼ˆãƒ¦ãƒ‹ãƒ¼ã‚¯ãªtreatment_idã®æ•°ï¼‰
        const uniqueTreatments = new Set(plans.map((p: any) => p.treatment_id));
        const treatmentsCount = uniqueTreatments.size;
        const treatmentsElement = document.getElementById('treatmentsCount');
        if (treatmentsElement) treatmentsElement.textContent = treatmentsCount.toString();
      }

      // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³æ•°
      const campaignsRes = await fetch('/api/campaigns?is_published=1');
      if (campaignsRes.ok) {
        const campaignsData = await campaignsRes.json();
        const allCampaigns = campaignsData.campaigns || [];
        const now = new Date();
        const activeCampaigns = allCampaigns.filter((c: any) => {
          const startDate = c.start_date ? new Date(c.start_date) : null;
          const endDate = c.end_date ? new Date(c.end_date) : null;
          const isInPeriod = (!startDate || startDate <= now) && (!endDate || endDate >= now);
          return isInPeriod;
        });
        const campaignsCount = activeCampaigns.length;
        const campaignsElement = document.getElementById('campaignsCount');
        if (campaignsElement) campaignsElement.textContent = campaignsCount.toString();
      }
    } catch (error) {
      console.error('çµ±è¨ˆæƒ…å ±èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
    }
  }

  // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã‚’èª­ã¿è¾¼ã‚€
  async function loadActiveCampaigns() {
    try {
      const res = await fetch('/api/campaigns?is_published=1');
      if (!res.ok) return;

      const data = await res.json();
      const allCampaigns = data.campaigns || [];
      
      const now = new Date();
      const activeCampaigns = allCampaigns.filter((c: any) => {
        const startDate = c.start_date ? new Date(c.start_date) : null;
        const endDate = c.end_date ? new Date(c.end_date) : null;
        return (!startDate || startDate <= now) && (!endDate || endDate >= now);
      });
      
      const container = document.getElementById('activeCampaigns');
      if (!container) return;

      if (activeCampaigns.length === 0) {
        container.innerHTML = '<div class="empty-state">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }

      const recentCampaigns = activeCampaigns.slice(0, 5);

      container.innerHTML = recentCampaigns.map((campaign: any) => {
        const startDate = campaign.start_date ? new Date(campaign.start_date).toLocaleDateString('ja-JP') : 'é–‹å§‹æ—¥æœªè¨­å®š';
        const endDate = campaign.end_date ? new Date(campaign.end_date).toLocaleDateString('ja-JP') : 'çµ‚äº†æ—¥æœªè¨­å®š';
        
        return `
          <div class="campaign-item">
            <div class="campaign-info">
              <h4 class="campaign-title">${escapeHtml(campaign.title)}</h4>
              <p class="campaign-period">${startDate} ã€œ ${endDate}</p>
              ${campaign.description ? `<p class="campaign-desc">${escapeHtml(campaign.description.substring(0, 100))}${campaign.description.length > 100 ? '...' : ''}</p>` : ''}
            </div>
            <a href="/campaigns/${campaign.id}/edit" class="btn btn-primary btn-sm">ç·¨é›†</a>
          </div>
        `;
      }).join('');
    } catch (error) {
      console.error('ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      const container = document.getElementById('activeCampaigns');
      if (container) {
        container.innerHTML = '<div class="empty-state" style="color: var(--color-error)">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
      }
    }
  }

  // æœ€è¿‘è¿½åŠ ã•ã‚ŒãŸæ–™é‡‘ãƒ—ãƒ©ãƒ³ã‚’èª­ã¿è¾¼ã‚€
  async function loadRecentPlans() {
    try {
      const res = await fetch('/api/pricing');
      if (!res.ok) return;

      const data = await res.json();
      const plans = data.plans || [];
      const container = document.getElementById('recentPlans');
      if (!container) return;

      if (plans.length === 0) {
        container.innerHTML = '<div class="empty-state">æ–™é‡‘ãƒ—ãƒ©ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }

      const recentPlans = plans.slice(0, 10);

      container.innerHTML = recentPlans.map((plan: any) => {
        return `
          <div class="plan-item">
            <div class="plan-info">
              <h4 class="plan-name">${escapeHtml(plan.subcategory_name)} - ${escapeHtml(plan.plan_name)}</h4>
              <p class="plan-category">${escapeHtml(plan.category_name)} / ${escapeHtml(plan.subcategory_name)}</p>
            </div>
            <span class="plan-price">Â¥${plan.price_taxed.toLocaleString()}</span>
            <a href="/pricing/${plan.id}/edit" class="btn btn-primary btn-sm">ç·¨é›†</a>
          </div>
        `;
      }).join('');
    } catch (error) {
      console.error('æ–™é‡‘ãƒ—ãƒ©ãƒ³èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      const container = document.getElementById('recentPlans');
      if (container) {
        container.innerHTML = '<div class="empty-state" style="color: var(--color-error)">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
      }
    }
  }

  function escapeHtml(text: string): string {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  document.addEventListener('DOMContentLoaded', () => {
    loadStats();
    loadActiveCampaigns();
    loadRecentPlans();
  });
</script>
