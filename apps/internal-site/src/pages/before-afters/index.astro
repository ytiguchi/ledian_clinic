---
import Layout from '../../components/Layout.astro';
---

<Layout>
  <div class="before-afters-page">
    <!-- Page Header -->
    <div class="page-header">
      <div>
        <h1 class="page-title">ç—‡ä¾‹å†™çœŸç®¡ç†</h1>
        <p class="page-subtitle">ãƒ“ãƒ•ã‚©ãƒ¼ã‚¢ãƒ•ã‚¿ãƒ¼å†™çœŸã‚’ç®¡ç†ã—ã¾ã™</p>
      </div>
      <a href="/before-afters/new" class="btn btn-primary">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        æ–°è¦ç—‡ä¾‹è¿½åŠ 
      </a>
    </div>

    <!-- Filter Bar -->
    <div class="filter-bar">
      <div class="filter-grid">
        <div class="filter-item">
          <label class="label">ã‚«ãƒ†ã‚´ãƒª</label>
          <select class="select" id="categoryFilter">
            <option value="">ã™ã¹ã¦ã®ã‚«ãƒ†ã‚´ãƒª</option>
          </select>
        </div>
        <div class="filter-item">
          <label class="label">æ–½è¡“</label>
          <select class="select" id="treatmentFilter">
            <option value="">ã™ã¹ã¦ã®æ–½è¡“</option>
          </select>
        </div>
        <div class="filter-item">
          <label class="label">å…¬é–‹çŠ¶æ…‹</label>
          <select class="select" id="publishedFilter">
            <option value="">ã™ã¹ã¦</option>
            <option value="published">å…¬é–‹ä¸­ã®ã¿</option>
            <option value="unpublished">éå…¬é–‹ã®ã¿</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Before/After Grid -->
    <div class="gallery-grid" id="beforeAfterGrid">
      <div class="loading-container">
        <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>
    </div>
  </div>
</Layout>

<style>
  .before-afters-page {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .filter-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
  }

  .filter-item {
    display: flex;
    flex-direction: column;
    gap: 0.375rem;
  }

  /* Gallery Grid */
  .gallery-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1.5rem;
  }

  .loading-container {
    grid-column: 1 / -1;
    display: flex;
    justify-content: center;
    padding: 3rem;
  }

  /* Gallery Card */
  .gallery-card {
    background: var(--color-bg-card);
    border-radius: var(--radius-lg);
    border: 1px solid var(--color-border-light);
    box-shadow: var(--shadow-sm);
    overflow: hidden;
    transition: all var(--transition-base);
    animation: fadeIn 0.3s ease-out backwards;
  }

  .gallery-card:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow-lg);
  }

  /* Image Comparison */
  .image-comparison {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2px;
    background: var(--color-border-light);
  }

  .image-wrapper {
    position: relative;
    aspect-ratio: 1;
    background: var(--color-bg-hover);
    overflow: hidden;
  }

  .image-wrapper img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform var(--transition-slow);
  }

  .gallery-card:hover .image-wrapper img {
    transform: scale(1.05);
  }

  .image-label {
    position: absolute;
    bottom: 0.5rem;
    left: 0.5rem;
    padding: 0.25rem 0.5rem;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    font-size: 0.6875rem;
    font-weight: 600;
    border-radius: var(--radius-sm);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .image-label.before {
    background: var(--color-primary);
  }

  .image-label.after {
    background: var(--color-accent);
    color: var(--color-primary);
  }

  /* Card Content */
  .card-content {
    padding: 1.25rem;
  }

  .card-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    margin-bottom: 0.75rem;
  }

  .treatment-name {
    font-size: 1rem;
    font-weight: 600;
    color: var(--color-text);
    margin: 0;
  }

  .card-caption {
    font-size: 0.875rem;
    color: var(--color-text-secondary);
    margin: 0 0 0.75rem 0;
    line-height: 1.5;
  }

  /* Card Meta */
  .card-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 1rem;
  }

  .meta-tag {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.25rem 0.5rem;
    background: var(--color-bg-hover);
    border-radius: var(--radius-sm);
    font-size: 0.75rem;
    color: var(--color-text-muted);
  }

  /* Card Actions */
  .card-actions {
    display: flex;
    gap: 0.5rem;
  }

  .action-btn {
    flex: 1;
    padding: 0.5rem 1rem;
    font-size: 0.8125rem;
    font-weight: 500;
    border-radius: var(--radius-md);
    text-decoration: none;
    text-align: center;
    transition: all var(--transition-fast);
    cursor: pointer;
    border: none;
  }

  .action-btn-edit {
    background: var(--color-accent);
    color: var(--color-primary);
  }

  .action-btn-edit:hover {
    background: var(--color-accent-light);
  }

  .action-btn-delete {
    background: var(--color-error-light);
    color: #b91c1c;
  }

  .action-btn-delete:hover {
    background: var(--color-error);
    color: white;
  }

  /* Responsive */
  @media (max-width: 1200px) {
    .gallery-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 768px) {
    .filter-grid {
      grid-template-columns: 1fr;
    }

    .gallery-grid {
      grid-template-columns: 1fr;
    }
  }
</style>

<script>
  interface BeforeAfter {
    id: string;
    treatment_id: string;
    treatment_name: string;
    before_image_url: string;
    after_image_url: string;
    caption: string | null;
    patient_age: number | null;
    patient_gender: string | null;
    treatment_count: number | null;
    treatment_period: string | null;
    is_published: number;
    sort_order: number;
    created_at: string;
  }

  let beforeAfters: BeforeAfter[] = [];
  let categories: Array<{ id: string; name: string }> = [];
  let selectedCategoryId = '';
  let selectedTreatmentId = '';
  let selectedPublished: string = '';

  async function loadCategories() {
    try {
      const res = await fetch('/api/categories');
      const data = await res.json();
      categories = data.categories || [];
      
      const select = document.getElementById('categoryFilter') as HTMLSelectElement;
      if (select) {
        select.innerHTML = '<option value="">ã™ã¹ã¦ã®ã‚«ãƒ†ã‚´ãƒª</option>' +
          categories.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('');
      }
    } catch (error) {
      console.error('ã‚«ãƒ†ã‚´ãƒªèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
    }
  }

  async function loadTreatments(categoryId: string) {
    const select = document.getElementById('treatmentFilter') as HTMLSelectElement;
    if (select) {
      select.innerHTML = '<option value="">ã™ã¹ã¦ã®æ–½è¡“</option>';
    }
  }

  async function loadBeforeAfters() {
    try {
      const params = new URLSearchParams();
      if (selectedTreatmentId) params.append('treatment_id', selectedTreatmentId);
      if (selectedPublished === 'published') params.append('is_published', '1');
      if (selectedPublished === 'unpublished') params.append('is_published', '0');

      const res = await fetch(`/api/before-afters?${params.toString()}`);
      const data = await res.json();
      beforeAfters = data.before_afters || [];
      renderGrid();
    } catch (error) {
      console.error('ç—‡ä¾‹å†™çœŸèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      showError('ç—‡ä¾‹å†™çœŸã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  }

  function renderGrid() {
    const grid = document.getElementById('beforeAfterGrid');
    if (!grid) return;

    if (beforeAfters.length === 0) {
      grid.innerHTML = `
        <div class="loading-container" style="grid-column: 1 / -1">
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ“¸</div>
            <div class="empty-state-title">ç—‡ä¾‹å†™çœŸãŒã‚ã‚Šã¾ã›ã‚“</div>
            <div class="empty-state-desc">æ–°è¦ç—‡ä¾‹ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</div>
          </div>
        </div>
      `;
      return;
    }

    grid.innerHTML = beforeAfters.map((item, index) => `
      <div class="gallery-card" style="animation-delay: ${index * 0.05}s">
        <div class="image-comparison">
          <div class="image-wrapper">
            <img 
              src="${escapeHtml(item.before_image_url)}" 
              alt="æ–½è¡“å‰"
              loading="lazy"
              onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22%3E%3Crect fill=%22%23f1f5f9%22 width=%22100%22 height=%22100%22/%3E%3Ctext x=%2250%22 y=%2255%22 text-anchor=%22middle%22 fill=%22%2394a3b8%22 font-size=%2212%22%3EBefore%3C/text%3E%3C/svg%3E'"
            />
            <span class="image-label before">Before</span>
          </div>
          <div class="image-wrapper">
            <img 
              src="${escapeHtml(item.after_image_url)}" 
              alt="æ–½è¡“å¾Œ"
              loading="lazy"
              onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22%3E%3Crect fill=%22%23fef3c7%22 width=%22100%22 height=%22100%22/%3E%3Ctext x=%2250%22 y=%2255%22 text-anchor=%22middle%22 fill=%22%23b8922e%22 font-size=%2212%22%3EAfter%3C/text%3E%3C/svg%3E'"
            />
            <span class="image-label after">After</span>
          </div>
        </div>
        <div class="card-content">
          <div class="card-header">
            <h3 class="treatment-name">${escapeHtml(item.treatment_name)}</h3>
            <span class="badge ${item.is_published === 1 ? 'badge-success' : 'badge-neutral'}">
              ${item.is_published === 1 ? 'å…¬é–‹' : 'éå…¬é–‹'}
            </span>
          </div>
          ${item.caption ? `<p class="card-caption">${escapeHtml(item.caption)}</p>` : ''}
          <div class="card-meta">
            ${item.treatment_count ? `<span class="meta-tag">ğŸ”„ ${item.treatment_count}å›</span>` : ''}
            ${item.treatment_period ? `<span class="meta-tag">ğŸ“… ${item.treatment_period}</span>` : ''}
            ${item.patient_age ? `<span class="meta-tag">ğŸ‘¤ ${item.patient_age}æ­³</span>` : ''}
            ${item.patient_gender ? `<span class="meta-tag">${item.patient_gender === 'å¥³æ€§' ? 'â™€ï¸' : 'â™‚ï¸'} ${item.patient_gender}</span>` : ''}
          </div>
          <div class="card-actions">
            <a href="/before-afters/${item.id}/edit" class="action-btn action-btn-edit">ç·¨é›†</a>
            <button onclick="deleteBeforeAfter('${item.id}')" class="action-btn action-btn-delete">å‰Šé™¤</button>
          </div>
        </div>
      </div>
    `).join('');
  }

  function escapeHtml(text: string): string {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function showError(message: string) {
    const grid = document.getElementById('beforeAfterGrid');
    if (grid) {
      grid.innerHTML = `
        <div class="loading-container" style="grid-column: 1 / -1">
          <div class="empty-state" style="color: var(--color-error)">
            <div class="empty-state-icon">âš ï¸</div>
            <div class="empty-state-title">${escapeHtml(message)}</div>
          </div>
        </div>
      `;
    }
  }

  async function deleteBeforeAfter(id: string) {
    if (!confirm('ã“ã®ç—‡ä¾‹å†™çœŸã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
    
    try {
      const res = await fetch(`/api/before-afters/${id}`, { method: 'DELETE' });
      if (res.ok) {
        await loadBeforeAfters();
      } else {
        alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    } catch (error) {
      console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
      alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    loadCategories();
    loadBeforeAfters();

    const categoryFilter = document.getElementById('categoryFilter') as HTMLSelectElement;
    const treatmentFilter = document.getElementById('treatmentFilter') as HTMLSelectElement;
    const publishedFilter = document.getElementById('publishedFilter') as HTMLSelectElement;

    categoryFilter?.addEventListener('change', () => {
      selectedCategoryId = categoryFilter.value;
      if (selectedCategoryId) {
        loadTreatments(selectedCategoryId);
      }
      loadBeforeAfters();
    });

    treatmentFilter?.addEventListener('change', () => {
      selectedTreatmentId = treatmentFilter.value;
      loadBeforeAfters();
    });

    publishedFilter?.addEventListener('change', () => {
      selectedPublished = publishedFilter.value;
      loadBeforeAfters();
    });
  });

  (window as any).deleteBeforeAfter = deleteBeforeAfter;
</script>
