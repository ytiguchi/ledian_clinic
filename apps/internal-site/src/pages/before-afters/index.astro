---
import Layout from '../../components/Layout.astro';
---

<Layout>
  <div class="before-afters-page">
    <!-- Page Header -->
    <div class="page-header">
      <div>
        <h1 class="page-title">ğŸ“¸ ç—‡ä¾‹å†™çœŸç®¡ç†</h1>
        <p class="page-subtitle">ãƒ“ãƒ•ã‚©ãƒ¼ã‚¢ãƒ•ã‚¿ãƒ¼å†™çœŸã‚’ç®¡ç†ã—ã¾ã™</p>
      </div>
      <a href="/before-afters/new" class="btn btn-primary">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        æ–°è¦ç—‡ä¾‹è¿½åŠ 
      </a>
    </div>

    <!-- Stats -->
    <div class="stats-row" id="statsRow">
      <div class="stat-card">
        <span class="stat-value" id="totalCount">-</span>
        <span class="stat-label">ç·ä»¶æ•°</span>
      </div>
      <div class="stat-card">
        <span class="stat-value" id="publishedCount">-</span>
        <span class="stat-label">å…¬é–‹ä¸­</span>
      </div>
      <div class="stat-card">
        <span class="stat-value" id="subcategoryCount">-</span>
        <span class="stat-label">æ–½è¡“ç¨®é¡</span>
      </div>
    </div>

    <!-- Filter Bar -->
    <div class="filter-bar">
      <div class="filter-grid">
        <div class="filter-item">
          <label class="label">ã‚«ãƒ†ã‚´ãƒª</label>
          <select class="select" id="categoryFilter">
            <option value="">ã™ã¹ã¦ã®ã‚«ãƒ†ã‚´ãƒª</option>
          </select>
        </div>
        <div class="filter-item">
          <label class="label">ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒª</label>
          <select class="select" id="subcategoryFilter">
            <option value="">ã™ã¹ã¦ã®ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒª</option>
          </select>
        </div>
        <div class="filter-item">
          <label class="label">å…¬é–‹çŠ¶æ…‹</label>
          <select class="select" id="publishedFilter">
            <option value="">ã™ã¹ã¦</option>
            <option value="published">å…¬é–‹ä¸­ã®ã¿</option>
            <option value="unpublished">éå…¬é–‹ã®ã¿</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Cases List -->
    <div class="cases-list" id="casesList">
      <div class="loading-container">
        <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>
    </div>
  </div>
</Layout>

<style>
  .before-afters-page {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    width: 100%;
    max-width: 100%;
    overflow-x: hidden;
    box-sizing: border-box;
  }

  /* Prevent any horizontal overflow */
  body {
    overflow-x: hidden;
  }

  /* Stats Row */
  .stats-row {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
  }

  .stat-card {
    background: linear-gradient(135deg, var(--color-bg-card) 0%, var(--color-bg) 100%);
    border: 1px solid var(--color-border-light);
    border-radius: 12px;
    padding: 0.75rem 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .stat-value {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--color-accent);
  }

  .stat-label {
    font-size: 0.75rem;
    color: var(--color-text-muted);
  }

  /* Filter */
  .filter-bar {
    background: var(--color-bg-card);
    border: 1px solid var(--color-border-light);
    border-radius: 12px;
    padding: 0.75rem 1rem;
  }

  .filter-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0.75rem;
  }

  .filter-item {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  /* Cases List - Absolute 2 Column Grid */
  .cases-list {
    display: grid;
    grid-template-columns: calc(50% - 0.5rem) calc(50% - 0.5rem);
    gap: 1rem;
    width: 100%;
    max-width: 100%;
    align-items: start;
    box-sizing: border-box;
  }

  .loading-container {
    grid-column: 1 / -1;
    display: flex;
    justify-content: center;
    padding: 3rem;
  }

  /* Case Card - Equal Height with Strict Constraints */
  .case-card {
    background: var(--color-bg-card);
    border: 1px solid var(--color-border-light);
    border-radius: 12px;
    overflow: hidden;
    animation: fadeIn 0.3s ease-out backwards;
    display: flex;
    flex-direction: column;
    width: 100%;
    max-width: 100%;
    min-width: 0;
    box-sizing: border-box;
    height: 100%;
  }

  .case-card * {
    box-sizing: border-box;
    max-width: 100%;
  }

  .case-card:hover {
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
  }

  /* Case Header - Compact */
  .case-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0.75rem;
    background: linear-gradient(135deg, var(--color-bg-secondary) 0%, var(--color-bg) 100%);
    border-bottom: 1px solid var(--color-border-light);
    gap: 0.5rem;
    min-height: 44px;
  }

  .case-title-section {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    min-width: 0;
    flex: 1;
    overflow: hidden;
  }

  .case-title {
    font-size: 0.8125rem;
    font-weight: 600;
    margin: 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .case-category {
    font-size: 0.625rem;
    color: var(--color-text-muted);
    background: var(--color-bg);
    padding: 0.125rem 0.375rem;
    border-radius: 8px;
    border: 1px solid var(--color-border);
    white-space: nowrap;
    flex-shrink: 0;
  }

  .case-actions {
    display: flex;
    gap: 0.25rem;
    align-items: center;
    flex-shrink: 0;
  }

  .badge-success {
    background: #dcfce7;
    color: #166534;
    padding: 0.125rem 0.375rem;
    border-radius: 8px;
    font-size: 0.5625rem;
    font-weight: 500;
    white-space: nowrap;
  }

  .badge-neutral {
    background: #f1f5f9;
    color: #475569;
    padding: 0.125rem 0.375rem;
    border-radius: 8px;
    font-size: 0.5625rem;
    font-weight: 500;
    white-space: nowrap;
  }

  /* Case Body - Clean Layout */
  .case-body {
    display: flex;
    flex-direction: column;
    padding: 0.75rem;
    flex: 1;
    min-height: 0;
    gap: 0.75rem;
  }

  /* Image Comparison - Side by Side */
  .image-comparison {
    display: grid;
    grid-template-columns: calc(50% - 0.25rem) calc(50% - 0.25rem);
    gap: 0.5rem;
    width: 100%;
    max-width: 100%;
    min-width: 0;
  }

  .image-panel {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    min-width: 0;
    width: 100%;
    max-width: 100%;
  }

  .image-label {
    font-size: 0.625rem;
    font-weight: 600;
    text-align: center;
    padding: 0.125rem 0.375rem;
    border-radius: 4px;
    white-space: nowrap;
  }

  .image-label.before {
    background: #f1f5f9;
    color: #475569;
  }

  .image-label.after {
    background: #fef3c7;
    color: #92400e;
  }

  .image-wrapper {
    width: 100%;
    max-width: 100%;
    min-width: 0;
    aspect-ratio: 3/4;
    border-radius: 6px;
    overflow: hidden;
    border: 1px solid var(--color-border-light);
    background: var(--color-bg-secondary);
    position: relative;
    flex-shrink: 0;
  }

  .image-wrapper img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    display: block;
    max-width: 100%;
    max-height: 100%;
    min-width: 0;
  }

  .no-image {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
    font-size: 0.625rem;
    color: var(--color-text-muted);
    text-align: center;
    padding: 0.25rem;
  }

  /* Case Info */
  .case-info {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    width: 100%;
    min-width: 0;
    flex: 1;
  }

  .info-section {
    padding: 0.5rem;
    background: var(--color-bg-secondary);
    border-radius: 6px;
    border-left: 2px solid var(--color-accent);
    width: 100%;
    max-width: 100%;
    overflow: hidden;
  }

  .info-section-title {
    font-size: 0.6875rem;
    font-weight: 600;
    color: var(--color-accent);
    margin: 0 0 0.25rem 0;
    display: flex;
    align-items: center;
    gap: 0.25rem;
  }

  .info-section-content {
    font-size: 0.6875rem;
    line-height: 1.4;
    color: var(--color-text);
    white-space: pre-wrap;
    word-break: break-word;
    overflow-wrap: break-word;
    max-width: 100%;
  }

  .info-section-content.truncate {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .info-section-full {
    max-height: 200px;
    overflow-y: auto;
    overflow-x: hidden;
  }

  .info-section-full .info-section-content {
    font-size: 0.6875rem;
    line-height: 1.4;
  }

  .caption-section-header {
    display: block;
    font-weight: 700;
    color: var(--color-accent);
    margin-top: 0.5rem;
    margin-bottom: 0.125rem;
    font-size: 0.6875rem;
  }

  .caption-section-header:first-child {
    margin-top: 0;
  }

  /* Meta Row */
  .meta-row {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    padding: 0.375rem 0 0;
    border-top: 1px solid var(--color-border-light);
    margin-top: auto;
    width: 100%;
    max-width: 100%;
  }

  .meta-item {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    font-size: 0.625rem;
    color: var(--color-text-secondary);
    background: var(--color-bg);
    padding: 0.125rem 0.375rem;
    border-radius: 4px;
    white-space: nowrap;
    flex-shrink: 0;
  }

  .meta-item-icon {
    font-size: 0.75rem;
  }

  /* Action Buttons - Compact */
  .action-btn {
    padding: 0.375rem 0.625rem;
    border-radius: 6px;
    font-size: 0.6875rem;
    font-weight: 500;
    cursor: pointer;
    text-decoration: none;
    transition: all 0.15s ease;
    border: none;
  }


  .action-btn-edit {
    background: var(--color-accent);
    color: var(--color-primary);
  }

  .action-btn-edit:hover {
    filter: brightness(1.1);
  }

  .action-btn-delete {
    background: #fee2e2;
    color: #dc2626;
  }

  .action-btn-delete:hover {
    background: #fecaca;
  }

  /* Empty State */
  .empty-state {
    grid-column: 1 / -1;
    text-align: center;
    padding: 3rem 2rem;
    background: var(--color-bg-card);
    border-radius: 12px;
    border: 1px dashed var(--color-border);
  }

  .empty-state-icon {
    font-size: 2.5rem;
    margin-bottom: 0.75rem;
  }

  .empty-state-title {
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: 0.375rem;
  }

  .empty-state-desc {
    color: var(--color-text-muted);
    font-size: 0.875rem;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @media (max-width: 900px) {
    .cases-list {
      grid-template-columns: 1fr;
    }
  }

  @media (max-width: 600px) {
    .filter-grid {
      grid-template-columns: 1fr;
    }

    .stats-row {
      grid-template-columns: repeat(3, 1fr);
    }
  }
</style>

<script>
  interface BeforeAfter {
    id: string;
    subcategory_id: string;
    subcategory_name: string;
    category_id: string;
    category_name: string;
    before_image_url: string;
    after_image_url: string;
    caption: string | null;
    treatment_content: string | null;
    treatment_duration: string | null;
    treatment_cost: number | null;
    treatment_cost_text: string | null;
    risks: string | null;
    patient_age: number | null;
    patient_gender: string | null;
    treatment_count: number | null;
    treatment_period: string | null;
    is_published: number;
    sort_order: number;
    created_at: string;
  }

  let beforeAfters: BeforeAfter[] = [];
  let categories: Array<{ id: string; name: string }> = [];
  let subcategories: Array<{ id: string; name: string }> = [];
  let selectedCategoryId = '';
  let selectedSubcategoryId = '';
  let selectedPublished: string = '';

  async function loadCategories() {
    try {
      const res = await fetch('/api/categories');
      const data = await res.json();
      categories = data.categories || [];
      
      const select = document.getElementById('categoryFilter') as HTMLSelectElement;
      if (select) {
        select.innerHTML = '<option value="">ã™ã¹ã¦ã®ã‚«ãƒ†ã‚´ãƒª</option>' +
          categories.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('');
      }
    } catch (error) {
      console.error('ã‚«ãƒ†ã‚´ãƒªèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
    }
  }

  async function loadSubcategories(categoryId: string) {
    try {
      const res = await fetch(`/api/subcategories?category_id=${categoryId}`);
      const data = await res.json();
      subcategories = data.subcategories || [];
      
      const select = document.getElementById('subcategoryFilter') as HTMLSelectElement;
      if (select) {
        select.innerHTML = '<option value="">ã™ã¹ã¦ã®ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒª</option>' +
          subcategories.map(sc => `<option value="${sc.id}">${sc.name}</option>`).join('');
      }
    } catch (error) {
      console.error('ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
    }
  }

  async function loadBeforeAfters() {
    try {
      const params = new URLSearchParams();
      if (selectedCategoryId) params.append('category_id', selectedCategoryId);
      if (selectedSubcategoryId) params.append('subcategory_id', selectedSubcategoryId);
      if (selectedPublished === 'published') params.append('is_published', '1');
      if (selectedPublished === 'unpublished') params.append('is_published', '0');

      const res = await fetch(`/api/before-afters?${params.toString()}`);
      const data = await res.json();
      beforeAfters = data.before_afters || [];
      
      updateStats();
      renderList();
    } catch (error) {
      console.error('ç—‡ä¾‹å†™çœŸèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      showError('ç—‡ä¾‹å†™çœŸã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  }

  function updateStats() {
    const totalEl = document.getElementById('totalCount');
    const publishedEl = document.getElementById('publishedCount');
    const subcatEl = document.getElementById('subcategoryCount');
    
    if (totalEl) totalEl.textContent = String(beforeAfters.length);
    if (publishedEl) publishedEl.textContent = String(beforeAfters.filter(b => b.is_published === 1).length);
    
    const uniqueSubcats = new Set(beforeAfters.map(b => b.subcategory_id));
    if (subcatEl) subcatEl.textContent = String(uniqueSubcats.size);
  }

  function renderList() {
    const container = document.getElementById('casesList');
    if (!container) return;

    if (beforeAfters.length === 0) {
      container.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">ğŸ“¸</div>
          <div class="empty-state-title">ç—‡ä¾‹å†™çœŸãŒã‚ã‚Šã¾ã›ã‚“</div>
          <div class="empty-state-desc">æ–°è¦ç—‡ä¾‹ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</div>
        </div>
      `;
      return;
    }

    container.innerHTML = beforeAfters.map((item, index) => `
      <div class="case-card" style="animation-delay: ${index * 0.03}s">
        <div class="case-header">
          <div class="case-title-section">
            <h3 class="case-title">${escapeHtml(item.subcategory_name)}</h3>
            <span class="case-category">${escapeHtml(item.category_name)}</span>
          </div>
          <div class="case-actions">
            <span class="badge ${item.is_published === 1 ? 'badge-success' : 'badge-neutral'}">
              ${item.is_published === 1 ? 'å…¬é–‹' : 'éå…¬é–‹'}
            </span>
            <a href="/before-afters/${item.id}/edit" class="action-btn action-btn-edit">ç·¨é›†</a>
          </div>
        </div>
        <div class="case-body">
          <div class="image-comparison">
            <div class="image-panel">
              <div class="image-label before">Before</div>
              <div class="image-wrapper">
                ${item.before_image_url 
                  ? `<img src="${escapeHtml(item.before_image_url)}" alt="æ–½è¡“å‰" loading="lazy" onerror="this.parentElement.innerHTML='<div class=\\'no-image\\'>-</div>'">`
                  : '<div class="no-image">-</div>'}
              </div>
            </div>
            <div class="image-panel">
              <div class="image-label after">After</div>
              <div class="image-wrapper">
                <img src="${escapeHtml(item.after_image_url)}" alt="æ–½è¡“å¾Œ" loading="lazy" onerror="this.parentElement.innerHTML='<div class=\\'no-image\\'>-</div>'">
              </div>
            </div>
          </div>
          <div class="case-info">
            ${item.caption ? `
            <div class="info-section info-section-full">
              <div class="info-section-content">${formatCaption(item.caption)}</div>
            </div>
            ` : `
            <div class="info-section">
              <div class="info-section-content">æ²»ç™‚ï¼š${escapeHtml(item.subcategory_name)}</div>
            </div>
            `}
            
            <div class="meta-row">
              ${item.treatment_count ? `<div class="meta-item">ğŸ”„ ${item.treatment_count}å›</div>` : ''}
              ${item.patient_age ? `<div class="meta-item">ğŸ‘¤ ${item.patient_age}æ­³</div>` : ''}
              ${item.patient_gender ? `<div class="meta-item">${item.patient_gender === 'å¥³æ€§' ? 'â™€' : 'â™‚'}</div>` : ''}
            </div>
          </div>
        </div>
      </div>
    `).join('');
  }

  function escapeHtml(text: string | null | undefined): string {
    if (!text) return '';
    return text
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#039;');
  }

  function formatCaption(text: string): string {
    if (!text) return '';
    
    // Escape HTML first
    let formatted = escapeHtml(text);
    
    // Convert section headers to styled spans
    formatted = formatted.replace(/ã€([^ã€‘]+)ã€‘/g, '<span class="caption-section-header">ã€$1ã€‘</span>');
    
    // Convert newlines to <br>
    formatted = formatted.replace(/\n/g, '<br>');
    
    return formatted;
  }

  function showError(message: string) {
    const container = document.getElementById('casesList');
    if (container) {
      container.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">âš ï¸</div>
          <div class="empty-state-title">ã‚¨ãƒ©ãƒ¼</div>
          <div class="empty-state-desc">${message}</div>
        </div>
      `;
    }
  }

  async function deleteBeforeAfter(id: string) {
    if (!confirm('ã“ã®ç—‡ä¾‹å†™çœŸã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
    
    try {
      const res = await fetch(`/api/before-afters/${id}`, { method: 'DELETE' });
      if (res.ok) {
        loadBeforeAfters();
      } else {
        alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    } catch (error) {
      console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
      alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    loadCategories();
    loadBeforeAfters();

    const categoryFilter = document.getElementById('categoryFilter') as HTMLSelectElement;
    const subcategoryFilter = document.getElementById('subcategoryFilter') as HTMLSelectElement;
    const publishedFilter = document.getElementById('publishedFilter') as HTMLSelectElement;

    categoryFilter?.addEventListener('change', () => {
      selectedCategoryId = categoryFilter.value;
      selectedSubcategoryId = '';
      if (selectedCategoryId) {
        loadSubcategories(selectedCategoryId);
      } else {
        const subcategoryFilter = document.getElementById('subcategoryFilter') as HTMLSelectElement;
        if (subcategoryFilter) {
          subcategoryFilter.innerHTML = '<option value="">ã™ã¹ã¦ã®ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒª</option>';
        }
      }
      loadBeforeAfters();
    });

    subcategoryFilter?.addEventListener('change', () => {
      selectedSubcategoryId = subcategoryFilter.value;
      loadBeforeAfters();
    });

    publishedFilter?.addEventListener('change', () => {
      selectedPublished = publishedFilter.value;
      loadBeforeAfters();
    });
  });

  (window as any).deleteBeforeAfter = deleteBeforeAfter;
</script>
