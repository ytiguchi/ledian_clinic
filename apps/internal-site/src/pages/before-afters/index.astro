---
import Layout from '../../components/Layout.astro';
---

<Layout>
  <div class="space-y-6">
    <div class="flex justify-between items-center">
      <h2 class="text-3xl font-bold">症例写真管理</h2>
      <a href="/before-afters/new" class="bg-accent text-white px-4 py-2 rounded-lg hover:bg-accent-light transition">
        + 新規症例追加
      </a>
    </div>

    <!-- Filter -->
    <div class="bg-white rounded-lg shadow p-6">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <select class="px-4 py-2 border rounded-lg" id="categoryFilter">
          <option value="">すべてのカテゴリ</option>
        </select>
        <select class="px-4 py-2 border rounded-lg" id="treatmentFilter">
          <option value="">すべての施術</option>
        </select>
        <select class="px-4 py-2 border rounded-lg" id="publishedFilter">
          <option value="">すべて</option>
          <option value="published">公開中のみ</option>
          <option value="unpublished">非公開のみ</option>
        </select>
      </div>
    </div>

    <!-- Before/After List -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="beforeAfterGrid">
      <div class="bg-white rounded-lg shadow p-6 text-center">
        <p class="text-gray-500">データを読み込み中...</p>
      </div>
    </div>
  </div>
</Layout>

<script>
  interface BeforeAfter {
    id: string;
    treatment_id: string;
    treatment_name: string;
    before_image_url: string;
    after_image_url: string;
    caption: string | null;
    patient_age: number | null;
    patient_gender: string | null;
    treatment_count: number | null;
    treatment_period: string | null;
    is_published: number;
    sort_order: number;
    created_at: string;
  }

  let beforeAfters: BeforeAfter[] = [];
  let categories: Array<{ id: string; name: string }> = [];
  let selectedCategoryId = '';
  let selectedTreatmentId = '';
  let selectedPublished: string = '';

  async function loadCategories() {
    try {
      const res = await fetch('/api/categories');
      const data = await res.json();
      categories = data.categories || [];
      
      const select = document.getElementById('categoryFilter') as HTMLSelectElement;
      if (select) {
        select.innerHTML = '<option value="">すべてのカテゴリ</option>' +
          categories.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('');
      }
    } catch (error) {
      console.error('カテゴリ読み込みエラー:', error);
    }
  }

  async function loadTreatments(categoryId: string) {
    // TODO: カテゴリに紐づく施術を取得するAPIが必要
    // 現在は簡易的に全施術を取得
    const select = document.getElementById('treatmentFilter') as HTMLSelectElement;
    if (select) {
      select.innerHTML = '<option value="">すべての施術</option>';
    }
  }

  async function loadBeforeAfters() {
    try {
      const params = new URLSearchParams();
      if (selectedTreatmentId) params.append('treatment_id', selectedTreatmentId);
      if (selectedPublished === 'published') params.append('is_published', '1');
      if (selectedPublished === 'unpublished') params.append('is_published', '0');

      const res = await fetch(`/api/before-afters?${params.toString()}`);
      const data = await res.json();
      beforeAfters = data.before_afters || [];
      renderGrid();
    } catch (error) {
      console.error('症例写真読み込みエラー:', error);
      showError('症例写真の読み込みに失敗しました');
    }
  }

  function renderGrid() {
    const grid = document.getElementById('beforeAfterGrid');
    if (!grid) return;

    if (beforeAfters.length === 0) {
      grid.innerHTML = `
        <div class="col-span-full bg-white rounded-lg shadow p-8 text-center">
          <p class="text-gray-500">症例写真が見つかりませんでした</p>
        </div>
      `;
      return;
    }

    grid.innerHTML = beforeAfters.map(item => `
      <div class="bg-white rounded-lg shadow overflow-hidden">
        <div class="grid grid-cols-2 gap-2 p-2">
          <div class="relative aspect-square bg-gray-100">
            <img 
              src="${escapeHtml(item.before_image_url)}" 
              alt="施術前"
              class="w-full h-full object-cover"
              onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22%3E%3Ctext x=%2250%22 y=%2250%22 text-anchor=%22middle%22 dy=%22.3em%22%3EBefore%3C/text%3E%3C/svg%3E'"
            />
          </div>
          <div class="relative aspect-square bg-gray-100">
            <img 
              src="${escapeHtml(item.after_image_url)}" 
              alt="施術後"
              class="w-full h-full object-cover"
              onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22%3E%3Ctext x=%2250%22 y=%2250%22 text-anchor=%22middle%22 dy=%22.3em%22%3EAfter%3C/text%3E%3C/svg%3E'"
            />
          </div>
        </div>
        <div class="p-4">
          <div class="flex items-center justify-between mb-2">
            <h3 class="font-semibold">${escapeHtml(item.treatment_name)}</h3>
            <span class="text-xs px-2 py-1 rounded ${item.is_published === 1 ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
              ${item.is_published === 1 ? '公開' : '非公開'}
            </span>
          </div>
          ${item.caption ? `<p class="text-sm text-gray-600 mb-2">${escapeHtml(item.caption)}</p>` : ''}
          <div class="text-xs text-gray-500 mb-3">
            ${item.treatment_count ? `${item.treatment_count}回` : ''}
            ${item.treatment_period ? `・${item.treatment_period}` : ''}
            ${item.patient_age ? `・${item.patient_age}歳` : ''}
            ${item.patient_gender ? `・${item.patient_gender}` : ''}
          </div>
          <div class="flex gap-2">
            <a href="/before-afters/${item.id}/edit" class="flex-1 text-center text-sm px-3 py-2 bg-accent text-white rounded hover:bg-accent-light transition">
              編集
            </a>
            <button 
              onclick="deleteBeforeAfter('${item.id}')" 
              class="flex-1 text-sm px-3 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition"
            >
              削除
            </button>
          </div>
        </div>
      </div>
    `).join('');
  }

  function escapeHtml(text: string): string {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function showError(message: string) {
    const grid = document.getElementById('beforeAfterGrid');
    if (grid) {
      grid.innerHTML = `
        <div class="col-span-full bg-white rounded-lg shadow p-8 text-center text-red-500">
          ${escapeHtml(message)}
        </div>
      `;
    }
  }

  async function deleteBeforeAfter(id: string) {
    if (!confirm('この症例写真を削除しますか？')) return;
    
    try {
      const res = await fetch(`/api/before-afters/${id}`, { method: 'DELETE' });
      if (res.ok) {
        await loadBeforeAfters();
      } else {
        alert('削除に失敗しました');
      }
    } catch (error) {
      console.error('削除エラー:', error);
      alert('削除に失敗しました');
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    loadCategories();
    loadBeforeAfters();

    const categoryFilter = document.getElementById('categoryFilter') as HTMLSelectElement;
    const treatmentFilter = document.getElementById('treatmentFilter') as HTMLSelectElement;
    const publishedFilter = document.getElementById('publishedFilter') as HTMLSelectElement;

    categoryFilter?.addEventListener('change', () => {
      selectedCategoryId = categoryFilter.value;
      if (selectedCategoryId) {
        loadTreatments(selectedCategoryId);
      }
      loadBeforeAfters();
    });

    treatmentFilter?.addEventListener('change', () => {
      selectedTreatmentId = treatmentFilter.value;
      loadBeforeAfters();
    });

    publishedFilter?.addEventListener('change', () => {
      selectedPublished = publishedFilter.value;
      loadBeforeAfters();
    });
  });

  (window as any).deleteBeforeAfter = deleteBeforeAfter;
</script>

