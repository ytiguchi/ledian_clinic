---
import Layout from '../../../components/Layout.astro';

const id = Astro.params.id;
export const prerender = false;
---

<Layout>
  <div class="max-w-4xl mx-auto space-y-6">
    <div>
      <a href="/before-afters" class="text-accent hover:underline">← 症例写真管理に戻る</a>
      <h2 class="text-3xl font-bold mt-4">症例写真編集</h2>
    </div>

    <div id="loadingMessage" class="bg-white rounded-lg shadow p-8 text-center">
      <p class="text-gray-500">データを読み込み中...</p>
    </div>

    <form class="bg-white rounded-lg shadow p-6 space-y-6 hidden" id="beforeAfterForm">
      <input type="hidden" name="id" id="beforeAfterId" />

      <!-- 基本情報 -->
      <div>
        <h3 class="text-xl font-semibold mb-4">基本情報</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">カテゴリ</label>
            <select name="category" id="categorySelect" class="w-full px-4 py-2 border rounded-lg" required>
              <option value="">選択してください</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">サブカテゴリ</label>
            <select name="subcategory" id="subcategorySelect" class="w-full px-4 py-2 border rounded-lg">
              <option value="">選択してください</option>
            </select>
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm font-medium mb-1">施術 <span class="text-red-500">*</span></label>
            <select name="treatment" id="treatmentSelect" class="w-full px-4 py-2 border rounded-lg" required>
              <option value="">選択してください</option>
            </select>
          </div>
        </div>
      </div>

      <!-- 画像 -->
      <div>
        <h3 class="text-xl font-semibold mb-4">画像 <span class="text-red-500">*</span></h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-medium mb-2">施術前画像URL</label>
            <input
              type="url"
              name="beforeImageUrl"
              id="beforeImageUrl"
              class="w-full px-4 py-2 border rounded-lg"
              required
            />
            <div class="mt-2 aspect-square bg-gray-100 rounded overflow-hidden">
              <img id="beforePreview" src="" alt="施術前プレビュー" class="w-full h-full object-cover hidden" />
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">施術後画像URL</label>
            <input
              type="url"
              name="afterImageUrl"
              id="afterImageUrl"
              class="w-full px-4 py-2 border rounded-lg"
              required
            />
            <div class="mt-2 aspect-square bg-gray-100 rounded overflow-hidden">
              <img id="afterPreview" src="" alt="施術後プレビュー" class="w-full h-full object-cover hidden" />
            </div>
          </div>
        </div>
      </div>

      <!-- 詳細情報 -->
      <div>
        <h3 class="text-xl font-semibold mb-4">詳細情報</h3>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium mb-1">説明文</label>
            <textarea
              name="caption"
              id="caption"
              rows="3"
              class="w-full px-4 py-2 border rounded-lg"
            ></textarea>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1">患者年齢</label>
              <input
                type="number"
                name="patientAge"
                id="patientAge"
                min="0"
                max="150"
                class="w-full px-4 py-2 border rounded-lg"
              />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">性別</label>
              <select name="patientGender" id="patientGender" class="w-full px-4 py-2 border rounded-lg">
                <option value="">選択してください</option>
                <option value="男性">男性</option>
                <option value="女性">女性</option>
                <option value="その他">その他</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">施術回数</label>
              <input
                type="number"
                name="treatmentCount"
                id="treatmentCount"
                min="1"
                class="w-full px-4 py-2 border rounded-lg"
              />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">施術期間</label>
              <input
                type="text"
                name="treatmentPeriod"
                id="treatmentPeriod"
                class="w-full px-4 py-2 border rounded-lg"
              />
            </div>
          </div>
        </div>
      </div>

      <!-- 公開設定 -->
      <div>
        <h3 class="text-xl font-semibold mb-4">公開設定</h3>
        <div class="flex items-center gap-4">
          <label class="flex items-center gap-2 cursor-pointer">
            <input
              type="checkbox"
              name="isPublished"
              id="isPublished"
              class="w-4 h-4 text-accent border-gray-300 rounded"
            />
            <span>公開する</span>
          </label>
        </div>
      </div>

      <!-- アクション -->
      <div class="flex justify-end gap-4 pt-4 border-t">
        <a href="/before-afters" class="px-6 py-2 border rounded-lg hover:bg-gray-50 transition">
          キャンセル
        </a>
        <button
          type="submit"
          class="px-6 py-2 bg-accent text-white rounded-lg hover:bg-accent-light transition"
        >
          更新
        </button>
      </div>
    </form>
  </div>
</Layout>

<script define:vars={{ beforeAfterId: id }}>
  let categories: Array<{ id: string; name: string }> = [];
  let subcategories: Array<{ id: string; name: string; category_id: string }> = [];
  let treatments: Array<{ id: string; name: string; subcategory_id: string }> = [];

  interface BeforeAfterData {
    id: string;
    treatment_id: string;
    category_id: string;
    subcategory_id: string;
    before_image_url: string;
    after_image_url: string;
    caption: string | null;
    patient_age: number | null;
    patient_gender: string | null;
    treatment_count: number | null;
    treatment_period: string | null;
    is_published: number;
  }

  async function loadData() {
    try {
      // カテゴリ一覧取得
      const catRes = await fetch('/api/categories');
      const catData = await catRes.json();
      categories = catData.categories || [];
      populateCategories();

      // 症例写真データ取得
      const res = await fetch(`/api/before-afters/${beforeAfterId}`);
      if (!res.ok) {
        throw new Error('症例写真が見つかりません');
      }
      const data = await res.json();
      const beforeAfter = data.before_after as BeforeAfterData;

      const categorySelect = document.getElementById('categorySelect') as HTMLSelectElement;
      if (categorySelect) {
        categorySelect.value = beforeAfter.category_id || '';
      }

      if (beforeAfter.category_id) {
        await loadSubcategories(beforeAfter.category_id);
      }

      const subcategorySelect = document.getElementById('subcategorySelect') as HTMLSelectElement;
      if (subcategorySelect) {
        subcategorySelect.value = beforeAfter.subcategory_id || '';
      }

      if (beforeAfter.subcategory_id) {
        await loadTreatments(beforeAfter.subcategory_id);
      }

      const treatmentSelect = document.getElementById('treatmentSelect') as HTMLSelectElement;
      if (treatmentSelect) {
        treatmentSelect.value = beforeAfter.treatment_id || '';
      }

      // フォームに値を設定
      populateForm(beforeAfter);

      // フォームを表示
      document.getElementById('loadingMessage')?.classList.add('hidden');
      const form = document.getElementById('beforeAfterForm');
      if (form) {
        form.classList.remove('hidden');
      }
    } catch (error) {
      console.error('データ読み込みエラー:', error);
      const loadingMsg = document.getElementById('loadingMessage');
      if (loadingMsg) {
        loadingMsg.innerHTML = `<p class="text-red-500">データの読み込みに失敗しました: ${error instanceof Error ? error.message : 'Unknown error'}</p>`;
      }
    }
  }

  async function loadSubcategories(categoryId: string) {
    const select = document.getElementById('subcategorySelect') as HTMLSelectElement;
    if (!select) return;
    select.innerHTML = '<option value="">選択してください</option>';
    treatments = [];
    const treatmentSelect = document.getElementById('treatmentSelect') as HTMLSelectElement;
    if (treatmentSelect) {
      treatmentSelect.innerHTML = '<option value="">選択してください</option>';
    }

    try {
      const res = await fetch(`/api/subcategories?category_id=${categoryId}`);
      const data = await res.json();
      subcategories = data.subcategories || [];
      select.innerHTML = '<option value="">選択してください</option>' +
        subcategories.map(sub => `<option value="${sub.id}">${sub.name}</option>`).join('');
    } catch (error) {
      console.error('サブカテゴリ読み込みエラー:', error);
    }
  }

  async function loadTreatments(subcategoryId: string) {
    const select = document.getElementById('treatmentSelect') as HTMLSelectElement;
    if (!select) return;
    select.innerHTML = '<option value="">選択してください</option>';

    try {
      const res = await fetch(`/api/treatments?subcategory_id=${subcategoryId}`);
      const data = await res.json();
      treatments = data.treatments || [];
      select.innerHTML = '<option value="">選択してください</option>' +
        treatments.map(treatment => `<option value="${treatment.id}">${treatment.name}</option>`).join('');
    } catch (error) {
      console.error('施術読み込みエラー:', error);
    }
  }

  function populateCategories() {
    const select = document.getElementById('categorySelect') as HTMLSelectElement;
    if (select) {
      select.innerHTML = '<option value="">選択してください</option>' +
        categories.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('');
    }
  }

  function populateForm(data: BeforeAfterData) {
    (document.getElementById('beforeAfterId') as HTMLInputElement).value = data.id;
    (document.getElementById('beforeImageUrl') as HTMLInputElement).value = data.before_image_url;
    (document.getElementById('afterImageUrl') as HTMLInputElement).value = data.after_image_url;
    
    const beforePreview = document.getElementById('beforePreview') as HTMLImageElement;
    if (beforePreview) {
      beforePreview.src = data.before_image_url;
      beforePreview.classList.remove('hidden');
    }
    const afterPreview = document.getElementById('afterPreview') as HTMLImageElement;
    if (afterPreview) {
      afterPreview.src = data.after_image_url;
      afterPreview.classList.remove('hidden');
    }
    
    (document.getElementById('caption') as HTMLTextAreaElement).value = data.caption || '';
    if (data.patient_age) {
      (document.getElementById('patientAge') as HTMLInputElement).value = data.patient_age.toString();
    }
    if (data.patient_gender) {
      (document.getElementById('patientGender') as HTMLSelectElement).value = data.patient_gender;
    }
    if (data.treatment_count) {
      (document.getElementById('treatmentCount') as HTMLInputElement).value = data.treatment_count.toString();
    }
    if (data.treatment_period) {
      (document.getElementById('treatmentPeriod') as HTMLInputElement).value = data.treatment_period;
    }
    (document.getElementById('isPublished') as HTMLInputElement).checked = data.is_published === 1;
  }

  function updateImagePreview(inputId: string, previewId: string) {
    const input = document.getElementById(inputId) as HTMLInputElement;
    const preview = document.getElementById(previewId) as HTMLImageElement;
    
    input?.addEventListener('input', () => {
      const url = input.value;
      if (url && preview) {
        preview.src = url;
        preview.classList.remove('hidden');
      }
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    loadData();

    updateImagePreview('beforeImageUrl', 'beforePreview');
    updateImagePreview('afterImageUrl', 'afterPreview');

    const categorySelect = document.getElementById('categorySelect') as HTMLSelectElement;
    const subcategorySelect = document.getElementById('subcategorySelect') as HTMLSelectElement;

    categorySelect?.addEventListener('change', async () => {
      const categoryId = categorySelect.value;
      if (!categoryId) {
        subcategorySelect.innerHTML = '<option value="">選択してください</option>';
        const treatmentSelect = document.getElementById('treatmentSelect') as HTMLSelectElement;
        if (treatmentSelect) {
          treatmentSelect.innerHTML = '<option value="">選択してください</option>';
        }
        return;
      }
      await loadSubcategories(categoryId);
    });

    subcategorySelect?.addEventListener('change', async () => {
      const subcategoryId = subcategorySelect.value;
      if (!subcategoryId) {
        const treatmentSelect = document.getElementById('treatmentSelect') as HTMLSelectElement;
        if (treatmentSelect) {
          treatmentSelect.innerHTML = '<option value="">選択してください</option>';
        }
        return;
      }
      await loadTreatments(subcategoryId);
    });

    const form = document.getElementById('beforeAfterForm') as HTMLFormElement;
    
    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(form);
      
      const data = {
        treatment_id: formData.get('treatment'),
        before_image_url: formData.get('beforeImageUrl'),
        after_image_url: formData.get('afterImageUrl'),
        caption: formData.get('caption') || null,
        patient_age: formData.get('patientAge') ? Number(formData.get('patientAge')) : null,
        patient_gender: formData.get('patientGender') || null,
        treatment_count: formData.get('treatmentCount') ? Number(formData.get('treatmentCount')) : null,
        treatment_period: formData.get('treatmentPeriod') || null,
        is_published: formData.get('isPublished') === 'on',
        sort_order: 0
      };

      try {
        const res = await fetch(`/api/before-afters/${beforeAfterId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });

        if (res.ok) {
          alert('更新しました');
          window.location.href = '/before-afters';
        } else {
          const error = await res.json();
          alert(`更新に失敗しました: ${error.message || 'Unknown error'}`);
        }
      } catch (error) {
        console.error('更新エラー:', error);
        alert('更新に失敗しました');
      }
    });
  });
</script>

