---
import Layout from '../../components/Layout.astro';
---

<Layout>
  <div class="max-w-4xl mx-auto space-y-6">
    <div>
      <a href="/campaigns" class="text-accent hover:underline">← キャンペーン管理に戻る</a>
      <h2 class="text-3xl font-bold mt-4">新規キャンペーン作成</h2>
    </div>

    <form class="bg-white rounded-lg shadow p-6 space-y-6" id="campaignForm">
      <!-- 基本情報 -->
      <div>
        <h3 class="text-xl font-semibold mb-4">基本情報</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">キャンペーン名 <span class="text-red-500">*</span></label>
            <input
              type="text"
              name="title"
              id="title"
              placeholder="例: 初回限定30%OFF"
              class="w-full px-4 py-2 border rounded-lg"
              required
            />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">スラッグ <span class="text-red-500">*</span></label>
            <input
              type="text"
              name="slug"
              id="slug"
              placeholder="例: first-time-30off"
              class="w-full px-4 py-2 border rounded-lg"
              required
            />
            <p class="text-xs text-gray-500 mt-1">URL用の識別子（英数字とハイフンのみ）</p>
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm font-medium mb-1">説明</label>
            <textarea
              name="description"
              id="description"
              rows="3"
              placeholder="キャンペーンの説明を入力してください"
              class="w-full px-4 py-2 border rounded-lg"
            ></textarea>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">キャンペーン種別</label>
            <select name="campaignType" id="campaignType" class="w-full px-4 py-2 border rounded-lg">
              <option value="discount">割引</option>
              <option value="bundle">セット</option>
              <option value="point">ポイント</option>
              <option value="referral">紹介</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">優先度</label>
            <input
              type="number"
              name="priority"
              id="priority"
              value="0"
              min="0"
              class="w-full px-4 py-2 border rounded-lg"
            />
            <p class="text-xs text-gray-500 mt-1">複数キャンペーン適用時、数値が大きいほど優先</p>
          </div>
        </div>
      </div>

      <!-- 期間設定 -->
      <div>
        <h3 class="text-xl font-semibold mb-4">期間設定</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">開始日</label>
            <input
              type="date"
              name="startDate"
              id="startDate"
              class="w-full px-4 py-2 border rounded-lg"
            />
            <p class="text-xs text-gray-500 mt-1">未設定の場合は無期限開始</p>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">終了日</label>
            <input
              type="date"
              name="endDate"
              id="endDate"
              class="w-full px-4 py-2 border rounded-lg"
            />
            <p class="text-xs text-gray-500 mt-1">未設定の場合は無期限</p>
          </div>
        </div>
      </div>

      <!-- 対象プラン -->
      <div>
        <h3 class="text-xl font-semibold mb-4">対象プラン</h3>
        <div class="border rounded-lg p-4 bg-gray-50">
          <p class="text-sm text-gray-600 mb-4">
            キャンペーン作成後、編集画面で対象プランを設定できます。
          </p>
          <div id="selectedPlans" class="space-y-2">
            <p class="text-sm text-gray-500">（プラン設定は編集画面で行います）</p>
          </div>
        </div>
      </div>

      <!-- 公開設定 -->
      <div>
        <h3 class="text-xl font-semibold mb-4">公開設定</h3>
        <div class="flex items-center gap-4">
          <label class="flex items-center gap-2 cursor-pointer">
            <input
              type="checkbox"
              name="isPublished"
              id="isPublished"
              class="w-4 h-4 text-accent border-gray-300 rounded"
            />
            <span>公開する</span>
          </label>
        </div>
      </div>

      <!-- アクション -->
      <div class="flex justify-end gap-4 pt-4 border-t">
        <a href="/campaigns" class="px-6 py-2 border rounded-lg hover:bg-gray-50 transition">
          キャンセル
        </a>
        <button
          type="submit"
          class="px-6 py-2 bg-accent text-white rounded-lg hover:bg-accent-light transition"
        >
          作成
        </button>
      </div>
    </form>
  </div>
</Layout>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('campaignForm') as HTMLFormElement;
    const titleInput = document.getElementById('title') as HTMLInputElement;
    const slugInput = document.getElementById('slug') as HTMLInputElement;

    // タイトルからスラッグを自動生成
    titleInput?.addEventListener('input', () => {
      if (!slugInput.value) {
        const title = titleInput.value;
        const slug = title
          .toLowerCase()
          .replace(/[^\w\s-]/g, '')
          .replace(/\s+/g, '-')
          .replace(/-+/g, '-')
          .trim();
        slugInput.value = slug;
      }
    });

    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(form);
      
      const data = {
        title: formData.get('title'),
        slug: formData.get('slug'),
        description: formData.get('description') || null,
        campaign_type: formData.get('campaignType') || 'discount',
        priority: formData.get('priority') ? Number(formData.get('priority')) : 0,
        start_date: formData.get('startDate') || null,
        end_date: formData.get('endDate') || null,
        is_published: formData.get('isPublished') === 'on',
        sort_order: 0
      };

      try {
        const res = await fetch('/api/campaigns', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });

        if (res.ok) {
          const result = await res.json();
          alert('キャンペーンを作成しました');
          window.location.href = `/campaigns/${result.id}/edit`;
        } else {
          const error = await res.json();
          alert(`作成に失敗しました: ${error.message || 'Unknown error'}`);
        }
      } catch (error) {
        console.error('作成エラー:', error);
        alert('作成に失敗しました');
      }
    });
  });
</script>



