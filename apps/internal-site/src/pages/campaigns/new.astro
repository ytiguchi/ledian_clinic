---
import Layout from '../../components/Layout.astro';
---

<Layout>
  <div class="max-w-4xl mx-auto space-y-6">
    <div>
      <a href="/campaigns" class="text-accent hover:underline">â† ãŠçŸ¥ã‚‰ã›ç®¡ç†ã«æˆ»ã‚‹</a>
      <h2 class="text-3xl font-bold mt-4">æ–°è¦è¨˜äº‹ä½œæˆ</h2>
    </div>

    <form class="bg-white rounded-lg shadow p-6 space-y-6" id="campaignForm">
      <!-- åŸºæœ¬æƒ…å ± -->
      <div>
        <h3 class="text-xl font-semibold mb-4">åŸºæœ¬æƒ…å ±</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">ã‚¿ã‚¤ãƒˆãƒ« <span class="text-red-500">*</span></label>
            <input
              type="text"
              name="title"
              id="title"
              placeholder="ä¾‹: åˆå›é™å®š30%OFF"
              class="w-full px-4 py-2 border rounded-lg"
              required
            />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">ã‚¹ãƒ©ãƒƒã‚° <span class="text-red-500">*</span></label>
            <input
              type="text"
              name="slug"
              id="slug"
              placeholder="ä¾‹: first-time-30off"
              class="w-full px-4 py-2 border rounded-lg"
              required
            />
            <p class="text-xs text-gray-500 mt-1">URLç”¨ã®è­˜åˆ¥å­ï¼ˆè‹±æ•°å­—ã¨ãƒã‚¤ãƒ•ãƒ³ã®ã¿ï¼‰</p>
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm font-medium mb-1">æ¦‚è¦ï¼ˆä¸€è¦§è¡¨ç¤ºç”¨ï¼‰</label>
            <textarea
              name="description"
              id="description"
              rows="2"
              placeholder="ä¸€è¦§ãƒšãƒ¼ã‚¸ã«è¡¨ç¤ºã•ã‚Œã‚‹çŸ­ã„æ¦‚è¦æ–‡"
              class="w-full px-4 py-2 border rounded-lg"
            ></textarea>
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm font-medium mb-1">æœ¬æ–‡ï¼ˆHTMLå¯ï¼‰</label>
            <textarea
              name="content"
              id="content"
              rows="10"
              placeholder="è¨˜äº‹ã®æœ¬æ–‡ã‚’å…¥åŠ›ï¼ˆHTMLã‚¿ã‚°ä½¿ç”¨å¯ï¼‰"
              class="w-full px-4 py-2 border rounded-lg font-mono text-sm"
            ></textarea>
            <p class="text-xs text-gray-500 mt-1">è©³ç´°ãƒšãƒ¼ã‚¸ã«è¡¨ç¤ºã•ã‚Œã‚‹è¨˜äº‹æœ¬æ–‡ã€‚HTMLã‚¿ã‚°ã‚’ä½¿ç”¨ã§ãã¾ã™ã€‚</p>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">è¡¨ç¤ºã‚«ãƒ†ã‚´ãƒª</label>
            <select name="campaign_type" id="campaign_type" class="w-full px-4 py-2 border rounded-lg">
              <option value="campaign">ğŸ ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³</option>
              <option value="new_service">âœ¨ æ–°ã‚µãƒ¼ãƒ“ã‚¹</option>
              <option value="news">ğŸ“¢ ãŠçŸ¥ã‚‰ã›</option>
            </select>
            <p class="text-xs text-gray-500 mt-1">å…¬é–‹ã‚µã‚¤ãƒˆã§ã®ãƒ•ã‚£ãƒ«ã‚¿åˆ†é¡</p>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">å„ªå…ˆåº¦</label>
            <input
              type="number"
              name="priority"
              id="priority"
              value="0"
              min="0"
              class="w-full px-4 py-2 border rounded-lg"
            />
            <p class="text-xs text-gray-500 mt-1">è¤‡æ•°ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³é©ç”¨æ™‚ã€æ•°å€¤ãŒå¤§ãã„ã»ã©å„ªå…ˆ</p>
          </div>
        </div>
      </div>

      <!-- æœŸé–“è¨­å®š -->
      <div>
        <h3 class="text-xl font-semibold mb-4">æœŸé–“è¨­å®š</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">é–‹å§‹æ—¥</label>
            <input
              type="date"
              name="startDate"
              id="startDate"
              class="w-full px-4 py-2 border rounded-lg"
            />
            <p class="text-xs text-gray-500 mt-1">æœªè¨­å®šã®å ´åˆã¯ç„¡æœŸé™é–‹å§‹</p>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">çµ‚äº†æ—¥</label>
            <input
              type="date"
              name="endDate"
              id="endDate"
              class="w-full px-4 py-2 border rounded-lg"
            />
            <p class="text-xs text-gray-500 mt-1">æœªè¨­å®šã®å ´åˆã¯ç„¡æœŸé™</p>
          </div>
        </div>
      </div>

      <!-- å¯¾è±¡ãƒ—ãƒ©ãƒ³ -->
      <div>
        <h3 class="text-xl font-semibold mb-4">å¯¾è±¡ãƒ—ãƒ©ãƒ³</h3>
        <div class="border rounded-lg p-4 bg-gray-50">
          <p class="text-sm text-gray-600 mb-4">
            ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ä½œæˆå¾Œã€ç·¨é›†ç”»é¢ã§å¯¾è±¡ãƒ—ãƒ©ãƒ³ã‚’è¨­å®šã§ãã¾ã™ã€‚
          </p>
          <div id="selectedPlans" class="space-y-2">
            <p class="text-sm text-gray-500">ï¼ˆãƒ—ãƒ©ãƒ³è¨­å®šã¯ç·¨é›†ç”»é¢ã§è¡Œã„ã¾ã™ï¼‰</p>
          </div>
        </div>
      </div>

      <!-- å…¬é–‹è¨­å®š -->
      <div>
        <h3 class="text-xl font-semibold mb-4">å…¬é–‹è¨­å®š</h3>
        <div class="flex items-center gap-4">
          <label class="flex items-center gap-2 cursor-pointer">
            <input
              type="checkbox"
              name="isPublished"
              id="isPublished"
              class="w-4 h-4 text-accent border-gray-300 rounded"
            />
            <span>å…¬é–‹ã™ã‚‹</span>
          </label>
        </div>
      </div>

      <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div class="flex justify-end gap-4 pt-4 border-t">
        <a href="/campaigns" class="px-6 py-2 border rounded-lg hover:bg-gray-50 transition">
          ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        </a>
        <button
          type="submit"
          class="px-6 py-2 bg-accent text-white rounded-lg hover:bg-accent-light transition"
        >
          ä½œæˆ
        </button>
      </div>
    </form>
  </div>
</Layout>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('campaignForm') as HTMLFormElement;
    const titleInput = document.getElementById('title') as HTMLInputElement;
    const slugInput = document.getElementById('slug') as HTMLInputElement;

    // ã‚¿ã‚¤ãƒˆãƒ«ã‹ã‚‰ã‚¹ãƒ©ãƒƒã‚°ã‚’è‡ªå‹•ç”Ÿæˆ
    titleInput?.addEventListener('input', () => {
      if (!slugInput.value) {
        const title = titleInput.value;
        const slug = title
          .toLowerCase()
          .replace(/[^\w\s-]/g, '')
          .replace(/\s+/g, '-')
          .replace(/-+/g, '-')
          .trim();
        slugInput.value = slug;
      }
    });

    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(form);
      
      const data = {
        title: formData.get('title'),
        slug: formData.get('slug'),
        description: formData.get('description') || null,
        content: formData.get('content') || null,
        campaign_type: formData.get('campaign_type') || 'campaign',
        priority: formData.get('priority') ? Number(formData.get('priority')) : 0,
        start_date: formData.get('startDate') || null,
        end_date: formData.get('endDate') || null,
        is_published: formData.get('isPublished') === 'on',
        sort_order: 0
      };

      try {
        const res = await fetch('/api/campaigns', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });

        if (res.ok) {
          const result = await res.json();
          alert('ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã‚’ä½œæˆã—ã¾ã—ãŸ');
          window.location.href = `/campaigns/${result.id}/edit`;
        } else {
          const error = await res.json();
          alert(`ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message || 'Unknown error'}`);
        }
      } catch (error) {
        console.error('ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
        alert('ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    });
  });
</script>



