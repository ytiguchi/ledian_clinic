---
import Layout from '../../components/Layout.astro';
---

<Layout>
  <div class="space-y-6">
    <div class="flex justify-between items-center">
      <h2 class="text-3xl font-bold">キャンペーン管理</h2>
      <a href="/campaigns/new" class="bg-accent text-white px-4 py-2 rounded-lg hover:bg-accent-light transition">
        + 新規キャンペーン
      </a>
    </div>

    <!-- Filter -->
    <div class="bg-white rounded-lg shadow p-6">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <select class="px-4 py-2 border rounded-lg" id="publishedFilter">
          <option value="">すべて</option>
          <option value="published">公開中のみ</option>
          <option value="unpublished">非公開のみ</option>
        </select>
      </div>
    </div>

    <!-- Campaign List -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
      <table class="w-full">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-4 py-3 text-left font-semibold">キャンペーン名</th>
            <th class="px-4 py-3 text-left font-semibold">期間</th>
            <th class="px-4 py-3 text-left font-semibold">対象プラン数</th>
            <th class="px-4 py-3 text-center font-semibold">状態</th>
            <th class="px-4 py-3 text-center font-semibold">操作</th>
          </tr>
        </thead>
        <tbody id="campaignTableBody">
          <tr>
            <td colspan="5" class="px-4 py-8 text-center text-gray-500">
              データを読み込み中...
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</Layout>

<script>
  interface Campaign {
    id: string;
    title: string;
    slug: string;
    description: string | null;
    start_date: string | null;
    end_date: string | null;
    campaign_type: string;
    priority: number;
    is_published: boolean;
    plan_count: number;
    created_at: string;
  }

  let campaigns: Campaign[] = [];
  let selectedPublished: string = '';

  async function loadCampaigns() {
    try {
      const params = new URLSearchParams();
      if (selectedPublished === 'published') params.append('is_published', '1');
      if (selectedPublished === 'unpublished') params.append('is_published', '0');

      const res = await fetch(`/api/campaigns?${params.toString()}`);
      if (!res.ok) {
        const errorData = await res.json().catch(() => ({ message: `HTTP ${res.status}: ${res.statusText}` }));
        console.error('API エラー:', errorData);
        showError(`キャンペーンの読み込みに失敗しました: ${errorData.message || errorData.error || 'Unknown error'}`);
        return;
      }
      const data = await res.json();
      if (data.error) {
        console.error('API エラー:', data);
        showError(`キャンペーンの読み込みに失敗しました: ${data.message || data.error}`);
        return;
      }
      campaigns = data.campaigns || [];
      renderTable();
    } catch (error) {
      console.error('キャンペーン読み込みエラー:', error);
      showError(`キャンペーンの読み込みに失敗しました: ${error instanceof Error ? error.message : 'Unknown error'}`);
    }
  }

  function renderTable() {
    const tbody = document.getElementById('campaignTableBody');
    if (!tbody) return;

    if (campaigns.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="5" class="px-4 py-8 text-center text-gray-500">
            キャンペーンが見つかりませんでした
          </td>
        </tr>
      `;
      return;
    }

    tbody.innerHTML = campaigns.map(campaign => {
      const period = getPeriodText(campaign.start_date, campaign.end_date);
      const status = getStatus(campaign);
      
      return `
        <tr class="border-b hover:bg-gray-50">
          <td class="px-4 py-3">
            <div class="font-semibold">${escapeHtml(campaign.title)}</div>
            ${campaign.description ? `<div class="text-sm text-gray-500 mt-1">${escapeHtml(campaign.description)}</div>` : ''}
          </td>
          <td class="px-4 py-3">
            <div class="text-sm">${period}</div>
          </td>
          <td class="px-4 py-3">
            <span class="text-sm">${campaign.plan_count}件</span>
          </td>
          <td class="px-4 py-3 text-center">
            <span class="text-xs px-2 py-1 rounded ${campaign.is_published ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
              ${campaign.is_published ? '公開中' : '非公開'}
            </span>
            ${status ? `<div class="text-xs text-gray-500 mt-1">${status}</div>` : ''}
          </td>
          <td class="px-4 py-3 text-center">
            <a href="/campaigns/${campaign.id}/edit" class="text-accent hover:underline mr-3">編集</a>
            <button onclick="deleteCampaign('${campaign.id}')" class="text-red-500 hover:underline">削除</button>
          </td>
        </tr>
      `;
    }).join('');
  }

  function getPeriodText(startDate: string | null, endDate: string | null): string {
    if (!startDate && !endDate) return '無期限';
    if (startDate && !endDate) return `${formatDate(startDate)} 〜 無期限`;
    if (!startDate && endDate) return `〜 ${formatDate(endDate)}`;
    return `${formatDate(startDate!)} 〜 ${formatDate(endDate!)}`;
  }

  function formatDate(dateStr: string): string {
    if (!dateStr) return '';
    const date = new Date(dateStr);
    return `${date.getFullYear()}/${date.getMonth() + 1}/${date.getDate()}`;
  }

  function getStatus(campaign: Campaign): string {
    const now = new Date();
    const start = campaign.start_date ? new Date(campaign.start_date) : null;
    const end = campaign.end_date ? new Date(campaign.end_date) : null;
    
    if (start && now < start) return '開始前';
    if (end && now > end) return '終了済み';
    if (campaign.is_published && (!start || now >= start) && (!end || now <= end)) return '実施中';
    return '';
  }

  function escapeHtml(text: string): string {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function showError(message: string) {
    const tbody = document.getElementById('campaignTableBody');
    if (tbody) {
      tbody.innerHTML = `
        <tr>
          <td colspan="5" class="px-4 py-8 text-center text-red-500">
            ${escapeHtml(message)}
          </td>
        </tr>
      `;
    }
  }

  async function deleteCampaign(id: string) {
    if (!confirm('このキャンペーンを削除しますか？関連するプラン設定も削除されます。')) return;
    
    try {
      const res = await fetch(`/api/campaigns/${id}`, { method: 'DELETE' });
      if (res.ok) {
        await loadCampaigns();
      } else {
        alert('削除に失敗しました');
      }
    } catch (error) {
      console.error('削除エラー:', error);
      alert('削除に失敗しました');
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    loadCampaigns();

    const publishedFilter = document.getElementById('publishedFilter') as HTMLSelectElement;
    publishedFilter?.addEventListener('change', () => {
      selectedPublished = publishedFilter.value;
      loadCampaigns();
    });
  });

  (window as any).deleteCampaign = deleteCampaign;
</script>

