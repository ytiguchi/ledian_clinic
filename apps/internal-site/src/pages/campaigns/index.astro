---
import Layout from '../../components/Layout.astro';
---

<Layout>
  <div class="campaigns-page">
    <!-- Page Header -->
    <div class="page-header">
      <div>
        <h1 class="page-title">ãŠçŸ¥ã‚‰ã›ç®¡ç†</h1>
        <p class="page-subtitle">ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒ»ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ãƒ»ãŠçŸ¥ã‚‰ã›ã‚’ç®¡ç†ã—ã¾ã™</p>
      </div>
      <a href="/campaigns/new" class="btn btn-primary">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        æ–°è¦ä½œæˆ
      </a>
    </div>

    <!-- Filter Bar -->
    <div class="filter-bar">
      <div class="filter-grid">
        <div class="filter-item">
          <label class="label">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
          <select class="select" id="publishedFilter">
            <option value="">ã™ã¹ã¦</option>
            <option value="published">å…¬é–‹ä¸­ã®ã¿</option>
            <option value="unpublished">éå…¬é–‹ã®ã¿</option>
          </select>
        </div>
        <div class="filter-item">
          <label class="label">è¡¨ç¤ºã‚«ãƒ†ã‚´ãƒª</label>
          <select class="select" id="typeFilter">
            <option value="">ã™ã¹ã¦</option>
            <option value="campaign">ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³</option>
            <option value="new_service">æ–°ã‚µãƒ¼ãƒ“ã‚¹</option>
            <option value="news">ãŠçŸ¥ã‚‰ã›</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Campaign Table -->
    <div class="table-container">
      <table class="table">
        <thead>
          <tr>
            <th>ã‚¿ã‚¤ãƒˆãƒ«</th>
            <th class="text-center">ã‚«ãƒ†ã‚´ãƒª</th>
            <th>æœŸé–“</th>
            <th class="text-center">å¯¾è±¡ãƒ—ãƒ©ãƒ³æ•°</th>
            <th class="text-center">çŠ¶æ…‹</th>
            <th class="text-center">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="campaignTableBody">
          <tr>
            <td colspan="6">
              <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</Layout>

<style>
  .campaigns-page {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .filter-grid {
    display: grid;
    grid-template-columns: 200px 200px;
    gap: 1rem;
  }

  .filter-item {
    display: flex;
    flex-direction: column;
    gap: 0.375rem;
  }

  .text-center {
    text-align: center;
  }

  /* Campaign Info */
  .campaign-info {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .campaign-title {
    font-weight: 600;
    color: var(--color-text);
  }

  .campaign-desc {
    font-size: 0.8125rem;
    color: var(--color-text-muted);
    max-width: 300px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  /* Period */
  .campaign-period {
    font-size: 0.875rem;
    color: var(--color-text-secondary);
  }

  /* Plan Count */
  .plan-count {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 32px;
    padding: 0.25rem 0.75rem;
    background: var(--color-bg-hover);
    border-radius: var(--radius-full);
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--color-text);
  }

  /* Status Badges */
  .status-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.25rem;
  }

  .status-indicator {
    font-size: 0.75rem;
    color: var(--color-text-muted);
  }

  /* Action Buttons */
  .action-buttons {
    display: flex;
    gap: 0.5rem;
    justify-content: center;
  }

  .action-btn {
    padding: 0.375rem 0.75rem;
    font-size: 0.8125rem;
    font-weight: 500;
    border-radius: var(--radius-md);
    text-decoration: none;
    transition: all var(--transition-fast);
    cursor: pointer;
    border: none;
  }

  .action-btn-edit {
    background: var(--color-accent-subtle);
    color: var(--color-accent-dark);
  }

  .action-btn-edit:hover {
    background: var(--color-accent);
    color: var(--color-primary);
  }

  .action-btn-delete {
    background: var(--color-error-light);
    color: #b91c1c;
  }

  .action-btn-delete:hover {
    background: var(--color-error);
    color: white;
  }

  @media (max-width: 768px) {
    .table-container {
      overflow-x: auto;
    }

    .table {
      min-width: 600px;
    }
  }
</style>

<script>
  interface Campaign {
    id: string;
    title: string;
    slug: string;
    description: string | null;
    start_date: string | null;
    end_date: string | null;
    campaign_type: string;
    priority: number;
    is_published: boolean;
    plan_count: number;
    created_at: string;
  }

  let campaigns: Campaign[] = [];
  let selectedPublished: string = '';
  let selectedType: string = '';

  async function loadCampaigns() {
    try {
      const params = new URLSearchParams();
      if (selectedPublished === 'published') params.append('is_published', '1');
      if (selectedPublished === 'unpublished') params.append('is_published', '0');
      if (selectedType) params.append('campaign_type', selectedType);

      const res = await fetch(`/api/campaigns?${params.toString()}`);
      if (!res.ok) {
        const errorData = await res.json().catch(() => ({ message: `HTTP ${res.status}: ${res.statusText}` }));
        console.error('API ã‚¨ãƒ©ãƒ¼:', errorData);
        showError(`ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${errorData.message || errorData.error || 'Unknown error'}`);
        return;
      }
      const data = await res.json();
      if (data.error) {
        console.error('API ã‚¨ãƒ©ãƒ¼:', data);
        showError(`ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${data.message || data.error}`);
        return;
      }
      campaigns = data.campaigns || [];
      renderTable();
    } catch (error) {
      console.error('ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      showError(`ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error instanceof Error ? error.message : 'Unknown error'}`);
    }
  }

  function renderTable() {
    const tbody = document.getElementById('campaignTableBody');
    if (!tbody) return;

    if (campaigns.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="6">
            <div class="empty-state">
              <div class="empty-state-icon">ğŸ</div>
              <div class="empty-state-title">è¨˜äº‹ãŒã‚ã‚Šã¾ã›ã‚“</div>
              <div class="empty-state-desc">æ–°è¦è¨˜äº‹ã‚’ä½œæˆã—ã¦ãã ã•ã„</div>
            </div>
          </td>
        </tr>
      `;
      return;
    }

    tbody.innerHTML = campaigns.map(campaign => {
      const period = getPeriodText(campaign.start_date, campaign.end_date);
      const status = getStatus(campaign);
      const statusBadgeClass = campaign.is_published ? 'badge-success' : 'badge-neutral';
      const categoryInfo = getCategoryInfo(campaign.campaign_type);
      
      return `
        <tr>
          <td>
            <div class="campaign-info">
              <span class="campaign-title">${escapeHtml(campaign.title)}</span>
              ${campaign.description ? `<span class="campaign-desc">${escapeHtml(campaign.description)}</span>` : ''}
            </div>
          </td>
          <td class="text-center">
            <span class="badge ${categoryInfo.badgeClass}">${categoryInfo.label}</span>
          </td>
          <td>
            <span class="campaign-period">${period}</span>
          </td>
          <td class="text-center">
            <span class="plan-count">${campaign.plan_count}ä»¶</span>
          </td>
          <td class="text-center">
            <div class="status-container">
              <span class="badge ${statusBadgeClass}">
                ${campaign.is_published ? 'å…¬é–‹ä¸­' : 'éå…¬é–‹'}
              </span>
              ${status ? `<span class="status-indicator">${status}</span>` : ''}
            </div>
          </td>
          <td>
            <div class="action-buttons">
              <a href="/campaigns/${campaign.id}/edit" class="action-btn action-btn-edit">ç·¨é›†</a>
              <button onclick="deleteCampaign('${campaign.id}')" class="action-btn action-btn-delete">å‰Šé™¤</button>
            </div>
          </td>
        </tr>
      `;
    }).join('');
  }

  function getPeriodText(startDate: string | null, endDate: string | null): string {
    if (!startDate && !endDate) return 'ç„¡æœŸé™';
    if (startDate && !endDate) return `${formatDate(startDate)} ã€œ ç„¡æœŸé™`;
    if (!startDate && endDate) return `ã€œ ${formatDate(endDate)}`;
    return `${formatDate(startDate!)} ã€œ ${formatDate(endDate!)}`;
  }

  function formatDate(dateStr: string): string {
    if (!dateStr) return '';
    const date = new Date(dateStr);
    return `${date.getFullYear()}/${date.getMonth() + 1}/${date.getDate()}`;
  }

  function getStatus(campaign: Campaign): string {
    const now = new Date();
    const start = campaign.start_date ? new Date(campaign.start_date) : null;
    const end = campaign.end_date ? new Date(campaign.end_date) : null;
    
    if (start && now < start) return 'é–‹å§‹å‰';
    if (end && now > end) return 'çµ‚äº†æ¸ˆã¿';
    if (campaign.is_published && (!start || now >= start) && (!end || now <= end)) return 'å®Ÿæ–½ä¸­';
    return '';
  }
  
  function getCategoryInfo(type: string): { label: string; badgeClass: string } {
    switch (type) {
      case 'campaign':
        return { label: 'ğŸ ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³', badgeClass: 'badge-warning' };
      case 'new_service':
        return { label: 'âœ¨ æ–°ã‚µãƒ¼ãƒ“ã‚¹', badgeClass: 'badge-info' };
      case 'news':
        return { label: 'ğŸ“¢ ãŠçŸ¥ã‚‰ã›', badgeClass: 'badge-neutral' };
      default:
        return { label: type || 'æœªè¨­å®š', badgeClass: 'badge-neutral' };
    }
  }

  function escapeHtml(text: string): string {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function showError(message: string) {
    const tbody = document.getElementById('campaignTableBody');
    if (tbody) {
      tbody.innerHTML = `
        <tr>
          <td colspan="6">
            <div class="empty-state" style="color: var(--color-error)">
              <div class="empty-state-icon">âš ï¸</div>
              <div class="empty-state-title">${escapeHtml(message)}</div>
            </div>
          </td>
        </tr>
      `;
    }
  }

  async function deleteCampaign(id: string) {
    if (!confirm('ã“ã®è¨˜äº‹ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿé–¢é€£ã™ã‚‹ãƒ—ãƒ©ãƒ³è¨­å®šã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ã€‚')) return;
    
    try {
      const res = await fetch(`/api/campaigns/${id}`, { method: 'DELETE' });
      if (res.ok) {
        await loadCampaigns();
      } else {
        alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    } catch (error) {
      console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
      alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    loadCampaigns();

    const publishedFilter = document.getElementById('publishedFilter') as HTMLSelectElement;
    publishedFilter?.addEventListener('change', () => {
      selectedPublished = publishedFilter.value;
      loadCampaigns();
    });
    
    const typeFilter = document.getElementById('typeFilter') as HTMLSelectElement;
    typeFilter?.addEventListener('change', () => {
      selectedType = typeFilter.value;
      loadCampaigns();
    });
  });

  (window as any).deleteCampaign = deleteCampaign;
</script>
