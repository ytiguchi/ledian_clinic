---
import Layout from '../../../components/Layout.astro';

const id = Astro.params.id;
export const prerender = false;
---

<Layout>
  <div class="max-w-6xl mx-auto space-y-6" data-campaign-id={id}>
    <div>
      <a href="/campaigns" class="text-accent hover:underline">â† ãŠçŸ¥ã‚‰ã›ç®¡ç†ã«æˆ»ã‚‹</a>
      <h2 class="text-3xl font-bold mt-4">è¨˜äº‹ç·¨é›†</h2>
    </div>

    <div id="loadingMessage" class="bg-white rounded-lg shadow p-8 text-center">
      <p class="text-gray-500">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
    </div>

    <form class="bg-white rounded-lg shadow p-6 space-y-6 hidden" id="campaignForm">
      <input type="hidden" name="id" id="campaignId" />

      <!-- åŸºæœ¬æƒ…å ± -->
      <div>
        <h3 class="text-xl font-semibold mb-4">åŸºæœ¬æƒ…å ±</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">ã‚¿ã‚¤ãƒˆãƒ« <span class="text-red-500">*</span></label>
            <input
              type="text"
              name="title"
              id="title"
              class="w-full px-4 py-2 border rounded-lg"
              required
            />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">ã‚¹ãƒ©ãƒƒã‚° <span class="text-red-500">*</span></label>
            <input
              type="text"
              name="slug"
              id="slug"
              class="w-full px-4 py-2 border rounded-lg"
              required
            />
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm font-medium mb-1">æ¦‚è¦ï¼ˆä¸€è¦§è¡¨ç¤ºç”¨ï¼‰</label>
            <textarea
              name="description"
              id="description"
              rows="2"
              class="w-full px-4 py-2 border rounded-lg"
              placeholder="ä¸€è¦§ãƒšãƒ¼ã‚¸ã«è¡¨ç¤ºã•ã‚Œã‚‹çŸ­ã„æ¦‚è¦æ–‡"
            ></textarea>
          </div>
        </div>
      </div>
      
      <!-- ãƒªãƒƒãƒHTMLã‚¨ãƒ‡ã‚£ã‚¿ï¼ˆå…¨å¹…ï¼‰ -->
      <div>
        <h3 class="text-xl font-semibold mb-4">æœ¬æ–‡ï¼ˆHTMLï¼‰</h3>
            
            <!-- ã‚¨ãƒ‡ã‚£ã‚¿ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ -->
            <div class="flex flex-wrap gap-1 p-2 bg-gray-100 border border-b-0 rounded-t-lg">
              <button type="button" onclick="insertHtmlTag('h2')" class="editor-btn" title="è¦‹å‡ºã—2">
                <span class="font-bold">H2</span>
              </button>
              <button type="button" onclick="insertHtmlTag('h3')" class="editor-btn" title="è¦‹å‡ºã—3">
                <span class="font-bold">H3</span>
              </button>
              <button type="button" onclick="insertHtmlTag('p')" class="editor-btn" title="æ®µè½">
                <span>Â¶</span>
              </button>
              <span class="w-px h-6 bg-gray-300 mx-1"></span>
              <button type="button" onclick="insertHtmlTag('strong')" class="editor-btn" title="å¤ªå­—">
                <span class="font-bold">B</span>
              </button>
              <button type="button" onclick="insertHtmlTag('em')" class="editor-btn" title="æ–œä½“">
                <span class="italic">I</span>
              </button>
              <button type="button" onclick="insertHtmlTag('u')" class="editor-btn" title="ä¸‹ç·š">
                <span class="underline">U</span>
              </button>
              <span class="w-px h-6 bg-gray-300 mx-1"></span>
              <button type="button" onclick="insertHtmlTag('ul')" class="editor-btn" title="ç®‡æ¡æ›¸ã">
                <span>â€¢ ãƒªã‚¹ãƒˆ</span>
              </button>
              <button type="button" onclick="insertHtmlTag('ol')" class="editor-btn" title="ç•ªå·ãƒªã‚¹ãƒˆ">
                <span>1. ãƒªã‚¹ãƒˆ</span>
              </button>
              <span class="w-px h-6 bg-gray-300 mx-1"></span>
              <button type="button" id="uploadBtn" onclick="triggerImageUpload()" class="editor-btn" title="ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆWebPè‡ªå‹•å¤‰æ›ï¼‰">
                <span>ğŸ“¤ ç”»åƒUP</span>
              </button>
              <button type="button" id="urlBtn" onclick="insertImageUrl()" class="editor-btn" title="ç”»åƒURLæŒ¿å…¥">
                <span>ğŸ–¼ï¸ URL</span>
              </button>
              <input type="file" id="imageUploadInput" accept="image/*" style="position: absolute; left: -9999px; opacity: 0; pointer-events: none;" />
              <button type="button" onclick="insertLink()" class="editor-btn" title="ãƒªãƒ³ã‚¯æŒ¿å…¥">
                <span>ğŸ”— ãƒªãƒ³ã‚¯</span>
              </button>
              <span class="w-px h-6 bg-gray-300 mx-1"></span>
              <button type="button" onclick="insertTemplate('news-image')" class="editor-btn bg-blue-50" title="ãƒ‹ãƒ¥ãƒ¼ã‚¹ç”»åƒãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ">
                <span>ğŸ“° ãƒ‹ãƒ¥ãƒ¼ã‚¹ç”»åƒ</span>
              </button>
            </div>
            
            <!-- ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ -->
            <div class="flex border-x border-gray-200 bg-gray-50">
              <button type="button" id="tabHtml" onclick="switchTab('html')" class="editor-tab active">
                ğŸ“ HTML
              </button>
              <button type="button" id="tabPreview" onclick="switchTab('preview')" class="editor-tab">
                ğŸ‘ï¸ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
              </button>
              <button type="button" id="tabSplit" onclick="switchTab('split')" class="editor-tab">
                â¬œ åˆ†å‰²è¡¨ç¤º
              </button>
            </div>
            
            <!-- ã‚¨ãƒ‡ã‚£ã‚¿æœ¬ä½“ -->
            <div id="editorContainer" class="border rounded-b-lg overflow-hidden">
              <!-- HTMLç·¨é›†ãƒ¢ãƒ¼ãƒ‰ -->
              <div id="htmlEditor" class="editor-pane">
                <textarea
                  name="content"
                  id="content"
                  rows="20"
                  class="w-full h-[500px] px-4 py-3 font-mono text-sm border-0 resize-none focus:outline-none focus:ring-2 focus:ring-accent focus:ring-inset"
                  placeholder="HTMLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."
                  oninput="updatePreview()"
                ></textarea>
              </div>
              
              <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ‰ -->
              <div id="previewPane" class="editor-pane hidden">
                <div id="previewContent" class="w-full h-[500px] px-6 py-4 overflow-auto bg-white prose prose-sm max-w-none">
                  <p class="text-gray-400">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</p>
                </div>
              </div>
              
              <!-- åˆ†å‰²è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ -->
              <div id="splitPane" class="editor-pane hidden">
                <div class="grid grid-cols-2 divide-x h-[500px]">
                  <div class="overflow-hidden">
                    <textarea
                      id="contentSplit"
                      rows="20"
                      class="w-full h-full px-4 py-3 font-mono text-sm border-0 resize-none focus:outline-none"
                      placeholder="HTMLã‚’å…¥åŠ›..."
                      oninput="syncContent(this); updatePreview()"
                    ></textarea>
                  </div>
                  <div id="splitPreviewContent" class="px-6 py-4 overflow-auto bg-gray-50 prose prose-sm max-w-none">
                    <p class="text-gray-400">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</p>
                  </div>
                </div>
              </div>
            </div>
            
        <p class="text-xs text-gray-500 mt-2">ğŸ’¡ ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ã®ãƒœã‚¿ãƒ³ã§HTMLã‚¿ã‚°ã‚’æŒ¿å…¥ã§ãã¾ã™ã€‚ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¿ãƒ–ã§è¡¨ç¤ºç¢ºèªãŒã§ãã¾ã™ã€‚</p>
      </div>
      
      <!-- è¡¨ç¤ºè¨­å®š -->
      <div>
        <h3 class="text-xl font-semibold mb-4">è¡¨ç¤ºè¨­å®š</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">è¡¨ç¤ºã‚«ãƒ†ã‚´ãƒª</label>
            <select name="campaign_type" id="campaign_type" class="w-full px-4 py-2 border rounded-lg">
              <option value="campaign">ğŸ ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³</option>
              <option value="new_service">âœ¨ æ–°ã‚µãƒ¼ãƒ“ã‚¹</option>
              <option value="news">ğŸ“¢ ãŠçŸ¥ã‚‰ã›</option>
            </select>
            <p class="text-xs text-gray-500 mt-1">å…¬é–‹ã‚µã‚¤ãƒˆã§ã®ãƒ•ã‚£ãƒ«ã‚¿åˆ†é¡</p>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">å„ªå…ˆåº¦</label>
            <input
              type="number"
              name="priority"
              id="priority"
              min="0"
              class="w-full px-4 py-2 border rounded-lg"
            />
          </div>
        </div>
      </div>

      <!-- æœŸé–“è¨­å®š -->
      <div>
        <h3 class="text-xl font-semibold mb-4">æœŸé–“è¨­å®š</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">é–‹å§‹æ—¥</label>
            <input
              type="date"
              name="startDate"
              id="startDate"
              class="w-full px-4 py-2 border rounded-lg"
            />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">çµ‚äº†æ—¥</label>
            <input
              type="date"
              name="endDate"
              id="endDate"
              class="w-full px-4 py-2 border rounded-lg"
            />
          </div>
        </div>
      </div>

      <!-- å¯¾è±¡ãƒ—ãƒ©ãƒ³ -->
      <div>
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-semibold">å¯¾è±¡ãƒ—ãƒ©ãƒ³</h3>
          <button
            type="button"
            onclick="togglePlanSelector()"
            class="px-4 py-2 bg-accent text-white rounded-lg hover:bg-accent-light transition text-sm"
          >
            + ãƒ—ãƒ©ãƒ³è¿½åŠ 
          </button>
        </div>
        
        <!-- ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰çµæœãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div id="uploadResultModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" style="display: none;">
          <div class="bg-white rounded-lg shadow-xl max-w-lg w-full">
            <div class="p-4 border-b flex justify-between items-center">
              <h4 class="text-lg font-semibold">ğŸ“¤ ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†</h4>
              <button type="button" onclick="closeUploadModal()" class="text-gray-500 hover:text-gray-700">Ã—</button>
            </div>
            <div class="p-4 space-y-4">
              <div id="uploadedImagePreview" class="flex justify-center bg-gray-100 rounded-lg p-2">
                <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒ -->
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">ç”»åƒURL</label>
                <div class="flex gap-2">
                  <input type="text" id="uploadedImageUrl" readonly class="flex-1 px-3 py-2 border rounded-lg bg-gray-50 text-sm" />
                  <button type="button" onclick="copyImageUrl()" class="px-3 py-2 bg-accent text-white rounded-lg hover:bg-accent-dark text-sm">
                    ğŸ“‹ ã‚³ãƒ”ãƒ¼
                  </button>
                </div>
              </div>
              <div class="flex gap-2">
                <button type="button" onclick="insertUploadedImage()" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                  âœ… æœ¬æ–‡ã«æŒ¿å…¥
                </button>
                <button type="button" onclick="closeUploadModal()" class="px-4 py-2 border rounded-lg hover:bg-gray-50">
                  ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- ãƒ—ãƒ©ãƒ³é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div id="planSelectorModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
          <div class="bg-white rounded-lg shadow-xl max-w-5xl w-full max-h-[70vh] flex flex-col">
            <div class="p-4 border-b flex justify-between items-center">
              <h4 class="text-lg font-semibold">é€šå¸¸ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰é¸æŠ</h4>
              <button onclick="togglePlanSelector()" class="text-gray-500 hover:text-gray-700 text-xl">&times;</button>
            </div>
            <div class="p-4 border-b">
              <input
                type="text"
                id="planSearchInput"
                placeholder="æ–½è¡“åãƒ»ãƒ—ãƒ©ãƒ³åã§æ¤œç´¢..."
                class="w-full px-4 py-2 border rounded-lg"
                oninput="filterPlans()"
              />
            </div>
            <div class="flex-1 overflow-y-auto p-4">
              <div id="availablePlans" class="space-y-2">
                <p class="text-gray-500 text-center py-8">èª­ã¿è¾¼ã¿ä¸­...</p>
              </div>
            </div>
          </div>
        </div>

        <!-- é¸æŠæ¸ˆã¿ãƒ—ãƒ©ãƒ³ãƒªã‚¹ãƒˆ -->
        <div id="planList" class="space-y-4">
          <p class="text-sm text-gray-500">ãƒ—ãƒ©ãƒ³ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</p>
        </div>
      </div>

      <!-- å…¬é–‹è¨­å®š -->
      <div>
        <h3 class="text-xl font-semibold mb-4">å…¬é–‹è¨­å®š</h3>
        <div class="flex items-center gap-4">
          <label class="flex items-center gap-2 cursor-pointer">
            <input
              type="checkbox"
              name="isPublished"
              id="isPublished"
              class="w-4 h-4 text-accent border-gray-300 rounded"
            />
            <span>å…¬é–‹ã™ã‚‹</span>
          </label>
        </div>
      </div>

      <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div class="flex justify-end gap-4 pt-4 border-t">
        <a href="/campaigns" class="px-6 py-2 border rounded-lg hover:bg-gray-50 transition">
          ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        </a>
        <button
          type="submit"
          class="px-6 py-2 bg-accent text-white rounded-lg hover:bg-accent-light transition"
        >
          æ›´æ–°
        </button>
      </div>
    </form>
  </div>
</Layout>

<style>
  .editor-btn {
    @apply px-2 py-1 text-sm bg-white border border-gray-300 rounded hover:bg-gray-100 hover:border-gray-400 transition-colors;
  }
  .editor-btn:hover {
    @apply bg-gray-100;
  }
  .editor-tab {
    @apply px-4 py-2 text-sm font-medium text-gray-600 border-b-2 border-transparent hover:text-gray-800 hover:bg-gray-100 transition-colors;
  }
  .editor-tab.active {
    @apply text-accent border-accent bg-white;
  }
  .editor-pane {
    min-height: 500px;
    width: 100%;
  }
  #editorContainer {
    width: 100%;
  }
  #editorContainer textarea {
    width: 100% !important;
    min-width: 100%;
  }
  .editor-pane.hidden {
    display: none !important;
  }
  /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
  .prose img {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
  }
  .prose h2 {
    @apply text-xl font-bold mt-6 mb-3 text-gray-800 border-b pb-2;
  }
  .prose h3 {
    @apply text-lg font-semibold mt-4 mb-2 text-gray-700;
  }
  .prose p {
    @apply my-3 text-gray-600 leading-relaxed;
  }
  .prose ul, .prose ol {
    @apply my-3 pl-6;
  }
  .prose li {
    @apply my-1;
  }
  .prose a {
    @apply text-accent underline hover:text-accent-light;
  }
</style>

<script>
  interface CampaignData {
    id: string;
    title: string;
    slug: string;
    description: string | null;
    content: string | null;
    start_date: string | null;
    end_date: string | null;
    campaign_type: string;
    priority: number;
    is_published: number;
  }

  interface Plan {
    id?: string;
    treatment_plan_id: string;
    discount_type: string;
    discount_value: number | null;
    special_price: number | null;
    special_price_taxed: number | null;
  }

  // Get campaignId from data attribute
  const campaignId = document.querySelector('[data-campaign-id]')?.getAttribute('data-campaign-id') || '';

  let campaign: CampaignData | null = null;
  let plans: Plan[] = [];
  let allTreatmentPlans: Array<{ 
    id: string; 
    plan_name: string; 
    treatment_name: string; 
    treatment_id: string;
    category_name: string;
    subcategory_name: string;
    price: number;
    price_taxed: number;
  }> = [];

  async function loadData() {
    try {
      // ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ãƒ‡ãƒ¼ã‚¿å–å¾—
      const res = await fetch(`/api/campaigns/${campaignId}`);
      if (!res.ok) {
        throw new Error('ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      }
      const data = await res.json();
      campaign = data.campaign as CampaignData;
      plans = data.plans || [];

      // ãƒ—ãƒ©ãƒ³ä¸€è¦§å–å¾—ï¼ˆå¯¾è±¡ãƒ—ãƒ©ãƒ³é¸æŠç”¨ï¼‰
      await loadTreatmentPlans();

      // ãƒ•ã‚©ãƒ¼ãƒ ã«å€¤ã‚’è¨­å®š
      populateForm(campaign);

      // ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º
      document.getElementById('loadingMessage')?.classList.add('hidden');
      const form = document.getElementById('campaignForm');
      if (form) {
        form.classList.remove('hidden');
      }

      // ãƒ—ãƒ©ãƒ³ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
      renderPlanList();
    } catch (error) {
      console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      const loadingMsg = document.getElementById('loadingMessage');
      if (loadingMsg) {
        loadingMsg.innerHTML = `<p class="text-red-500">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error instanceof Error ? error.message : 'Unknown error'}</p>`;
      }
    }
  }

  async function loadTreatmentPlans() {
    try {
      const res = await fetch('/api/pricing');
      const data = await res.json();
      allTreatmentPlans = (data.plans || []).map((p: any) => ({
        id: p.id,
        plan_name: p.plan_name,
        treatment_name: p.treatment_name,
        treatment_id: p.treatment_id,
        category_name: p.category_name,
        subcategory_name: p.subcategory_name,
        price: p.price,
        price_taxed: p.price_taxed
      }));
      renderAvailablePlans();
    } catch (error) {
      console.error('ãƒ—ãƒ©ãƒ³ä¸€è¦§èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
    }
  }

  function togglePlanSelector() {
    const modal = document.getElementById('planSelectorModal');
    if (modal) {
      modal.classList.toggle('hidden');
      if (!modal.classList.contains('hidden')) {
        renderAvailablePlans();
      }
    }
  }

  function filterPlans() {
    renderAvailablePlans();
  }

  function renderAvailablePlans() {
    const container = document.getElementById('availablePlans');
    if (!container) return;

    const searchTerm = (document.getElementById('planSearchInput') as HTMLInputElement)?.value.toLowerCase() || '';
    const selectedPlanIds = plans.map(p => p.treatment_plan_id);
    const isSearching = searchTerm.length > 0;
    
    // ã‚«ãƒ†ã‚´ãƒªãƒ»ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
    const grouped: Record<string, Record<string, typeof allTreatmentPlans>> = {};
    allTreatmentPlans
      .filter(plan => {
        const matchesSearch = !searchTerm || 
          plan.treatment_name.toLowerCase().includes(searchTerm) ||
          plan.plan_name.toLowerCase().includes(searchTerm) ||
          plan.category_name.toLowerCase().includes(searchTerm) ||
          plan.subcategory_name.toLowerCase().includes(searchTerm);
        return matchesSearch && !selectedPlanIds.includes(plan.id);
      })
      .forEach(plan => {
        if (!grouped[plan.category_name]) {
          grouped[plan.category_name] = {};
        }
        if (!grouped[plan.category_name][plan.subcategory_name]) {
          grouped[plan.category_name][plan.subcategory_name] = [];
        }
        grouped[plan.category_name][plan.subcategory_name].push(plan);
      });

    if (Object.keys(grouped).length === 0) {
      container.innerHTML = '<p class="text-gray-500 text-center py-8">è©²å½“ã™ã‚‹ãƒ—ãƒ©ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</p>';
      return;
    }

    // ã‚«ãƒ†ã‚´ãƒªã”ã¨ã®ãƒ—ãƒ©ãƒ³æ•°ã‚’è¨ˆç®—
    const categoryPlanCounts: Record<string, number> = {};
    Object.entries(grouped).forEach(([categoryName, subcategories]) => {
      categoryPlanCounts[categoryName] = Object.values(subcategories).reduce((sum, plans) => sum + plans.length, 0);
    });

    container.innerHTML = Object.entries(grouped).map(([categoryName, subcategories], catIndex) => {
      const planCount = categoryPlanCounts[categoryName];
      const isOpen = isSearching; // æ¤œç´¢ä¸­ã¯é–‹ãã€ãã†ã§ãªã‘ã‚Œã°é–‰ã˜ã‚‹
      return `
      <details class="mb-2 border rounded-lg" ${isOpen ? 'open' : ''}>
        <summary class="flex items-center justify-between p-3 cursor-pointer bg-gray-50 hover:bg-gray-100 rounded-lg font-medium">
          <span>${escapeHtml(categoryName)}</span>
          <span class="text-sm text-gray-500 bg-white px-2 py-1 rounded">${planCount}ä»¶</span>
        </summary>
        <div class="p-3 border-t max-h-[300px] overflow-y-auto">
          ${Object.entries(subcategories).map(([subcategoryName, plans]) => `
            <details class="mb-2" ${isSearching ? 'open' : ''}>
              <summary class="text-sm font-medium text-gray-600 cursor-pointer hover:text-gray-800 py-1">
                ${escapeHtml(subcategoryName)} (${plans.length})
              </summary>
              <div class="ml-4 mt-1 space-y-1">
                ${plans.map(plan => `
                  <label class="flex items-center gap-2 p-2 text-sm border rounded hover:bg-gray-50 cursor-pointer">
                    <input
                      type="checkbox"
                      class="w-4 h-4 text-accent"
                      value="${plan.id}"
                      onchange="handlePlanSelection('${plan.id}', this.checked)"
                    />
                    <div class="flex-1 min-w-0">
                      <div class="font-medium truncate">${escapeHtml(plan.treatment_name)}</div>
                      <div class="text-xs text-gray-500 flex justify-between">
                        <span class="truncate">${escapeHtml(plan.plan_name)}</span>
                        <span class="whitespace-nowrap ml-2">Â¥${plan.price_taxed.toLocaleString()}</span>
                      </div>
                    </div>
                  </label>
                `).join('')}
              </div>
            </details>
          `).join('')}
        </div>
      </details>
    `}).join('');
  }

  function handlePlanSelection(planId: string, isSelected: boolean) {
    if (isSelected) {
      const plan = allTreatmentPlans.find(p => p.id === planId);
      if (plan) {
        plans.push({
          treatment_plan_id: planId,
          discount_type: 'percentage',
          discount_value: null,
          special_price: null,
          special_price_taxed: null
        });
      }
    } else {
      plans = plans.filter(p => p.treatment_plan_id !== planId);
    }
    renderPlanList();
    renderAvailablePlans(); // é¸æŠæ¸ˆã¿ã‚’é™¤å¤–ã™ã‚‹ãŸã‚ã«å†æç”»
  }

  function populateForm(data: CampaignData) {
    (document.getElementById('campaignId') as HTMLInputElement).value = data.id;
    (document.getElementById('title') as HTMLInputElement).value = data.title;
    (document.getElementById('slug') as HTMLInputElement).value = data.slug;
    (document.getElementById('description') as HTMLTextAreaElement).value = data.description || '';
    (document.getElementById('content') as HTMLTextAreaElement).value = data.content || '';
    (document.getElementById('campaign_type') as HTMLSelectElement).value = data.campaign_type || 'campaign';
    (document.getElementById('priority') as HTMLInputElement).value = (data.priority ?? 0).toString();
    
    if (data.start_date) {
      (document.getElementById('startDate') as HTMLInputElement).value = data.start_date.split('T')[0];
    }
    if (data.end_date) {
      (document.getElementById('endDate') as HTMLInputElement).value = data.end_date.split('T')[0];
    }
    
    (document.getElementById('isPublished') as HTMLInputElement).checked = data.is_published === 1;
    
    // åˆ†å‰²ãƒ“ãƒ¥ãƒ¼ã®ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã‚‚åŒæœŸã—ã€ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
    const contentSplit = document.getElementById('contentSplit') as HTMLTextAreaElement;
    if (contentSplit) {
      contentSplit.value = data.content || '';
    }
    updatePreview();
  }

  function renderPlanList() {
    const planList = document.getElementById('planList');
    if (!planList) return;

    if (plans.length === 0) {
      planList.innerHTML = '<p class="text-sm text-gray-500">ãƒ—ãƒ©ãƒ³ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</p>';
      return;
    }

    planList.innerHTML = plans.map((plan, index) => {
      const selectedPlan = allTreatmentPlans.find(p => p.id === plan.treatment_plan_id);
      const originalPrice = selectedPlan?.price_taxed || 0;
      let campaignPrice = originalPrice;
      
      if (plan.special_price_taxed) {
        campaignPrice = plan.special_price_taxed;
      } else if (plan.discount_type === 'percentage' && plan.discount_value) {
        campaignPrice = Math.floor(originalPrice * (1 - plan.discount_value / 100));
      } else if (plan.discount_type === 'fixed' && plan.discount_value) {
        campaignPrice = Math.max(0, originalPrice - plan.discount_value);
      }
      
      const discountAmount = originalPrice - campaignPrice;
      const discountRate = originalPrice > 0 ? Math.round((discountAmount / originalPrice) * 100) : 0;

      return `
        <div class="border rounded-lg p-4 bg-white plan-item shadow-sm" data-index="${index}">
          <div class="flex justify-between items-start mb-4">
            <div class="flex-1">
              <div class="font-semibold text-lg">${escapeHtml(selectedPlan?.treatment_name || '')}</div>
              <div class="text-sm text-gray-600 mt-1">${escapeHtml(selectedPlan?.category_name || '')} / ${escapeHtml(selectedPlan?.subcategory_name || '')}</div>
              <div class="text-sm text-gray-500 mt-1">${escapeHtml(selectedPlan?.plan_name || '')}</div>
              <div class="mt-2 flex items-center gap-4">
                <div>
                  <span class="text-sm text-gray-500">é€šå¸¸ä¾¡æ ¼:</span>
                  <span class="text-lg font-semibold ml-2">Â¥${originalPrice.toLocaleString()}</span>
                </div>
                ${discountAmount > 0 ? `
                  <div class="text-accent">
                    <span class="text-sm">ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ä¾¡æ ¼:</span>
                    <span class="text-lg font-semibold ml-2">Â¥${campaignPrice.toLocaleString()}</span>
                    <span class="text-sm ml-2">(${discountRate}% OFF)</span>
                  </div>
                ` : ''}
              </div>
            </div>
            <button
              type="button"
              onclick="removePlan(${index})"
              class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition text-sm"
            >
              å‰Šé™¤
            </button>
          </div>
          
          <input type="hidden" name="plan_${index}_treatment_plan_id" value="${plan.treatment_plan_id}" />
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pt-4 border-t">
            <div>
              <label class="block text-sm font-medium mb-1">å‰²å¼•ã‚¿ã‚¤ãƒ— <span class="text-red-500">*</span></label>
              <select name="plan_${index}_discount_type" class="w-full px-4 py-2 border rounded-lg discount-type-select" onchange="updatePlanPreview(${index})">
                <option value="percentage" ${plan.discount_type === 'percentage' ? 'selected' : ''}>ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆå‰²å¼•</option>
                <option value="fixed" ${plan.discount_type === 'fixed' ? 'selected' : ''}>å›ºå®šé¡å‰²å¼•</option>
                <option value="special_price" ${plan.discount_type === 'special_price' ? 'selected' : ''}>ç‰¹åˆ¥ä¾¡æ ¼</option>
              </select>
            </div>
            <div id="plan_${index}_discount_value_container">
              <label class="block text-sm font-medium mb-1">å‰²å¼•å€¤</label>
              <input
                type="number"
                name="plan_${index}_discount_value"
                value="${plan.discount_value || ''}"
                placeholder="ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆ(%) ã¾ãŸã¯ å›ºå®šé¡(å††)"
                class="w-full px-4 py-2 border rounded-lg"
                oninput="updatePlanPreview(${index})"
              />
            </div>
            <div id="plan_${index}_special_price_container" class="${plan.discount_type === 'special_price' ? '' : 'hidden'}">
              <label class="block text-sm font-medium mb-1">ç‰¹åˆ¥ä¾¡æ ¼ï¼ˆç¨æŠœï¼‰</label>
              <input
                type="number"
                name="plan_${index}_special_price"
                value="${plan.special_price || ''}"
                placeholder="ç‰¹åˆ¥ä¾¡æ ¼ã‚’è¨­å®š"
                class="w-full px-4 py-2 border rounded-lg"
                oninput="updatePlanPreview(${index})"
              />
            </div>
          </div>
        </div>
      `;
    }).join('');
    
    // å‰²å¼•ã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
    plans.forEach((plan, index) => {
      const discountTypeSelect = document.querySelector(`select[name="plan_${index}_discount_type"]`) as HTMLSelectElement;
      const discountValueContainer = document.getElementById(`plan_${index}_discount_value_container`);
      const specialPriceContainer = document.getElementById(`plan_${index}_special_price_container`);
      
      if (discountTypeSelect && discountValueContainer && specialPriceContainer) {
        discountTypeSelect.addEventListener('change', () => {
          if (discountTypeSelect.value === 'special_price') {
            discountValueContainer.classList.add('hidden');
            specialPriceContainer.classList.remove('hidden');
          } else {
            discountValueContainer.classList.remove('hidden');
            specialPriceContainer.classList.add('hidden');
          }
        });
      }
    });
  }

  function removePlan(index: number) {
    plans.splice(index, 1);
    renderPlanList();
    renderAvailablePlans(); // é¸æŠè§£é™¤ã•ã‚ŒãŸãƒ—ãƒ©ãƒ³ã‚’å†åº¦è¡¨ç¤º
  }

  function updatePlanPreview(index: number) {
    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°ï¼ˆå¿…è¦ã«å¿œã˜ã¦å®Ÿè£…ï¼‰
    // ç¾åœ¨ã¯ renderPlanList ã§å†è¨ˆç®—ã•ã‚Œã‚‹ã®ã§ã€ã“ã“ã§ã¯ç‰¹ã«å‡¦ç†ä¸è¦
  }

  function escapeHtml(text: string): string {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  document.addEventListener('DOMContentLoaded', () => {
    loadData();

    const form = document.getElementById('campaignForm') as HTMLFormElement;
    
    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(form);
      
      // ãƒ—ãƒ©ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’åé›†
      const planData: Plan[] = [];
      plans.forEach((plan, index) => {
        const discountType = formData.get(`plan_${index}_discount_type`) as string;
        const discountValue = formData.get(`plan_${index}_discount_value`);
        const specialPrice = formData.get(`plan_${index}_special_price`);
        
        planData.push({
          treatment_plan_id: plan.treatment_plan_id,
          discount_type: discountType || plan.discount_type,
          discount_value: discountValue ? Number(discountValue) : null,
          special_price: specialPrice ? Number(specialPrice) : null,
          special_price_taxed: specialPrice ? Math.round(Number(specialPrice) * 1.1) : null
        });
      });
      
      const data = {
        title: formData.get('title'),
        slug: formData.get('slug'),
        description: formData.get('description') || null,
        content: formData.get('content') || null,
        campaign_type: formData.get('campaign_type') || 'campaign',
        priority: formData.get('priority') ? Number(formData.get('priority')) : 0,
        start_date: formData.get('startDate') || null,
        end_date: formData.get('endDate') || null,
        is_published: formData.get('isPublished') === 'on',
        sort_order: 0,
        plans: planData
      };

      try {
        const res = await fetch(`/api/campaigns/${campaignId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });

        if (res.ok) {
          alert('æ›´æ–°ã—ã¾ã—ãŸ');
          window.location.reload();
        } else {
          const error = await res.json();
          alert(`æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message || 'Unknown error'}`);
        }
      } catch (error) {
        console.error('æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
        alert('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    });
  });

  (window as any).togglePlanSelector = togglePlanSelector;
  (window as any).filterPlans = filterPlans;
  (window as any).handlePlanSelection = handlePlanSelection;
  (window as any).removePlan = removePlan;
  (window as any).updatePlanPreview = updatePlanPreview;

  // ========================================
  // HTMLã‚¨ãƒ‡ã‚£ã‚¿æ©Ÿèƒ½
  // ========================================
  
  let currentTab = 'html';

  function switchTab(tab: string) {
    currentTab = tab;
    
    // ã‚¿ãƒ–ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
    document.querySelectorAll('.editor-tab').forEach(t => t.classList.remove('active'));
    document.getElementById(`tab${tab.charAt(0).toUpperCase() + tab.slice(1)}`)?.classList.add('active');
    
    // ãƒšã‚¤ãƒ³ã®è¡¨ç¤ºåˆ‡æ›¿
    const htmlEditor = document.getElementById('htmlEditor');
    const previewPane = document.getElementById('previewPane');
    const splitPane = document.getElementById('splitPane');
    
    htmlEditor?.classList.add('hidden');
    previewPane?.classList.add('hidden');
    splitPane?.classList.add('hidden');
    
    if (tab === 'html') {
      htmlEditor?.classList.remove('hidden');
    } else if (tab === 'preview') {
      previewPane?.classList.remove('hidden');
      updatePreview();
    } else if (tab === 'split') {
      splitPane?.classList.remove('hidden');
      // åˆ†å‰²ãƒ“ãƒ¥ãƒ¼ã®ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã‚’åŒæœŸ
      const content = (document.getElementById('content') as HTMLTextAreaElement)?.value || '';
      (document.getElementById('contentSplit') as HTMLTextAreaElement).value = content;
      updatePreview();
    }
  }

  function syncContent(source: HTMLTextAreaElement) {
    const content = source.value;
    (document.getElementById('content') as HTMLTextAreaElement).value = content;
  }

  function updatePreview() {
    let content = (document.getElementById('content') as HTMLTextAreaElement)?.value || '';
    const previewContent = document.getElementById('previewContent');
    const splitPreviewContent = document.getElementById('splitPreviewContent');
    
    // ç›¸å¯¾ãƒ‘ã‚¹ã®ç”»åƒã‚’å…¬é–‹ã‚µã‚¤ãƒˆã®URLã«å¤‰æ›
    // æœ¬ç•ªã‹é–‹ç™ºã‹ã‚’æ¤œå‡º
    const isDev = window.location.hostname.includes('develop') || window.location.hostname.includes('pages.dev');
    const publicSiteBase = isDev 
      ? 'https://develop.ledian-clinic-public.pages.dev' 
      : 'https://ledianclinic.jp';
    content = content.replace(/src="\/images\//g, `src="${publicSiteBase}/images/`);
    
    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’é©ç”¨
    const previewHtml = content || '<p class="text-gray-400">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</p>';
    
    if (previewContent) {
      previewContent.innerHTML = previewHtml;
    }
    if (splitPreviewContent) {
      splitPreviewContent.innerHTML = content || '<p class="text-gray-400">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</p>';
    }
  }

  function insertHtmlTag(tag: string) {
    const textarea = document.getElementById('content') as HTMLTextAreaElement;
    if (!textarea) return;
    
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const selectedText = textarea.value.substring(start, end);
    
    let insertText = '';
    
    switch (tag) {
      case 'ul':
        insertText = `<ul>\n  <li>${selectedText || 'ãƒªã‚¹ãƒˆé …ç›®'}</li>\n</ul>`;
        break;
      case 'ol':
        insertText = `<ol>\n  <li>${selectedText || 'ãƒªã‚¹ãƒˆé …ç›®'}</li>\n</ol>`;
        break;
      case 'h2':
        insertText = `<h2>${selectedText || 'è¦‹å‡ºã—2'}</h2>`;
        break;
      case 'h3':
        insertText = `<h3>${selectedText || 'è¦‹å‡ºã—3'}</h3>`;
        break;
      case 'p':
        insertText = `<p>${selectedText || 'ãƒ†ã‚­ã‚¹ãƒˆ'}</p>`;
        break;
      default:
        insertText = `<${tag}>${selectedText || 'ãƒ†ã‚­ã‚¹ãƒˆ'}</${tag}>`;
    }
    
    textarea.value = textarea.value.substring(0, start) + insertText + textarea.value.substring(end);
    textarea.focus();
    textarea.selectionStart = textarea.selectionEnd = start + insertText.length;
    updatePreview();
  }

  // ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–¢é€£
  let lastUploadedUrl = '';
  
  function triggerImageUpload() {
    const input = document.getElementById('imageUploadInput') as HTMLInputElement;
    if (input) input.click();
  }

  // WebPå¤‰æ›é–¢æ•°
  async function convertToWebP(file: File, quality: number = 0.85): Promise<Blob> {
    return new Promise((resolve, reject) => {
      // ã™ã§ã«WebPã®å ´åˆã¯ãã®ã¾ã¾è¿”ã™
      if (file.type === 'image/webp') {
        resolve(file);
        return;
      }

      const img = new Image();
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');

      img.onload = () => {
        canvas.width = img.width;
        canvas.height = img.height;
        ctx?.drawImage(img, 0, 0);
        
        canvas.toBlob(
          (blob) => {
            if (blob) {
              resolve(blob);
            } else {
              reject(new Error('WebPå¤‰æ›ã«å¤±æ•—ã—ã¾ã—ãŸ'));
            }
          },
          'image/webp',
          quality
        );
      };

      img.onerror = () => reject(new Error('ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ'));
      img.src = URL.createObjectURL(file);
    });
  }

  async function handleImageUpload(event: Event) {
    const input = event.target as HTMLInputElement;
    const file = input.files?.[0];
    if (!file) return;

    // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­ã®è¡¨ç¤º
    const uploadBtn = document.getElementById('uploadBtn') as HTMLButtonElement;
    const originalText = uploadBtn?.innerHTML;
    if (uploadBtn) {
      uploadBtn.innerHTML = '<span class="animate-pulse">â³ å¤‰æ›ä¸­...</span>';
      uploadBtn.disabled = true;
    }

    try {
      // WebPã«å¤‰æ›
      const webpBlob = await convertToWebP(file);
      const webpFile = new File([webpBlob], file.name.replace(/\.[^.]+$/, '.webp'), { type: 'image/webp' });
      
      if (uploadBtn) {
        uploadBtn.innerHTML = '<span class="animate-pulse">â³ UPä¸­...</span>';
      }

      const formData = new FormData();
      formData.append('file', webpFile);
      formData.append('type', 'news');

      const response = await fetch('/api/upload', {
        method: 'POST',
        body: formData,
      });

      const result = await response.json();
      
      if (response.ok && result.url) {
        lastUploadedUrl = result.url;
        showUploadResult(result.url, webpBlob);
      } else {
        alert('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (result.error || 'Unknown error'));
      }
    } catch (error) {
      console.error('Upload error:', error);
      alert('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    } finally {
      if (uploadBtn) {
        uploadBtn.innerHTML = originalText || '<span>ğŸ“¤ ç”»åƒUP</span>';
        uploadBtn.disabled = false;
      }
      input.value = ''; // ãƒªã‚»ãƒƒãƒˆ
    }
  }

  function showUploadResult(url: string, blob: Blob) {
    const modal = document.getElementById('uploadResultModal');
    const preview = document.getElementById('uploadedImagePreview');
    const urlInput = document.getElementById('uploadedImageUrl') as HTMLInputElement;
    
    if (preview) {
      preview.innerHTML = `<img src="${URL.createObjectURL(blob)}" alt="ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”»åƒ" style="max-height: 200px; max-width: 100%; object-fit: contain;" />`;
    }
    if (urlInput) {
      urlInput.value = url;
    }
    if (modal) {
      modal.style.display = 'flex';
    }
  }

  function closeUploadModal() {
    const modal = document.getElementById('uploadResultModal');
    if (modal) {
      modal.style.display = 'none';
    }
  }

  function copyImageUrl() {
    const urlInput = document.getElementById('uploadedImageUrl') as HTMLInputElement;
    if (urlInput) {
      navigator.clipboard.writeText(urlInput.value);
      const btn = document.querySelector('[onclick="copyImageUrl()"]') as HTMLButtonElement;
      if (btn) {
        const original = btn.innerHTML;
        btn.innerHTML = 'âœ… ã‚³ãƒ”ãƒ¼å®Œäº†';
        setTimeout(() => btn.innerHTML = original, 1500);
      }
    }
  }

  function insertUploadedImage() {
    const textarea = document.getElementById('content') as HTMLTextAreaElement;
    if (textarea && lastUploadedUrl) {
      const start = textarea.selectionStart;
      const imgTag = `<img src="${lastUploadedUrl}" alt="" style="width: 100%; max-width: 100%;" />`;
      textarea.value = textarea.value.substring(0, start) + imgTag + textarea.value.substring(start);
      textarea.focus();
      updatePreview();
    }
    closeUploadModal();
  }

  function insertImageUrl() {
    const url = prompt('ç”»åƒURLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', 'https://');
    if (!url) return;
    
    const alt = prompt('ç”»åƒã®èª¬æ˜ï¼ˆaltå±æ€§ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', '');
    
    const textarea = document.getElementById('content') as HTMLTextAreaElement;
    if (!textarea) return;
    
    const start = textarea.selectionStart;
    const imgTag = `<img src="${url}" alt="${alt || ''}" style="width: 100%; max-width: 100%;" />`;
    
    textarea.value = textarea.value.substring(0, start) + imgTag + textarea.value.substring(start);
    textarea.focus();
    updatePreview();
  }

  function insertLink() {
    const url = prompt('ãƒªãƒ³ã‚¯å…ˆURLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', 'https://');
    if (!url) return;
    
    const textarea = document.getElementById('content') as HTMLTextAreaElement;
    if (!textarea) return;
    
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const selectedText = textarea.value.substring(start, end) || 'ãƒªãƒ³ã‚¯ãƒ†ã‚­ã‚¹ãƒˆ';
    
    const linkTag = `<a href="${url}" target="_blank">${selectedText}</a>`;
    
    textarea.value = textarea.value.substring(0, start) + linkTag + textarea.value.substring(end);
    textarea.focus();
    updatePreview();
  }

  function insertTemplate(templateName: string) {
    const textarea = document.getElementById('content') as HTMLTextAreaElement;
    if (!textarea) return;
    
    let template = '';
    
    switch (templateName) {
      case 'news-image':
        template = `<div class="news-content-images">
  <img src="/images/news/content/YOUR_IMAGE.jpg" alt="ç”»åƒã®èª¬æ˜" style="width: 100%; max-width: 100%;" />
</div>

<p>ã“ã“ã«æœ¬æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>

<h3>è©³ç´°æƒ…å ±</h3>
<ul>
  <li>é …ç›®1</li>
  <li>é …ç›®2</li>
  <li>é …ç›®3</li>
</ul>`;
        break;
    }
    
    const start = textarea.selectionStart;
    textarea.value = textarea.value.substring(0, start) + template + textarea.value.substring(start);
    textarea.focus();
    updatePreview();
  }

  // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
  document.getElementById('imageUploadInput')?.addEventListener('change', handleImageUpload);

  // ã‚¨ãƒ‡ã‚£ã‚¿é–¢æ•°ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹
  (window as any).switchTab = switchTab;
  (window as any).insertHtmlTag = insertHtmlTag;
  (window as any).triggerImageUpload = triggerImageUpload;
  (window as any).handleImageUpload = handleImageUpload;
  (window as any).insertImageUrl = insertImageUrl;
  (window as any).insertLink = insertLink;
  (window as any).insertTemplate = insertTemplate;
  (window as any).updatePreview = updatePreview;
  (window as any).syncContent = syncContent;
  (window as any).closeUploadModal = closeUploadModal;
  (window as any).copyImageUrl = copyImageUrl;
  (window as any).insertUploadedImage = insertUploadedImage;
</script>
