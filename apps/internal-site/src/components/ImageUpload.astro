---
// 画像アップロードコンポーネント
// Props: id (input要素のID), label (ラベルテキスト), value (既存のURL), onUpload (コールバック)
---

<div class="image-upload-container">
  <label class="block text-sm font-medium mb-2">{label}</label>
  
  <!-- URL入力またはファイルアップロード -->
  <div class="mb-2">
    <input
      type="url"
      id={`${id}Url`}
      name={`${id}Url`}
      placeholder="画像URLを入力するか、ファイルをアップロードしてください"
      value={value || ''}
      class="w-full px-4 py-2 border rounded-lg"
      data-image-input={id}
    />
  </div>

  <!-- ドラッグ&ドロップエリア -->
  <div
    class="upload-area"
    data-upload-target={id}
  >
    <div class="upload-area-content">
      <svg class="upload-icon" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
        <polyline points="17 8 12 3 7 8"></polyline>
        <line x1="12" y1="3" x2="12" y2="15"></line>
      </svg>
      <p class="upload-text">画像をドラッグ&ドロップ</p>
      <p class="upload-hint">またはクリックしてファイルを選択</p>
      <input
        type="file"
        id={`${id}File`}
        name={`${id}File`}
        accept="image/jpeg,image/png,image/webp,image/gif"
        class="hidden"
        data-image-file={id}
      />
    </div>
  </div>

  <!-- プレビュー -->
  <div class="mt-2 aspect-square bg-gray-100 rounded overflow-hidden relative" data-preview-container={id}>
    <img
      id={`${id}Preview`}
      data-preview={id}
      src={value || ''}
      alt="プレビュー"
      class={`w-full h-full object-cover ${value ? '' : 'hidden'}`}
    />
    <div class="preview-placeholder hidden" data-placeholder={id}>
      <div class="flex items-center justify-center h-full text-gray-400">
        <span>プレビューが表示されます</span>
      </div>
    </div>
    <!-- アップロード中の表示 -->
    <div class="upload-progress hidden" data-progress={id}>
      <div class="flex items-center justify-center h-full bg-black bg-opacity-50 text-white">
        <div class="text-center">
          <div class="spinner"></div>
          <p class="mt-2">アップロード中...</p>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .image-upload-container {
    width: 100%;
  }

  .upload-area {
    border: 2px dashed #cbd5e1;
    border-radius: 0.5rem;
    padding: 2rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    background: #f8fafc;
  }

  .upload-area:hover {
    border-color: #94a3b8;
    background: #f1f5f9;
  }

  .upload-area.dragover {
    border-color: #3b82f6;
    background: #eff6ff;
  }

  .upload-area-content {
    pointer-events: none;
  }

  .upload-icon {
    margin: 0 auto 0.5rem;
    color: #94a3b8;
  }

  .upload-text {
    font-weight: 500;
    color: #475569;
    margin-bottom: 0.25rem;
  }

  .upload-hint {
    font-size: 0.875rem;
    color: #94a3b8;
  }

  .upload-progress {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
  }

  .spinner {
    width: 32px;
    height: 32px;
    border: 3px solid rgba(255, 255, 255, 0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin: 0 auto;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }
</style>

<script>
  // 画像アップロード機能
  function initImageUpload(targetId: string) {
    const fileInput = document.querySelector(`[data-image-file="${targetId}"]`) as HTMLInputElement;
    const urlInput = document.querySelector(`[data-image-input="${targetId}"]`) as HTMLInputElement;
    const preview = document.querySelector(`[data-preview="${targetId}"]`) as HTMLImageElement;
    const uploadArea = document.querySelector(`[data-upload-target="${targetId}"]`) as HTMLElement;
    const progress = document.querySelector(`[data-progress="${targetId}"]`) as HTMLElement;
    const placeholder = document.querySelector(`[data-placeholder="${targetId}"]`) as HTMLElement;

    if (!fileInput || !urlInput || !preview || !uploadArea) return;

    // ファイル選択時
    fileInput.addEventListener('change', async (e) => {
      const file = (e.target as HTMLInputElement).files?.[0];
      if (file) {
        await uploadFile(file, targetId);
      }
    });

    // ドラッグ&ドロップ
    uploadArea.addEventListener('click', () => fileInput.click());
    
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', async (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      const file = e.dataTransfer?.files[0];
      if (file && file.type.startsWith('image/')) {
        await uploadFile(file, targetId);
      }
    });

    // URL入力時
    urlInput.addEventListener('input', () => {
      const url = urlInput.value;
      if (url) {
        preview.src = url;
        preview.classList.remove('hidden');
        if (placeholder) placeholder.classList.add('hidden');
      } else {
        preview.classList.add('hidden');
        if (placeholder) placeholder.classList.remove('hidden');
      }
    });

    async function uploadFile(file: File, targetId: string) {
      try {
        // プレビューを一時的に表示
        const objectUrl = URL.createObjectURL(file);
        preview.src = objectUrl;
        preview.classList.remove('hidden');
        if (placeholder) placeholder.classList.add('hidden');
        if (progress) progress.classList.remove('hidden');

        // フォームデータを作成
        const formData = new FormData();
        formData.append('file', file);
        formData.append('type', 'before-after');

        // アップロード
        const res = await fetch('/api/upload', {
          method: 'POST',
          body: formData,
        });

        if (!res.ok) {
          const error = await res.json();
          throw new Error(error.message || 'アップロードに失敗しました');
        }

        const result = await res.json();
        
        // URLを入力欄に設定
        // 注意: R2バケットのパブリックURLに変換する必要がある場合があります
        urlInput.value = result.url || result.key;
        preview.src = result.url || result.key;

        // 一時URLを解放
        URL.revokeObjectURL(objectUrl);
      } catch (error) {
        console.error('Upload error:', error);
        alert(`アップロードに失敗しました: ${error instanceof Error ? error.message : 'Unknown error'}`);
        preview.src = '';
        preview.classList.add('hidden');
        if (placeholder) placeholder.classList.remove('hidden');
      } finally {
        if (progress) progress.classList.add('hidden');
      }
    }
  }

  // ページ読み込み時に初期化
  document.addEventListener('DOMContentLoaded', () => {
    initImageUpload('before');
    initImageUpload('after');
  });
</script>

