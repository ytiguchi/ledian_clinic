---
export interface Props {
  // ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆIDï¼ˆè¤‡æ•°ä½¿ç”¨æ™‚ã®è­˜åˆ¥ç”¨ï¼‰
  id?: string;
  // åˆæœŸå€¤
  initialCategoryId?: string;
  initialSubcategoryId?: string;
  initialTreatmentId?: string;
  // ã‚«ãƒ†ã‚´ãƒªã‚¢ã‚¤ã‚³ãƒ³ãƒãƒƒãƒ—ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  categoryIcons?: Record<string, string>;
  // ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼
  onCategoryChange?: (categoryId: string) => void;
  onSubcategoryChange?: (subcategoryId: string) => void;
  onTreatmentChange?: (treatmentId: string) => void;
  // å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è¨­å®š
  requiredCategory?: boolean;
  requiredSubcategory?: boolean;
  requiredTreatment?: boolean;
  // ã‚¹ãƒ†ãƒƒãƒ—3ã‚’è¡¨ç¤ºã™ã‚‹ã‹ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: trueï¼‰
  showTreatmentStep?: boolean;
}

const {
  id = 'treatment-selector',
  initialCategoryId,
  initialSubcategoryId,
  initialTreatmentId,
  categoryIcons = {},
  onCategoryChange,
  onSubcategoryChange,
  onTreatmentChange,
  requiredCategory = false,
  requiredSubcategory = false,
  requiredTreatment = false,
  showTreatmentStep = true,
} = Astro.props;

const categoryInputId = `${id}-category-input`;
const subcategoryInputId = `${id}-subcategory-input`;
const treatmentSelectId = `${id}-treatment-select`;
const categoryGridId = `${id}-category-grid`;
const subcategoryGridId = `${id}-subcategory-grid`;
const subcategorySectionId = `${id}-subcategory-section`;
const treatmentSectionId = `${id}-treatment-section`;

// define:varsã§undefinedã‚’æ¸¡ã™ã¨æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã®ã§ç©ºæ–‡å­—ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
const safeInitialCategoryId = initialCategoryId || '';
const safeInitialSubcategoryId = initialSubcategoryId || '';
const safeInitialTreatmentId = initialTreatmentId || '';
---

<div class="treatment-selector-wrapper">
  <!-- STEP 1: ã‚«ãƒ†ã‚´ãƒªé¸æŠ -->
  <div class="category-selector">
    <div class="selector-header">
      <span class="selector-step">STEP 1</span>
      <h3 class="selector-title">æ–½è¡“ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠ</h3>
    </div>
    <div class="category-grid" id={categoryGridId}>
      <div class="category-loading">
        <div class="loading-spinner"></div>
        <span>ã‚«ãƒ†ã‚´ãƒªã‚’èª­ã¿è¾¼ã¿ä¸­...</span>
      </div>
    </div>
    <input type="hidden" name="category" id={categoryInputId} required={requiredCategory} />
  </div>

  <!-- STEP 2: ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªé¸æŠ -->
  <div class="subcategory-selector hidden" id={subcategorySectionId}>
    <div class="selector-header">
      <span class="selector-step">STEP 2</span>
      <h3 class="selector-title">ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠ</h3>
    </div>
    <div class="subcategory-grid" id={subcategoryGridId}>
      <!-- å‹•çš„ã«ç”Ÿæˆ -->
    </div>
    <input type="hidden" name="subcategory" id={subcategoryInputId} required={requiredSubcategory} />
  </div>

  {showTreatmentStep && (
    <!-- STEP 3: æ–½è¡“é¸æŠ -->
    <div class="treatment-selector hidden" id={treatmentSectionId}>
      <div class="selector-header">
        <span class="selector-step">STEP 3</span>
        <h3 class="selector-title">æ–½è¡“ã‚’é¸æŠ</h3>
      </div>
      <div class="section-content">
        <div class="form-group">
          <select name="treatment" id={treatmentSelectId} class="form-input" required={requiredTreatment}>
            <option value="">æ–½è¡“ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
          </select>
        </div>
      </div>
    </div>
  )}
</div>

<style>
  /* ========================================
     Category Selector
     ======================================== */
  .category-selector,
  .subcategory-selector {
    background: white;
    border-radius: 1rem;
    padding: 1.5rem;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
    border: 1px solid #e2e8f0;
  }

  .selector-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1.25rem;
  }

  .selector-step {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.25rem 0.75rem;
    background: linear-gradient(135deg, #d4a853 0%, #e9c97a 100%);
    color: #0f172a;
    font-size: 0.6875rem;
    font-weight: 700;
    letter-spacing: 0.1em;
    border-radius: 2rem;
  }

  .selector-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: #0f172a;
    margin: 0;
  }

  .category-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 0.75rem;
  }

  .category-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.625rem;
    padding: 1.25rem 1rem;
    background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
    border: 2px solid #e2e8f0;
    border-radius: 1rem;
    cursor: pointer;
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    text-align: center;
    user-select: none;
    -webkit-user-select: none;
    min-height: 90px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
  }

  .category-card :global(*) {
    pointer-events: none;
  }

  .category-card:hover {
    background: linear-gradient(145deg, #fffbeb 0%, #fef3c7 100%);
    border-color: #d4a853;
    transform: translateY(-4px);
    box-shadow: 0 8px 25px rgba(212, 168, 83, 0.2);
  }

  .category-card.selected {
    background: linear-gradient(135deg, #d4a853 0%, #e9c97a 100%);
    border-color: #b8922e;
    box-shadow: 0 0 0 4px rgba(212, 168, 83, 0.3), 0 8px 25px rgba(212, 168, 83, 0.3);
    transform: scale(1.02);
  }

  .category-card-icon {
    font-size: 2rem;
    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
  }

  .category-card-name {
    font-size: 0.8125rem;
    font-weight: 600;
    color: #334155;
    line-height: 1.4;
  }

  .category-card.selected .category-card-name {
    color: #0f172a;
    font-weight: 700;
  }

  /* Subcategory Grid */
  .subcategory-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 0.75rem;
  }

  .subcategory-card {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem 1.25rem;
    background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
    border: 2px solid #e2e8f0;
    border-radius: 0.875rem;
    cursor: pointer;
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    min-height: 56px;
    user-select: none;
    -webkit-user-select: none;
    font-family: inherit;
    font-size: inherit;
    text-align: left;
    width: 100%;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
  }

  .subcategory-card :global(*) {
    pointer-events: none;
  }

  .subcategory-card:focus {
    outline: 3px solid #d4a853;
    outline-offset: 2px;
  }

  .subcategory-card:hover {
    background: linear-gradient(145deg, #fffbeb 0%, #fef3c7 100%);
    border-color: #d4a853;
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(212, 168, 83, 0.2);
  }

  .subcategory-card.selected {
    background: linear-gradient(135deg, #d4a853 0%, #f0d78c 100%) !important;
    border-color: #b8922e !important;
    border-width: 4px !important;
    box-shadow: 0 0 0 6px rgba(212, 168, 83, 0.4), 0 12px 40px rgba(212, 168, 83, 0.5) !important;
    transform: scale(1.08);
    animation: pulse-gold 0.5s ease-out;
  }

  @keyframes pulse-gold {
    0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(212, 168, 83, 0.7); }
    50% { transform: scale(1.12); box-shadow: 0 0 0 15px rgba(212, 168, 83, 0); }
    100% { transform: scale(1.08); box-shadow: 0 0 0 6px rgba(212, 168, 83, 0.4), 0 12px 40px rgba(212, 168, 83, 0.5); }
  }

  .subcategory-card-check {
    width: 28px;
    height: 28px;
    min-width: 28px;
    background: linear-gradient(145deg, #f1f5f9 0%, #e2e8f0 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    color: transparent;
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    border: 2px solid #cbd5e1;
  }

  .subcategory-card.selected .subcategory-card-check {
    background: #0f172a !important;
    color: #ffffff !important;
    border-color: #0f172a !important;
    box-shadow: none;
  }

  .subcategory-card-name {
    font-size: 1rem;
    font-weight: 600;
    color: #1e293b;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    line-height: 1.4;
  }

  .subcategory-card.selected .subcategory-card-name {
    color: #0f172a !important;
    font-weight: 800 !important;
    font-size: 1.1rem !important;
  }

  /* Loading State */
  .category-loading {
    grid-column: 1 / -1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    padding: 2rem;
    color: #64748b;
  }

  .loading-spinner {
    width: 20px;
    height: 20px;
    border: 2px solid #e2e8f0;
    border-top-color: #d4a853;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .subcategory-selector.hidden,
  .treatment-selector.hidden {
    display: none;
  }

  .treatment-selector {
    background: white;
    border-radius: 1rem;
    padding: 1.5rem;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
    border: 1px solid #e2e8f0;
  }

  .section-content {
    margin-top: 0.5rem;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .form-input {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #e2e8f0;
    border-radius: 0.5rem;
    font-size: 0.9375rem;
    transition: border-color 0.2s;
  }

  .form-input:focus {
    outline: none;
    border-color: #d4a853;
    box-shadow: 0 0 0 3px rgba(212, 168, 83, 0.1);
  }
</style>

<script define:vars={{
  componentId: id,
  categoryInputId,
  subcategoryInputId,
  treatmentSelectId,
  categoryGridId,
  subcategoryGridId,
  subcategorySectionId,
  treatmentSectionId,
  initialCategoryId: safeInitialCategoryId,
  initialSubcategoryId: safeInitialSubcategoryId,
  initialTreatmentId: safeInitialTreatmentId,
  categoryIconsJson: JSON.stringify(categoryIcons),
  showTreatmentStep,
}}>
  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚«ãƒ†ã‚´ãƒªã‚¢ã‚¤ã‚³ãƒ³
  var defaultCategoryIcons = {
    'è‚Œè¨ºæ–­': 'ğŸ”¬',
    'ãƒ•ã‚©ãƒˆãƒ•ã‚§ã‚¤ã‚·ãƒ£ãƒ«': 'ğŸ’¡',
    'ãƒªãƒ•ãƒˆã‚¢ãƒƒãƒ—': 'âœ¨',
    'ãƒ‹ã‚­ãƒ“ãƒ»ãƒ‹ã‚­ãƒ“ç—•ãƒ»æ¯›ç©´æ²»ç™‚': 'ğŸ¯',
    'ãƒ¬ãƒ¼ã‚¶ãƒ¼æ²»ç™‚': 'âš¡',
    'å„ç¨®ãƒ”ãƒ¼ãƒªãƒ³ã‚°': 'ğŸ–Œï¸',
    'å°å…¥ãƒ»ã‚¨ãƒ¬ã‚¯ãƒˆãƒ­ãƒãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³': 'ğŸŒ€',
    'åŒ»ç™‚è„±æ¯›': 'âœ‚ï¸',
    'ã‚¢ãƒ¼ãƒˆãƒ¡ã‚¤ã‚¯': 'ğŸ¨',
    'ç‚¹æ»´ãƒ»æ³¨å°„': 'ğŸ’‰',
    'è„‚è‚ªæº¶è§£æ³¨å°„': 'ğŸ’§',
    'è‚Œè‚²æ³¨å°„': 'ğŸŒ±',
    'ãƒœãƒˆãƒƒã‚¯ã‚¹æ³¨å°„': 'ğŸ’',
    'ãƒ’ã‚¢ãƒ«ãƒ­ãƒ³é…¸æ³¨å…¥': 'ğŸ’—',
    'ç³¸ãƒªãƒ•ãƒˆ': 'ğŸ§µ',
    'ä»–é™¢æŠœç³¸': 'ğŸ”§',
    'éº»é…”': 'ğŸ˜´',
    'åŒ»è–¬å“': 'ğŸ’Š',
    'ãƒ‰ã‚¯ã‚¿ãƒ¼ã‚ºã‚³ã‚¹ãƒ¡': 'ğŸ§´',
    'ãƒ­ãƒ¼ãƒãƒ”ãƒ³ã‚¯': 'ğŸŒ¸',
    'LDM': 'ğŸ“¡',
  };

  const icons = { ...defaultCategoryIcons, ...JSON.parse(categoryIconsJson) };

  let categories = [];
  let subcategories = [];
  let treatments = [];
  let selectedCategoryId = initialCategoryId || null;
  let selectedSubcategoryId = initialSubcategoryId || null;
  let selectedTreatmentId = initialTreatmentId || null;

  // ã‚«ã‚¹ã‚¿ãƒ ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼
  function dispatchChangeEvent(eventName, detail) {
    const event = new CustomEvent(eventName, { detail, bubbles: true });
    document.dispatchEvent(event);
  }

  async function loadCategories() {
    try {
      const res = await fetch('/api/categories');
      const data = await res.json();
      categories = data.categories || [];
      
      const grid = document.getElementById(categoryGridId);
      if (grid) {
        grid.innerHTML = categories.map(cat => `
          <div class="category-card" data-category-id="${cat.id}">
            <div class="category-card-icon">${icons[cat.name] || 'ğŸ“‹'}</div>
            <div class="category-card-name">${cat.name}</div>
          </div>
        `).join('');

        // ã‚«ãƒ¼ãƒ‰é¸æŠã‚¤ãƒ™ãƒ³ãƒˆ
        grid.querySelectorAll('.category-card').forEach(card => {
          card.addEventListener('click', () => {
            const categoryId = card.getAttribute('data-category-id');
            if (categoryId) {
              selectCategory(categoryId, card);
            }
          });
        });

        // åˆæœŸå€¤ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
        if (initialCategoryId) {
          const card = grid.querySelector(`[data-category-id="${initialCategoryId}"]`);
          if (card) {
            selectCategory(initialCategoryId, card);
          }
        }
      }
    } catch (error) {
      console.error('ã‚«ãƒ†ã‚´ãƒªèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      const grid = document.getElementById(categoryGridId);
      if (grid) {
        grid.innerHTML = '<div class="category-loading">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
      }
    }
  }

  function selectCategory(categoryId, cardElement) {
    selectedCategoryId = categoryId;
    
    // hidden inputã‚’æ›´æ–°
    const input = document.getElementById(categoryInputId);
    if (input) input.value = categoryId;
    
    // å…¨ã‚«ãƒ¼ãƒ‰ã‹ã‚‰é¸æŠã‚¹ã‚¿ã‚¤ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆ
    document.querySelectorAll(`#${categoryGridId} .category-card`).forEach(c => {
      c.classList.remove('selected');
    });
    
    // é¸æŠã•ã‚ŒãŸã‚«ãƒ¼ãƒ‰ã«ã‚¹ã‚¿ã‚¤ãƒ«ã‚’é©ç”¨
    cardElement.classList.add('selected');

    // ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
    const subcategorySection = document.getElementById(subcategorySectionId);
    if (subcategorySection) {
      subcategorySection.classList.remove('hidden');
      subcategorySection.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    // æ²»ç™‚ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤º
    if (showTreatmentStep) {
      const treatmentSection = document.getElementById(treatmentSectionId);
      if (treatmentSection) {
        treatmentSection.classList.add('hidden');
      }
      const treatmentSelect = document.getElementById(treatmentSelectId);
      if (treatmentSelect) {
        treatmentSelect.innerHTML = '<option value="">æ–½è¡“ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
      }
      selectedTreatmentId = null;
    }
    selectedSubcategoryId = null;

    // ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªã‚’èª­ã¿è¾¼ã¿
    void loadSubcategories(categoryId);

    // ã‚«ã‚¹ã‚¿ãƒ ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«
    dispatchChangeEvent(`treatment-selector:category-change:${componentId}`, { categoryId });
  }

  async function loadSubcategories(categoryId) {
    const grid = document.getElementById(subcategoryGridId);
    if (!grid) return;
    
    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
    grid.innerHTML = '<div class="category-loading"><div class="loading-spinner"></div><span>ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªã‚’èª­ã¿è¾¼ã¿ä¸­...</span></div>';
    
    try {
      const res = await fetch(`/api/subcategories?category_id=${categoryId}`);
      const data = await res.json();
      subcategories = data.subcategories || [];
      
      if (subcategories.length === 0) {
        grid.innerHTML = '<div class="category-loading">ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }
      
      grid.innerHTML = subcategories.map(sub => `
        <button type="button" class="subcategory-card" data-subcategory-id="${sub.id}">
          <span class="subcategory-card-check">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
              <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
          </span>
          <span class="subcategory-card-name">${sub.name}</span>
        </button>
      `).join('');

      // ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªé¸æŠã‚¤ãƒ™ãƒ³ãƒˆ
      grid.querySelectorAll('.subcategory-card').forEach(card => {
        card.addEventListener('click', () => {
          const subcategoryId = card.getAttribute('data-subcategory-id');
          if (subcategoryId) {
            selectSubcategory(subcategoryId, card);
          }
        });
      });

      // åˆæœŸå€¤ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
      if (initialSubcategoryId) {
        const card = grid.querySelector(`[data-subcategory-id="${initialSubcategoryId}"]`);
        if (card) {
          selectSubcategory(initialSubcategoryId, card);
        }
      }
    } catch (error) {
      console.error('ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      grid.innerHTML = '<div class="category-loading">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
    }
  }

  function selectSubcategory(subcategoryId, element) {
    selectedSubcategoryId = subcategoryId;
    
    // hidden inputã‚’æ›´æ–°
    const input = document.getElementById(subcategoryInputId);
    if (input) input.value = subcategoryId;
    
    // å…¨ã‚«ãƒ¼ãƒ‰ã‹ã‚‰é¸æŠã‚¹ã‚¿ã‚¤ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆ
    document.querySelectorAll(`#${subcategoryGridId} .subcategory-card`).forEach(c => {
      c.classList.remove('selected');
    });
    
    // é¸æŠã•ã‚ŒãŸã‚«ãƒ¼ãƒ‰ã«ã‚¹ã‚¿ã‚¤ãƒ«ã‚’é©ç”¨
    element.classList.add('selected');

    // æ²»ç™‚ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
    if (showTreatmentStep) {
      const treatmentSection = document.getElementById(treatmentSectionId);
      if (treatmentSection) {
        treatmentSection.classList.remove('hidden');
        treatmentSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
      void loadTreatments(subcategoryId);
    }

    // ã‚«ã‚¹ã‚¿ãƒ ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«
    dispatchChangeEvent(`treatment-selector:subcategory-change:${componentId}`, { subcategoryId });
  }

  async function loadTreatments(subcategoryId) {
    const select = document.getElementById(treatmentSelectId);
    if (!select) return;
    select.innerHTML = '<option value="">æ–½è¡“ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
    selectedTreatmentId = null;

    try {
      const res = await fetch(`/api/treatments?subcategory_id=${subcategoryId}`);
      const data = await res.json();
      treatments = data.treatments || [];

      if (treatments.length === 0) {
        select.innerHTML = '<option value="">æ–½è¡“ãŒã‚ã‚Šã¾ã›ã‚“</option>';
        return;
      }

      select.innerHTML = '<option value="">æ–½è¡“ã‚’é¸æŠã—ã¦ãã ã•ã„</option>' +
        treatments.map(treatment => `<option value="${treatment.id}">${treatment.name}</option>`).join('');

      // åˆæœŸå€¤ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
      if (initialTreatmentId) {
        select.value = initialTreatmentId;
        selectedTreatmentId = initialTreatmentId;
      }

      select.onchange = () => {
        selectedTreatmentId = select.value || null;
        
        // ã‚«ã‚¹ã‚¿ãƒ ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«
        dispatchChangeEvent(`treatment-selector:treatment-change:${componentId}`, { treatmentId: selectedTreatmentId });
      };
    } catch (error) {
      console.error('æ–½è¡“èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      select.innerHTML = '<option value="">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</option>';
    }
  }

  async function setSelection(next) {
    const categoryId = next.categoryId ?? null;
    const subcategoryId = next.subcategoryId ?? null;
    const treatmentId = next.treatmentId ?? null;

    // Ensure categories are loaded and selectable
    if (categories.length === 0) {
      await loadCategories();
    }

    if (categoryId) {
      const grid = document.getElementById(categoryGridId);
      const card = grid?.querySelector(`[data-category-id="${categoryId}"]`);
      if (card) {
        selectCategory(categoryId, card);
      }
      await loadSubcategories(categoryId);
    }

    if (subcategoryId) {
      const subGrid = document.getElementById(subcategoryGridId);
      const subCard = subGrid?.querySelector(`[data-subcategory-id="${subcategoryId}"]`);
      if (subCard) {
        selectSubcategory(subcategoryId, subCard);
      } else if (categoryId) {
        // If not found due to timing, try once after reload
        await loadSubcategories(categoryId);
        const retry = subGrid?.querySelector(`[data-subcategory-id="${subcategoryId}"]`);
        if (retry) selectSubcategory(subcategoryId, retry);
      }
      if (showTreatmentStep) {
        await loadTreatments(subcategoryId);
      }
    }

    if (showTreatmentStep && treatmentId) {
      const select = document.getElementById(treatmentSelectId);
      if (select) {
        select.value = treatmentId;
        selectedTreatmentId = treatmentId;
      }
    }
  }

  // å…¬é–‹APIï¼ˆå¤–éƒ¨ã‹ã‚‰å€¤ã«ã‚¢ã‚¯ã‚»ã‚¹/è¨­å®šã™ã‚‹ãŸã‚ã®ãƒ¡ã‚½ãƒƒãƒ‰ï¼‰
  window[`getTreatmentSelector_${componentId}`] = () => ({
    getCategoryId: () => selectedCategoryId,
    getSubcategoryId: () => selectedSubcategoryId,
    getTreatmentId: () => selectedTreatmentId,
    setSelection,
  });

  // åˆæœŸåŒ–ã‚’ç¢ºå®Ÿã«è¡Œã†ãŸã‚ã®é–¢æ•°
  function init() {
    console.log('Initializing TreatmentSelector:', componentId);
    loadCategories().catch(err => {
      console.error('Initialization error:', err);
    });
  }

  // DOMã®èª­ã¿è¾¼ã¿å®Œäº†ã‚’å¾…ã¤
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
</script>

